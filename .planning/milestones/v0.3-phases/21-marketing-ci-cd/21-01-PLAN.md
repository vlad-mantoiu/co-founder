---
phase: 21-marketing-ci-cd
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/lib/github-deploy-stack.ts
  - .github/workflows/deploy-marketing.yml
autonomous: true
requirements:
  - CICD-01
  - CICD-02

must_haves:
  truths:
    - "A push to main that modifies any file under /marketing triggers the deploy-marketing workflow, which builds the static export, syncs to S3, and creates a CloudFront invalidation — no manual intervention required"
    - "A push to main that modifies only /frontend or /backend does NOT trigger the deploy-marketing workflow"
    - "The cofounder-github-deploy IAM role has scoped S3 and CloudFront permissions sufficient to run aws s3 sync and aws cloudfront create-invalidation against the marketing resources"
    - "manual workflow_dispatch trigger exists on deploy-marketing.yml for infra-only redeployment scenarios"
  artifacts:
    - path: ".github/workflows/deploy-marketing.yml"
      provides: "Path-filtered GitHub Actions workflow — builds Next.js static export, syncs to S3, invalidates CloudFront"
      contains: "on:push paths: marketing/**"
    - path: "infra/lib/github-deploy-stack.ts"
      provides: "Updated CDK IAM role with MarketingS3Sync and MarketingCFInvalidation policy statements"
      contains: "MarketingS3Sync"
  key_links:
    - from: ".github/workflows/deploy-marketing.yml"
      to: "arn:aws:iam::837175765586:role/cofounder-github-deploy"
      via: "aws-actions/configure-aws-credentials@v4 with secrets.AWS_DEPLOY_ROLE_ARN"
      pattern: "role-to-assume.*AWS_DEPLOY_ROLE_ARN"
    - from: "infra/lib/github-deploy-stack.ts"
      to: "arn:aws:s3:::getinsourced-marketing"
      via: "PolicyStatement sid=MarketingS3Sync"
      pattern: "MarketingS3Sync"
    - from: "infra/lib/github-deploy-stack.ts"
      to: "arn:aws:cloudfront::837175765586:distribution/E1BF4KDBGHEQPX"
      via: "PolicyStatement sid=MarketingCFInvalidation"
      pattern: "MarketingCFInvalidation"
---

<objective>
Add automated marketing site CI/CD: a path-filtered GitHub Actions workflow that builds the Next.js static export, syncs it to S3, and invalidates the CloudFront cache on every push to main that touches `/marketing`. Also update the CDK GitHubDeployStack with the IAM permissions the workflow requires.

Purpose: Eliminate manual deploys of the marketing site. The existing `cofounder-github-deploy` IAM role has no S3 or CloudFront permissions — adding them via CDK keeps infra as code and prevents drift.

Output: `.github/workflows/deploy-marketing.yml` + updated `infra/lib/github-deploy-stack.ts` + CDK deployed to AWS.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@infra/lib/github-deploy-stack.ts
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add S3 and CloudFront IAM permissions to GitHubDeployStack, then redeploy</name>
  <files>infra/lib/github-deploy-stack.ts</files>
  <action>
    Open `infra/lib/github-deploy-stack.ts`. Immediately after the existing `PassRole` policy statement block (after its closing `)`), add two new policy statements:

    Statement 1 — S3 sync permissions (insert after PassRole block, before the `new cdk.CfnOutput` line):
    ```typescript
    // S3 permissions — sync marketing static site to bucket
    this.deployRole.addToPolicy(
      new iam.PolicyStatement({
        sid: "MarketingS3Sync",
        actions: [
          "s3:PutObject",
          "s3:GetObject",
          "s3:DeleteObject",
          "s3:ListBucket",
        ],
        resources: [
          "arn:aws:s3:::getinsourced-marketing",
          "arn:aws:s3:::getinsourced-marketing/*",
        ],
      })
    );

    // CloudFront permissions — invalidate marketing distribution cache
    // Distribution ID E1BF4KDBGHEQPX from CoFounderMarketing stack output (Phase 19)
    this.deployRole.addToPolicy(
      new iam.PolicyStatement({
        sid: "MarketingCFInvalidation",
        actions: ["cloudfront:CreateInvalidation"],
        resources: [
          `arn:aws:cloudfront::${this.account}:distribution/E1BF4KDBGHEQPX`,
        ],
      })
    );
    ```

    After editing the file, run CDK deploy to apply the IAM changes to the live role:
    ```bash
    cd /Users/vladcortex/co-founder/infra
    CDK_DEFAULT_ACCOUNT=837175765586 CDK_DEFAULT_REGION=us-east-1 AWS_DEFAULT_REGION=us-east-1 \
      npx cdk deploy CoFounderGitHubDeploy --require-approval never
    ```

    If CDK deploy fails with a bootstrap error, run `npx cdk bootstrap aws://837175765576/us-east-1` first, then retry.

    After deploy succeeds, verify the new policy statements are live:
    ```bash
    aws iam get-role-policy --role-name cofounder-github-deploy --policy-name CoFounderGitHubDeployGitHubDeployRole* 2>/dev/null || \
    aws iam list-role-policies --role-name cofounder-github-deploy
    ```
    Confirm both `MarketingS3Sync` and `MarketingCFInvalidation` SIDs appear in the inline policy output.
  </action>
  <verify>
    1. `git diff infra/lib/github-deploy-stack.ts` shows both new `addToPolicy` blocks with `MarketingS3Sync` and `MarketingCFInvalidation`.
    2. CDK deploy exits with status 0 and prints `✅ CoFounderGitHubDeploy`.
    3. `aws iam list-role-policies --role-name cofounder-github-deploy` lists at least one inline policy; fetching it shows both new SIDs.
  </verify>
  <done>The live `cofounder-github-deploy` IAM role has S3 PutObject/GetObject/DeleteObject/ListBucket on `arn:aws:s3:::getinsourced-marketing` and CloudFront CreateInvalidation on distribution `E1BF4KDBGHEQPX`.</done>
</task>

<task type="auto">
  <name>Task 2: Create deploy-marketing.yml — path-filtered GitHub Actions workflow</name>
  <files>.github/workflows/deploy-marketing.yml</files>
  <action>
    Create `.github/workflows/deploy-marketing.yml` with the following exact content:

    ```yaml
    name: Deploy Marketing Site

    on:
      push:
        branches:
          - main
        paths:
          - 'marketing/**'
      workflow_dispatch: # manual trigger for infra-only changes (CloudFront/S3 config)

    env:
      AWS_REGION: us-east-1
      S3_BUCKET: getinsourced-marketing
      # CloudFront Distribution ID from CoFounderMarketing stack output (Phase 19)
      CF_DISTRIBUTION_ID: E1BF4KDBGHEQPX

    jobs:
      deploy-marketing:
        runs-on: ubuntu-latest
        permissions:
          id-token: write
          contents: read
        environment: production

        steps:
          - uses: actions/checkout@v4

          - uses: actions/setup-node@v4
            with:
              node-version: '20'
              cache: 'npm'
              cache-dependency-path: marketing/package-lock.json

          - name: Install dependencies
            working-directory: marketing
            run: npm ci

          - name: Build static export
            working-directory: marketing
            run: npm run build

          - uses: aws-actions/configure-aws-credentials@v4
            with:
              role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
              aws-region: ${{ env.AWS_REGION }}

          - name: Sync to S3
            run: |
              aws s3 sync marketing/out/ s3://${{ env.S3_BUCKET }}/ \
                --delete \
                --region ${{ env.AWS_REGION }}

          - name: Invalidate CloudFront cache
            run: |
              aws cloudfront create-invalidation \
                --distribution-id ${{ env.CF_DISTRIBUTION_ID }} \
                --paths "/*" \
                --region ${{ env.AWS_REGION }}
    ```

    Key design decisions baked in:
    - `on:push paths: ['marketing/**']` — native GitHub path filter, no third-party action needed (satisfies CICD-02)
    - `workflow_dispatch` — escape hatch for infra-only CloudFront/S3 changes that don't touch `/marketing`
    - `cache-dependency-path: marketing/package-lock.json` — `marketing/package-lock.json` is confirmed tracked in git; `npm ci` will use it for reproducible installs
    - `aws-actions/configure-aws-credentials@v4` with `secrets.AWS_DEPLOY_ROLE_ARN` — same OIDC pattern as existing `deploy.yml`; no new secrets needed
    - `aws s3 sync --delete` — removes stale files when marketing pages are deleted
    - CloudFront invalidation is fire-and-forget (no `--wait-for-completion`) — propagation takes 1-5 min and blocking is not worth it
    - `environment: production` — matches existing `deploy.yml` pattern; picks up any environment protection rules already configured in GitHub
  </action>
  <verify>
    1. File `.github/workflows/deploy-marketing.yml` exists.
    2. `cat .github/workflows/deploy-marketing.yml | grep "paths:"` shows `marketing/**`.
    3. `cat .github/workflows/deploy-marketing.yml | grep "workflow_dispatch"` shows the manual trigger.
    4. `cat .github/workflows/deploy-marketing.yml | grep "CF_DISTRIBUTION_ID"` shows `E1BF4KDBGHEQPX`.
    5. `cat .github/workflows/deploy-marketing.yml | grep "AWS_DEPLOY_ROLE_ARN"` shows it uses the existing secret.
    6. Run a YAML lint check: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-marketing.yml'))" && echo "YAML valid"` — must print "YAML valid".
  </verify>
  <done>`.github/workflows/deploy-marketing.yml` exists, passes YAML parse, contains path filter `marketing/**`, `workflow_dispatch`, distribution ID `E1BF4KDBGHEQPX`, and reuses `AWS_DEPLOY_ROLE_ARN` secret.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. CDK deploy succeeded — `CoFounderGitHubDeploy` stack shows no pending changes.
2. IAM role `cofounder-github-deploy` has both `MarketingS3Sync` and `MarketingCFInvalidation` inline policy statements:
   ```bash
   aws iam get-role-policy \
     --role-name cofounder-github-deploy \
     --policy-name "$(aws iam list-role-policies --role-name cofounder-github-deploy --query 'PolicyNames[0]' --output text)"
   ```
3. YAML is valid:
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-marketing.yml'))" && echo "YAML valid"
   ```
4. Path filter is present:
   ```bash
   grep "marketing/\*\*" .github/workflows/deploy-marketing.yml
   ```
5. Both files are committed and pushed to main.
6. Confirm the `Actions` tab in GitHub shows `Deploy Marketing Site` workflow listed.
</verification>

<success_criteria>
Phase 21 is complete when:
1. Pushing a commit that modifies a file under `/marketing` triggers `Deploy Marketing Site` in GitHub Actions, the build succeeds, S3 sync completes, and a CloudFront invalidation is created — verified in the GitHub Actions run log.
2. Pushing a commit that modifies only `/backend` or `/frontend` does NOT trigger `Deploy Marketing Site` — confirmed by the absence of a workflow run for that commit.
3. `workflow_dispatch` is available on the `Deploy Marketing Site` workflow for manual redeployment.
</success_criteria>

<output>
After completion, create `.planning/phases/21-marketing-ci-cd/21-01-SUMMARY.md` with:
- What was built (workflow file + IAM role update)
- CDK stack deployed (CoFounderGitHubDeploy)
- Key values used (S3 bucket, CF distribution ID, IAM role name, secret name)
- Verification result (workflow triggered or not, IAM policy confirmed)
</output>
