---
phase: 19-cloudfront-s3-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/lib/marketing-stack.ts
  - infra/functions/url-handler.js
  - infra/bin/app.ts
  - infra/lib/compute-stack.ts
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03
  - INFRA-04

must_haves:
  truths:
    - "cdk synth CoFounderMarketing produces a valid CloudFormation template with S3 bucket, CloudFront distribution, OAC, ACM certificate, and Route53 records"
    - "The S3 bucket has BlockPublicAccess.BLOCK_ALL and no website hosting configuration"
    - "The CloudFront distribution has two cache behaviors: default (5-min TTL for HTML) and _next/static/* (1-year TTL for assets)"
    - "The www-to-apex 301 redirect and clean URL rewriting are handled by a CloudFront Function"
    - "The ComputeStack no longer creates Route53 A records for getinsourced.ai or www.getinsourced.ai"
  artifacts:
    - path: "infra/lib/marketing-stack.ts"
      provides: "CoFounderMarketing CDK stack with S3, CloudFront, OAC, ACM, Route53"
      exports: ["MarketingStack"]
      min_lines: 80
    - path: "infra/functions/url-handler.js"
      provides: "CloudFront Function for www redirect and clean URL rewriting"
      contains: "async function handler"
      min_lines: 15
    - path: "infra/bin/app.ts"
      provides: "MarketingStack instantiation in CDK app"
      contains: "CoFounderMarketing"
    - path: "infra/lib/compute-stack.ts"
      provides: "ComputeStack without getinsourced.ai/www Route53 records"
  key_links:
    - from: "infra/lib/marketing-stack.ts"
      to: "infra/functions/url-handler.js"
      via: "path.join(__dirname, '../functions/url-handler.js')"
      pattern: "FunctionCode\\.fromFile"
    - from: "infra/bin/app.ts"
      to: "infra/lib/marketing-stack.ts"
      via: "import and instantiation"
      pattern: "new MarketingStack.*CoFounderMarketing"
    - from: "infra/lib/marketing-stack.ts"
      to: "cdk.context.json"
      via: "HostedZone.fromLookup for getinsourced.ai"
      pattern: "fromLookup.*getinsourced\\.ai"
---

<objective>
Create the CoFounderMarketing CDK stack with all infrastructure code: private S3 bucket with OAC, CloudFront distribution with dual cache policies, ACM certificate with DNS validation, Route53 alias records, and CloudFront Function for www redirect + clean URL rewriting. Also remove conflicting Route53 records from ComputeStack.

Purpose: All CDK code must exist and pass `cdk synth` before deployment can happen.
Output: Four files — marketing-stack.ts, url-handler.js, updated app.ts, updated compute-stack.ts.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-cloudfront-s3-infrastructure/19-RESEARCH.md
@infra/lib/compute-stack.ts
@infra/lib/dns-stack.ts
@infra/bin/app.ts
@infra/cdk.context.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CloudFront Function and MarketingStack CDK code</name>
  <files>infra/functions/url-handler.js, infra/lib/marketing-stack.ts</files>
  <action>
Create `infra/functions/` directory and `url-handler.js` — a CloudFront Function (JS 2.0 runtime) that:
1. Checks if host starts with "www." — if so, returns 301 redirect to `https://getinsourced.ai` + request URI
2. For non-www requests: if URI has no file extension and does not end with "/" and is not "/", appends ".html" (clean URL rewriting for Next.js static export: /about -> /about.html)
3. For trailing slash URIs (not "/"), appends "index.html"
4. Returns the (possibly rewritten) request

Create `infra/lib/marketing-stack.ts` — the `MarketingStack` class (exported as `MarketingStack`) containing:

**S3 Bucket (INFRA-04):**
- bucketName: "getinsourced-marketing"
- blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL
- removalPolicy: cdk.RemovalPolicy.RETAIN (production bucket)
- encryption: s3.BucketEncryption.S3_MANAGED (SSE-S3, not KMS — avoids OAC KMS complexity)
- versioned: false (hash-busting handles asset versioning)

**OAC (INFRA-04):**
- Use `origins.S3BucketOrigin.withOriginAccessControl(bucket)` — the L2 construct auto-creates OAC and auto-adds the scoped bucket policy. Do NOT use deprecated S3Origin or OAI.

**ACM Certificate (INFRA-03):**
- domainName: "getinsourced.ai"
- subjectAlternativeNames: ["www.getinsourced.ai"]
- validation: acm.CertificateValidation.fromDns(hostedZone)
- Do NOT use deprecated DnsValidatedCertificate

**CloudFront Function:**
- functionName: "marketing-url-handler"
- code: cloudfront.FunctionCode.fromFile({ filePath: path.join(__dirname, '../functions/url-handler.js') })
- runtime: cloudfront.FunctionRuntime.JS_2_0

**Cache Policies:**
- HTML cache policy (Marketing-Html-5min): defaultTtl 5 min, minTtl 0, maxTtl 5 min, enableAcceptEncodingGzip true, enableAcceptEncodingBrotli true, queryStringBehavior none, cookieBehavior none
- Asset cache policy (Marketing-Assets-1yr): defaultTtl 365 days, minTtl 365 days, maxTtl 365 days, same encoding/query/cookie settings

**CloudFront Distribution (INFRA-01):**
- defaultBehavior: s3Origin, REDIRECT_TO_HTTPS, htmlCachePolicy, compress true, GET_HEAD_OPTIONS, functionAssociations with url-handler on VIEWER_REQUEST
- additionalBehaviors: "_next/static/*" with s3Origin, REDIRECT_TO_HTTPS, assetCachePolicy, compress true, GET_HEAD_OPTIONS
- domainNames: ["getinsourced.ai", "www.getinsourced.ai"]
- certificate: the ACM certificate
- defaultRootObject: "index.html"
- priceClass: PRICE_CLASS_200
- minimumProtocolVersion: TLS_V1_2_2021
- errorResponses: map all 403, 404, and 5xx error types to /404.html per user decision. Use the following entries:
  - { httpStatus: 403, responsePagePath: '/404.html', responseHttpStatus: 404, ttl: cdk.Duration.minutes(5) }  — S3 returns 403 for missing keys with OAC, convert to 404
  - { httpStatus: 404, responsePagePath: '/404.html', responseHttpStatus: 404, ttl: cdk.Duration.minutes(5) }
  - { httpStatus: 500, responsePagePath: '/404.html', responseHttpStatus: 500, ttl: cdk.Duration.seconds(5) }  — keep original 5xx status, short TTL to avoid caching transient errors
  - { httpStatus: 502, responsePagePath: '/404.html', responseHttpStatus: 502, ttl: cdk.Duration.seconds(5) }
  - { httpStatus: 503, responsePagePath: '/404.html', responseHttpStatus: 503, ttl: cdk.Duration.seconds(5) }
  - { httpStatus: 504, responsePagePath: '/404.html', responseHttpStatus: 504, ttl: cdk.Duration.seconds(5) }
- responseHeadersPolicy: cloudfront.ResponseHeadersPolicy.SECURITY_HEADERS (AWS-managed, adds HSTS, X-Content-Type-Options, X-Frame-Options, X-XSS-Protection)

**Hosted Zone (INFRA-02):**
- Use route53.HostedZone.fromLookup(this, "HostedZone", { domainName: "getinsourced.ai" }) — already cached in cdk.context.json as Z100112320CO99MQG9VJS

**Route53 Records (INFRA-02):**
- Create ARecord and AaaaRecord for both "getinsourced.ai" and "www.getinsourced.ai" pointing to CloudFrontTarget(distribution)
- Use a loop for DRY: iterate over [["Apex", "getinsourced.ai"], ["Www", "www.getinsourced.ai"]]

**CfnOutputs (for Phase 21):**
- DistributionId: distribution.distributionId, exportName "CoFounderMarketingDistributionId"
- DistributionDomain: distribution.distributionDomainName, exportName "CoFounderMarketingDistributionDomain"
- BucketName: bucket.bucketName, exportName "CoFounderMarketingBucketName"

Use the complete skeleton from 19-RESEARCH.md as the reference implementation. Import path from "path" at the top.
  </action>
  <verify>Both files exist. `cat infra/functions/url-handler.js` shows the handler function. `cat infra/lib/marketing-stack.ts` shows the MarketingStack class with all constructs including all 6 errorResponses entries (403, 404, 500, 502, 503, 504).</verify>
  <done>marketing-stack.ts exports MarketingStack with S3 bucket (private, OAC), CloudFront distribution (dual cache behaviors, error responses for 403/404/5xx, security headers), ACM certificate (apex+www, DNS validation), Route53 records (A+AAAA for apex and www), and 3 CfnOutputs. url-handler.js handles www-to-apex 301 redirect and clean URL rewriting.</done>
</task>

<task type="auto">
  <name>Task 2: Remove conflicting Route53 records from ComputeStack and register MarketingStack</name>
  <files>infra/lib/compute-stack.ts, infra/bin/app.ts</files>
  <action>
**compute-stack.ts changes:**
Remove lines 293-309 (the Route53 A records for getinsourced.ai and www.getinsourced.ai that currently point to the frontend ALB). Specifically remove:
1. The `parentDomain` variable declaration (line 294)
2. The `WwwRecord` ARecord construct (lines 295-301)
3. The `ApexRecord` ARecord construct (lines 303-309)

These records conflict with the MarketingStack's Route53 records. The marketing site now owns getinsourced.ai and www.getinsourced.ai. The cofounder.getinsourced.ai subdomain record is managed by the `FrontendService` ALB pattern (domainName: domainName which is "cofounder.getinsourced.ai") and stays untouched.

Do NOT remove the `route53Targets` import or any other code. Only remove the 3 items above.

**app.ts changes:**
1. Add import: `import { MarketingStack } from '../lib/marketing-stack';`
2. After the GitHubDeployStack instantiation (line 82), add:

```typescript
// 7. Marketing Stack (CloudFront + S3 for getinsourced.ai)
new MarketingStack(app, 'CoFounderMarketing', {
  env,
  description: 'CloudFront + S3 marketing site for getinsourced.ai',
});
```

No dependency on other stacks needed — MarketingStack uses fromLookup for the hosted zone (resolved at synth time, not deploy time).
  </action>
  <verify>Run `cd /Users/vladcortex/co-founder/infra && npx cdk synth CoFounderMarketing --quiet 2>&1 | head -20` — should produce CloudFormation YAML without errors. Also verify `grep -n "WwwRecord\|ApexRecord\|parentDomain" infra/lib/compute-stack.ts` returns nothing (records removed).</verify>
  <done>ComputeStack no longer creates Route53 A records for getinsourced.ai or www.getinsourced.ai. app.ts instantiates CoFounderMarketing stack. `cdk synth CoFounderMarketing` succeeds and produces valid CloudFormation template containing AWS::S3::Bucket, AWS::CloudFront::Distribution, AWS::CloudFront::OriginAccessControl, AWS::CertificateManager::Certificate, and AWS::Route53::RecordSet resources.</done>
</task>

</tasks>

<verification>
1. `cd /Users/vladcortex/co-founder/infra && npx cdk synth CoFounderMarketing --quiet` succeeds without errors
2. `npx cdk synth CoFounderCompute --quiet` succeeds without errors (no broken references from record removal)
3. The synthesized CoFounderMarketing template contains: S3 bucket with BlockPublicAccess, CloudFront Distribution with OAC, ACM Certificate, 4 Route53 RecordSets (A+AAAA for apex and www), CloudFront Function
4. No references to WwwRecord or ApexRecord remain in compute-stack.ts
5. `npx cdk ls` shows CoFounderMarketing in the list of stacks
</verification>

<success_criteria>
- `cdk synth CoFounderMarketing` produces valid CloudFormation
- `cdk synth CoFounderCompute` still produces valid CloudFormation (no regressions)
- All four requirement IDs (INFRA-01 through INFRA-04) are addressed in the synthesized template
- MarketingStack is registered in app.ts and appears in `cdk ls`
</success_criteria>

<output>
After completion, create `.planning/phases/19-cloudfront-s3-infrastructure/19-01-SUMMARY.md`
</output>
