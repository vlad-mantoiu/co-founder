---
phase: 19-cloudfront-s3-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 19-01
files_modified: []
autonomous: false
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03
  - INFRA-04

must_haves:
  truths:
    - "cdk deploy CoFounderCompute completes successfully with Route53 records for getinsourced.ai and www removed"
    - "cdk deploy CoFounderMarketing completes successfully — S3 bucket, CloudFront distribution, OAC, ACM certificate, and Route53 records all provisioned"
    - "https://getinsourced.ai serves content over HTTPS with a valid TLS certificate (after initial S3 upload)"
    - "https://www.getinsourced.ai returns a 301 redirect to https://getinsourced.ai"
    - "Direct S3 object URLs (s3.amazonaws.com/getinsourced-marketing/*) return 403"
  artifacts: []
  key_links:
    - from: "CoFounderCompute stack"
      to: "Route53 hosted zone"
      via: "Removed A records for apex/www"
      pattern: "no WwwRecord or ApexRecord in compute CloudFormation"
    - from: "CoFounderMarketing stack"
      to: "Route53 hosted zone"
      via: "New A/AAAA records pointing to CloudFront"
      pattern: "AWS::Route53::RecordSet"
    - from: "CloudFront distribution"
      to: "S3 bucket"
      via: "OAC (Origin Access Control)"
      pattern: "AWS::CloudFront::OriginAccessControl"
---

<objective>
Deploy the CDK changes: first update CoFounderCompute to remove conflicting Route53 records, then deploy CoFounderMarketing to provision the full CloudFront + S3 infrastructure. Upload the marketing site static export to S3 and verify the live site.

Purpose: The CDK code from Plan 01 must be deployed to AWS to make getinsourced.ai resolve to CloudFront.
Output: Live CloudFront distribution serving getinsourced.ai with TLS, OAC-protected S3 bucket, and working www redirect.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-cloudfront-s3-infrastructure/19-RESEARCH.md
@.planning/phases/19-cloudfront-s3-infrastructure/19-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy ComputeStack update and MarketingStack</name>
  <files></files>
  <action>
**Step 1: Build the marketing site static export**
```bash
cd /Users/vladcortex/co-founder/marketing && npm run build
```
Verify `/Users/vladcortex/co-founder/marketing/out/` exists with index.html and other pages.

**Step 2: Deploy ComputeStack update (remove conflicting Route53 records)**
```bash
cd /Users/vladcortex/co-founder/infra
CDK_DEFAULT_ACCOUNT=837175765586 CDK_DEFAULT_REGION=us-east-1 AWS_DEFAULT_REGION=us-east-1 npx cdk deploy CoFounderCompute --require-approval never
```
This removes the A records for getinsourced.ai and www.getinsourced.ai from ComputeStack. Wait for completion.

**Step 3: Deploy CoFounderMarketing stack**
```bash
CDK_DEFAULT_ACCOUNT=837175765586 CDK_DEFAULT_REGION=us-east-1 AWS_DEFAULT_REGION=us-east-1 npx cdk deploy CoFounderMarketing --require-approval never
```
This creates: S3 bucket (getinsourced-marketing), CloudFront distribution with OAC, ACM certificate (DNS validation auto-completes via Route53), Route53 A+AAAA records for apex and www.

ACM DNS validation typically takes 1-5 minutes. CloudFront distribution creation takes 5-15 minutes. The deploy command will wait for completion.

Note the CfnOutput values (DistributionId, BucketName) from the deploy output — needed for S3 sync.

**Step 4: Upload marketing site to S3**
```bash
aws s3 sync /Users/vladcortex/co-founder/marketing/out/ s3://getinsourced-marketing/ --delete --region us-east-1
```

**Step 5: Invalidate CloudFront cache**
Get the distribution ID from the deploy output, then:
```bash
DIST_ID=$(aws cloudformation describe-stacks --stack-name CoFounderMarketing --query "Stacks[0].Outputs[?OutputKey=='DistributionId'].OutputValue" --output text --region us-east-1)
aws cloudfront create-invalidation --distribution-id "$DIST_ID" --paths "/*" --region us-east-1
```

If any deploy step fails due to auth, create a checkpoint for the user to authenticate. If ComputeStack deploy fails due to resource in use, check if the frontend ECS service is the issue and proceed accordingly.
  </action>
  <verify>
Run these checks:
1. `aws cloudformation describe-stacks --stack-name CoFounderMarketing --query "Stacks[0].StackStatus" --output text --region us-east-1` returns "CREATE_COMPLETE" or "UPDATE_COMPLETE"
2. `aws s3 ls s3://getinsourced-marketing/ --region us-east-1` shows files (index.html at minimum)
3. `curl -sI https://getinsourced.ai | head -5` returns HTTP 200 with valid response
4. `curl -sI https://www.getinsourced.ai | head -5` returns HTTP 301 with Location: https://getinsourced.ai/
5. `curl -sI https://s3.amazonaws.com/getinsourced-marketing/index.html | head -5` returns HTTP 403 (OAC enforced)
  </verify>
  <done>Both CDK stacks deployed. Marketing site content uploaded to S3. CloudFront distribution is serving getinsourced.ai.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify live site in browser</name>
  <what-built>
CloudFront + S3 infrastructure for getinsourced.ai:
- Private S3 bucket (getinsourced-marketing) with marketing site content
- CloudFront distribution with OAC, ACM certificate (TLS), dual cache policies
- Route53 alias records pointing getinsourced.ai and www to CloudFront
- CloudFront Function handling www-to-apex 301 redirect and clean URL rewriting
  </what-built>
  <how-to-verify>
1. Open https://getinsourced.ai in your browser — should show the marketing site homepage over HTTPS with valid certificate (click lock icon to verify)
2. Open https://www.getinsourced.ai — should 301 redirect to https://getinsourced.ai
3. Navigate to https://getinsourced.ai/about — should show the About page (clean URL rewriting working)
4. Navigate to https://getinsourced.ai/pricing — should show the Pricing page
5. Navigate to https://getinsourced.ai/nonexistent-page — should show the branded 404 page
6. Try https://s3.amazonaws.com/getinsourced-marketing/index.html — should return 403 Forbidden (OAC working)
7. Verify https://cofounder.getinsourced.ai still works (should be unaffected — separate ALB)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. CoFounderMarketing stack is in CREATE_COMPLETE or UPDATE_COMPLETE status
2. CoFounderCompute stack is in UPDATE_COMPLETE status (records removed)
3. https://getinsourced.ai returns 200 with valid TLS
4. https://www.getinsourced.ai returns 301 to apex
5. Direct S3 URLs return 403
6. https://cofounder.getinsourced.ai is unaffected
7. Clean URL rewriting works (/about, /pricing, /contact all resolve)
</verification>

<success_criteria>
- getinsourced.ai serves the marketing site over HTTPS with valid TLS certificate
- www.getinsourced.ai 301 redirects to getinsourced.ai
- S3 bucket is private (direct URLs return 403)
- cofounder.getinsourced.ai is unaffected
- CloudFront distribution ID, domain name, and bucket name are exported as CfnOutputs for Phase 21
</success_criteria>

<output>
After completion, create `.planning/phases/19-cloudfront-s3-infrastructure/19-02-SUMMARY.md`
</output>
