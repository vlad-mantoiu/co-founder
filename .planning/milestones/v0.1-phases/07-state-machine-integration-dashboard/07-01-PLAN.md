---
phase: 07-state-machine-integration-dashboard
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/app/schemas/dashboard.py
  - backend/app/services/dashboard_service.py
  - backend/app/api/routes/dashboard.py
  - backend/app/api/routes/__init__.py
  - backend/tests/api/test_dashboard_api.py
autonomous: true

must_haves:
  truths:
    - "GET /api/dashboard/{project_id} returns full dashboard payload with all required fields"
    - "Empty project returns empty arrays for artifacts, risk_flags, pending_decisions (never null)"
    - "Unauthorized user receives 404 (user isolation enforced)"
    - "Progress percentage computed from domain pure functions on each request"
    - "Suggested focus follows deterministic priority: pending decisions > failed artifacts > risks > all clear"
  artifacts:
    - path: "backend/app/schemas/dashboard.py"
      provides: "DashboardResponse Pydantic model with empty array defaults"
      contains: "class DashboardResponse"
    - path: "backend/app/services/dashboard_service.py"
      provides: "DashboardService aggregating state machine + artifacts + builds"
      contains: "class DashboardService"
    - path: "backend/app/api/routes/dashboard.py"
      provides: "GET /api/dashboard/{project_id} endpoint"
      contains: "async def get_dashboard"
    - path: "backend/tests/api/test_dashboard_api.py"
      provides: "Integration tests for dashboard API"
      min_lines: 100
  key_links:
    - from: "backend/app/services/dashboard_service.py"
      to: "backend/app/domain/progress.py"
      via: "compute_stage_progress import"
      pattern: "from app\\.domain\\.progress import"
    - from: "backend/app/services/dashboard_service.py"
      to: "backend/app/domain/risks.py"
      via: "detect_system_risks import"
      pattern: "from app\\.domain\\.risks import"
    - from: "backend/app/api/routes/dashboard.py"
      to: "backend/app/services/dashboard_service.py"
      via: "DashboardService instantiation"
      pattern: "DashboardService"
    - from: "backend/app/api/routes/__init__.py"
      to: "backend/app/api/routes/dashboard.py"
      via: "router registration"
      pattern: "dashboard"
---

<objective>
Dashboard API endpoint aggregating state machine, artifacts, and build status into a single response.

Purpose: Provide the backend data source for the founder-facing Company dashboard. This is the single API call that powers the entire dashboard view.
Output: GET /api/dashboard/{project_id} endpoint returning DashboardResponse with all required fields per DASH-01 and DASH-03.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-state-machine-core/02-01-SUMMARY.md
@.planning/phases/02-state-machine-core/02-04-SUMMARY.md
@.planning/phases/06-artifact-generation-pipeline/06-01-SUMMARY.md
@.planning/phases/06-artifact-generation-pipeline/06-03-SUMMARY.md

Key existing code:
@backend/app/domain/progress.py — compute_stage_progress(), compute_global_progress()
@backend/app/domain/risks.py — detect_system_risks()
@backend/app/services/journey.py — JourneyService (state machine orchestration)
@backend/app/services/artifact_service.py — ArtifactService (artifact CRUD)
@backend/app/db/models/artifact.py — Artifact model with generation_status
@backend/app/db/models/project.py — Project model with stage info
@backend/app/core/auth.py — require_auth, ClerkUser
@backend/app/api/routes/__init__.py — Router registration
</context>

<feature>
  <name>Dashboard Aggregation API</name>
  <files>
    backend/app/schemas/dashboard.py
    backend/app/services/dashboard_service.py
    backend/app/api/routes/dashboard.py
    backend/app/api/routes/__init__.py
    backend/tests/api/test_dashboard_api.py
  </files>
  <behavior>
    GET /api/dashboard/{project_id} with valid auth:
    - Returns 200 with DashboardResponse containing:
      project_id (str), stage (int), stage_name (str), product_version (str),
      mvp_completion_percent (int 0-100), next_milestone (str|null),
      risk_flags (list, default []), suggested_focus (str),
      artifacts (list, default []), pending_decisions (list, default []),
      latest_build_status (str|null), preview_url (str|null)
    - Empty/new project returns all list fields as [] (never null)
    - Progress computed from domain pure functions (compute_stage_progress)
    - Risks computed from domain pure functions (detect_system_risks)
    - Suggested focus deterministic: pending decisions > failed artifacts > risks > "All clear"

    GET /api/dashboard/{project_id} without auth: 401
    GET /api/dashboard/{other_user_project}: 404

    Cases:
    - New project with no artifacts: {artifacts: [], risk_flags: [], pending_decisions: [], mvp_completion_percent: 0}
    - Project with artifacts generating: artifacts list includes items with generation_status="generating"
    - Project with pending gate: suggested_focus mentions the pending decision
    - Project with failed artifact: suggested_focus mentions failed artifact retry
    - Project with risk: risk_flags contains risk objects
  </behavior>
  <implementation>
    1. Create backend/app/schemas/dashboard.py with Pydantic models:
       - RiskFlagResponse(type: str, rule: str, message: str)
       - ArtifactSummary(id: str, artifact_type: str, generation_status: str, version_number: int, has_user_edits: bool, updated_at: datetime)
       - PendingDecision(id: str, gate_type: str, status: str, created_at: datetime)
       - DashboardResponse with all fields from DASH-01
       - ALL list fields use Field(default_factory=list) to guarantee empty arrays

    2. Create backend/app/services/dashboard_service.py with DashboardService class:
       - get_dashboard(session, project_id, user_id) -> DashboardResponse | None
       - Queries: Project (ownership check), Artifact (list), DecisionGate (pending), StageConfig (milestones)
       - Calls compute_stage_progress() from domain layer for percentage
       - Calls detect_system_risks() from domain layer for risk flags
       - _compute_suggested_focus(): deterministic priority logic
         * Priority 1: Pending gates (sorted by created_at, oldest first)
         * Priority 2: Failed artifacts (sorted by id for determinism)
         * Priority 3: Active risks (sorted by rule name alphabetically)
         * Priority 4: "All clear — ready to build"
       - _get_next_milestone(): from StageConfig milestones, first incomplete

    3. Create backend/app/api/routes/dashboard.py:
       - router = APIRouter()
       - GET /{project_id} with require_auth dependency
       - Instantiate DashboardService, call get_dashboard
       - Return 404 if None (project not found or unauthorized)
       - Register in __init__.py with prefix="/dashboard"

    4. Write integration tests (TDD RED phase first):
       - test_get_dashboard_returns_full_payload
       - test_get_dashboard_empty_project_returns_empty_arrays
       - test_get_dashboard_unauthenticated_returns_401
       - test_get_dashboard_other_user_returns_404
       - test_get_dashboard_with_artifacts_includes_summaries
       - test_get_dashboard_suggested_focus_pending_decision
       - test_get_dashboard_suggested_focus_all_clear
       - test_get_dashboard_nonexistent_project_returns_404
  </implementation>
</feature>

<verification>
- `cd backend && python -m pytest tests/api/test_dashboard_api.py -v` — all tests pass
- `python -c "from app.schemas.dashboard import DashboardResponse; print(DashboardResponse().model_dump())"` — shows empty arrays for list fields
- `python -c "from app.api.routes import api_router; routes = [r.path for r in api_router.routes if 'dashboard' in str(r.path)]; print(routes)"` — shows /dashboard/{project_id}
</verification>

<success_criteria>
- GET /api/dashboard/{project_id} returns 200 with all DASH-01 fields
- Empty project returns empty arrays for artifacts, risk_flags, pending_decisions (DASH-03)
- User isolation enforced (404 for wrong user)
- Progress computed from domain pure functions (not hardcoded)
- Suggested focus is deterministic (same input = same output)
- All integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-state-machine-integration-dashboard/07-01-SUMMARY.md`
</output>
