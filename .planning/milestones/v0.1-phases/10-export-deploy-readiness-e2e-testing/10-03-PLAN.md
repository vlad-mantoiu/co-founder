---
phase: 10-export-deploy-readiness-e2e-testing
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/tests/api/test_response_contracts.py
  - backend/tests/api/test_beta_gating.py
  - backend/app/schemas/dashboard.py
  - backend/app/schemas/decision_gates.py
autonomous: true

must_haves:
  truths:
    - "Dashboard response returns empty arrays (not null) for all list fields"
    - "Timeline response returns empty arrays (not null) for items"
    - "Graph response returns empty arrays for nodes and edges"
    - "Beta-gated endpoints return 403 when feature flag is disabled"
    - "Beta flags endpoint exposes available flags for UI labeling"
  artifacts:
    - path: "backend/tests/api/test_response_contracts.py"
      provides: "Response contract validation tests"
      contains: "test_dashboard_returns_empty_arrays"
    - path: "backend/tests/api/test_beta_gating.py"
      provides: "Beta gating enforcement tests"
      contains: "test_beta_endpoint_returns_403"
  key_links:
    - from: "backend/tests/api/test_response_contracts.py"
      to: "backend/app/schemas/dashboard.py"
      via: "Tests verify Pydantic default_factory=list"
      pattern: "isinstance.*list"
    - from: "backend/tests/api/test_beta_gating.py"
      to: "backend/app/core/feature_flags.py"
      via: "Tests verify require_feature dependency"
      pattern: "require_feature"
---

<objective>
Validate response contracts (empty arrays, not null) and beta gating enforcement.

Purpose: CNTR-01 (stable shapes), CNTR-02 (empty arrays not null), BETA-01 (403 unless beta enabled), BETA-02 (API exposes flags). These are validation tests that prove existing patterns work correctly. Any Pydantic schema with `Optional[list] = None` must be fixed to `list = Field(default_factory=list)`.

Output: Contract tests, beta gating tests, schema fixes if needed.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-export-deploy-readiness-e2e-testing/10-RESEARCH.md

@backend/app/schemas/dashboard.py
@backend/app/core/feature_flags.py
@backend/app/api/routes/features.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Response contract validation tests and schema audit</name>
  <files>backend/tests/api/test_response_contracts.py, backend/app/schemas/dashboard.py, backend/app/schemas/decision_gates.py</files>
  <action>
    **Step 1 — Audit all Pydantic response models for null-risk list fields:**
    Grep all response models in `backend/app/schemas/` for patterns:
    - `Optional[list` — must be changed to `list[...] = Field(default_factory=list)`
    - `list[...] | None = None` — must be changed to `list[...] = Field(default_factory=list)`
    - `list[...] = None` — must be changed to `list[...] = Field(default_factory=list)`

    Fix any found issues. The dashboard schemas already use `Field(default_factory=list)` per Phase 7 — but verify timeline, graph, and decision gate schemas too.

    Check these schema files specifically:
    - `backend/app/schemas/dashboard.py` — DashboardResponse (artifacts, pending_decisions, risk_flags)
    - `backend/app/schemas/decision_gates.py` — CreateGateResponse (options), GateStatusResponse (options)
    - `backend/app/schemas/timeline.py` (if exists) — TimelineResponse (items)
    - `backend/app/schemas/graph.py` (if exists) — GraphResponse (nodes, edges)

    **Step 2 — Write contract tests in `backend/tests/api/test_response_contracts.py`:**

    Tests should instantiate Pydantic models with minimal data and verify list fields default to []:

    ```python
    def test_dashboard_response_empty_arrays_not_null():
        """CNTR-02: Dashboard empty states return [] not null."""
        response = DashboardResponse(
            project_id="test", stage=0, stage_name="Pre-stage",
            product_version="v0.1", mvp_completion_percent=0,
            suggested_focus="All clear"
        )
        assert isinstance(response.artifacts, list) and response.artifacts == []
        assert isinstance(response.pending_decisions, list) and response.pending_decisions == []
        assert isinstance(response.risk_flags, list) and response.risk_flags == []
        assert response.latest_build_status is None  # This is OK as None (not a list)
        assert response.preview_url is None  # This is OK as None (not a list)

    def test_dashboard_response_serialization_no_nulls():
        """CNTR-02: JSON serialization produces [] not null."""
        response = DashboardResponse(
            project_id="test", stage=0, stage_name="Pre-stage",
            product_version="v0.1", mvp_completion_percent=0,
            suggested_focus="All clear"
        )
        data = response.model_dump()
        assert data["artifacts"] == []
        assert data["pending_decisions"] == []
        assert data["risk_flags"] == []

    def test_gate_response_options_default():
        """CNTR-01: Gate response options field has stable shape."""
        # Verify CreateGateResponse has correct shape
        ...

    def test_all_response_models_list_fields_have_defaults():
        """CNTR-02: Meta-test — scan all response models for list fields missing defaults."""
        # Use model_fields to introspect all response models and verify
        # every list-typed field has a default_factory or default value of []
        from app.schemas.dashboard import DashboardResponse
        for name, field in DashboardResponse.model_fields.items():
            annotation = field.annotation
            # Check if field type is list-like
            origin = getattr(annotation, '__origin__', None)
            if origin is list:
                assert field.default is not None or field.default_factory is not None, \
                    f"Field {name} is list type but has no default — will serialize as null"
    ```

    Add similar checks for all response models that the frontend consumes (timeline, graph, etc.).
  </action>
  <verify>
    `cd /Users/vladcortex/co-founder && python -m pytest backend/tests/api/test_response_contracts.py -v` — all pass.
  </verify>
  <done>All list-typed response fields default to [] not null. Contract tests prove stable shapes. CNTR-01, CNTR-02 satisfied.</done>
</task>

<task type="auto">
  <name>Task 2: Beta gating enforcement tests</name>
  <files>backend/tests/api/test_beta_gating.py</files>
  <action>
    Write tests in `backend/tests/api/test_beta_gating.py` that verify:

    1. `test_require_feature_returns_403_when_disabled` — Create a test endpoint with `dependencies=[Depends(require_feature("test_feature"))]`. Override `get_feature_flags` to return empty dict. Hit the endpoint, assert 403 with "beta access" message.

    2. `test_require_feature_allows_when_enabled` — Same endpoint, but override `get_feature_flags` to return `{"test_feature": True}`. Assert 200.

    3. `test_require_feature_admin_bypass` — Override user_settings to have `is_admin=True`. Assert 200 even without flag explicitly set.

    4. `test_features_endpoint_returns_flags` — Hit `GET /api/features` with auth override. Assert response has `{"features": {...}}` shape.

    5. `test_features_endpoint_only_enabled_flags` — Override defaults to include both True and False flags. Assert response only contains True flags.

    Use the existing test patterns from the codebase (app.dependency_overrides, TestClient). The `require_feature` closure in `feature_flags.py` already handles the 403 — these tests prove it works.

    BETA-01: The tests prove non-MVP features return 403 unless beta enabled.
    BETA-02: The test proves `GET /api/features` exposes beta flags for UI labeling.
  </action>
  <verify>
    `cd /Users/vladcortex/co-founder && python -m pytest backend/tests/api/test_beta_gating.py -v` — all 5 tests pass.
  </verify>
  <done>Beta gating enforcement proven via tests. 403 returned for disabled flags, 200 for enabled. Admin bypass works. Features endpoint exposes flags. BETA-01, BETA-02 satisfied.</done>
</task>

</tasks>

<verification>
- All list-typed response fields verified to default to []
- No null serialization for list fields in any response model
- require_feature returns 403 for disabled flags
- Admin users bypass beta gates
- GET /api/features returns only enabled flags
</verification>

<success_criteria>
- `python -m pytest backend/tests/api/test_response_contracts.py backend/tests/api/test_beta_gating.py -v` — all pass
- No Pydantic schema has `Optional[list] = None` pattern
</success_criteria>

<output>
After completion, create `.planning/phases/10-export-deploy-readiness-e2e-testing/10-03-SUMMARY.md`
</output>
