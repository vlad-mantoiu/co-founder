---
phase: 10-export-deploy-readiness-e2e-testing
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - backend/app/api/routes/generation.py
  - backend/app/services/generation_service.py
  - backend/app/queue/state_machine.py
  - backend/tests/api/test_generation_routes.py
autonomous: true

must_haves:
  truths:
    - "POST /api/generation/start returns job_id with status queued"
    - "GET /api/generation/{job_id}/status returns current build stage and preview_url when ready"
    - "POST /api/generation/{job_id}/cancel stops the job and cleans up"
    - "Rerun for same project creates new version without corrupting prior build"
    - "Workspace contains expected files (README, env example, start script)"
  artifacts:
    - path: "backend/app/api/routes/generation.py"
      provides: "Generation API endpoints"
      exports: ["router"]
    - path: "backend/tests/api/test_generation_routes.py"
      provides: "Generation route tests"
      contains: "test_start_generation"
  key_links:
    - from: "backend/app/api/routes/generation.py"
      to: "backend/app/services/generation_service.py"
      via: "GenerationService dependency injection"
      pattern: "GenerationService"
    - from: "backend/app/api/routes/generation.py"
      to: "backend/app/queue/worker.py"
      via: "BackgroundTasks.add_task(process_next_job)"
      pattern: "background_tasks\\.add_task"
---

<objective>
Create Generation API routes for start, status, cancel, and workspace validation.

Purpose: GENR-01 (start returns job_id), GENR-03 (workspace files), GENR-04 (preview URL), GENR-05 (build versioning), GENR-07 (idempotent rerun). Wires the GenerationService from 10-01 to API endpoints.

Output: Generation routes, workspace validation, route tests.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-export-deploy-readiness-e2e-testing/10-RESEARCH.md
@.planning/phases/10-export-deploy-readiness-e2e-testing/10-01-SUMMARY.md

@backend/app/api/routes/jobs.py
@backend/app/services/generation_service.py
@backend/app/queue/worker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generation API routes</name>
  <files>backend/app/api/routes/generation.py, backend/app/main.py</files>
  <action>
    Create `backend/app/api/routes/generation.py` with the following endpoints:

    **POST /api/generation/start** (authenticated, subscription required):
    Request body: `{project_id: str, goal: str}`
    - Verify project ownership (select Project where id + clerk_user_id)
    - Check no pending gate is blocking (GateService.check_gate_blocking)
    - Create job via existing jobs flow (QueueManager.enqueue + state_machine.create_job)
    - Trigger worker via BackgroundTasks
    - Return: `{job_id, status: "queued", build_version: "build_v0_N" (predicted)}`

    **GET /api/generation/{job_id}/status** (authenticated):
    - Get job data from Redis state machine
    - Verify user owns the job
    - Return: `{job_id, status, stage_label, preview_url, build_version, error_message, debug_id}`
    - `stage_label` maps status to user-friendly labels per locked decision: "Scaffolding workspace...", "Writing code...", "Installing dependencies...", "Running checks...", "Build complete!", "Build failed"

    **POST /api/generation/{job_id}/cancel** (authenticated):
    - Per locked decision: "Build cancellation supported with confirmation dialog — stops agent and cleans up partial work"
    - Get job from state machine, verify ownership
    - If job is in non-terminal state (not READY, not FAILED): transition to FAILED with message "Cancelled by user"
    - If sandbox_id exists in job data, attempt to kill sandbox (best-effort, E2B API call)
    - Return: `{job_id, status: "cancelled", message: "Build cancelled"}`
    - If already terminal, return 409

    **POST /api/generation/{job_id}/preview-viewed** (authenticated):
    Per research: triggers Solidification Gate 2 after founder views preview. Creates gate with gate_type="solidification" via GateService (idempotent — 409 if already exists).
    - Return: `{gate_id, status: "gate_created"}` or `{status: "gate_already_created"}`

    Register router in main.py: `app.include_router(generation_router, prefix="/api/generation", tags=["generation"])`

    Pydantic schemas for request/response in the same file or a new `backend/app/schemas/generation.py`.
  </action>
  <verify>
    Check that `from app.api.routes.generation import router` imports without error.
    Verify routes registered by running: `cd /Users/vladcortex/co-founder/backend && python -c "from app.main import app; routes = [r.path for r in app.routes]; print([r for r in routes if 'generation' in r])"`
  </verify>
  <done>Generation routes (start, status, cancel, preview-viewed) created and registered. Per locked decisions: named stages, cancel support, Gate 2 trigger on preview view.</done>
</task>

<task type="auto">
  <name>Task 2: Generation route tests with workspace validation</name>
  <files>backend/tests/api/test_generation_routes.py</files>
  <action>
    Write tests using TestClient with dependency overrides (RunnerFake, FakeSandboxRuntime, FakeAsyncRedis):

    1. `test_start_generation_returns_job_id` — POST /api/generation/start with valid project_id + goal. Assert 201, response has job_id and status="queued". (GENR-01)

    2. `test_start_generation_blocked_by_gate` — Create a pending gate for the project. POST /api/generation/start. Assert 409 "Pending gate must be resolved first".

    3. `test_get_generation_status_stage_labels` — Create job in SCAFFOLD state. GET /api/generation/{job_id}/status. Assert stage_label = "Scaffolding workspace...". Repeat for CODE → "Writing code...", DEPS → "Installing dependencies...", CHECKS → "Running checks...", READY → "Build complete!".

    4. `test_cancel_generation_in_progress` — Create job in CODE state. POST /api/generation/{job_id}/cancel. Assert 200, status transitions to FAILED.

    5. `test_cancel_terminal_job_returns_409` — Create job in READY state. POST cancel. Assert 409.

    6. `test_preview_viewed_creates_gate_2` — Create READY job. POST /api/generation/{job_id}/preview-viewed. Assert gate created with gate_type="solidification".

    7. `test_preview_viewed_idempotent` — Call preview-viewed twice. Second call returns "gate_already_created".

    8. `test_rerun_creates_new_version` — Start generation, complete to READY with build_v0_1. Start generation again for same project. Assert new job created with predicted build_v0_2. (GENR-07)

    For workspace validation (GENR-03), add a unit test in GenerationService tests:
    9. `test_workspace_files_expected` — After RunnerFake.run(), verify working_files contains README.md, .env.example, and a start script entry. If RunnerFake doesn't return these, update RunnerFake's deterministic response to include them.
  </action>
  <verify>
    `cd /Users/vladcortex/co-founder && python -m pytest backend/tests/api/test_generation_routes.py -v` — all 9 tests pass.
  </verify>
  <done>Generation routes tested for start, status, cancel, preview-viewed, rerun. Workspace validation confirmed. GENR-01, GENR-03, GENR-04, GENR-05, GENR-07 covered.</done>
</task>

</tasks>

<verification>
- POST /api/generation/start returns job_id + status
- GET /api/generation/{job_id}/status returns user-friendly stage labels
- Cancel transitions job to FAILED
- Preview-viewed creates Solidification Gate 2 (idempotent)
- Rerun creates new version
- Workspace has README, .env.example, start script
</verification>

<success_criteria>
- `python -m pytest backend/tests/api/test_generation_routes.py -v` — all pass
- Routes registered in FastAPI app
</success_criteria>

<output>
After completion, create `.planning/phases/10-export-deploy-readiness-e2e-testing/10-04-SUMMARY.md`
</output>
