---
phase: 04-onboarding-idea-capture
plan: 04
type: tdd
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - backend/app/services/onboarding_service.py
  - backend/app/api/routes/onboarding.py
  - backend/app/api/routes/projects.py
  - backend/tests/api/test_project_creation_from_onboarding.py
  - frontend/src/hooks/useOnboarding.ts
  - frontend/src/components/onboarding/ThesisSnapshot.tsx
autonomous: true

must_haves:
  truths:
    - "Create project from completed onboarding returns project_id (PROJ-01)"
    - "Idea text persisted as project description and linked to onboarding session (PROJ-02)"
    - "Empty idea rejected with 400 validation error (PROJ-03)"
    - "User cannot create project from another user's onboarding session (PROJ-04)"
    - "Onboarding session can be resumed after page close and reopen (ONBD-03)"
    - "Welcome back screen shows choice to continue or start fresh"
    - "Project creation respects plan tier project limits"
  artifacts:
    - path: "backend/tests/api/test_project_creation_from_onboarding.py"
      provides: "Integration tests for project creation from onboarding"
      min_lines: 100
    - path: "backend/app/api/routes/onboarding.py"
      provides: "POST /api/onboarding/{session_id}/create-project endpoint"
  key_links:
    - from: "backend/app/api/routes/onboarding.py"
      to: "backend/app/db/models/project.py"
      via: "Project creation from onboarding session"
      pattern: "Project\\("
    - from: "backend/app/services/onboarding_service.py"
      to: "backend/app/db/models/onboarding_session.py"
      via: "session.project_id FK linking"
      pattern: "project_id"
    - from: "frontend/src/components/onboarding/ThesisSnapshot.tsx"
      to: "/api/onboarding/{session_id}/create-project"
      via: "fetch call on Create Project button click"
      pattern: "create-project"
---

<objective>
Project creation from onboarding, session resumption logic, and comprehensive integration tests

Purpose: Wire the final piece — converting a completed onboarding session into a Project. Also hardens resumption logic and ensures all PROJ-* requirements are met with tests. Links the frontend "Create Project" button to the backend.

Output: Project creation endpoint, resumption flow, 8+ integration tests covering PROJ-01 through PROJ-04
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-onboarding-idea-capture/04-01-SUMMARY.md
@.planning/phases/04-onboarding-idea-capture/04-02-SUMMARY.md
@backend/app/api/routes/projects.py
@backend/app/db/models/project.py
@backend/app/core/llm_config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project creation endpoint + service method + frontend wiring</name>
  <files>
    backend/app/services/onboarding_service.py
    backend/app/api/routes/onboarding.py
    frontend/src/hooks/useOnboarding.ts
    frontend/src/components/onboarding/ThesisSnapshot.tsx
  </files>
  <action>
    **Service method** — Add to `OnboardingService`:

    `async def create_project_from_session(self, user_id: str, session_id: str, tier_slug: str) -> tuple[OnboardingSession, Project]`:
    - Load session (with user isolation — 404 if not found or wrong user)
    - Verify session status is "completed" (400 if still in_progress or abandoned)
    - Verify session.project_id is None (400 if project already created — idempotent guard)
    - Check project limit for user's tier (same logic as existing projects.py):
      - Get user_settings, check override_max_projects or plan_tier.max_projects
      - Count active projects for user
      - If at limit, raise 403
    - Create Project:
      - name: First 50 chars of idea_text (truncated with "..." if longer)
      - description: Full idea_text
      - clerk_user_id: user_id
      - status: "active"
      - stage_number: 1 (Stage.THESIS_DEFINED from Phase 02 state machine — the onboarding completes the thesis stage)
    - Link: Set session.project_id = project.id
    - Commit both
    - Return (session, project)

    **API endpoint** — Add to onboarding routes:

    `POST /api/onboarding/{session_id}/create-project`:
    - Get user_settings for tier
    - Call create_project_from_session(user.user_id, session_id, tier_slug)
    - Return: `{"project_id": str(project.id), "project_name": project.name, "status": project.status}`

    **Frontend — useOnboarding hook update**:
    Add method `createProject()`:
    - POST /api/onboarding/{sessionId}/create-project
    - On success, redirect to `/dashboard` (or project page when available)
    - On error (403 project limit), show error message with upgrade CTA

    **Frontend — ThesisSnapshot update**:
    Wire the "Create Project" button:
    - On click, call `createProject()` from useOnboarding hook
    - Show loading state during creation
    - On success, show success message and redirect
    - On project limit error, show "Project limit reached. Upgrade to create more projects." with link to /pricing

    Also add the resumption "Welcome back" screen to the onboarding page:
    - On page mount, fetch GET /api/onboarding/sessions
    - If in_progress sessions exist, show choice screen:
      - Card for each active session showing: idea_text preview, question progress (e.g., "3 of 6 questions answered"), created_at relative time
      - "Continue" button per session → calls resumeSession(sessionId)
      - "Start Fresh" button → goes to idea_input phase
    - If no active sessions, go directly to idea_input phase
  </action>
  <verify>
    - `python -c "from app.services.onboarding_service import OnboardingService; print(hasattr(OnboardingService, 'create_project_from_session'))"` returns True
    - `cd frontend && npx tsc --noEmit` passes
    - `npm run build` succeeds
  </verify>
  <done>
    Project creation from onboarding session works end-to-end. Idea text persisted as project description. Tier project limits enforced. Frontend "Create Project" button wired with loading state and error handling. Resumption "Welcome back" screen shows active sessions with continue/start fresh options.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for project creation, resumption, and user isolation</name>
  <files>
    backend/tests/api/test_project_creation_from_onboarding.py
  </files>
  <action>
    Create comprehensive integration tests (`backend/tests/api/test_project_creation_from_onboarding.py`):

    Use the same test infrastructure as test_onboarding_api.py (api_client fixture, dependency overrides for require_auth and get_runner).

    Tests (RED then GREEN):

    1. `test_create_project_from_completed_session` — Start session, answer all questions, finalize, create project. Verify: returns project_id, project has idea_text as description, session.project_id is set (PROJ-01, PROJ-02)

    2. `test_create_project_rejects_incomplete_session` — Start session but don't finalize. Try create-project. Verify: returns 400 "Session not completed" (PROJ-01 guard)

    3. `test_create_project_rejects_duplicate` — Create project from session, try again. Verify: returns 400 "Project already created from this session" (idempotent guard)

    4. `test_create_project_respects_tier_limit` — Create max projects for bootstrapper tier (1), then try to create another from onboarding. Verify: returns 403 with upgrade message

    5. `test_create_project_from_other_users_session_returns_404` — User A completes onboarding. User B tries to create project from User A's session. Verify: returns 404 (PROJ-04)

    6. `test_resume_returns_current_state` — Start session, answer 3 questions. GET session. Verify: returns current_question_index=3, answers has 3 entries, all questions present (ONBD-03)

    7. `test_resume_after_abandon_shows_no_active` — Start session, abandon it. GET sessions list. Verify: no in_progress sessions (abandoned sessions excluded from resumption)

    8. `test_project_name_truncated_at_50_chars` — Start session with very long idea (100+ chars). Complete and create project. Verify: project.name is first 50 chars + "..."

    Helper functions:
    - `complete_onboarding_flow(client, user_override)` — Executes full flow: start -> answer all -> finalize. Returns session_id. Reuse across tests to reduce boilerplate.

    Follow existing test patterns from test_user_isolation.py for multi-user tests (create separate require_auth overrides per user).
  </action>
  <verify>
    - `cd backend && python -m pytest tests/api/test_project_creation_from_onboarding.py -v` — all 8 tests pass
    - `cd backend && python -m pytest tests/api/ -v` — all API tests pass (no regressions)
  </verify>
  <done>
    8 integration tests verify: project creation from onboarding (PROJ-01), idea text persistence (PROJ-02), incomplete session rejection, duplicate creation guard, tier project limits, user isolation (PROJ-04), session resumption state (ONBD-03), and name truncation. All tests pass. No regressions in existing tests.
  </done>
</task>

</tasks>

<verification>
1. POST /api/onboarding/{id}/create-project returns project_id (PROJ-01)
2. Project.description contains idea_text (PROJ-02)
3. Empty idea already rejected by StartOnboardingRequest validation in 04-02 (PROJ-03)
4. Other user's session returns 404 on create-project (PROJ-04)
5. Resumption works: GET session returns full state for continuation (ONBD-03)
6. "Welcome back" screen shows active sessions with continue/start fresh
7. All 8 new tests pass
8. All existing API tests still pass (no regressions)
9. Frontend builds without errors
</verification>

<success_criteria>
- Project creation from onboarding works end-to-end (PROJ-01, PROJ-02)
- User isolation enforced on project creation (PROJ-04)
- Session resumption returns correct state (ONBD-03)
- Welcome back screen functional
- Tier project limits respected
- 8+ new integration tests pass
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/04-onboarding-idea-capture/04-04-SUMMARY.md`
</output>
