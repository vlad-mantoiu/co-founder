---
phase: 01-runner-interface-test-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - backend/tests/conftest.py
  - backend/tests/api/__init__.py
  - backend/tests/api/conftest.py
  - backend/tests/orchestration/__init__.py
  - backend/tests/e2e/__init__.py
  - backend/Makefile
  - .github/workflows/test.yml
  - backend/app/api/routes/health.py
  - backend/app/db/models/user_settings.py
  - backend/app/api/routes/admin.py
  - backend/app/core/locking.py
  - backend/app/memory/episodic.py
  - backend/app/db/models/project.py
  - backend/app/db/models/usage_log.py
  - backend/app/integrations/github.py
  - backend/app/agent/nodes/architect.py
  - backend/app/api/routes/agent.py
autonomous: true

must_haves:
  truths:
    - "pytest from backend/ root discovers and runs all tests in tests/domain/, tests/api/, tests/orchestration/, tests/e2e/"
    - "make test runs full suite, make test-domain runs domain tests only"
    - "GitHub Actions CI runs tests with PostgreSQL and Redis service containers"
    - "Root conftest.py provides runner_fake fixture available to all test groups"
    - "/api/ready endpoint returns 503 when database or Redis is unreachable"
    - "No datetime.utcnow() calls remain in codebase (replaced with datetime.now(timezone.utc))"
    - "No bare except: pass blocks remain — all have logging"
    - "Full test suite completes in <30 seconds with RunnerFake"
  artifacts:
    - path: "backend/tests/conftest.py"
      provides: "Shared test fixtures (runner_fake factory, scenario fixtures)"
      contains: "runner_fake"
    - path: "backend/tests/api/conftest.py"
      provides: "API-specific fixtures (test client with RunnerFake)"
      contains: "api_client"
    - path: "backend/Makefile"
      provides: "Test convenience targets"
      contains: "test-domain"
    - path: ".github/workflows/test.yml"
      provides: "CI pipeline with PostgreSQL + Redis services"
      contains: "postgres"
  key_links:
    - from: "backend/tests/conftest.py"
      to: "backend/app/agent/runner_fake.py"
      via: "RunnerFake import for fixtures"
      pattern: "from app\\.agent\\.runner_fake import RunnerFake"
    - from: ".github/workflows/test.yml"
      to: "backend/Makefile"
      via: "CI runs make test"
      pattern: "make test"
---

<objective>
Set up the test harness infrastructure (directories, fixtures, Makefile, CI) and fix critical tech debt (datetime.utcnow(), health check, silent exceptions).

Purpose: Establish the complete testing foundation so every future phase can add tests to the right directory with shared fixtures already available. Fix tech debt that affects Runner reliability and production stability.

Output: Test infrastructure files, CI workflow, tech debt fixes across 7+ files
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-runner-interface-test-foundation/01-RESEARCH.md

# Prior plan outputs needed for fixture setup
@.planning/phases/01-runner-interface-test-foundation/01-01-SUMMARY.md
@.planning/phases/01-runner-interface-test-foundation/01-02-SUMMARY.md

# Existing files to modify
@backend/app/api/routes/health.py
@backend/pyproject.toml
@backend/tests/test_agent.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test harness infrastructure (directories, fixtures, Makefile, CI)</name>
  <files>backend/tests/conftest.py, backend/tests/api/__init__.py, backend/tests/api/conftest.py, backend/tests/orchestration/__init__.py, backend/tests/e2e/__init__.py, backend/Makefile, .github/workflows/test.yml</files>
  <action>
**1. Test directory structure:**

Create `__init__.py` files (empty) for: `backend/tests/api/`, `backend/tests/orchestration/`, `backend/tests/e2e/`. The `backend/tests/domain/__init__.py` was created in Plan 01-01.

Move existing `backend/tests/test_agent.py` to `backend/tests/domain/test_agent.py` (it tests state and graph structure — domain concern). Update imports if needed.

Move existing `backend/tests/test_auth.py` to `backend/tests/api/test_auth.py` (it tests auth routes — API concern). Update imports if needed.

**2. Root conftest.py** (`backend/tests/conftest.py`):

```python
"""Shared test fixtures for all test groups."""
import pytest
from app.agent.runner_fake import RunnerFake
from app.agent.state import create_initial_state

@pytest.fixture
def runner_fake():
    """Fresh RunnerFake with happy_path scenario (default)."""
    return RunnerFake(scenario="happy_path")

@pytest.fixture
def runner_fake_failing():
    """RunnerFake with llm_failure scenario."""
    return RunnerFake(scenario="llm_failure")

@pytest.fixture
def runner_fake_partial():
    """RunnerFake with partial_build scenario."""
    return RunnerFake(scenario="partial_build")

@pytest.fixture
def runner_fake_rate_limited():
    """RunnerFake with rate_limited scenario."""
    return RunnerFake(scenario="rate_limited")

@pytest.fixture
def sample_state():
    """Create a sample initial state for testing."""
    return create_initial_state(
        user_id="test-user-001",
        project_id="test-project-001",
        project_path="/tmp/test-project",
        goal="Build a simple inventory tracking app",
        session_id="test-session-001",
    )
```

**3. API conftest.py** (`backend/tests/api/conftest.py`):

```python
"""API-specific test fixtures."""
import pytest
from fastapi.testclient import TestClient

# Note: Full API client fixture will be expanded in later phases
# when dependency injection for Runner is added to FastAPI routes.
# For now, provide a basic test client.

@pytest.fixture
def api_client():
    """FastAPI test client."""
    from app.main import create_app
    app = create_app()
    with TestClient(app) as client:
        yield client
```

**4. Makefile** (`backend/Makefile`):

```makefile
.PHONY: test test-domain test-api test-orchestration test-e2e test-cov lint

test:
	python -m pytest tests/ -v

test-domain:
	python -m pytest tests/domain/ -v

test-api:
	python -m pytest tests/api/ -v

test-orchestration:
	python -m pytest tests/orchestration/ -v

test-e2e:
	python -m pytest tests/e2e/ -v

test-cov:
	python -m pytest tests/ -v --cov=app --cov-report=term-missing

lint:
	ruff check app/ tests/
	ruff format --check app/ tests/
```

**5. GitHub Actions CI** (`.github/workflows/test.yml`):

Create CI workflow with:
- Trigger: push and pull_request
- Services: PostgreSQL 16 (user: test_user, pass: test_pass, db: cofounder_test) and Redis 7-alpine, both with health checks
- Python 3.12 with pip cache
- Working directory: backend
- Install: `pip install -e ".[dev]"`
- Run: `make test`
- Environment vars: DATABASE_URL, REDIS_URL pointing to service containers

Use the exact service container config from the research (01-RESEARCH.md Pattern 4).
  </action>
  <verify>
Run `cd /Users/vladcortex/co-founder/backend && make test` — discovers and runs all tests in domain/ (and any in api/, orchestration/, e2e/).
Run `cd /Users/vladcortex/co-founder/backend && make test-domain` — runs only domain tests.
Verify `ls backend/tests/api/__init__.py backend/tests/orchestration/__init__.py backend/tests/e2e/__init__.py` — all exist.
Verify `.github/workflows/test.yml` exists and contains postgres service.
  </verify>
  <done>Test directories created. Root conftest.py provides 4 runner_fake fixtures. Makefile has 6 targets. CI workflow configured with PostgreSQL + Redis services. Existing tests moved to correct directories.</done>
</task>

<task type="auto">
  <name>Task 2: Fix critical tech debt (datetime.utcnow, health check, silent exceptions)</name>
  <files>backend/app/api/routes/health.py, backend/app/db/models/user_settings.py, backend/app/api/routes/admin.py, backend/app/core/locking.py, backend/app/memory/episodic.py, backend/app/db/models/project.py, backend/app/db/models/usage_log.py, backend/app/integrations/github.py, backend/app/agent/nodes/architect.py, backend/app/api/routes/agent.py</files>
  <action>
**1. Fix datetime.utcnow() (7 files):**

In ALL 7 files identified by research, replace `datetime.utcnow()` with `datetime.now(timezone.utc)`. Add `timezone` to the `datetime` import where missing.

Files and locations:
- `backend/app/db/models/user_settings.py` — default_factory for timestamps
- `backend/app/api/routes/admin.py` — line ~282
- `backend/app/core/locking.py` — lines ~58, ~256. ALSO fix the `.seconds` bug: replace `(datetime.utcnow() - start).seconds` with `(datetime.now(timezone.utc) - start).total_seconds()` (the lock timeout calculation bug from CONCERNS.md)
- `backend/app/memory/episodic.py` — lines ~48, ~137, ~178
- `backend/app/db/models/project.py` — timestamp defaults
- `backend/app/db/models/usage_log.py` — timestamp defaults
- `backend/app/integrations/github.py` — lines ~43, ~59, ~82

Pattern: `from datetime import datetime` becomes `from datetime import datetime, timezone`. Then `datetime.utcnow()` becomes `datetime.now(timezone.utc)`.

**2. Fix health check** (`backend/app/api/routes/health.py`):

Replace the TODO readiness check with actual dependency checks:

```python
import logging
from fastapi import APIRouter
from fastapi.responses import JSONResponse
from sqlalchemy import text

logger = logging.getLogger(__name__)

router = APIRouter()

@router.get("/health")
async def health_check():
    """Health check endpoint for load balancer."""
    return {"status": "healthy", "service": "cofounder-backend"}

@router.get("/ready")
async def readiness_check():
    """Readiness check - verifies dependencies are available."""
    checks = {"database": False, "redis": False}

    try:
        from app.db.base import get_session_factory
        async with get_session_factory()() as session:
            await session.execute(text("SELECT 1"))
        checks["database"] = True
    except Exception as e:
        logger.error(f"Database health check failed: {e}")

    try:
        from app.db.redis import get_redis
        redis = get_redis()
        await redis.ping()
        checks["redis"] = True
    except Exception as e:
        logger.error(f"Redis health check failed: {e}")

    all_healthy = all(checks.values())
    status_code = 200 if all_healthy else 503

    return JSONResponse(
        status_code=status_code,
        content={"status": "ready" if all_healthy else "degraded", "checks": checks},
    )
```

**3. Fix silent exception swallowing (add logging):**

In each file with `except Exception: pass`, add logging:

- `backend/app/agent/nodes/architect.py` line ~65-66: Replace `except Exception: pass` with:
  ```python
  except Exception as e:
      logger.warning(f"Semantic memory context retrieval failed (non-blocking): {e}")
  ```
  Add `import logging` and `logger = logging.getLogger(__name__)` at top.

- `backend/app/api/routes/agent.py` — find all `except Exception: pass` or `except Exception:` with `pass` and replace with `logger.warning(...)`. Preserve the non-blocking behavior (don't re-raise).

Do NOT fix Mem0 async issues (deferred to Phase 2 per research recommendation).
  </action>
  <verify>
Run `cd /Users/vladcortex/co-founder/backend && grep -r "utcnow" app/` — should return ZERO matches.
Run `cd /Users/vladcortex/co-founder/backend && grep -rn "except.*:$" app/ | grep -v "logger\|logging\|log\|raise\|return\|continue"` — verify no bare except:pass patterns remain in modified files.
Run `cd /Users/vladcortex/co-founder/backend && make test` — all tests still pass after tech debt fixes.
  </verify>
  <done>datetime.utcnow() replaced in all 7 files. Lock timeout bug fixed (total_seconds). Health check verifies DB + Redis (returns 503 when down). Silent exception blocks replaced with logging in architect.py and agent.py routes. All tests pass.</done>
</task>

</tasks>

<verification>
1. `cd backend && make test` — all tests pass across all directories
2. `cd backend && make test-domain` — runs domain tests only
3. `grep -r "utcnow" backend/app/` — zero matches
4. `cat .github/workflows/test.yml` — contains postgres and redis services
5. `cd backend && python -m pytest tests/ -v --durations=0` — total time <30 seconds
6. `grep -rn "except Exception:" backend/app/agent/nodes/architect.py` — shows logging, not pass
</verification>

<success_criteria>
- Test harness: 4 directories (domain, api, orchestration, e2e) with conftest fixtures
- Makefile: make test, make test-domain, make test-api, make test-orchestration, make test-e2e, make test-cov
- CI: GitHub Actions with PostgreSQL + Redis service containers
- Tech debt: Zero utcnow() calls, health check with real checks, logged exceptions
- Full suite completes in <30 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/01-runner-interface-test-foundation/01-03-SUMMARY.md`
</output>
