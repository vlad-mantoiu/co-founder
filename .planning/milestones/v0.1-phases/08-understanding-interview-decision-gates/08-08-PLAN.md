---
phase: 08-understanding-interview-decision-gates
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/gate_service.py
  - backend/app/services/understanding_service.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Choosing Narrow regenerates brief sections via Runner with narrowing context"
    - "Choosing Pivot regenerates brief sections via Runner with pivot context"
    - "get_brief enforces project ownership (any authenticated user cannot read arbitrary briefs)"
  artifacts:
    - path: "backend/app/services/gate_service.py"
      provides: "Real narrow/pivot brief regeneration via runner.generate_idea_brief"
      contains: "runner.generate_idea_brief"
    - path: "backend/app/services/understanding_service.py"
      provides: "Project ownership check in get_brief"
      contains: "Project.clerk_user_id"
  key_links:
    - from: "backend/app/services/gate_service.py _handle_narrow"
      to: "runner.generate_idea_brief"
      via: "Calls runner with existing brief + narrowing instruction as context"
      pattern: "self\\.runner\\.generate_idea_brief"
    - from: "backend/app/services/gate_service.py _handle_pivot"
      to: "runner.generate_idea_brief"
      via: "Calls runner with pivot description as new idea context"
      pattern: "self\\.runner\\.generate_idea_brief"
    - from: "backend/app/services/understanding_service.py get_brief"
      to: "Project table"
      via: "Join on project_id + clerk_user_id ownership check"
      pattern: "Project\\.clerk_user_id.*clerk_user_id"
---

<objective>
Replace narrow/pivot brief regeneration stubs with real Runner calls, and fix get_brief project ownership security gap.

Purpose: Gap 2 closure (SC8 partial) — _handle_narrow and _handle_pivot write placeholder notes instead of regenerating brief sections. Gap 3 closure (security) — get_brief has a TODO for project ownership check allowing any authenticated user to read any brief by project_id.

Output: gate_service.py calls runner.generate_idea_brief with action_text context to produce real updated brief content. understanding_service.py get_brief verifies clerk_user_id owns the project before returning the brief.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-understanding-interview-decision-gates/08-VERIFICATION.md
@.planning/phases/08-understanding-interview-decision-gates/08-02-SUMMARY.md
@backend/app/services/gate_service.py
@backend/app/services/understanding_service.py
@backend/app/agent/runner.py
@backend/app/agent/runner_fake.py
@backend/app/db/models/artifact.py
@backend/app/db/models/project.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace narrow/pivot stubs with real Runner brief regeneration</name>
  <files>backend/app/services/gate_service.py</files>
  <action>
Update `_handle_narrow` and `_handle_pivot` in `backend/app/services/gate_service.py` to call `self.runner.generate_idea_brief` instead of writing placeholder notes.

**For `_handle_narrow` (lines 206-238):**

Replace the stub logic with:
1. Load the existing brief artifact (already done — keep that query).
2. If no brief artifact exists, return early (already handled).
3. Load the OnboardingSession linked to the project to get `idea_text` (needed for runner call). Query: `select(OnboardingSession).where(OnboardingSession.project_id == project.id).order_by(OnboardingSession.created_at.desc()).limit(1)`. Add import for `OnboardingSession` from `app.db.models.onboarding_session`.
4. Also load the UnderstandingSession to get `questions` and `answers`. Query: `select(UnderstandingSession).where(UnderstandingSession.project_id == project.id).order_by(UnderstandingSession.created_at.desc()).limit(1)`. Add import for `UnderstandingSession` from `app.db.models.understanding_session`.
5. Build context for the runner call. The idea text should be the original idea PLUS the narrowing instruction appended:
   ```python
   narrowed_idea = f"{onboarding.idea_text}\n\n[NARROWING INSTRUCTION]: {action_text}"
   ```
6. Call `self.runner.generate_idea_brief(idea=narrowed_idea, questions=understanding.questions, answers=understanding.answers)` to regenerate the full brief with narrowing context.
7. Rotate versions: `brief_artifact.previous_content = brief_artifact.current_content`
8. Set new content: `brief_artifact.current_content = new_brief_content`
9. Increment version: `brief_artifact.version_number += 1`
10. Reset edit flag: `brief_artifact.has_user_edits = False`
11. Update timestamp: `brief_artifact.updated_at = datetime.now(timezone.utc)`
12. Keep the existing `gate.context["narrowing_instruction"] = action_text` line.
13. Commit.

If either OnboardingSession or UnderstandingSession is not found (edge case), fall back to generating with minimal context:
```python
narrowed_idea = f"{project.name}: {project.description}\n\n[NARROWING INSTRUCTION]: {action_text}"
new_brief_content = await self.runner.generate_idea_brief(idea=narrowed_idea, questions=[], answers={})
```

**For `_handle_pivot` (lines 240-274):**

Replace the stub logic with:
1. Load existing brief artifact (already done — keep that query).
2. If no brief artifact, return early.
3. Load OnboardingSession and UnderstandingSession same as narrow.
4. Build context — for pivot, the action_text IS the new direction, so:
   ```python
   pivoted_idea = f"[PIVOT — NEW DIRECTION]: {action_text}\n\nOriginal idea: {onboarding.idea_text if onboarding else project.name}"
   ```
5. Call `self.runner.generate_idea_brief(idea=pivoted_idea, questions=understanding.questions if understanding else [], answers=understanding.answers if understanding else {})`.
6. Rotate versions: `brief_artifact.previous_content = brief_artifact.current_content`
7. Set new content: `brief_artifact.current_content = new_brief_content`
8. Increment version: `brief_artifact.version_number += 1`
9. Reset edit flag: `brief_artifact.has_user_edits = False`
10. Update timestamp.
11. Keep existing `gate.context["pivot_description"] = action_text`.
12. Commit.

**Important:** Add `flag_modified` import from `sqlalchemy.orm.attributes` and call `flag_modified(brief_artifact, "current_content")` and `flag_modified(brief_artifact, "previous_content")` after setting JSONB values to ensure SQLAlchemy detects the change.

Do NOT modify RunnerFake — generate_idea_brief already handles any input and returns a complete brief. The narrowing/pivot context is passed via the `idea` parameter string.
  </action>
  <verify>
Run: `cd /Users/vladcortex/co-founder/backend && python -c "from app.services.gate_service import GateService; import inspect; src = inspect.getsource(GateService._handle_narrow); assert 'generate_idea_brief' in src; assert '_narrowing_note' not in src; print('Narrow stub replaced'); src2 = inspect.getsource(GateService._handle_pivot); assert 'generate_idea_brief' in src2; assert '_pivot_note' not in src2; print('Pivot stub replaced')"`

Expected: "Narrow stub replaced" and "Pivot stub replaced"
  </verify>
  <done>
_handle_narrow and _handle_pivot call self.runner.generate_idea_brief with action_text context. Brief sections (problem_statement, target_user, etc.) are fully regenerated — not just placeholder notes. Version rotation preserved. No _narrowing_note or _pivot_note stubs remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add project ownership check to get_brief</name>
  <files>backend/app/services/understanding_service.py</files>
  <action>
Fix the security gap in `get_brief` method (line 286-318) of `backend/app/services/understanding_service.py`.

Replace the TODO comment at line 312 with an actual project ownership check:

1. Add import for `Project` model: `from app.db.models.project import Project`
2. Before querying the Artifact, first verify the user owns the project:
   ```python
   # Verify project ownership
   project_result = await session.execute(
       select(Project).where(
           Project.id == UUID(project_id),
           Project.clerk_user_id == clerk_user_id,
       )
   )
   project = project_result.scalar_one_or_none()
   if not project:
       raise HTTPException(status_code=404, detail="Project not found")
   ```
3. Remove the `# TODO: Add project ownership check via join to ensure user owns project` comment.
4. The rest of the method stays the same — query Artifact by project_id and artifact_type.

Also check `edit_brief_section` method (line 320-376) — it has the same pattern of querying Artifact without verifying project ownership. Add the same ownership check there:
   ```python
   # Verify project ownership
   project_result = await session.execute(
       select(Project).where(
           Project.id == UUID(project_id),
           Project.clerk_user_id == clerk_user_id,
       )
   )
   project = project_result.scalar_one_or_none()
   if not project:
       raise HTTPException(status_code=404, detail="Project not found")
   ```

Note: The `edit_brief_section` method signature already takes `clerk_user_id` as a parameter, so no signature change needed.
  </action>
  <verify>
Run: `cd /Users/vladcortex/co-founder/backend && python -c "from app.services.understanding_service import UnderstandingService; import inspect; src = inspect.getsource(UnderstandingService.get_brief); assert 'TODO' not in src; assert 'clerk_user_id' in src; assert 'Project' in src; print('Ownership check added to get_brief'); src2 = inspect.getsource(UnderstandingService.edit_brief_section); assert 'Project.clerk_user_id' in src2 or 'clerk_user_id' in src2; print('edit_brief_section also secured')"`

Expected: "Ownership check added to get_brief" and "edit_brief_section also secured"
  </verify>
  <done>
get_brief verifies clerk_user_id owns the project before returning the brief. edit_brief_section has the same ownership check. Any authenticated user who does not own the project receives a 404. The TODO comment is removed.
  </done>
</task>

</tasks>

<verification>
1. `_handle_narrow` calls `self.runner.generate_idea_brief` — no `_narrowing_note` stub remains
2. `_handle_pivot` calls `self.runner.generate_idea_brief` — no `_pivot_note` stub remains
3. `get_brief` checks project ownership via `Project.clerk_user_id == clerk_user_id` before returning
4. `edit_brief_section` also checks project ownership
5. No TODO comments remain in get_brief
6. All imports resolve without error
</verification>

<success_criteria>
- Narrow decision regenerates full brief sections via Runner (not placeholder notes)
- Pivot decision regenerates full brief sections via Runner (not placeholder notes)
- get_brief returns 404 for projects not owned by the requesting user
- SC8 gap (narrow/pivot stub) is fully closed
- Security gap (brief access without ownership check) is closed
</success_criteria>

<output>
After completion, create `.planning/phases/08-understanding-interview-decision-gates/08-08-SUMMARY.md`
</output>
