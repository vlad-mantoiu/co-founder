---
phase: 29-build-log-streaming
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/app/services/log_streamer.py
  - backend/tests/services/test_log_streamer.py
autonomous: true
requirements:
  - BUILD-01

must_haves:
  truths:
    - "LogStreamer buffers raw E2B chunks and emits complete lines to Redis Stream"
    - "ANSI escape codes are stripped before storage"
    - "Known secret patterns (API keys, connection strings, AWS keys) are redacted to [REDACTED]"
    - "Lines longer than 2000 characters are truncated"
    - "flush() drains remaining buffered content after command completes"
    - "Redis Stream TTL is set to 24 hours on every write"
    - "write_event() emits synthetic system log lines for stage transitions"
  artifacts:
    - path: "backend/app/services/log_streamer.py"
      provides: "LogStreamer class with on_stdout, on_stderr, flush, write_event methods"
      min_lines: 80
    - path: "backend/tests/services/test_log_streamer.py"
      provides: "Unit tests for all LogStreamer behaviors"
      min_lines: 100
  key_links:
    - from: "backend/app/services/log_streamer.py"
      to: "redis.asyncio xadd"
      via: "self._redis.xadd()"
      pattern: "xadd.*stream_key"
---

<objective>
Implement the LogStreamer class that captures E2B stdout/stderr chunks, buffers them into complete lines, sanitizes (strip ANSI, redact secrets, truncate), and writes structured entries to a Redis Stream.

Purpose: LogStreamer is the core data pipeline for Phase 29 — everything downstream (SSE endpoint, REST pagination, S3 archival) reads from the Redis Stream it populates. Getting the buffering, sanitization, and structured format right is essential.

Output: `backend/app/services/log_streamer.py` with full implementation, `backend/tests/services/test_log_streamer.py` with comprehensive unit tests using fakeredis.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-build-log-streaming/29-RESEARCH.md
@backend/app/db/redis.py
</context>

<feature>
  <name>LogStreamer: Redis Stream Writer for Build Logs</name>
  <files>backend/app/services/log_streamer.py, backend/tests/services/test_log_streamer.py</files>
  <behavior>
    LogStreamer receives raw string chunks from E2B on_stdout/on_stderr callbacks and writes structured log entries to a Redis Stream.

    Key behaviors to test (RED phase — write these tests first):

    1. **Line buffering:** on_stdout("ins\ntalling dep\nendencies\n") should produce two Redis Stream entries for "installing dep" and "endencies", buffering "ins" from first call.
       - Input: on_stdout("hello\nworld\n") → 2 entries in stream with text "hello" and "world"
       - Input: on_stdout("par"), on_stdout("tial\n") → 1 entry with text "partial"
       - Input: on_stdout("no-newline") then flush() → 1 entry with text "no-newline"

    2. **Structured entries:** Each Redis Stream entry has fields: ts (ISO timestamp), source ("stdout" | "stderr" | "system"), text (sanitized line), phase (e.g. "install", "dev_server")

    3. **ANSI stripping:** Input with ANSI codes like "\x1b[32mSuccess\x1b[0m" → stored as "Success"

    4. **Secret redaction:**
       - "API_KEY=sk-abc123def456ghi789" → "API_KEY=[REDACTED]"
       - "sk-abcdefghijklmnopqrstuvwxyz" → "[REDACTED]"
       - "postgresql://user:pass@host/db" → "[REDACTED]"
       - "AKIA1234567890ABCDEF" → "[REDACTED]"

    5. **Line truncation:** Line with 3000 chars → stored as 2000 chars + "...[truncated]"

    6. **Blank line filtering:** Empty or whitespace-only lines are not written to stream

    7. **TTL enforcement:** After any write, stream key has 86400s TTL

    8. **Stream cap:** xadd called with maxlen=50000, approximate=True

    9. **write_event():** streamer.write_event("--- Installing dependencies ---") → entry with source="system"

    10. **Separate stderr buffering:** on_stdout and on_stderr maintain independent buffers

    11. **Error resilience:** If redis.xadd raises, log warning and continue (do not crash the build)
  </behavior>
  <implementation>
    Create `backend/app/services/log_streamer.py` based on the verified Pattern 1 from 29-RESEARCH.md:

    - `_ANSI_RE`: regex pattern `r'\x1b(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])'` to strip all ANSI/VT100 sequences
    - `_SECRET_PATTERNS`: list of compiled regex patterns for API keys (sk-...), Stripe keys (pk_live/test_...), connection strings (postgresql://, redis://, mongodb://), AWS access keys (AKIA...), and generic `key=value` patterns where value is 8+ chars
    - `MAX_LINE_LENGTH = 2000`
    - `STREAM_TTL_SECONDS = 86400`
    - Class `LogStreamer` with `__init__(redis, job_id, phase)`, async methods `on_stdout(chunk)`, `on_stderr(chunk)`, `flush()`, `write_event(text, source)`, private `_write(line, source)`
    - `_write()` strips ANSI, redacts secrets, truncates, skips blank lines, calls `xadd` with maxlen=50000 approximate=True, and `expire` with 86400s
    - Secret redaction: for patterns with `=`, preserve the key name and replace value with [REDACTED]. For standalone patterns (sk-..., AKIA..., connection strings), replace entire match.
    - Wrap xadd/expire in try/except — log warning on failure, never raise

    Tests use `fakeredis.aioredis.FakeRedis()` for a real Redis Stream implementation in-process. Verify entries with `xrange` after each test.
  </implementation>
</feature>

<verification>
```bash
cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_log_streamer.py -v
```
All tests pass. No new warnings or errors.
</verification>

<success_criteria>
- LogStreamer class exists at backend/app/services/log_streamer.py with on_stdout, on_stderr, flush, write_event
- All 11+ test cases pass covering buffering, ANSI stripping, secret redaction, truncation, TTL, error resilience
- fakeredis xrange confirms correct structured entries in Redis Stream
</success_criteria>

<output>
After completion, create `.planning/phases/29-build-log-streaming/29-01-SUMMARY.md`
</output>
