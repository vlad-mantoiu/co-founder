---
phase: 12-milestone-audit-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/useBuildProgress.ts
  - frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
  - frontend/src/app/(dashboard)/projects/[id]/strategy/page.tsx
  - frontend/src/app/(dashboard)/strategy/page.tsx
  - frontend/src/components/strategy-graph/StrategyGraphCanvas.tsx
  - frontend/src/components/strategy-graph/ForceGraphInner.tsx
  - frontend/src/app/(dashboard)/company/[projectId]/page.tsx
  - frontend/src/app/(dashboard)/company/[id]/deploy/page.tsx
  - frontend/src/app/(dashboard)/company/[id]/build/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Build progress page displays preview_url, build_version, error_message from generation status endpoint"
    - "Strategy graph renders edges/relationships between nodes (not isolated nodes)"
    - "Old /company/[id]/* routes redirect to /projects/[id]/* equivalents"
    - "Old /strategy and /timeline pages remain functional with project selectors (no redirect needed)"
    - "New /projects/[id]/build page shows connectionFailed reconnection banner"
  artifacts:
    - path: "frontend/src/hooks/useBuildProgress.ts"
      provides: "Correct polling endpoint and response interface"
      contains: "/api/generation/"
    - path: "frontend/src/app/(dashboard)/projects/[id]/strategy/page.tsx"
      provides: "Graph data mapping from edges to links"
      contains: "data.edges"
    - path: "frontend/src/app/(dashboard)/strategy/page.tsx"
      provides: "Graph data mapping from edges to links"
      contains: "data.edges"
    - path: "frontend/src/app/(dashboard)/company/[projectId]/page.tsx"
      provides: "Redirect to /projects/[projectId]"
      contains: "redirect"
    - path: "frontend/src/app/(dashboard)/company/[id]/deploy/page.tsx"
      provides: "Redirect to /projects/[id]/deploy"
      contains: "redirect"
    - path: "frontend/src/app/(dashboard)/company/[id]/build/page.tsx"
      provides: "Redirect to /projects/[id]/build"
      contains: "redirect"
  key_links:
    - from: "frontend/src/hooks/useBuildProgress.ts"
      to: "/api/generation/{job_id}/status"
      via: "apiFetch URL"
      pattern: "apiFetch.*api/generation.*status"
    - from: "frontend/src/app/(dashboard)/projects/[id]/strategy/page.tsx"
      to: "backend GraphResponse.edges"
      via: "data.edges mapping to links"
      pattern: "data\\.edges"
    - from: "frontend/src/components/strategy-graph/ForceGraphInner.tsx"
      to: "StrategyGraphCanvas"
      via: "GraphLink with source/target props"
      pattern: "source.*target"
---

<objective>
Fix 2 critical integration breaks (build polling endpoint, graph field mismatch) and convert old company routes to redirects.

Purpose: Close all remaining gaps from v0.1 milestone audit. Build progress page currently shows null for preview_url/build_version/error_message because the frontend polls a non-existent `/api/jobs/{id}` endpoint instead of `/api/generation/{id}/status`. Strategy graph renders isolated nodes because the frontend reads `data.links` but backend returns `edges`. Old `/company/[id]/*` routes need thin redirects to `/projects/[id]/*`.

Output: All 9 files updated — the build page correctly polls and displays generation data, strategy graph shows edges between nodes, and legacy routes redirect cleanly.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-milestone-audit-gap-closure/12-CONTEXT.md

Key backend reference files (read to confirm response shapes):
@backend/app/api/routes/generation.py — GenerationStatusResponse schema (lines 63-72)
@backend/app/schemas/strategy_graph.py — GraphResponse has `edges` (line 48), GraphEdge uses aliases "from"/"to" (lines 35-37)
@backend/app/api/routes/strategy_graph.py — Confirms JSON uses `from`/`to` aliases via GraphEdge

Existing redirect pattern to follow:
@frontend/src/app/(dashboard)/understanding/page.tsx — Phase 11 redirect pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix build polling endpoint and add connectionFailed banner</name>
  <files>
    frontend/src/hooks/useBuildProgress.ts
    frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
  </files>
  <action>
**useBuildProgress.ts** — Two changes:

1. **Fix endpoint URL (line 118):** Change `apiFetch(\`/api/jobs/${jobId}\`, getToken)` to `apiFetch(\`/api/generation/${jobId}/status\`, getToken)`.

2. **Update response interface (lines 72-80):** Rename `JobStatusResponse` to `GenerationStatusResponse` and update to match backend schema from `backend/app/api/routes/generation.py` lines 63-72:
```typescript
interface GenerationStatusResponse {
  job_id: string;
  status: string;
  stage_label: string;
  preview_url?: string | null;
  build_version?: string | null;
  error_message?: string | null;
  debug_id?: string | null;
}
```

3. **Update the label fallback (line 125):** Change `data.message` fallback to `data.stage_label` since the new response has `stage_label` instead of `message`:
```typescript
const label = STAGE_LABELS[status] ?? data.stage_label ?? status;
```

4. **Update the comment block above the interface (line 69-70):** Change "Job status response shape from GET /api/jobs/{job_id}" to "Generation status response from GET /api/generation/{job_id}/status".

**projects/[id]/build/page.tsx** — One change:

1. **Add connectionFailed banner:** The old `company/[id]/build/page.tsx` has a `connectionFailed` state and banner (lines 48-49 destructuring, lines 168-175 JSX) that the new page is missing. Add `connectionFailed` to the destructured hook return (line 48) and add the reconnection banner JSX inside the building state section, between the header div and the BuildProgressBar. Copy the exact banner markup from the old page (Loader2 import already available, add it to the import if missing):

Import `Loader2` from `lucide-react` (add to the existing import on line 17).

Add `connectionFailed` to the useBuildProgress destructuring.

Insert the banner JSX just before the BuildProgressBar in the building state:
```tsx
{/* Reconnecting banner — shown after 3 consecutive poll failures */}
{connectionFailed && (
  <div className="mb-4 px-4 py-3 bg-yellow-500/10 border border-yellow-500/20 rounded-xl flex items-center gap-2">
    <Loader2 className="h-4 w-4 text-yellow-400 animate-spin" />
    <span className="text-sm text-yellow-400">
      Reconnecting to build server...
    </span>
  </div>
)}
```
  </action>
  <verify>
Run `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit` — no TypeScript errors. Grep for `/api/jobs/` in frontend/src — should return zero results. Grep for `connectionFailed` in `projects/[id]/build/page.tsx` — should find the destructured variable and the banner JSX.
  </verify>
  <done>
useBuildProgress.ts polls `/api/generation/{jobId}/status` and uses `GenerationStatusResponse` interface matching backend schema. The new `/projects/[id]/build` page shows the connectionFailed reconnection banner. No references to the old `/api/jobs/` endpoint remain in frontend code.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix strategy graph edge field mismatch</name>
  <files>
    frontend/src/app/(dashboard)/projects/[id]/strategy/page.tsx
    frontend/src/app/(dashboard)/strategy/page.tsx
    frontend/src/components/strategy-graph/StrategyGraphCanvas.tsx
    frontend/src/components/strategy-graph/ForceGraphInner.tsx
  </files>
  <action>
The backend `GraphResponse` returns `edges` (not `links`), and each edge has `from`/`to` fields (Pydantic aliases). The frontend `ForceGraph2D` library expects `source`/`target`. The fix requires updating the data mapping layer in both strategy pages to translate API response shape into component shape.

**Important detail on backend serialization:** `GraphEdge` in `backend/app/schemas/strategy_graph.py` uses `Field(alias="from")` and `Field(alias="to")` with `populate_by_name=True`. FastAPI serializes using aliases by default, so the JSON response has `{ "from": "...", "to": "...", "relation": "..." }`.

**ForceGraphInner.tsx** — No changes needed. Its `GraphLink` interface already uses `source`/`target`/`relation` which is correct for the react-force-graph-2d library. The component is fine as-is.

**StrategyGraphCanvas.tsx** — No changes needed. Props use `GraphLink` with `source`/`target` which matches what ForceGraphInner expects.

**Both strategy pages** (projects/[id]/strategy/page.tsx AND strategy/page.tsx) — Apply identical changes to both files:

1. **Update the `GraphResponse` interface** at the top of the file. Change:
```typescript
interface GraphResponse {
  nodes: GraphNode[];
  links: GraphLink[];
}
```
to:
```typescript
interface ApiEdge {
  from: string;
  to: string;
  relation: string;
}

interface GraphResponse {
  nodes: GraphNode[];
  edges: ApiEdge[];
}
```
This separates the API shape (`ApiEdge` with `from`/`to`) from the component shape (`GraphLink` with `source`/`target`).

2. **Update the initial state** — Change `useState<GraphResponse>` to use a component-friendly shape. Replace:
```typescript
const [graphData, setGraphData] = useState<GraphResponse>({ nodes: [], links: [] });
```
with:
```typescript
const [graphData, setGraphData] = useState<{ nodes: GraphNode[]; links: GraphLink[] }>({ nodes: [], links: [] });
```

3. **Update the data mapping in fetchGraph** — Replace:
```typescript
setGraphData({ nodes: data.nodes ?? [], links: data.links ?? [] });
```
with:
```typescript
const mappedLinks: GraphLink[] = (data.edges ?? []).map((e: ApiEdge) => ({
  source: e.from,
  target: e.to,
  relation: e.relation,
}));
setGraphData({ nodes: data.nodes ?? [], links: mappedLinks });
```

Apply these exact same 3 changes to BOTH files. The flat `/strategy/page.tsx` also has a `projectId` guard and project selector — leave all of that unchanged. Only modify the GraphResponse interface, initial state type, and data mapping.
  </action>
  <verify>
Run `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit` — no TypeScript errors. Grep for `data.links` in strategy pages — should return zero results. Grep for `data.edges` in both strategy pages — should find the new mapping.
  </verify>
  <done>
Both strategy pages read `data.edges` from the API, map `from`/`to` to `source`/`target` for ForceGraph2D, and pass the correctly shaped `links` array to StrategyGraphCanvas. Graph renders edges/relationships between nodes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Convert old company routes to thin redirects</name>
  <files>
    frontend/src/app/(dashboard)/company/[projectId]/page.tsx
    frontend/src/app/(dashboard)/company/[id]/deploy/page.tsx
    frontend/src/app/(dashboard)/company/[id]/build/page.tsx
  </files>
  <action>
Convert all 3 old company route pages to thin redirect pages following the exact pattern from Phase 11's `/understanding` redirect (`frontend/src/app/(dashboard)/understanding/page.tsx`). These pages use route params (not searchParams) since the project ID is in the URL path segment.

**company/[projectId]/page.tsx** — Replace entire file content with:
```tsx
"use client";

import { useParams, useSearchParams } from "next/navigation";
import { redirect } from "next/navigation";

/**
 * Legacy /company/[projectId] redirect.
 * Redirects to /projects/[projectId] (new canonical dashboard route).
 */
export default function CompanyDashboardRedirect() {
  const params = useParams<{ projectId: string }>();
  const searchParams = useSearchParams();
  const qs = searchParams.toString();
  redirect(`/projects/${params.projectId}${qs ? `?${qs}` : ""}`);
}
```

**company/[id]/deploy/page.tsx** — Replace entire file content with:
```tsx
"use client";

import { useParams, useSearchParams } from "next/navigation";
import { redirect } from "next/navigation";

/**
 * Legacy /company/[id]/deploy redirect.
 * Redirects to /projects/[id]/deploy (new canonical deploy route).
 */
export default function CompanyDeployRedirect() {
  const params = useParams<{ id: string }>();
  const searchParams = useSearchParams();
  const qs = searchParams.toString();
  redirect(`/projects/${params.id}/deploy${qs ? `?${qs}` : ""}`);
}
```

**company/[id]/build/page.tsx** — Replace entire file content with:
```tsx
"use client";

import { useParams, useSearchParams } from "next/navigation";
import { redirect } from "next/navigation";

/**
 * Legacy /company/[id]/build redirect.
 * Redirects to /projects/[id]/build (new canonical build route).
 * Preserves ?job_id= query param for active build tracking.
 */
export default function CompanyBuildRedirect() {
  const params = useParams<{ id: string }>();
  const searchParams = useSearchParams();
  const qs = searchParams.toString();
  redirect(`/projects/${params.id}/build${qs ? `?${qs}` : ""}`);
}
```

Keep all 3 files in place (do not delete) — they serve as permanent redirects for bookmarks and old links. The pattern mirrors the Phase 11 understanding redirect: "use client", useParams for path segment, redirect() from next/navigation, preserve query params.
  </action>
  <verify>
Run `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit` — no TypeScript errors. Each old company page file should be under 20 lines (thin redirect). Grep for `redirect.*projects` in company directory — should match all 3 files.
  </verify>
  <done>
All 3 old company routes (/company/[projectId], /company/[id]/deploy, /company/[id]/build) are thin redirects to their /projects/[id]/* equivalents, preserving query params. Files kept in place for legacy bookmark support.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit` passes with zero errors
2. `grep -r "/api/jobs/" frontend/src/` returns no results (old endpoint fully removed)
3. `grep -r "data\.links" frontend/src/app/\(dashboard\)/*/strategy/ frontend/src/app/\(dashboard\)/strategy/` returns no results
4. `grep -r "data\.edges" frontend/src/app/\(dashboard\)/projects/\[id\]/strategy/ frontend/src/app/\(dashboard\)/strategy/` finds mappings in both files
5. `grep -r "connectionFailed" frontend/src/app/\(dashboard\)/projects/\[id\]/build/page.tsx` confirms banner added
6. All 3 company redirect files contain `redirect(\`/projects/`
</verification>

<success_criteria>
- Build progress hook polls GET /api/generation/{jobId}/status and correctly maps preview_url, build_version, error_message, debug_id from GenerationStatusResponse
- Strategy graph pages read data.edges from backend, map from/to to source/target, and pass correctly shaped links to ForceGraph2D — graph renders edges between nodes
- /projects/[id]/build page shows connectionFailed reconnection banner (feature parity with old company build page)
- /company/[projectId] redirects to /projects/[projectId]
- /company/[id]/deploy redirects to /projects/[id]/deploy
- /company/[id]/build redirects to /projects/[id]/build (preserving ?job_id= param)
- Old /strategy and /timeline flat pages remain functional with project selectors (untouched)
- TypeScript compilation succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-milestone-audit-gap-closure/12-01-SUMMARY.md`
</output>
