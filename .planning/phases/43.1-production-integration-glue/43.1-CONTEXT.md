# Phase 43.1: Production Integration Glue - Context

**Gathered:** 2026-02-27
**Status:** Ready for planning

<domain>
## Phase Boundary

Wire GenerationService to call run_agent_loop() with a fully-assembled context dict, inject all autonomous agent services (E2BToolDispatcher, BudgetService, CheckpointService, WakeDaemon) into production, connect S3SnapshotService for file durability, resolve model from subscription tier, and remove the 501 gate so the full build pipeline works end-to-end. This is pure integration glue — no new services, no new capabilities.

</domain>

<decisions>
## Implementation Decisions

### GenerationService rewrite scope
- Modify execute_build() inline with an if-branch when AUTONOMOUS_AGENT=True — do not create a separate method
- Context dict assembled inline inside execute_build() — no factory or builder pattern
- execute_build() queries Artifact records from DB for idea_brief and understanding_qna using project_id — self-contained, not passed from caller
- Old RunnerReal.run() path: Claude's discretion on whether to keep or remove based on whether it has remaining value

### 501 gate removal
- Remove the 501 gate entirely — no readiness check replacement
- Keep AUTONOMOUS_AGENT env var as a kill switch — when False, the build endpoint returns an appropriate error (Claude's discretion on HTTP status)
- WakeDaemon.run() launched as asyncio.create_task per-build alongside the TAOR loop — lifecycle tied to the build, not a global singleton

### S3 snapshot sync timing
- Batch S3 sync at GSD phase commit boundaries — not per write_file/edit_file call
- Forced S3 sync before agent sleeps (budget exhaustion) regardless of phase status — prevents work loss during long sleep periods
- Full tar of project each sync — no incremental diffing. S3SnapshotService already supports this. Project sizes are small (fresh builds)
- Rolling retention of last 5 snapshots per build — older snapshots deleted

### E2E test approach
- Mock E2B sandbox + mock Anthropic API — fast, deterministic, runs in CI without API keys
- Minimum E2E scenario: start build → TAOR loop runs 1 iteration → tool dispatches → cost tracked → checkpoint saved
- Skip sleep/wake cycle in E2E — already covered by Phase 43 unit tests
- Write separate unit-level integration tests for each service injection (BudgetService wired, CheckpointService wired, etc.) in addition to the single E2E test

### Claude's Discretion
- HTTP status code when AUTONOMOUS_AGENT=False (503 vs 501 vs other)
- Whether old RunnerReal.run() path is kept or removed
- Exact error message/response when agent is disabled
- Model resolution implementation details (resolve_llm_config call site)

</decisions>

<specifics>
## Specific Ideas

No specific requirements — open to standard approaches. The success criteria from the roadmap are highly prescriptive and define the exact wiring needed.

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope.

</deferred>

---

*Phase: 43.1-production-integration-glue*
*Context gathered: 2026-02-27*
