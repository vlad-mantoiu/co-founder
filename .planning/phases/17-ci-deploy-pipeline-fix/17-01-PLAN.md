---
phase: 17-ci-deploy-pipeline-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/domain/test_usage_counters.py
  - backend/tests/api/test_auth.py
  - backend/tests/domain/test_runner_protocol.py
  - backend/tests/domain/test_runner_fake.py
  - backend/tests/domain/test_artifact_models.py
  - backend/tests/test_agent.py
  - backend/tests/test_auth.py
autonomous: true
requirements: [PIPE-01]

must_haves:
  truths:
    - "All 8 test_usage_counters tests pass with far-future dates"
    - "All 4 test_auth tests pass with mock request parameter"
    - "test_runner_is_runtime_checkable passes with all 10 protocol methods"
    - "Both test_runner_fake tests pass with corrected key names"
    - "test_artifact_type_enum count test passes with 7 values"
    - "Deleted test_agent.py and test_auth.py are staged for removal"
    - "All pending git changes are committed for a clean working tree"
  artifacts:
    - path: "backend/tests/domain/test_usage_counters.py"
      provides: "Fixed usage counter tests with future dates"
      contains: "datetime(2030"
    - path: "backend/tests/api/test_auth.py"
      provides: "Fixed auth tests with mock request"
      contains: "mock_request"
    - path: "backend/tests/domain/test_runner_protocol.py"
      provides: "CompleteRunner with all 10 methods"
      contains: "generate_understanding_questions"
    - path: "backend/tests/domain/test_runner_fake.py"
      provides: "Corrected key name assertions"
      contains: "\"problem\""
    - path: "backend/tests/domain/test_artifact_models.py"
      provides: "Updated enum count assertion"
      contains: "== 7"
  key_links:
    - from: "backend/tests/domain/test_usage_counters.py"
      to: "backend/app/queue/usage.py"
      via: "UsageTracker API unchanged, only test dates fixed"
      pattern: "datetime\\(2030"
    - from: "backend/tests/api/test_auth.py"
      to: "backend/app/core/auth.py"
      via: "require_auth(request, credentials) signature"
      pattern: "require_auth\\(request=mock_request"
---

<objective>
Fix all 16 pre-existing test failures that block the CI gate, stage deleted duplicate test files, and commit all pending git changes for a clean working tree.

Purpose: The CI test gate (test.yml) runs on every push to main. These 16 failures prevent any automated deploy from triggering. Fixing them is the prerequisite for PIPE-02 (deploy.yml fix).

Output: All unit tests pass locally via `pytest tests/ --ignore=tests/e2e`, clean git working tree.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-ci-deploy-pipeline-fix/17-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix all 16 test failures</name>
  <files>
    backend/tests/domain/test_usage_counters.py
    backend/tests/api/test_auth.py
    backend/tests/domain/test_runner_protocol.py
    backend/tests/domain/test_runner_fake.py
    backend/tests/domain/test_artifact_models.py
  </files>
  <action>
Fix each of the 16 failing tests individually. Research file (17-RESEARCH.md) has exact root causes and code examples.

**Category 1 — test_usage_counters.py (8 failures):**
Replace all `now = datetime(2026, 2, 17, 10, 30, 0, tzinfo=timezone.utc)` with `now = datetime(2030, 6, 15, 10, 30, 0, tzinfo=timezone.utc)`. This prevents fakeredis from immediately expiring keys set via `expireat` with past timestamps. The UsageTracker API is correct — only test fixture dates need updating.

**Category 2 — test_auth.py (4 failures):**
`require_auth()` signature changed from `(credentials)` to `(request, credentials)` in v0.2. For each of the 4 `TestRequireAuth` tests:
1. Import `MagicMock, AsyncMock, patch` from unittest.mock
2. Create `mock_request = MagicMock(); mock_request.state = MagicMock()`
3. Add `patch("app.core.auth.provision_user_on_first_login", new_callable=AsyncMock)` to the existing `with` block
4. Change `require_auth(credentials=creds)` to `require_auth(request=mock_request, credentials=creds)`

**Category 3 — test_runner_protocol.py (1 failure):**
The `CompleteRunner` class only implements 5 of the now-10 Runner protocol methods. Add these 5 async stub methods to `CompleteRunner`:
- `generate_understanding_questions(self, context: dict) -> list[dict]` — return `[]`
- `generate_idea_brief(self, idea: str, questions: list[dict], answers: dict) -> dict` — return `{}`
- `check_question_relevance(self, idea: str, answered: list[dict], answers: dict, remaining: list[dict]) -> dict` — return `{"needs_regeneration": False, "preserve_indices": []}`
- `assess_section_confidence(self, section_key: str, content: str) -> str` — return `"moderate"`
- `generate_execution_options(self, brief: dict, feedback: str | None = None) -> dict` — return `{"options": [], "recommended_id": ""}`

**Category 4 — test_runner_fake.py (2 failures):**
- `test_happy_path_generate_brief_returns_brief`: Change expected keys from `["problem_statement", "target_user", "value_prop", "differentiation", "monetization_hypothesis", "assumptions", "risks", "smallest_viable_experiment"]` to `["problem", "target_user", "value_prop", "key_constraint", "differentiation", "monetization_hypothesis", "assumptions", "risks", "smallest_viable_experiment"]`
- `test_happy_path_generate_artifacts_returns_artifacts`: Change expected key `"product_brief"` to `"brief"` in the required_keys list

**Category 5 — test_artifact_models.py (1 failure):**
- Change `assert len(list(ArtifactType)) == 5` to `assert len(list(ArtifactType)) == 7`
- Update the test name/docstring from "five values" to "seven values" if present

Read each test file before editing to confirm exact code. Do NOT assume — verify the actual current code matches the research.
  </action>
  <verify>
Run `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/domain/test_usage_counters.py tests/api/test_auth.py tests/domain/test_runner_protocol.py tests/domain/test_runner_fake.py tests/domain/test_artifact_models.py -v` — all 16 previously failing tests must now pass.
  </verify>
  <done>All 16 tests pass. Zero failures in the 5 modified test files.</done>
</task>

<task type="auto">
  <name>Task 2: Stage deleted test files and commit all pending git changes</name>
  <files>
    backend/tests/test_agent.py
    backend/tests/test_auth.py
  </files>
  <action>
**Part A — Deleted test files:**
Per research: `backend/tests/test_agent.py` and `backend/tests/test_auth.py` are exact duplicates of files already in `tests/domain/test_agent.py` and `tests/api/test_auth.py` respectively. They were the original root-level files, later reorganized. Stage them for deletion with `git rm`.

**Part B — Git working tree cleanup:**
Stage ALL pending changes for a clean working tree. The git status shows:
- Modified files: `.planning/config.json`, phase 14 plan, backend source files (debugger.py, seed.py, onboarding_service.py), docker-compose.yml, frontend pages and components, marketing pages
- Deleted files: `backend/.planning/phases/10-.../10-10-SUMMARY.md`, the two test files (Part A)
- Untracked files: `.claude/`, phase 13 verification, brand guidelines, frontend new pages/components/hooks, infra stacks, tsconfig.tsbuildinfo

Commit grouping at Claude's discretion. Recommended grouping for readable git log:
1. `chore(cleanup): stage v0.2 development changes` — all modified/untracked files from v0.2 development that aren't test fixes
2. `test(17-01): fix 16 pre-existing test failures` — the 5 test file fixes from Task 1
3. `chore(tests): remove duplicate root-level test files` — the 2 deleted test files

Alternatively, a single cleanup commit for non-test changes is acceptable if it keeps things simpler. The test fixes MUST be in their own commit for traceability.

Run `ruff check` and `ruff format --check` on backend before committing to ensure the CI lint gate will also pass.
  </action>
  <verify>
1. `git status` shows clean working tree (no untracked, no modified, no deleted)
2. `cd /Users/vladcortex/co-founder/backend && ruff check app/ tests/ && ruff format --check app/ tests/` passes
3. `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/ --ignore=tests/e2e -v --tb=short` passes with zero failures
  </verify>
  <done>Git working tree is clean. All unit and integration tests pass (where Postgres is available). Ruff lint and format checks pass.</done>
</task>

</tasks>

<verification>
1. `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/ --ignore=tests/e2e -v --tb=short` — zero test failures
2. `cd /Users/vladcortex/co-founder/backend && ruff check app/ tests/ && ruff format --check app/ tests/` — no lint or format errors
3. `git status` — clean working tree
4. `git log --oneline -5` — commits visible for test fixes and cleanup
</verification>

<success_criteria>
- All 16 pre-existing test failures are fixed
- `pytest tests/ --ignore=tests/e2e` passes with zero failures locally
- Ruff lint and format pass
- Git working tree is clean (all changes committed)
- Deleted duplicate test files are staged and committed
</success_criteria>

<output>
After completion, create `.planning/phases/17-ci-deploy-pipeline-fix/17-01-SUMMARY.md`
</output>
