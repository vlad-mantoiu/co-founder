---
phase: 40-langgraph-removal-protocol-extension
plan: 04
type: execute
wave: 3
depends_on:
  - 40-01
  - 40-03
files_modified:
  - backend/app/core/config.py
  - backend/app/api/routes/generation.py
  - backend/tests/agent/test_feature_flag_routing.py
  - backend/tests/api/test_generation_routes.py
  - frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
autonomous: true
requirements:
  - MIGR-02

must_haves:
  truths:
    - "AUTONOMOUS_AGENT=false starts the server and routes build to RunnerReal behavior"
    - "AUTONOMOUS_AGENT=true routes build to AutonomousRunner which returns HTTP 501"
    - "The 501 response detail contains 'Your AI Co-Founder is being built'"
    - "Non-build routes (understanding, onboarding, execution plans) are unaffected by the flag"
    - "Frontend displays a non-blocking banner when build endpoint returns 501"
  artifacts:
    - path: "backend/app/core/config.py"
      provides: "AUTONOMOUS_AGENT boolean setting defaulting to True"
      contains: "autonomous_agent"
    - path: "backend/app/api/routes/generation.py"
      provides: "Feature flag routing in _build_runner()"
      contains: "_build_runner"
    - path: "backend/tests/agent/test_feature_flag_routing.py"
      provides: "Tests for feature flag routing to correct runner"
      min_lines: 30
  key_links:
    - from: "backend/app/api/routes/generation.py"
      to: "backend/app/core/config.py"
      via: "get_settings().autonomous_agent"
      pattern: "autonomous_agent"
    - from: "backend/app/api/routes/generation.py"
      to: "backend/app/agent/runner_autonomous.py"
      via: "conditional import when flag is True"
      pattern: "AutonomousRunner"
    - from: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      to: "POST /api/generation/start"
      via: "fetch call handling 501 response"
      pattern: "501|coming.soon|being.built"
---

<objective>
Wire the AUTONOMOUS_AGENT feature flag to route build/generation requests between RunnerReal (flag=false) and AutonomousRunner (flag=true, returns 501), and add a non-blocking "coming soon" banner in the frontend build page when the 501 is returned.

Purpose: Enable safe incremental migration — the flag defaults to true (product not live), meaning the build endpoint returns 501 with a clear message while the autonomous agent is being built in Phases 41+. Setting the flag to false falls back to the rewritten RunnerReal for testing.

Output: Working feature flag, 501 response for autonomous mode, frontend banner, all with tests.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-langgraph-removal-protocol-extension/40-RESEARCH.md
@.planning/phases/40-langgraph-removal-protocol-extension/40-01-SUMMARY.md
@.planning/phases/40-langgraph-removal-protocol-extension/40-03-SUMMARY.md

@backend/app/core/config.py
@backend/app/api/routes/generation.py
@frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AUTONOMOUS_AGENT setting and wire feature flag routing in generation route</name>
  <files>
    backend/app/core/config.py
    backend/app/api/routes/generation.py
    backend/tests/agent/test_feature_flag_routing.py
    backend/tests/api/test_generation_routes.py
  </files>
  <action>
**Step 1: Add setting to config.py.**
Read `backend/app/core/config.py` and add to the Settings class:
```python
# Feature flag for autonomous agent migration (Phase 40 — v0.7)
autonomous_agent: bool = True  # env: AUTONOMOUS_AGENT
```
Place it near other feature flags or at the end of the Settings fields. The `pydantic-settings` BaseSettings class will automatically read the `AUTONOMOUS_AGENT` env var.

**Step 2: Wire the feature flag in generation.py.**
Read `backend/app/api/routes/generation.py` and find the existing `_build_runner()` function (or equivalent runner factory). Modify it:

```python
def _build_runner(request: Request) -> Runner:
    """Return AutonomousRunner or RunnerReal based on AUTONOMOUS_AGENT flag.

    Scope: build/generation endpoints only.
    Understanding, onboarding, execution plans use RunnerReal directly.
    """
    settings = get_settings()
    if settings.autonomous_agent:
        from app.agent.runner_autonomous import AutonomousRunner
        return AutonomousRunner()
    else:
        from app.agent.runner_real import RunnerReal
        return RunnerReal()
```

**Step 3: Handle 501 in the generation start endpoint.**
Find the POST endpoint that starts a build (likely `/start` or similar). Add a check:
- If `settings.autonomous_agent` is True, return HTTP 501 immediately (before enqueueing any job)
- Use `raise HTTPException(status_code=501, detail="Autonomous agent coming soon. Your AI Co-Founder is being built.")`
- This is cleaner than letting the background task fail — gives instant feedback per research recommendation

Alternatively, detect AutonomousRunner type and return 501:
```python
runner = _build_runner(request)
if isinstance(runner, AutonomousRunner):
    raise HTTPException(
        status_code=501,
        detail="Autonomous agent coming soon. Your AI Co-Founder is being built.",
    )
```

**Important:** Do NOT modify `_build_runner` in other route files (`understanding.py`, `onboarding.py`, `execution_plans.py`). The flag only scopes to generation.py per user decision.

**Step 4: Create test_feature_flag_routing.py (Wave 0 gap).**
Create `backend/tests/agent/test_feature_flag_routing.py`:

```python
"""Tests for AUTONOMOUS_AGENT feature flag routing."""
import pytest
from unittest.mock import patch

@pytest.mark.unit
class TestFeatureFlagRouting:
    """MIGR-02: Feature flag routes to correct runner."""

    def test_flag_true_routes_to_autonomous_runner(self):
        """AUTONOMOUS_AGENT=true returns AutonomousRunner."""
        with patch("app.core.config.get_settings") as mock_settings:
            mock_settings.return_value.autonomous_agent = True
            from app.api.routes.generation import _build_runner
            # _build_runner may need a mock request — adapt to actual signature
            runner = _build_runner(mock_request)
            from app.agent.runner_autonomous import AutonomousRunner
            assert isinstance(runner, AutonomousRunner)

    def test_flag_false_routes_to_runner_real(self):
        """AUTONOMOUS_AGENT=false returns RunnerReal."""
        with patch("app.core.config.get_settings") as mock_settings:
            mock_settings.return_value.autonomous_agent = False
            from app.api.routes.generation import _build_runner
            runner = _build_runner(mock_request)
            from app.agent.runner_real import RunnerReal
            assert isinstance(runner, RunnerReal)

    def test_default_flag_value_is_true(self):
        """Default AUTONOMOUS_AGENT is True (product not live)."""
        from app.core.config import Settings
        settings = Settings()
        assert settings.autonomous_agent is True
```

Adapt the above to match the actual `_build_runner` function signature (it may take `request: Request` or nothing). Use proper mocking for FastAPI request if needed.

**Step 5: Extend test_generation_routes.py.**
Read `backend/tests/api/test_generation_routes.py` and add:
- `test_start_generation_returns_501_when_autonomous_agent_true` — POST to the start endpoint with AUTONOMOUS_AGENT=true, assert 501 status code and "being built" in response detail
- Use the existing test client fixture and override `get_settings` to set `autonomous_agent=True`

**Step 6: Run tests:**
```bash
cd backend && python -m pytest tests/agent/test_feature_flag_routing.py tests/api/test_generation_routes.py -x -v
```

Then full suite:
```bash
cd backend && python -m pytest tests/ -m unit -x -q
```

Commit: `feat(40-04): wire AUTONOMOUS_AGENT feature flag with 501 response for autonomous mode`
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -m pytest tests/agent/test_feature_flag_routing.py tests/api/test_generation_routes.py -x -v && python -m pytest tests/ -m unit -x -q 2>&1 | tail -10</automated>
    <manual>Feature flag tests pass, 501 test passes, full unit suite green</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>AUTONOMOUS_AGENT setting exists in config.py defaulting to True, generation.py routes to AutonomousRunner when true, 501 returned from start endpoint, tests verify both flag states</done>
</task>

<task type="auto">
  <name>Task 2: Add frontend "coming soon" banner for 501 response on build page</name>
  <files>
    frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
  </files>
  <action>
**Step 1: Read the build page.**
Read `frontend/src/app/(dashboard)/projects/[id]/build/page.tsx` to understand:
- How the build start is triggered (likely a fetch/POST to `/api/generation/start`)
- How errors are currently handled (likely `setError()` or similar state)
- The PreBuildView component structure
- Where to add the banner

**Step 2: Add 501 detection and banner.**
Find the error handling code after the build start fetch call. Add specific handling for 501:

```typescript
// After the fetch call to start generation
if (response.status === 501) {
  // Autonomous agent not yet ready — show non-blocking banner
  setComingSoon(true);
  return;
}
```

Add state:
```typescript
const [comingSoon, setComingSoon] = useState(false);
```

Add banner component in the build area (PreBuildView or wherever the build start button is):
```tsx
{comingSoon && (
  <div className="rounded-lg border border-blue-200 bg-blue-50 p-4 text-center dark:border-blue-800 dark:bg-blue-950">
    <p className="text-sm font-medium text-blue-800 dark:text-blue-200">
      Your AI Co-Founder is being built
    </p>
    <p className="mt-1 text-xs text-blue-600 dark:text-blue-400">
      We&apos;re upgrading your co-founder with autonomous capabilities. This feature will be available soon.
    </p>
  </div>
)}
```

**Design constraints per user decision:**
- Non-blocking — other navigation remains functional
- In the build/agent area only (not a global alert)
- Banner copy: "Your AI Co-Founder is being built"
- Temporary — will be removed once AutonomousRunner ships (Phase 41+)

**Step 3: Verify the banner renders.**
The banner should appear when:
1. User clicks "Start Build" (or equivalent)
2. Backend returns 501
3. Banner shows instead of error state

Other page functionality (navigation, project details, etc.) must remain unaffected.

Commit: `feat(40-04): add frontend 501 'coming soon' banner on build page`
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | tail -5</automated>
    <manual>TypeScript compiles without errors; banner appears in build page component when 501 is received</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Build page handles 501 status with a non-blocking blue banner reading "Your AI Co-Founder is being built"; other navigation and features unaffected; TypeScript compiles cleanly</done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest tests/agent/test_feature_flag_routing.py -x -v` — all flag routing tests pass
2. `cd backend && python -m pytest tests/api/test_generation_routes.py -x -v` — 501 response test passes
3. `cd backend && python -c "from app.core.config import Settings; s = Settings(); assert s.autonomous_agent is True; print('default True OK')"` — default is True
4. `cd frontend && npx tsc --noEmit` — TypeScript compiles cleanly
5. `cd backend && python -m pytest tests/ -m unit -x -q` — full unit suite green
6. `cd backend && AUTONOMOUS_AGENT=false python -c "from app.core.config import Settings; s = Settings(); assert s.autonomous_agent is False; print('override False OK')"` — env var override works
</verification>

<success_criteria>
- AUTONOMOUS_AGENT=true (default) returns 501 from build start endpoint
- AUTONOMOUS_AGENT=false routes to RunnerReal for build operations
- Understanding, onboarding, execution plan routes are completely unaffected by the flag
- Frontend shows "Your AI Co-Founder is being built" banner on 501 — non-blocking
- Full test suite green
</success_criteria>

<output>
After completion, create `.planning/phases/40-langgraph-removal-protocol-extension/40-04-SUMMARY.md`
</output>
