---
phase: 40-langgraph-removal-protocol-extension
plan: 03
type: execute
wave: 2
depends_on:
  - 40-01
files_modified:
  - backend/app/agent/graph.py
  - backend/app/agent/nodes/__init__.py
  - backend/app/agent/nodes/architect.py
  - backend/app/agent/nodes/coder.py
  - backend/app/agent/nodes/debugger.py
  - backend/app/agent/nodes/executor.py
  - backend/app/agent/nodes/reviewer.py
  - backend/app/agent/nodes/git_manager.py
  - backend/app/agent/runner_real.py
  - backend/app/agent/llm_config.py
  - backend/app/agent/llm_helpers.py
  - backend/app/main.py
  - backend/pyproject.toml
  - backend/tests/domain/test_agent.py
  - backend/tests/agent/test_runner_real.py
  - backend/tests/api/test_artifact_export.py
  - backend/tests/agent/test_langgraph_removal.py
autonomous: true
requirements:
  - MIGR-01

must_haves:
  truths:
    - "import langgraph raises ImportError anywhere in the codebase"
    - "import langchain raises ImportError anywhere in the codebase"
    - "The full pytest unit suite passes after LangGraph removal"
    - "RunnerReal uses direct anthropic SDK (no LangChain message wrappers)"
    - "llm_config.py uses anthropic.AsyncAnthropic (no ChatAnthropic)"
    - "main.py has no LangGraph checkpointer initialization or teardown"
    - "pyproject.toml has no langgraph or langchain dependencies"
  artifacts:
    - path: "backend/pyproject.toml"
      provides: "Clean dependency list without LangGraph/LangChain"
      contains: "anthropic"
    - path: "backend/app/agent/runner_real.py"
      provides: "RunnerReal using direct Anthropic SDK"
      contains: "anthropic"
    - path: "backend/app/agent/llm_config.py"
      provides: "LLM config using anthropic.AsyncAnthropic"
      contains: "AsyncAnthropic"
    - path: "backend/tests/agent/test_langgraph_removal.py"
      provides: "Verification tests that langgraph/langchain are truly gone"
      min_lines: 15
  key_links:
    - from: "backend/app/agent/runner_real.py"
      to: "backend/app/agent/llm_config.py"
      via: "create_tracked_llm or direct AsyncAnthropic"
      pattern: "anthropic|create_tracked_llm"
    - from: "backend/app/agent/llm_config.py"
      to: "anthropic"
      via: "AsyncAnthropic client creation"
      pattern: "AsyncAnthropic"
---

<objective>
Atomically remove all LangGraph and LangChain dependencies from the codebase: delete the 6 node files + graph.py, rewrite llm_config.py and RunnerReal to use direct Anthropic SDK, remove checkpointer from main.py, strip dependencies from pyproject.toml, and fix all broken tests.

Purpose: Clean the codebase of the old multi-agent pipeline so the AutonomousRunner (Phase 41) has no import conflicts, shared namespace confusion, or dead LangGraph dependencies.

Output: Zero LangGraph/LangChain references in code or dependencies; RunnerReal is a minimal direct-Anthropic pass-through; all tests pass.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-langgraph-removal-protocol-extension/40-RESEARCH.md
@.planning/phases/40-langgraph-removal-protocol-extension/40-01-SUMMARY.md

@backend/app/agent/runner_real.py
@backend/app/agent/llm_config.py
@backend/app/agent/llm_helpers.py
@backend/app/agent/graph.py
@backend/app/main.py
@backend/pyproject.toml
@backend/tests/domain/test_agent.py
@backend/tests/agent/test_runner_real.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete LangGraph files, rewrite llm_config.py and RunnerReal, clean main.py and pyproject.toml</name>
  <files>
    backend/app/agent/graph.py
    backend/app/agent/nodes/__init__.py
    backend/app/agent/nodes/architect.py
    backend/app/agent/nodes/coder.py
    backend/app/agent/nodes/debugger.py
    backend/app/agent/nodes/executor.py
    backend/app/agent/nodes/reviewer.py
    backend/app/agent/nodes/git_manager.py
    backend/app/agent/runner_real.py
    backend/app/agent/llm_config.py
    backend/app/agent/llm_helpers.py
    backend/app/main.py
    backend/pyproject.toml
  </files>
  <action>
**CRITICAL ORDER: Fix tests that import LangGraph BEFORE deleting files (Pitfall 3). But since test fixes are in Task 2, we must do the deletion and rewrites atomically. Read all affected files first, then execute.**

**Step 1: Read all files to understand current structure.** Read:
- `backend/app/agent/graph.py` — understand what it exports
- `backend/app/agent/runner_real.py` — understand all LangChain/LangGraph imports and method implementations
- `backend/app/agent/llm_config.py` — understand ChatAnthropic usage and callback handlers
- `backend/app/agent/llm_helpers.py` — understand `_invoke_with_retry` and other helpers
- `backend/app/main.py` — find checkpointer initialization block (around lines 92-127 per research)
- `backend/pyproject.toml` — find langgraph/langchain dependency lines
- All 6 node files — confirm they only have LangGraph-specific code

**Step 2: Delete the 7 LangGraph-specific files:**
```bash
rm backend/app/agent/graph.py
rm backend/app/agent/nodes/__init__.py
rm backend/app/agent/nodes/architect.py
rm backend/app/agent/nodes/coder.py
rm backend/app/agent/nodes/debugger.py
rm backend/app/agent/nodes/executor.py
rm backend/app/agent/nodes/reviewer.py
rm backend/app/agent/nodes/git_manager.py
rmdir backend/app/agent/nodes
```

**Step 3: Rewrite `llm_config.py`:**
- Remove `from langchain_anthropic import ChatAnthropic`
- Remove `from langchain_core.callbacks import AsyncCallbackHandler`
- Remove `from langchain_core.outputs import LLMResult`
- Replace `create_tracked_llm()` with a function that returns an `anthropic.AsyncAnthropic` client (or a thin wrapper that tracks usage via the response's `usage` object)
- Keep the same function name `create_tracked_llm()` for backward compatibility with RunnerReal, but change return type from ChatAnthropic to AsyncAnthropic client
- Usage tracking: after each `messages.create()` call, read `response.usage.input_tokens` and `response.usage.output_tokens` — calculate cost from `_calculate_cost()` (keep existing cost logic, just change the input source from LangChain callback to Anthropic response)

**Step 4: Rewrite `llm_helpers.py`:**
- The `_invoke_with_retry` function currently wraps `llm.ainvoke()` (LangChain-specific). Rewrite to wrap `client.messages.create()` instead
- Keep the tenacity retry decorator and OverloadedError handling
- `_strip_json_fences` and `_parse_json_response` are pure string utilities — leave them unchanged

**Step 5: Rewrite `runner_real.py`:**
- Remove ALL imports from `langchain_core` and `langgraph`
- Remove `from app.agent.graph import create_cofounder_graph`
- Remove imports of individual node modules
- Replace `SystemMessage(content=...)` / `HumanMessage(content=...)` with direct Anthropic message format: `{"role": "user", "content": "..."}`
- The `run()` method becomes a minimal pass-through: make a single Claude API call with the idea brief context and return a CoFounderState with a basic plan response. This is throwaway code (per user decision: "delete RunnerReal entirely" once AutonomousRunner is stable)
- Add `run_agent_loop()` to RunnerReal that raises `NotImplementedError` (or delegates — it's only called when AUTONOMOUS_AGENT=true which routes to AutonomousRunner, not RunnerReal)
- Keep all other protocol methods (generate_questions, generate_brief, etc.) working — they still serve onboarding/understanding routes. Rewrite them to use direct Anthropic SDK via the rewritten `create_tracked_llm()` or direct `client.messages.create()`
- **IMPORTANT:** Do NOT break `generate_questions()`, `generate_brief()`, `generate_strategy_graph()`, `generate_execution_options()`, `generate_app_architecture()` — these are used by non-build routes that must continue working

**Step 6: Clean `main.py`:**
- Remove the entire LangGraph checkpointer initialization block (AsyncPostgresSaver or MemorySaver)
- Remove the corresponding teardown block in the lifespan function
- Remove `app.state.checkpointer` assignments
- Remove any imports of `langgraph` modules
- Keep all other lifespan logic (database, Redis, Neo4j, etc.) intact

**Step 7: Clean `pyproject.toml`:**
- Remove these 4 dependencies:
  - `langgraph>=0.2.0`
  - `langgraph-checkpoint-postgres>=2.0.0`
  - `langchain-anthropic>=0.3.0`
  - `langchain-core>=0.3.0`
- Keep `anthropic>=0.40.0` (used everywhere)

**Step 8: Grep to verify no remaining references:**
```bash
cd backend && grep -rn "langgraph\|langchain\|ChatAnthropic\|from langchain" app/ --include="*.py" | grep -v "__pycache__" | grep -v "NOT LangChain"
```
Should return empty. Any hits must be fixed.

Commit: `refactor(40-03): remove all LangGraph/LangChain dependencies, rewrite RunnerReal and llm_config for direct Anthropic SDK`
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && grep -rn "langgraph\|langchain\|ChatAnthropic" app/ --include="*.py" | grep -v "__pycache__" | grep -v "NOT LangChain" | grep -v "LangGraph" | wc -l</automated>
    <manual>Grep count should be 0 — no LangGraph/LangChain references remain in app/ Python code</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>7 LangGraph files deleted, llm_config.py rewritten to AsyncAnthropic, RunnerReal rewritten as minimal pass-through, main.py checkpointer removed, 4 dependencies removed from pyproject.toml, zero LangGraph/LangChain imports remain</done>
</task>

<task type="auto">
  <name>Task 2: Fix all broken tests and create LangGraph removal verification tests</name>
  <files>
    backend/tests/domain/test_agent.py
    backend/tests/agent/test_runner_real.py
    backend/tests/api/test_artifact_export.py
    backend/tests/agent/test_langgraph_removal.py
  </files>
  <action>
**Step 1: Fix test_agent.py:**
- Read `tests/domain/test_agent.py`
- Delete the `from app.agent.graph import create_cofounder_graph` import
- Delete `TestCoFounderGraph` class entirely (tests LangGraph graph structure — no longer exists)
- Delete `test_graph_entry_point` function if it exists
- KEEP `TestCoFounderState` class and any state-related tests (CoFounderState TypedDict is preserved)
- Verify the file still imports cleanly

**Step 2: Fix test_runner_real.py:**
- Read `tests/agent/test_runner_real.py`
- Remove all `from langchain_core.messages import SystemMessage, HumanMessage` imports
- Rewrite assertions that check for SystemMessage/HumanMessage content — now check for Anthropic message dict format: `{"role": "user", "content": "..."}` or `system="..."` parameter
- Update mocks: instead of mocking `create_tracked_llm` returning a ChatAnthropic object with `.ainvoke()`, mock `anthropic.AsyncAnthropic` with `.messages.create()` returning a mock response with `.content[0].text` and `.usage`
- Ensure all test scenarios (happy path, error handling, each RunnerReal method) are adapted
- Any test that specifically tests the 6-node graph pipeline execution should be deleted (that pipeline no longer exists)

**Step 3: Fix test_artifact_export.py:**
- Read `tests/api/test_artifact_export.py`
- Line 228 (per research) mentions "LangGraph agents" in fixture data string — update the string to reflect the new architecture (e.g., "autonomous agent" or "Claude agent")
- This is a minor string change, no logic change needed

**Step 4: Create test_langgraph_removal.py (Wave 0 gap):**
Create `backend/tests/agent/test_langgraph_removal.py`:
```python
"""Verify LangGraph and LangChain are completely removed from the codebase."""
import importlib
import subprocess
import pytest

@pytest.mark.unit
def test_langgraph_not_importable():
    """MIGR-01: import langgraph must raise ImportError."""
    with pytest.raises(ImportError):
        importlib.import_module("langgraph")

@pytest.mark.unit
def test_langchain_core_not_importable():
    """MIGR-01: import langchain_core must raise ImportError."""
    with pytest.raises(ImportError):
        importlib.import_module("langchain_core")

@pytest.mark.unit
def test_langchain_anthropic_not_importable():
    """MIGR-01: import langchain_anthropic must raise ImportError."""
    with pytest.raises(ImportError):
        importlib.import_module("langchain_anthropic")

@pytest.mark.unit
def test_no_langgraph_in_pyproject():
    """MIGR-01: pyproject.toml must not reference langgraph."""
    import pathlib
    pyproject = pathlib.Path(__file__).parent.parent.parent / "pyproject.toml"
    content = pyproject.read_text()
    assert "langgraph" not in content.lower(), "Found langgraph reference in pyproject.toml"

@pytest.mark.unit
def test_no_langchain_in_pyproject():
    """MIGR-01: pyproject.toml must not reference langchain."""
    import pathlib
    pyproject = pathlib.Path(__file__).parent.parent.parent / "pyproject.toml"
    content = pyproject.read_text()
    assert "langchain" not in content.lower(), "Found langchain reference in pyproject.toml"
```

**Step 5: Run the full test suite:**
```bash
cd backend && python -m pytest tests/ -m unit -x -q
```

All tests must pass. If any fail, read the error, fix the specific test, and re-run.

**Step 6: Run the full suite (including integration tests if available):**
```bash
cd backend && python -m pytest tests/ -x -q
```

Commit: `test(40-03): fix broken tests after LangGraph removal, add removal verification tests`
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -m pytest tests/agent/test_langgraph_removal.py tests/domain/test_agent.py tests/agent/test_runner_real.py -x -q && python -m pytest tests/ -m unit -x -q 2>&1 | tail -10</automated>
    <manual>All fixed tests pass, removal verification tests pass, full unit suite green</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>test_agent.py cleaned of graph tests, test_runner_real.py rewritten for Anthropic SDK, test_artifact_export.py string updated, test_langgraph_removal.py verifies LangGraph/LangChain are truly gone, full unit suite passes</done>
</task>

</tasks>

<verification>
1. `cd backend && grep -rn "langgraph\|langchain\|ChatAnthropic" app/ --include="*.py" | grep -v "__pycache__" | grep -v "NOT LangChain"` — returns empty
2. `cd backend && grep -n "langgraph\|langchain" pyproject.toml` — returns empty
3. `cd backend && python -m pytest tests/agent/test_langgraph_removal.py -x -v` — all 5 removal verification tests pass
4. `cd backend && python -m pytest tests/ -m unit -x -q` — full unit suite green
5. `ls backend/app/agent/nodes/` — directory does not exist (deleted)
6. `ls backend/app/agent/graph.py` — file does not exist (deleted)
7. `cd backend && python -c "from app.agent.runner_real import RunnerReal; print('RunnerReal importable')"` — imports without error
</verification>

<success_criteria>
- Zero LangGraph/LangChain imports in any Python file under backend/app/
- Zero LangGraph/LangChain dependencies in pyproject.toml
- backend/app/agent/nodes/ directory deleted entirely
- backend/app/agent/graph.py deleted
- RunnerReal uses direct anthropic SDK for all methods
- llm_config.py returns AsyncAnthropic client (not ChatAnthropic)
- main.py has no checkpointer code
- All unit tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/40-langgraph-removal-protocol-extension/40-03-SUMMARY.md`
</output>
