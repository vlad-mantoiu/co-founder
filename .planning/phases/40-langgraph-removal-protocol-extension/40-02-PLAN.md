---
phase: 40-langgraph-removal-protocol-extension
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/narration_service.py
  - backend/app/services/doc_generation_service.py
  - backend/tests/services/test_narration_service.py
  - backend/tests/services/test_doc_generation_service.py
autonomous: true
requirements:
  - MIGR-01

must_haves:
  truths:
    - "NarrationService operates as a standalone utility without JobStateMachine dependency in constructor"
    - "DocGenerationService operates as a standalone utility without JobStateMachine dependency in constructor"
    - "Existing narration and doc generation tests pass after API simplification"
    - "_SAFETY_PATTERNS is importable from a shared location by both services"
  artifacts:
    - path: "backend/app/services/narration_service.py"
      provides: "Standalone NarrationService utility"
      contains: "class NarrationService"
    - path: "backend/app/services/doc_generation_service.py"
      provides: "Standalone DocGenerationService utility"
      contains: "class DocGenerationService"
  key_links:
    - from: "backend/app/services/narration_service.py"
      to: "anthropic.AsyncAnthropic"
      via: "Direct Anthropic SDK client"
      pattern: "AsyncAnthropic"
    - from: "backend/app/services/doc_generation_service.py"
      to: "anthropic.AsyncAnthropic"
      via: "Direct Anthropic SDK client"
      pattern: "AsyncAnthropic"
---

<objective>
Extract NarrationService and DocGenerationService to standalone utilities with simplified APIs — remove hard dependency on JobStateMachine from their constructors so the autonomous agent (Phase 41+) can call them directly without wiring up the full SSE/state machine infrastructure.

Purpose: Per user decision, these services are NOT deleted — they are preserved as standalone utilities for the autonomous agent to use. The TAOR loop (Phase 41) will call narrate() and generate_docs() as tool-like functions. Making them standalone now prevents coupling issues later.

Output: Two simplified service classes, shared _SAFETY_PATTERNS constant, all existing tests adapted and passing.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-langgraph-removal-protocol-extension/40-RESEARCH.md

@backend/app/services/narration_service.py
@backend/app/services/doc_generation_service.py
@backend/tests/services/test_narration_service.py
@backend/tests/services/test_doc_generation_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract _SAFETY_PATTERNS to shared constants and simplify service constructors</name>
  <files>
    backend/app/services/narration_service.py
    backend/app/services/doc_generation_service.py
  </files>
  <action>
**Step 1: Identify the current coupling.** Read both service files to understand:
- What `_SAFETY_PATTERNS` contains and where it's defined
- What constructor parameters each service takes (specifically JobStateMachine, Redis, etc.)
- What external dependencies exist beyond Anthropic SDK

**Step 2: Handle _SAFETY_PATTERNS cross-import.**
The research identifies that `narration_service.py` imports `_SAFETY_PATTERNS` from `doc_generation_service.py`. This is a fragile cross-import. Fix by:
- If `_SAFETY_PATTERNS` is defined in `doc_generation_service.py`, keep it there BUT also define a local reference in `narration_service.py` (copy the list) OR create a small shared constant. Claude's discretion on approach — the goal is that both files can be imported independently without circular dependency issues.
- Simplest approach: keep `_SAFETY_PATTERNS` in `doc_generation_service.py` and maintain the existing import in `narration_service.py` — this works fine since both stay in `app/services/`.

**Step 3: Simplify NarrationService constructor.**
Current constructor likely requires `JobStateMachine` for SSE event emission. Change to:
- Make `JobStateMachine` (or any SSE/event emitter) an **optional** constructor parameter with `None` default
- Core narration logic (Claude API call + safety filtering) works without the emitter
- If emitter is provided, publish events as before; if None, just return the narration text
- This makes the service callable from both: (a) the existing build pipeline (passes JobStateMachine) and (b) the future autonomous agent (passes None, handles narration text directly)

**Step 4: Simplify DocGenerationService constructor.**
Same pattern:
- Make event/state dependencies **optional** with None defaults
- Core doc generation (Claude API call → structured sections) works standalone
- SSE emission is conditional on whether an emitter is passed

**Key constraint:** Do NOT change the public method signatures (what they return). Only the constructor becomes more flexible. Callers in `generation_service.py` / `worker.py` that currently pass JobStateMachine continue to work unchanged.

Commit: `refactor(40-02): simplify NarrationService and DocGenerationService constructors for standalone use`
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -c "from app.services.narration_service import NarrationService; print('NarrationService importable')" && python -c "from app.services.doc_generation_service import DocGenerationService; print('DocGenerationService importable')"</automated>
    <manual>Both services import cleanly and can be instantiated without JobStateMachine</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Both services have optional constructor parameters for event emission; core logic works without JobStateMachine; _SAFETY_PATTERNS is importable by both services without circular dependency</done>
</task>

<task type="auto">
  <name>Task 2: Adapt existing service tests to match simplified interface</name>
  <files>
    backend/tests/services/test_narration_service.py
    backend/tests/services/test_doc_generation_service.py
  </files>
  <action>
**Step 1: Read existing test files** to understand current test structure, fixtures, and assertions.

**Step 2: Adapt test_narration_service.py:**
- Update fixture that creates NarrationService instance — if it currently requires JobStateMachine, update to test BOTH modes:
  - With emitter (existing behavior): verify SSE events are published
  - Without emitter (standalone mode): verify narration text is returned and no SSE calls are made
- Add test: `test_narration_service_standalone_mode` — creates `NarrationService()` with no event emitter, calls the narration method, asserts Claude is called and result is returned without SSE side effects
- Ensure all existing tests still pass by providing the emitter in those fixtures

**Step 3: Adapt test_doc_generation_service.py:**
- Same pattern: test both standalone and wired modes
- Add test: `test_doc_generation_service_standalone_mode` — creates service without emitter, verifies doc sections are returned
- Ensure all existing tests pass

**Step 4: Run full test suite:**
```bash
cd backend && python -m pytest tests/services/test_narration_service.py tests/services/test_doc_generation_service.py -x -v
```

Then verify no regressions in the broader suite:
```bash
cd backend && python -m pytest tests/ -m unit -x -q
```

Commit: `test(40-02): adapt service tests for standalone NarrationService and DocGenerationService`
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_narration_service.py tests/services/test_doc_generation_service.py -x -v && python -m pytest tests/ -m unit -x -q 2>&1 | tail -10</automated>
    <manual>All service tests pass in both standalone and wired modes; no regressions in full unit suite</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Both service test files updated with standalone mode tests; all existing tests still pass; NarrationService and DocGenerationService are genuine standalone utilities usable by the future autonomous agent</done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest tests/services/test_narration_service.py -x -v` — all tests pass including standalone mode
2. `cd backend && python -m pytest tests/services/test_doc_generation_service.py -x -v` — all tests pass including standalone mode
3. `cd backend && python -c "from app.services.narration_service import NarrationService; ns = NarrationService(); print('standalone OK')"` — instantiates without error
4. `cd backend && python -c "from app.services.doc_generation_service import DocGenerationService; ds = DocGenerationService(); print('standalone OK')"` — instantiates without error
5. `cd backend && python -m pytest tests/ -m unit -x -q` — full unit suite green
</verification>

<success_criteria>
- NarrationService constructor accepts optional event emitter (None = standalone mode)
- DocGenerationService constructor accepts optional event emitter (None = standalone mode)
- _SAFETY_PATTERNS is importable by both services
- All existing tests pass with no changes to assertion logic
- New standalone mode tests verify services work without SSE infrastructure
</success_criteria>

<output>
After completion, create `.planning/phases/40-langgraph-removal-protocol-extension/40-02-SUMMARY.md`
</output>
