---
phase: 40-langgraph-removal-protocol-extension
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/app/agent/runner.py
  - backend/app/agent/runner_fake.py
  - backend/app/agent/runner_autonomous.py
  - backend/tests/domain/test_runner_protocol.py
  - backend/tests/domain/test_runner_fake.py
  - backend/tests/agent/test_autonomous_runner_stub.py
autonomous: true
requirements:
  - MIGR-03

must_haves:
  truths:
    - "run_agent_loop() is defined in the Runner Protocol class"
    - "isinstance(RunnerFake(), Runner) returns True after protocol extension"
    - "RunnerFake.run_agent_loop() returns deterministic stub result for happy_path scenario"
    - "AutonomousRunner implements all Runner protocol methods with NotImplementedError"
    - "AutonomousRunner.run_agent_loop() raises NotImplementedError"
  artifacts:
    - path: "backend/app/agent/runner.py"
      provides: "Runner protocol with run_agent_loop() method"
      contains: "run_agent_loop"
    - path: "backend/app/agent/runner_fake.py"
      provides: "RunnerFake with run_agent_loop() deterministic stub"
      contains: "run_agent_loop"
    - path: "backend/app/agent/runner_autonomous.py"
      provides: "AutonomousRunner stub raising NotImplementedError"
      contains: "class AutonomousRunner"
    - path: "backend/tests/agent/test_autonomous_runner_stub.py"
      provides: "Tests for AutonomousRunner stub behavior"
      min_lines: 30
  key_links:
    - from: "backend/app/agent/runner_autonomous.py"
      to: "backend/app/agent/runner.py"
      via: "Protocol compliance (implements all Runner methods)"
      pattern: "class AutonomousRunner"
    - from: "backend/app/agent/runner_fake.py"
      to: "backend/app/agent/runner.py"
      via: "Protocol compliance (run_agent_loop added)"
      pattern: "run_agent_loop"
---

<objective>
Extend the Runner protocol with run_agent_loop(), implement it in RunnerFake as a deterministic stub, and create the AutonomousRunner stub class that raises NotImplementedError for all methods.

Purpose: Enable TDD for the autonomous agent before it exists — Phase 41+ can write tests against run_agent_loop() using RunnerFake, and the feature flag (Plan 04) can route to AutonomousRunner without import errors.

Output: Extended Runner protocol, updated RunnerFake, new AutonomousRunner stub, all with passing tests.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-langgraph-removal-protocol-extension/40-RESEARCH.md

@backend/app/agent/runner.py
@backend/app/agent/runner_fake.py
@backend/app/agent/state.py
@backend/tests/domain/test_runner_protocol.py
@backend/tests/domain/test_runner_fake.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for run_agent_loop() protocol extension and AutonomousRunner stub</name>
  <files>
    backend/tests/domain/test_runner_protocol.py
    backend/tests/domain/test_runner_fake.py
    backend/tests/agent/test_autonomous_runner_stub.py
  </files>
  <action>
Create the milestone branch first:
```bash
git checkout -b feature/autonomous-agent-migration
```

**test_runner_protocol.py** — extend existing tests:
1. Add `run_agent_loop` to the `CompleteRunner` dummy class (the existing minimal implementation used to test `isinstance()`) — it must accept `context: dict` and return `dict`
2. Add test: `test_runner_protocol_has_run_agent_loop` — asserts `hasattr(Runner, 'run_agent_loop')` and checks the method signature includes `context: dict` parameter
3. The existing `test_runner_is_runtime_checkable` test with `CompleteRunner` must still pass after adding the method

**test_runner_fake.py** — extend existing tests:
1. Add test: `test_run_agent_loop_happy_path` — calls `RunnerFake(scenario="happy_path").run_agent_loop({"project_id": "test-123", "user_id": "user-1"})` and asserts return dict has keys `status`, `project_id`, `phases_completed`, `result`
2. Add test: `test_run_agent_loop_llm_failure` — calls `RunnerFake(scenario="llm_failure").run_agent_loop(...)` and asserts it raises `RuntimeError` with "rate limit" in message
3. Add test: `test_runner_fake_still_satisfies_protocol` — verifies `isinstance(RunnerFake(), Runner)` is True (may already exist — extend if needed)

**test_autonomous_runner_stub.py** — create new test file:
1. `test_autonomous_runner_run_raises_not_implemented` — calls `AutonomousRunner().run(state)` with a minimal CoFounderState and asserts `NotImplementedError` is raised
2. `test_autonomous_runner_run_agent_loop_raises_not_implemented` — calls `AutonomousRunner().run_agent_loop({})` and asserts `NotImplementedError` is raised
3. `test_autonomous_runner_satisfies_protocol` — verifies `isinstance(AutonomousRunner(), Runner)` is True
4. `test_autonomous_runner_all_methods_raise_not_implemented` — iterates all Runner protocol methods and confirms each raises `NotImplementedError` when called

Import pattern: `from app.agent.runner_autonomous import AutonomousRunner`, `from app.agent.runner import Runner`, `from app.agent.state import CoFounderState`

All tests must be marked `@pytest.mark.unit` and use `async def` for async methods.

Run tests — they MUST fail (RED phase):
```bash
cd backend && python -m pytest tests/domain/test_runner_protocol.py tests/domain/test_runner_fake.py tests/agent/test_autonomous_runner_stub.py -x -q 2>&1 | head -50
```

Commit: `test(40-01): add failing tests for run_agent_loop protocol extension and AutonomousRunner stub`
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -m pytest tests/domain/test_runner_protocol.py tests/domain/test_runner_fake.py tests/agent/test_autonomous_runner_stub.py -x -q 2>&1 | tail -5</automated>
    <manual>Tests should FAIL — red phase of TDD</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>All new tests exist and fail with ImportError or AttributeError (not syntax errors) — confirming they test real missing behavior</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Implement run_agent_loop() in Runner protocol, RunnerFake, and create AutonomousRunner stub</name>
  <files>
    backend/app/agent/runner.py
    backend/app/agent/runner_fake.py
    backend/app/agent/runner_autonomous.py
  </files>
  <action>
**runner.py** — add `run_agent_loop()` to the Runner Protocol class:
```python
async def run_agent_loop(self, context: dict) -> dict:
    """Execute the autonomous TAOR agent loop for a build session.

    Args:
        context: Dict with keys: project_id, user_id, idea_brief, execution_plan

    Returns:
        Dict with keys: status, project_id, phases_completed, result
    """
    ...
```
Place after the last existing method in the Protocol class. Do NOT change any other methods.

**runner_fake.py** — add `run_agent_loop()` method to RunnerFake:
```python
async def run_agent_loop(self, context: dict) -> dict:
    """Deterministic stub for TDD — returns synthetic agent loop result."""
    if self.scenario == "llm_failure":
        raise RuntimeError("Anthropic API rate limit exceeded. Retry after 60 seconds.")
    if self.scenario == "rate_limited":
        raise RuntimeError("Worker capacity exceeded. Estimated wait: 5 minutes. Current queue depth: 12.")
    return {
        "status": "completed",
        "project_id": context.get("project_id", "test-project"),
        "phases_completed": 3,
        "result": "stub: autonomous agent loop completed",
    }
```

**runner_autonomous.py** — create new file:
1. Import `structlog`, `CoFounderState` from `app.agent.state`
2. Create `AutonomousRunner` class with a docstring: "Stub runner — placeholder until Phase 41 TAOR implementation."
3. Implement ALL methods from the Runner protocol — inspect `runner.py` to get the full list of protocol methods. Every method raises `NotImplementedError` with a message like `"AutonomousRunner.{method}() not yet implemented — Phase 41"`
4. Include `run_agent_loop()` — also raises `NotImplementedError`
5. Use `logger = structlog.get_logger(__name__)` at module level

Run ALL tests — they MUST pass (GREEN phase):
```bash
cd backend && python -m pytest tests/domain/test_runner_protocol.py tests/domain/test_runner_fake.py tests/agent/test_autonomous_runner_stub.py -x -q
```

Then run the full unit test suite to verify no regressions:
```bash
cd backend && python -m pytest tests/ -m unit -x -q
```

Commit: `feat(40-01): extend Runner protocol with run_agent_loop, add AutonomousRunner stub`
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -m pytest tests/domain/test_runner_protocol.py tests/domain/test_runner_fake.py tests/agent/test_autonomous_runner_stub.py -x -q && python -m pytest tests/ -m unit -x -q 2>&1 | tail -10</automated>
    <manual>All new tests green, zero regressions in full unit suite</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>run_agent_loop() exists in Runner protocol, RunnerFake returns deterministic stub, AutonomousRunner raises NotImplementedError for all methods, isinstance() checks pass for both, full unit suite green</done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest tests/domain/test_runner_protocol.py -x -q` — passes with run_agent_loop tests
2. `cd backend && python -m pytest tests/domain/test_runner_fake.py -x -q` — passes with run_agent_loop happy_path and llm_failure tests
3. `cd backend && python -m pytest tests/agent/test_autonomous_runner_stub.py -x -q` — passes all 4 AutonomousRunner tests
4. `cd backend && python -m pytest tests/ -m unit -x -q` — full unit suite passes (no regressions)
5. `python -c "from app.agent.runner_autonomous import AutonomousRunner; from app.agent.runner import Runner; assert isinstance(AutonomousRunner(), Runner)"` — protocol compliance verified
</verification>

<success_criteria>
- run_agent_loop() is in the Runner Protocol with correct signature
- RunnerFake.run_agent_loop() returns deterministic results per scenario
- AutonomousRunner implements all 14+ Runner protocol methods with NotImplementedError
- isinstance() checks pass for both RunnerFake and AutonomousRunner
- Full unit test suite green with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/40-langgraph-removal-protocol-extension/40-01-SUMMARY.md`
</output>
