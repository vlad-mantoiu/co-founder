---
phase: 34-screenshotservice
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - docker/Dockerfile.backend
  - backend/pyproject.toml
autonomous: true
requirements: [SNAP-01, SNAP-02]

must_haves:
  truths:
    - "Playwright headless-shell Chromium is installed in the Docker image via playwright install --with-deps --only-shell chromium"
    - "playwright>=1.58.0 is declared in pyproject.toml dependencies"
    - "Pillow is explicitly declared in pyproject.toml (not just a transitive dep of weasyprint)"
    - "PLAYWRIGHT_BROWSERS_PATH env var is set for predictable browser location in Docker"
    - "Docker image builds successfully with playwright + chromium headless-shell"
    - "Playwright system dependencies (libatk, libnspr, libnss, etc.) are installed in the production stage"
  artifacts:
    - path: "docker/Dockerfile.backend"
      provides: "Playwright headless-shell Chromium installation in production image"
      contains: "playwright install --with-deps --only-shell chromium"
    - path: "backend/pyproject.toml"
      provides: "playwright and Pillow declared as dependencies"
      contains: "playwright"
  key_links:
    - from: "docker/Dockerfile.backend"
      to: "backend/pyproject.toml"
      via: "pip install -e . installs playwright from pyproject.toml; playwright install installs browser binary"
      pattern: "playwright"
---

<objective>
Add Playwright and Pillow dependencies to pyproject.toml and install Chromium headless-shell in the Docker image so ScreenshotService can launch a real browser in ECS Fargate.

Purpose: Without browser binaries and system libraries in the Docker image, ScreenshotService cannot capture screenshots in production. This plan adds the dependencies that Plan 01's mocked tests assumed would exist.

Output: Updated `docker/Dockerfile.backend` with Playwright + Chromium headless-shell installation, updated `backend/pyproject.toml` with playwright and Pillow dependencies.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-screenshotservice/34-RESEARCH.md
@docker/Dockerfile.backend
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add playwright and Pillow to pyproject.toml dependencies</name>
  <files>backend/pyproject.toml</files>
  <action>
    Add `"playwright>=1.58.0"` and `"Pillow>=11.0.0"` to the `dependencies` list in `backend/pyproject.toml`.

    Pillow may already be a transitive dependency of weasyprint, but declaring it explicitly ensures the version constraint is respected and makes the dependency visible.

    Place the new entries alphabetically within the existing dependency list.

    After editing, verify syntax with: `cd /Users/vladcortex/co-founder/backend && python -c "import tomllib; tomllib.load(open('pyproject.toml','rb'))"` to confirm valid TOML.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -c "import tomllib; d=tomllib.load(open('pyproject.toml','rb')); deps=d['project']['dependencies']; assert any('playwright' in x for x in deps), 'playwright missing'; assert any('Pillow' in x or 'pillow' in x for x in deps), 'Pillow missing'; print('OK: playwright and Pillow in dependencies')"</automated>
  </verify>
  <done>pyproject.toml contains playwright>=1.58.0 and Pillow>=11.0.0 in the dependencies list and parses as valid TOML</done>
</task>

<task type="auto">
  <name>Task 2: Install Playwright headless-shell Chromium in Dockerfile.backend</name>
  <files>docker/Dockerfile.backend</files>
  <action>
    Modify `docker/Dockerfile.backend` to install Playwright's Chromium headless-shell binary with all required system dependencies. The installation MUST happen in the production stage (not just the builder stage) because:
    1. Browser binaries are installed to a filesystem path (not Python site-packages)
    2. System libraries (libatk, libnspr, libnss, etc.) must be in the final image

    Changes to make:

    **1. Set PLAYWRIGHT_BROWSERS_PATH in the production stage** (before the playwright install command):
    ```
    ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    ```
    This ensures a predictable, absolute path for browser binaries that ScreenshotService can find.

    **2. Add Playwright browser installation in the production stage** after the `COPY --from=builder` lines but BEFORE `USER appuser`:
    ```dockerfile
    # Install Playwright Chromium headless-shell with system dependencies
    # --with-deps installs OS-level libs (libatk, libnspr, libnss, etc.) ~300MB
    # --only-shell installs headless-shell (not full Chrome for Testing) to save memory
    RUN playwright install --with-deps --only-shell chromium && \
        rm -rf /var/lib/apt/lists/*
    ```

    **3. Also set PLAYWRIGHT_BROWSERS_PATH in the builder stage** so that if `pip install -e .` triggers any playwright post-install hooks, they use the same path. Add it before `RUN pip install`:
    ```
    ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    ```

    **4. Ensure the appuser can read the browser directory.** After the `playwright install` line and before `USER appuser`, add:
    ```dockerfile
    RUN chmod -R 755 /ms-playwright
    ```

    The final Dockerfile order in the production stage should be:
    1. apt-get install curl (existing)
    2. COPY from builder (existing)
    3. COPY application code (existing)
    4. ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    5. RUN playwright install --with-deps --only-shell chromium
    6. RUN chmod -R 755 /ms-playwright
    7. RUN mkdir -p /tmp/cofounder (existing)
    8. RUN useradd + USER appuser (existing)

    Do NOT add Playwright to the builder stage apt-get — the builder only needs pip packages, not browser binaries.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder && grep -q "playwright install.*--only-shell chromium" docker/Dockerfile.backend && grep -q "PLAYWRIGHT_BROWSERS_PATH" docker/Dockerfile.backend && echo "OK: Dockerfile has playwright install and PLAYWRIGHT_BROWSERS_PATH"</automated>
    <manual>Verify Dockerfile builds: docker build -f docker/Dockerfile.backend -t cofounder-backend-test . (optional — full build takes 5+ minutes)</manual>
  </verify>
  <done>Dockerfile.backend installs Playwright Chromium headless-shell with system deps in the production stage; PLAYWRIGHT_BROWSERS_PATH is set; appuser can read the browser directory</done>
</task>

</tasks>

<verification>
```bash
# Verify pyproject.toml has both dependencies
cd /Users/vladcortex/co-founder/backend && python -c "
import tomllib
d = tomllib.load(open('pyproject.toml','rb'))
deps = d['project']['dependencies']
has_playwright = any('playwright' in x for x in deps)
has_pillow = any('Pillow' in x or 'pillow' in x for x in deps)
print(f'playwright: {has_playwright}, Pillow: {has_pillow}')
assert has_playwright and has_pillow
"

# Verify Dockerfile has correct Playwright installation
grep -n "playwright" /Users/vladcortex/co-founder/docker/Dockerfile.backend
grep -n "PLAYWRIGHT_BROWSERS_PATH" /Users/vladcortex/co-founder/docker/Dockerfile.backend

# Verify the screenshot service tests still pass (no regressions from dependency changes)
cd /Users/vladcortex/co-founder && python -m pytest backend/tests/services/test_screenshot_service.py -x -v 2>&1 | tail -20
```
</verification>

<success_criteria>
- `backend/pyproject.toml` declares `playwright>=1.58.0` and `Pillow>=11.0.0`
- `docker/Dockerfile.backend` runs `playwright install --with-deps --only-shell chromium` in the production stage
- `PLAYWRIGHT_BROWSERS_PATH=/ms-playwright` is set in the Dockerfile
- Browser directory is readable by appuser (chmod 755)
- Dockerfile syntax is valid (no broken RUN commands)
- ScreenshotService tests from Plan 01 still pass
</success_criteria>

<output>
After completion, create `.planning/phases/34-screenshotservice/34-02-SUMMARY.md`
</output>
