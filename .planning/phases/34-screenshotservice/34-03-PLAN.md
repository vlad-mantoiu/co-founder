---
phase: 34-screenshotservice
plan: 03
type: execute
wave: 1
depends_on: ["34-01", "34-02"]
files_modified:
  - backend/app/services/screenshot_service.py
  - backend/tests/services/test_screenshot_service.py
autonomous: true
gap_closure: true
requirements: [SNAP-02]

must_haves:
  truths:
    - "S3 put_object call includes CacheControl='max-age=31536000, immutable' parameter"
    - "Test asserts CacheControl is passed to put_object in the upload method"
  artifacts:
    - path: "backend/app/services/screenshot_service.py"
      provides: "CacheControl header in S3 upload"
      contains: "CacheControl"
    - path: "backend/tests/services/test_screenshot_service.py"
      provides: "Test assertion for CacheControl header"
      contains: "CacheControl"
  key_links:
    - from: "backend/app/services/screenshot_service.py"
      to: "S3 put_object"
      via: "CacheControl parameter"
      pattern: "CacheControl.*max-age=31536000.*immutable"
---

<objective>
Fix the missing CacheControl header in ScreenshotService.upload() so that screenshots uploaded to S3 are served via CloudFront with immutable cache headers, satisfying SC2 of the Phase 34 verification.

Purpose: Without `CacheControl='max-age=31536000, immutable'` on the S3 object metadata, CloudFront uses its default TTL instead of the intended immutable caching. Since screenshot S3 keys include `{job_id}/{stage}.png` (content-addressed), immutable caching is safe and correct.

Output: Patched upload method + updated test assertion.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-screenshotservice/34-VERIFICATION.md
@.planning/phases/34-screenshotservice/34-01-SUMMARY.md
@backend/app/services/screenshot_service.py
@backend/tests/services/test_screenshot_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CacheControl header to S3 upload and test assertion</name>
  <files>
    backend/app/services/screenshot_service.py
    backend/tests/services/test_screenshot_service.py
  </files>
  <action>
In `backend/app/services/screenshot_service.py`, find the `upload()` method's `put_object` call (around line 258-264). Add `CacheControl="max-age=31536000, immutable"` as a parameter to the `s3.put_object()` call, alongside the existing `ContentType="image/png"`.

The change is a single line addition inside the `asyncio.to_thread()` call:

```python
await asyncio.to_thread(
    s3.put_object,
    Bucket=bucket,
    Key=s3_key,
    Body=png_bytes,
    ContentType="image/png",
    CacheControl="max-age=31536000, immutable",
)
```

In `backend/tests/services/test_screenshot_service.py`, update `test_upload_uses_correct_s3_key_structure` (around line 599) to also assert that the `CacheControl` parameter is passed correctly. Alternatively, add a new focused test `test_upload_sets_immutable_cache_control` in the `TestUpload` class that verifies the `to_thread` call includes `CacheControl="max-age=31536000, immutable"`.

Recommended approach: Add a new test method `test_upload_sets_immutable_cache_control` to the `TestUpload` class that:
1. Patches `get_settings`, `boto3`, and `asyncio.to_thread`
2. Calls `service.upload(png_bytes, "job-1", "checks")`
3. Asserts `mock_to_thread.call_args` contains `CacheControl="max-age=31536000, immutable"` in kwargs

Use the same mocking pattern as `test_upload_constructs_correct_cloudfront_url` (patch `get_settings`, `boto3`, `asyncio.to_thread`).
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder && python -m pytest backend/tests/services/test_screenshot_service.py -x -v 2>&1 | tail -20</automated>
    <manual>Verify CacheControl appears in put_object call in screenshot_service.py</manual>
  </verify>
  <done>
    - `put_object` call in `upload()` includes `CacheControl="max-age=31536000, immutable"` parameter
    - New test `test_upload_sets_immutable_cache_control` passes
    - All 42 tests (41 existing + 1 new) pass with no regressions
    - SC2 gap from VERIFICATION.md is resolved
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest backend/tests/services/test_screenshot_service.py -x -v` — all tests pass (42 total)
2. `grep -n "CacheControl" backend/app/services/screenshot_service.py` — confirms header is present in upload method
3. `grep -n "CacheControl" backend/tests/services/test_screenshot_service.py` — confirms test asserts the header
</verification>

<success_criteria>
- All 42 tests pass (41 existing + 1 new CacheControl test)
- `CacheControl="max-age=31536000, immutable"` present in the S3 put_object call
- SC2 verification gap from 34-VERIFICATION.md is resolved
</success_criteria>

<output>
After completion, create `.planning/phases/34-screenshotservice/34-03-SUMMARY.md`
</output>
