---
phase: 34-screenshotservice
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/tests/services/test_screenshot_service.py
  - backend/app/services/screenshot_service.py
autonomous: true
requirements: [SNAP-01, SNAP-02, SNAP-06, SNAP-07]

must_haves:
  truths:
    - "ScreenshotService.validate() rejects PNGs under 5KB as blank"
    - "ScreenshotService.validate() rejects solid-color images with low stddev as blank"
    - "ScreenshotService.validate() accepts real rendered page PNGs"
    - "Circuit breaker stops capture attempts after 3 consecutive failures per job"
    - "Feature flag screenshot_enabled=False causes capture() to return None"
    - "Non-capture stages (scaffold, code, deps) are skipped — capture() returns None"
    - "Blank page retry fires once after 2-second delay before final discard"
    - "Successful upload writes snapshot_url to Redis hash and emits SSE event"
    - "S3 upload failure is non-fatal — capture() returns None, build continues"
    - "Playwright failure is non-fatal — capture() returns None, build continues"
  artifacts:
    - path: "backend/tests/services/test_screenshot_service.py"
      provides: "Unit tests for validate, circuit breaker, capture orchestration, upload, Redis persist"
      min_lines: 150
    - path: "backend/app/services/screenshot_service.py"
      provides: "ScreenshotService class with capture(), validate(), upload(), _do_capture(), _capture_with_retry()"
      exports: ["ScreenshotService", "CAPTURE_STAGES", "MIN_FILE_SIZE_BYTES", "MIN_CHANNEL_STDDEV", "CIRCUIT_BREAKER_THRESHOLD"]
      min_lines: 120
  key_links:
    - from: "backend/app/services/screenshot_service.py"
      to: "backend/app/core/config.py"
      via: "get_settings() for screenshot_enabled, screenshots_bucket, screenshots_cloudfront_domain"
      pattern: "get_settings\\(\\)"
    - from: "backend/app/services/screenshot_service.py"
      to: "backend/app/queue/state_machine.py"
      via: "JobStateMachine.publish_event() with SSEEventType.SNAPSHOT_UPDATED"
      pattern: "SSEEventType\\.SNAPSHOT_UPDATED"
    - from: "backend/app/services/screenshot_service.py"
      to: "redis"
      via: "redis.hset(f'job:{job_id}', 'snapshot_url', cloudfront_url)"
      pattern: "hset.*snapshot_url"
---

<objective>
Test-drive the ScreenshotService class — validate blank page detection, circuit breaker logic, capture orchestration with retry, S3 upload, and Redis persistence + SSE event emission.

Purpose: The ScreenshotService is the core backend service for Phase 34. TDD ensures all failure paths (blank pages, Playwright crashes, S3 failures, circuit breaker) are covered before implementation. Playwright and S3 are mocked — real browser testing happens in Phase 34-02.

Output: Tested ScreenshotService class at `backend/app/services/screenshot_service.py` with full test coverage at `backend/tests/services/test_screenshot_service.py`.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-screenshotservice/34-RESEARCH.md
@.planning/phases/33-infrastructure-configuration/33-02-SUMMARY.md
@.planning/phases/33-infrastructure-configuration/33-03-SUMMARY.md
@backend/app/core/config.py
@backend/app/queue/state_machine.py
@backend/app/api/routes/generation.py
</context>

<feature>
  <name>ScreenshotService — capture, validate, upload, persist</name>
  <files>backend/app/services/screenshot_service.py, backend/tests/services/test_screenshot_service.py</files>
  <behavior>
    The ScreenshotService captures viewport screenshots of E2B preview URLs via Playwright, validates them against blank page detection, uploads to S3, writes the CloudFront URL to Redis, and emits an SSE event.

    All external I/O (Playwright, S3, Redis) is mocked in tests. TDD drives the control flow.

    Cases:
    - validate(4KB_bytes) -> (False, "file_too_small: ...")
    - validate(solid_white_100x100_png) -> (False, "uniform_pixels: ...")
    - validate(real_rendered_png_with_high_stddev) -> (True, "")
    - validate(corrupt_bytes) -> (False, "pillow_error: ...")
    - capture(url, job_id, "scaffold") -> None (not in CAPTURE_STAGES)
    - capture(url, job_id, "checks") with screenshot_enabled=False -> None
    - capture(url, job_id, "checks") with 3 prior failures -> None (circuit breaker open)
    - capture(url, job_id, "checks") with Playwright success + valid PNG -> CloudFront URL string
    - capture(url, job_id, "checks") with Playwright success + blank PNG + retry success -> CloudFront URL
    - capture(url, job_id, "checks") with Playwright success + blank PNG + retry blank -> None (both blanks)
    - capture(url, job_id, "checks") with Playwright failure -> None (non-fatal)
    - capture(url, job_id, "checks") with S3 upload failure -> None (non-fatal)
    - capture(url, job_id, "checks") success -> writes snapshot_url to Redis hash + publishes SSE event
    - capture(url, job_id, "checks") after asyncio.wait_for timeout -> None (non-fatal, increments failure count)
    - reset_circuit(job_id) -> clears failure count for job
  </behavior>
  <implementation>
    Create `backend/app/services/screenshot_service.py` with the ScreenshotService class following the architecture from 34-RESEARCH.md.

    Key implementation decisions (from CONTEXT.md locked decisions + research):
    - CAPTURE_STAGES = frozenset({"checks", "ready"}) — skip scaffold/code/deps
    - MIN_FILE_SIZE_BYTES = 5 * 1024 (5KB) — SNAP-06
    - MIN_CHANNEL_STDDEV = 8.0 — empirical threshold for blank page color variance
    - CIRCUIT_BREAKER_THRESHOLD = 3 — consecutive failures before circuit opens
    - BLANK_RETRY_DELAY_SECONDS = 2 — delay before blank page retry
    - Fresh browser per capture via async_playwright() context manager
    - Chromium args: --no-sandbox, --disable-setuid-sandbox, --disable-dev-shm-usage, --disable-gpu, --single-process
    - Viewport: 1280x800
    - page.goto(url, wait_until="load", timeout=10_000) + asyncio.sleep(1) for hydration
    - page.screenshot(type="png", full_page=False) — viewport only
    - S3 upload via asyncio.to_thread(s3.put_object, ...) — never block event loop
    - S3 key: screenshots/{job_id}/{stage}.png
    - CloudFront URL: https://{cf_domain}/{s3_key}
    - Redis: hset(f"job:{job_id}", "snapshot_url", cloudfront_url)
    - SSE: state_machine.publish_event(job_id, {"type": SSEEventType.SNAPSHOT_UPDATED, "snapshot_url": cloudfront_url})
    - All exceptions caught and logged as warnings — never raised to caller
    - Total timeout budget: asyncio.wait_for(30s) wrapping _capture_with_retry (2 attempts x 15s max)

    Test structure:
    - Use pytest.mark.unit — no external services
    - Mock Playwright via patch("app.services.screenshot_service.async_playwright")
    - Mock boto3 via patch("app.services.screenshot_service.boto3")
    - Mock get_settings() for feature flag and bucket/domain configuration
    - Use real Pillow to generate test PNGs (solid white, random noise) for validate() tests
    - Use AsyncMock for Redis client
    - Use asyncio_mode = "auto" (project convention)
  </implementation>
</feature>

<verification>
```bash
cd /Users/vladcortex/co-founder && python -m pytest backend/tests/services/test_screenshot_service.py -x -v 2>&1 | tail -40
```
All tests pass. No test uses real Playwright, real S3, or real Redis.
</verification>

<success_criteria>
- All test cases listed in behavior section pass
- ScreenshotService class has capture(), validate(), upload(), _do_capture(), _capture_with_retry(), _upload_and_persist(), reset_circuit() methods
- validate() uses Pillow ImageStat.Stat for color variance detection
- Circuit breaker tracks failures per job_id in _failure_count dict
- Non-fatal error handling wraps all external calls in try/except
- Ruff formatting passes (`ruff check backend/app/services/screenshot_service.py backend/tests/services/test_screenshot_service.py`)
</success_criteria>

<output>
After completion, create `.planning/phases/34-screenshotservice/34-01-SUMMARY.md`
</output>
