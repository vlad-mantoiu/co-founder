---
phase: 28-sandbox-runtime-fixes
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - backend/app/sandbox/e2b_runtime.py
  - backend/app/services/generation_service.py
  - backend/tests/services/test_generation_service.py
  - backend/tests/services/test_iteration_build.py
autonomous: true
requirements:
  - SBOX-02

must_haves:
  truths:
    - "npm run dev starts inside the sandbox and a valid HTTPS preview URL is returned"
    - "The preview URL is live (HTTP 200 or non-5xx) when the job reaches READY state"
    - "Framework detection reads package.json to determine start command and port"
    - "Preview URL is stored in the jobs table in the database"
  artifacts:
    - path: "backend/app/sandbox/e2b_runtime.py"
      provides: "start_dev_server() method, _detect_framework() helper, _wait_for_dev_server() poll"
      contains: "_detect_framework"
    - path: "backend/app/services/generation_service.py"
      provides: "Dev server launch integrated into build pipeline before READY transition"
      contains: "start_dev_server"
    - path: "backend/tests/services/test_generation_service.py"
      provides: "Tests for framework detection and dev server launch"
      contains: "test_detect_framework"
  key_links:
    - from: "backend/app/sandbox/e2b_runtime.py"
      to: "httpx.AsyncClient"
      via: "_wait_for_dev_server HTTP polling loop"
      pattern: "httpx\\.AsyncClient"
    - from: "backend/app/services/generation_service.py"
      to: "backend/app/sandbox/e2b_runtime.py"
      via: "start_dev_server() call before READY"
      pattern: "await sandbox\\.start_dev_server"
    - from: "backend/app/sandbox/e2b_runtime.py"
      to: "package.json"
      via: "_detect_framework parses dependencies"
      pattern: "_detect_framework"
---

<objective>
Add dev server launch with framework detection and HTTP readiness polling so that the preview URL is live when the job reaches READY state.

Purpose: Without this, the sandbox builds files but never starts a dev server — the preview_url points to a dead host. This plan makes the core product promise real: a founder's idea results in a running app they can see.

Output: Framework detection from package.json, background dev server launch, HTTP readiness polling, and preview_url populated from the correct port.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-sandbox-runtime-fixes/28-01-SUMMARY.md
@backend/app/sandbox/e2b_runtime.py
@backend/app/services/generation_service.py
@backend/tests/services/test_generation_service.py
@backend/tests/services/test_iteration_build.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add framework detection, dev server launch, and readiness polling to E2BSandboxRuntime</name>
  <files>
    backend/app/sandbox/e2b_runtime.py
  </files>
  <action>
Add three new methods to `E2BSandboxRuntime`:

**1. `_detect_framework()` — static/classmethod helper**

```python
@staticmethod
def _detect_framework(package_json_content: str) -> tuple[str, int]:
    """Detect framework from package.json and return (start_command, port).

    Detection priority:
    1. Next.js (deps: "next") → "npm run dev", 3000
    2. Vite (deps: "vite") → "npm run dev", 5173
    3. Create React App (deps: "react-scripts") → "npm start", 3000
    4. Express/Hono (deps: "express" or "@hono/node-server") → "npm start", 3000
    5. Fallback: check scripts.dev → "npm run dev", 3000
    6. Last resort: "npm run dev", 3000
    """
    import json

    try:
        pkg = json.loads(package_json_content)
    except (json.JSONDecodeError, TypeError):
        return ("npm run dev", 3000)

    deps = {**pkg.get("dependencies", {}), **pkg.get("devDependencies", {})}
    scripts = pkg.get("scripts", {})

    if "next" in deps:
        return ("npm run dev", 3000)
    if "vite" in deps:
        return ("npm run dev", 5173)
    if "react-scripts" in deps:
        return ("npm start", 3000)
    if "express" in deps or "@hono/node-server" in deps:
        return ("npm start", 3000)

    if "dev" in scripts:
        return ("npm run dev", 3000)
    if "start" in scripts:
        return ("npm start", 3000)

    return ("npm run dev", 3000)
```

**2. `_wait_for_dev_server()` — async HTTP poll**

Add `import httpx` and `import asyncio` at the top of the file.

```python
async def _wait_for_dev_server(self, url: str, timeout: int = 120, interval: float = 3.0) -> None:
    """Poll URL with httpx until a non-5xx response or timeout.

    Args:
        url: Full HTTPS preview URL to poll
        timeout: Max seconds to wait (default: 120)
        interval: Seconds between poll attempts (default: 3.0)

    Raises:
        SandboxError: If server doesn't respond within timeout
    """
    import asyncio

    deadline = asyncio.get_event_loop().time() + timeout
    async with httpx.AsyncClient(verify=False, timeout=10.0) as client:
        while asyncio.get_event_loop().time() < deadline:
            try:
                resp = await client.get(url, follow_redirects=True)
                if resp.status_code < 500:
                    return  # Server is up
            except (httpx.ConnectError, httpx.TimeoutException, httpx.RemoteProtocolError):
                pass  # Server not ready yet
            await asyncio.sleep(interval)

    raise SandboxError(f"Dev server did not become ready within {timeout}s at {url}")
```

**3. `start_dev_server()` — public method combining detection + launch + poll**

```python
async def start_dev_server(self, workspace_path: str, working_files: dict | None = None) -> str:
    """Detect framework, start dev server, wait for readiness, return preview_url.

    Args:
        workspace_path: Absolute path to project root in sandbox (e.g., /home/user/project)
        working_files: Dict of file paths to FileChange dicts. Used to read package.json
                       for framework detection without a sandbox filesystem read.

    Returns:
        HTTPS preview URL that is confirmed live (non-5xx response)

    Raises:
        SandboxError: If sandbox not started, or server fails to become ready
    """
    if not self._sandbox:
        raise SandboxError("Sandbox not started")

    # Detect framework from package.json
    package_json_content = None
    if working_files:
        # Try to find package.json in working_files (may be at root or workspace-relative path)
        for key in ["package.json", f"{workspace_path}/package.json", "/home/user/project/package.json"]:
            fc = working_files.get(key)
            if fc:
                package_json_content = fc.get("new_content", "") if isinstance(fc, dict) else str(fc)
                break

    if package_json_content is None:
        # Read from sandbox filesystem as fallback
        try:
            package_json_content = await self.read_file(f"{workspace_path}/package.json")
        except SandboxError:
            package_json_content = ""

    start_cmd, port = self._detect_framework(package_json_content)

    # Install dependencies first
    install_result = await self.run_command("npm install", timeout=300, cwd=workspace_path)
    if install_result.get("exit_code", 1) != 0:
        stderr = install_result.get("stderr", "")
        # Retry once on network errors
        if any(keyword in stderr.lower() for keyword in ["econnreset", "network", "etimedout"]):
            import asyncio
            await asyncio.sleep(10)
            install_result = await self.run_command("npm install", timeout=300, cwd=workspace_path)
            if install_result.get("exit_code", 1) != 0:
                raise SandboxError(
                    f"npm install failed after retry: {install_result.get('stderr', '')[:500]}"
                )
        else:
            raise SandboxError(
                f"npm install failed: {install_result.get('stderr', '')[:500]}"
            )

    # Start dev server in background
    await self.run_background(start_cmd, cwd=workspace_path)

    # Build preview URL
    host = self.get_host(port)
    preview_url = f"https://{host}"

    # Poll until server responds
    await self._wait_for_dev_server(preview_url, timeout=120)

    return preview_url
```

Add `import httpx` at the top of the file alongside other imports.
  </action>
  <verify>
Run: `cd /Users/vladcortex/co-founder/backend && python -c "from app.sandbox.e2b_runtime import E2BSandboxRuntime; r = E2BSandboxRuntime; print(hasattr(r, 'start_dev_server'), hasattr(r, '_detect_framework'), hasattr(r, '_wait_for_dev_server'))"`

Must print: `True True True`

Run: `cd /Users/vladcortex/co-founder/backend && python -c "
from app.sandbox.e2b_runtime import E2BSandboxRuntime
# Test framework detection
assert E2BSandboxRuntime._detect_framework('{\"dependencies\": {\"next\": \"14.0.0\"}}') == ('npm run dev', 3000)
assert E2BSandboxRuntime._detect_framework('{\"dependencies\": {\"vite\": \"5.0.0\"}}') == ('npm run dev', 5173)
assert E2BSandboxRuntime._detect_framework('{\"dependencies\": {\"react-scripts\": \"5.0\"}}') == ('npm start', 3000)
assert E2BSandboxRuntime._detect_framework('{\"dependencies\": {\"express\": \"4.0\"}}') == ('npm start', 3000)
assert E2BSandboxRuntime._detect_framework('invalid json') == ('npm run dev', 3000)
assert E2BSandboxRuntime._detect_framework('{\"scripts\": {\"dev\": \"vite\"}}') == ('npm run dev', 3000)
print('All framework detection tests passed')
"`
  </verify>
  <done>
E2BSandboxRuntime has _detect_framework (static, parses package.json deps), _wait_for_dev_server (HTTP poll with httpx), and start_dev_server (orchestrates install + background launch + readiness poll). Framework detection correctly identifies Next.js/Vite/CRA/Express and falls back to npm run dev on port 3000.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate dev server launch into build pipeline and update tests</name>
  <files>
    backend/app/services/generation_service.py
    backend/tests/services/test_generation_service.py
    backend/tests/services/test_iteration_build.py
  </files>
  <action>
**Part A: Integrate start_dev_server into generation_service.py**

In `execute_build()`, between the CHECKS health check (step 5) and the "Compute build result fields" (step 6), add the dev server launch:

Replace the current steps 5-6 section. After the CHECKS transition and health check command, add:

```python
# 5b. Start dev server and get live preview URL
preview_url = await sandbox.start_dev_server(
    workspace_path=workspace_path,
    working_files=working_files,
)

# 6. Compute build result fields
sandbox_id = sandbox.sandbox_id
build_version = await self._get_next_build_version(project_id, state_machine)
```

Remove the old `host = sandbox.get_host(3000)` and `preview_url = f"https://{host}"` lines since `start_dev_server` now returns the live, verified preview_url.

Similarly in `execute_iteration_build()`, replace the current host/preview_url computation (step 6) with:

```python
# 5b. Start dev server on patched codebase
preview_url = await sandbox.start_dev_server(
    workspace_path=workspace_path,
    working_files=working_files,
)

# 6. Compute remaining build result fields
sandbox_id = sandbox.sandbox_id
build_version = await self._get_next_build_version(project_id, state_machine)
```

**Part B: Update tests**

In `test_generation_service.py`, update `FakeSandboxRuntime` to add `start_dev_server`:

```python
async def start_dev_server(self, workspace_path: str, working_files: dict | None = None) -> str:
    """Fake dev server launch — returns preview URL immediately."""
    return f"https://3000-{self._sandbox_id}.e2b.app"
```

Update `test_execute_build_success`:
- The preview_url assertion should be: `assert result["preview_url"] == "https://3000-fake-sandbox-001.e2b.app"`
- This should already be correct from Plan 01. Verify it still holds.

**Part C: Add framework detection unit tests**

Add new test functions to `test_generation_service.py`:

```python
# ---------------------------------------------------------------------------
# Tests: framework detection (SBOX-02)
# ---------------------------------------------------------------------------

def test_detect_framework_nextjs():
    """Next.js detected from dependencies → npm run dev on port 3000."""
    from app.sandbox.e2b_runtime import E2BSandboxRuntime
    cmd, port = E2BSandboxRuntime._detect_framework('{"dependencies": {"next": "14.0.0"}}')
    assert cmd == "npm run dev"
    assert port == 3000

def test_detect_framework_vite():
    """Vite detected from dependencies → npm run dev on port 5173."""
    from app.sandbox.e2b_runtime import E2BSandboxRuntime
    cmd, port = E2BSandboxRuntime._detect_framework('{"dependencies": {"vite": "5.0.0"}}')
    assert cmd == "npm run dev"
    assert port == 5173

def test_detect_framework_cra():
    """Create React App detected → npm start on port 3000."""
    from app.sandbox.e2b_runtime import E2BSandboxRuntime
    cmd, port = E2BSandboxRuntime._detect_framework('{"dependencies": {"react-scripts": "5.0.0"}}')
    assert cmd == "npm start"
    assert port == 3000

def test_detect_framework_express():
    """Express detected → npm start on port 3000."""
    from app.sandbox.e2b_runtime import E2BSandboxRuntime
    cmd, port = E2BSandboxRuntime._detect_framework('{"dependencies": {"express": "4.18.0"}}')
    assert cmd == "npm start"
    assert port == 3000

def test_detect_framework_fallback_invalid_json():
    """Invalid JSON → fallback to npm run dev on port 3000."""
    from app.sandbox.e2b_runtime import E2BSandboxRuntime
    cmd, port = E2BSandboxRuntime._detect_framework("not valid json")
    assert cmd == "npm run dev"
    assert port == 3000

def test_detect_framework_fallback_scripts_dev():
    """No known framework but scripts.dev exists → npm run dev on port 3000."""
    from app.sandbox.e2b_runtime import E2BSandboxRuntime
    cmd, port = E2BSandboxRuntime._detect_framework('{"scripts": {"dev": "node server.js"}}')
    assert cmd == "npm run dev"
    assert port == 3000

def test_detect_framework_fallback_scripts_start():
    """No known framework, no dev script, but scripts.start exists → npm start on port 3000."""
    from app.sandbox.e2b_runtime import E2BSandboxRuntime
    cmd, port = E2BSandboxRuntime._detect_framework('{"scripts": {"start": "node index.js"}}')
    assert cmd == "npm start"
    assert port == 3000
```

Mark these as `pytestmark = pytest.mark.unit` (already at module level).

**Part D: Update test_iteration_build.py FakeSandboxRuntime with start_dev_server**

`backend/tests/services/test_iteration_build.py` has its own `FakeSandboxRuntime` (updated in 28-01 to remove `_FakeSandboxInner`). After 28-02 integrates `start_dev_server()` into `execute_iteration_build()`, this fake must also have the method. Add to `FakeSandboxRuntime` in test_iteration_build.py:

```python
async def start_dev_server(self, workspace_path: str, working_files: dict | None = None) -> str:
    """Fake dev server launch — returns preview URL immediately."""
    return f"https://3000-{self._sandbox_id}.e2b.app"
```

The existing preview_url assertion (`"https://3000-fake-iter-sandbox-001.e2b.app"`) should already be correct from the 28-01 revision. Verify it still holds after this change.
  </action>
  <verify>
Run: `cd /Users/vladcortex/co-founder && python -m pytest backend/tests/services/test_generation_service.py -v --tb=short`

All tests must pass — original 4 + 7 new framework detection tests = 11 total.

Run: `cd /Users/vladcortex/co-founder && python -m pytest backend/tests/services/test_iteration_build.py -v --tb=short`

All 4 iteration build tests must pass (FakeSandboxRuntime now has start_dev_server).

Run: `grep -n "start_dev_server" backend/app/services/generation_service.py` — should show calls in both execute_build and execute_iteration_build.

Run: `grep -n "get_host(8080)\|get_host(3000)" backend/app/services/generation_service.py` — should return nothing (preview_url now comes from start_dev_server, not manual get_host).
  </verify>
  <done>
Dev server launch is integrated into both execute_build and execute_iteration_build pipelines. The preview_url returned is verified live via HTTP polling before READY. Framework detection has 7 unit tests covering Next.js, Vite, CRA, Express, and 3 fallback scenarios. test_iteration_build.py FakeSandboxRuntime updated with start_dev_server and all 4 tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest backend/tests/services/test_generation_service.py -v` — all 11 tests pass
2. `python -m pytest backend/tests/services/test_iteration_build.py -v` — all 4 tests pass
3. `grep -n "start_dev_server" backend/app/services/generation_service.py` — present in both build methods
4. `grep -n "get_host(8080)" backend/app/services/generation_service.py` — zero results
5. `python -c "from app.sandbox.e2b_runtime import E2BSandboxRuntime; print(hasattr(E2BSandboxRuntime, 'start_dev_server'))"` — True
6. Framework detection correctly identifies 4 frameworks + 3 fallback scenarios
</verification>

<success_criteria>
- start_dev_server() exists on E2BSandboxRuntime and is called in both execute_build and execute_iteration_build
- _detect_framework() correctly identifies Next.js (3000), Vite (5173), CRA (3000), Express (3000) and falls back sanely
- _wait_for_dev_server() polls with httpx until non-5xx or 120s timeout
- npm install runs before dev server start with 300s timeout and network retry
- Preview URL returned from start_dev_server is the actual URL stored in build result (not a dead unpolled URL)
- 7 framework detection tests pass
- All existing tests still pass (test_generation_service.py and test_iteration_build.py)
</success_criteria>

<output>
After completion, create `.planning/phases/28-sandbox-runtime-fixes/28-02-SUMMARY.md`
</output>
