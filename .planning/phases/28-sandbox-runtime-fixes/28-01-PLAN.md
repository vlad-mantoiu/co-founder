---
phase: 28-sandbox-runtime-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/sandbox/e2b_runtime.py
  - backend/app/services/generation_service.py
  - backend/tests/services/test_generation_service.py
  - backend/tests/services/test_iteration_build.py
autonomous: true
requirements:
  - SBOX-01
  - SBOX-03
  - SBOX-04

must_haves:
  truths:
    - "All E2B sandbox calls are async-native — no run_in_executor wrappers remain"
    - "Generated files contain actual content, not empty strings"
    - "set_timeout is awaited after sandbox.start() and sandbox.connect()"
    - "beta_pause() method exists on E2BSandboxRuntime (ready for Phase 32 SBOX-04 to call)"
    - "Existing tests pass with the updated FakeSandboxRuntime"
  artifacts:
    - path: "backend/app/sandbox/e2b_runtime.py"
      provides: "AsyncSandbox-based runtime with all methods as native coroutines, including beta_pause()"
      contains: "from e2b_code_interpreter import AsyncSandbox"
    - path: "backend/app/services/generation_service.py"
      provides: "Corrected file write key and awaited set_timeout calls"
      contains: "new_content"
    - path: "backend/tests/services/test_generation_service.py"
      provides: "Updated FakeSandboxRuntime matching new async interface"
  key_links:
    - from: "backend/app/sandbox/e2b_runtime.py"
      to: "e2b_code_interpreter.AsyncSandbox"
      via: "import and AsyncSandbox.create()"
      pattern: "await AsyncSandbox\\.create"
    - from: "backend/app/services/generation_service.py"
      to: "backend/app/sandbox/e2b_runtime.py"
      via: "sandbox_runtime_factory() returns E2BSandboxRuntime"
      pattern: "await sandbox\\.set_timeout"
    - from: "backend/app/services/generation_service.py"
      to: "backend/app/agent/state.py"
      via: "FileChange TypedDict key alignment"
      pattern: 'file_change\.get\("new_content"'
---

<objective>
Migrate E2BSandboxRuntime from sync Sandbox to async-native AsyncSandbox, fix the FileChange key mismatch bug that causes all generated files to be written as empty strings, and add the beta_pause() method for Phase 32 (SBOX-04).

Purpose: The sync Sandbox wrapped in run_in_executor blocks the event loop for concurrent builds, and the "content" vs "new_content" key mismatch means zero file content reaches the sandbox. Both bugs make the entire build pipeline non-functional. The beta_pause() method must exist on the runtime so Phase 32 can call it (per locked decision: "Use explicit beta_pause() — never auto_pause=True").

Output: A fully async E2BSandboxRuntime (with beta_pause), corrected file writes in generation_service.py, and passing tests in both test_generation_service.py and test_iteration_build.py.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/sandbox/e2b_runtime.py
@backend/app/services/generation_service.py
@backend/app/agent/state.py
@backend/tests/services/test_generation_service.py
@backend/tests/services/test_iteration_build.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix FileChange key mismatch and migrate E2BSandboxRuntime to AsyncSandbox</name>
  <files>
    backend/app/sandbox/e2b_runtime.py
    backend/app/services/generation_service.py
  </files>
  <action>
**Part A: Fix SBOX-03 — FileChange key mismatch (do this first, it's a 2-line fix)**

In `backend/app/services/generation_service.py`, find both occurrences of:
```python
content = file_change.get("content", "") if isinstance(file_change, dict) else str(file_change)
```

Change `"content"` to `"new_content"` in both locations:
1. Line ~109 inside `execute_build()` — the initial build file write loop
2. Line ~255 inside `execute_iteration_build()` — the iteration build file write loop
3. Line ~279 inside `execute_iteration_build()` — the rollback file write loop (same bug)

The `FileChange` TypedDict in `app/agent/state.py` defines the key as `new_content` (line 25). The current code reads `content` which always returns the empty-string fallback.

**Part B: SBOX-01 — AsyncSandbox migration of e2b_runtime.py**

Replace the entire `E2BSandboxRuntime` class in `backend/app/sandbox/e2b_runtime.py`:

1. Change import from `from e2b_code_interpreter import Sandbox` to `from e2b_code_interpreter import AsyncSandbox`

2. Update `__init__`:
   - Type hint: `self._sandbox: AsyncSandbox | None = None`
   - Use `dict[str, any]` for `_background_processes` (keep as-is)

3. Update `start()`: Replace `run_in_executor(None, Sandbox.create)` with `self._sandbox = await AsyncSandbox.create()`

4. Update `connect()`: Replace `run_in_executor(None, lambda: Sandbox.connect(sandbox_id))` with `self._sandbox = await AsyncSandbox.connect(sandbox_id)`

5. Update `stop()`: Replace `run_in_executor(None, self._sandbox.kill)` with `await self._sandbox.kill()`

6. Update `write_file()`: Replace `run_in_executor(None, lambda: self._sandbox.files.write(...))` with `await self._sandbox.files.write(abs_path, content)`

7. Update `read_file()`: Replace `run_in_executor(None, lambda: self._sandbox.files.read(...))` with direct `await self._sandbox.files.read(abs_path)`

8. Update `list_files()`: Replace `run_in_executor(None, lambda: self._sandbox.files.list(...))` with `await self._sandbox.files.list(abs_path)`

9. Update `make_dir()`: Replace `run_in_executor(None, lambda: self._sandbox.files.make_dir(...))` with `await self._sandbox.files.make_dir(abs_path)`

10. Update `run_command()`: Replace `run_in_executor` wrapper with direct `await self._sandbox.commands.run(command, timeout=float(timeout), cwd=work_dir)`. Note: timeout must be float.

11. Update `run_background()`: Replace `run_in_executor` with `await self._sandbox.commands.run(command, background=True, cwd=work_dir)`

12. Update `get_process_output()`: Replace `run_in_executor(None, self._sandbox.commands.list)` with `await self._sandbox.commands.list()`

13. Update `kill_process()`: Replace `run_in_executor(None, lambda: self._sandbox.commands.kill(int(pid)))` with `await self._sandbox.commands.kill(int(pid))`

14. Add a new public method `set_timeout()`:
```python
async def set_timeout(self, seconds: int) -> None:
    """Extend sandbox lifetime. Must be awaited (class_method_variant)."""
    if not self._sandbox:
        return
    await self._sandbox.set_timeout(seconds)
```

15. Add a public method `beta_pause()` — per locked decision "Use explicit `beta_pause()` — never `auto_pause=True`". This method is NOT called in Phase 28; it exists so Phase 32 (SBOX-04: Sandbox Snapshot Lifecycle) can call it. Wrap in try/except for Hobby plan compatibility per RESEARCH.md:
```python
async def beta_pause(self) -> None:
    """Pause (snapshot) the sandbox for later reconnection via connect().

    Per locked decision: always use explicit beta_pause(), never auto_pause=True
    (E2B #884 bug: file loss on multi-resume).

    Wraps in try/except because E2B Hobby plan does not support pause —
    if it fails, logs a warning and returns without raising.
    """
    if not self._sandbox:
        return
    try:
        await self._sandbox.beta_pause()
    except Exception as e:
        import logging
        logging.getLogger(__name__).warning(
            "beta_pause() failed (may be unsupported on Hobby tier): %s", e
        )
```

16. Add a public property `sandbox_id`:
```python
@property
def sandbox_id(self) -> str | None:
    """Return the sandbox ID for reconnection."""
    return self._sandbox.sandbox_id if self._sandbox else None
```

17. Add a public method `get_host()`:
```python
def get_host(self, port: int) -> str:
    """Get the public hostname for a port. Synchronous — no await needed."""
    if not self._sandbox:
        raise SandboxError("Sandbox not started")
    return self._sandbox.get_host(port)
```

18. Update `execute_in_sandbox()` convenience function: Remove `run_in_executor` — it uses `E2BSandboxRuntime` methods which are now natively async, so no changes needed there (it already uses `await`).

19. Remove `import asyncio` from the top of the file — it is no longer needed since all `run_in_executor` / `get_event_loop()` calls are removed.

**Part C: Update generation_service.py to use new public API instead of _sandbox**

In `generation_service.py`, replace all direct `sandbox._sandbox.*` access with public methods:

1. `sandbox._sandbox.set_timeout(3600)` → `await sandbox.set_timeout(3600)` (2 locations: execute_build ~line 102 and execute_iteration_build ~line 227)

2. `sandbox._sandbox.get_host(8080)` → `sandbox.get_host(3000)` (2 locations: execute_build ~line 118 and execute_iteration_build ~line 302). **Change port from 8080 to 3000** per user decision (port 8080 is wrong — Next.js defaults to 3000). The exact port will be refined in Plan 02 with framework detection, but 3000 is the correct default.

3. `sandbox._sandbox.sandbox_id` → `sandbox.sandbox_id` (2 locations: execute_build ~line 120 and execute_iteration_build ~line 303)
  </action>
  <verify>
Run `cd /Users/vladcortex/co-founder/backend && python -c "from app.sandbox.e2b_runtime import E2BSandboxRuntime; print('import ok')"` to verify no syntax errors.

Run `grep -n "run_in_executor" backend/app/sandbox/e2b_runtime.py` — must return zero results.

Run `grep -n 'file_change.get("content"' backend/app/services/generation_service.py` — must return zero results.

Run `grep -n '_sandbox\.' backend/app/services/generation_service.py` — must return zero results (no more private access).

Run `grep -n 'get_host(8080)' backend/app/services/generation_service.py` — must return zero results.
  </verify>
  <done>
E2BSandboxRuntime uses AsyncSandbox with zero run_in_executor calls. generation_service.py reads "new_content" from FileChange dicts. All sandbox access uses public methods. Port default is 3000.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tests to match new async interface</name>
  <files>
    backend/tests/services/test_generation_service.py
    backend/tests/services/test_iteration_build.py
  </files>
  <action>
Update `FakeSandboxRuntime` and `_FakeSandboxInner` in `test_generation_service.py` to match the new public API:

1. Remove the `_FakeSandboxInner` class entirely — generation_service.py no longer accesses `sandbox._sandbox` directly.

2. Update `FakeSandboxRuntime` to add the new public methods:

```python
class FakeSandboxRuntime:
    """Test double for E2BSandboxRuntime — no real network calls."""

    def __init__(self) -> None:
        self.files: dict[str, str] = {}
        self._started = False
        self._sandbox_id = "fake-sandbox-001"
        self._timeout: int | None = None

    async def start(self) -> None:
        self._started = True

    async def stop(self) -> None:
        pass

    async def connect(self, sandbox_id: str) -> None:
        self._sandbox_id = sandbox_id

    async def set_timeout(self, seconds: int) -> None:
        self._timeout = seconds

    async def beta_pause(self) -> None:
        pass  # no-op in tests

    @property
    def sandbox_id(self) -> str | None:
        return self._sandbox_id

    def get_host(self, port: int) -> str:
        return f"{port}-{self._sandbox_id}.e2b.app"

    async def write_file(self, path: str, content: str) -> None:
        self.files[path] = content

    async def run_command(self, cmd: str, **kwargs) -> dict:
        return {"stdout": "ok", "stderr": "", "exit_code": 0}

    async def run_background(self, cmd: str, **kwargs) -> str:
        return "fake-pid-001"
```

3. Update the test assertion in `test_execute_build_success` that checks preview_url:
   - Old: `assert result["preview_url"] == "https://8080-fake-sandbox-001.e2b.app"`
   - New: `assert result["preview_url"] == "https://3000-fake-sandbox-001.e2b.app"`
   (Port changed from 8080 to 3000)

4. Verify `test_execute_build_success` still validates all 5 FSM transitions in order, the 4-field result dict, and that sandbox._started is True.

5. Ensure `test_execute_build_failure_sets_failed` still works — it should since it fails at the runner.run() stage before sandbox access.

6. Update `backend/tests/services/test_iteration_build.py` — this file has its own `_FakeSandboxInner` and `FakeSandboxRuntime` that will break after the 28-01 changes:

   a. Remove the `_FakeSandboxInner` class entirely.

   b. Update `FakeSandboxRuntime` to remove `self._sandbox = _FakeSandboxInner()` from `__init__`. Add these public methods/properties instead:
      - `self._sandbox_id = "fake-iter-sandbox-001"` in `__init__`
      - `async def set_timeout(self, seconds: int) -> None: pass`
      - `async def beta_pause(self) -> None: pass`
      - `@property sandbox_id -> str | None` returning `self._sandbox_id`
      - `def get_host(self, port: int) -> str` returning `f"{port}-{self._sandbox_id}.e2b.app"`

   c. Update `FakeSandboxRuntimeConnectFails` and `FakeSandboxRuntimeCheckFails` — they inherit from `FakeSandboxRuntime` so they inherit the new methods automatically. No changes needed to these subclasses.

   d. Update the preview_url assertion in `test_iteration_build_creates_v0_2`:
      - Old: `assert result["preview_url"] == "https://8080-fake-iter-sandbox-001.e2b.app"`
      - New: `assert result["preview_url"] == "https://3000-fake-iter-sandbox-001.e2b.app"`
  </action>
  <verify>
Run: `cd /Users/vladcortex/co-founder && python -m pytest backend/tests/services/test_generation_service.py -v --tb=short`

All 4 tests must pass:
- test_execute_build_success
- test_execute_build_failure_sets_failed
- test_get_next_build_version_first_build
- test_get_next_build_version_increment

Also run: `cd /Users/vladcortex/co-founder && python -m pytest backend/tests/services/test_iteration_build.py -v --tb=short`

All 4 iteration build tests must pass:
- test_iteration_build_creates_v0_2
- test_iteration_build_sandbox_reconnect_fallback
- test_iteration_build_check_failure_marks_needs_review
- test_iteration_build_timeline_event
  </verify>
  <done>
All generation_service tests (4) and iteration_build tests (4) pass with the updated FakeSandboxRuntime that matches the new public API (including beta_pause). No _FakeSandboxInner needed in either file. Port assertion updated to 3000.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "run_in_executor" backend/app/sandbox/e2b_runtime.py` returns nothing
2. `grep -rn 'file_change.get("content"' backend/app/services/generation_service.py` returns nothing (all changed to "new_content")
3. `grep -rn "_sandbox\." backend/app/services/generation_service.py` returns nothing (all private access removed)
4. `grep -rn "get_host(8080)" backend/app/services/generation_service.py` returns nothing (port 8080 removed)
5. `grep -n "AsyncSandbox" backend/app/sandbox/e2b_runtime.py` confirms AsyncSandbox import and usage
6. `grep -n "beta_pause" backend/app/sandbox/e2b_runtime.py` confirms beta_pause method exists
7. `python -m pytest backend/tests/services/test_generation_service.py -v` — all 4 tests pass
8. `python -m pytest backend/tests/services/test_iteration_build.py -v` — all 4 tests pass
</verification>

<success_criteria>
- Zero `run_in_executor` calls in e2b_runtime.py
- Zero `"content"` key reads from FileChange dicts (all use `"new_content"`)
- Zero `_sandbox.` private accesses in generation_service.py
- Zero port 8080 references in generation_service.py
- All existing tests pass (test_generation_service.py and test_iteration_build.py)
- `set_timeout()` is awaited in both execute_build and execute_iteration_build
- `beta_pause()` method exists on E2BSandboxRuntime (wrapped in try/except for Hobby tier)
</success_criteria>

<output>
After completion, create `.planning/phases/28-sandbox-runtime-fixes/28-01-SUMMARY.md`
</output>
