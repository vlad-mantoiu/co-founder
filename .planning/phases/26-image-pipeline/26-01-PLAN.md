---
phase: 26-image-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - marketing/package.json
  - marketing/package-lock.json
  - marketing/scripts/convert-images.mjs
  - marketing/next.config.ts
  - marketing/public/images/.gitkeep
autonomous: true
requirements:
  - PERF-06

must_haves:
  truths:
    - "Build-time image conversion script exists and converts PNG/JPG to WebP in out/images/"
    - "The script no-ops gracefully when public/images/ is empty"
    - "OG image and logo.png are excluded from conversion"
    - "PNG sources produce lossless WebP; JPG sources produce lossy WebP at quality 87"
    - "next.config.ts no longer contains images: { unoptimized: true }"
    - "npm run build completes successfully with the conversion script in the postbuild chain"
  artifacts:
    - path: "marketing/scripts/convert-images.mjs"
      provides: "Build-time PNG/JPG to WebP conversion"
      min_lines: 50
    - path: "marketing/next.config.ts"
      provides: "Next.js config without unoptimized escape hatch"
      contains: "output: \"export\""
    - path: "marketing/public/images/.gitkeep"
      provides: "Convention directory for source images"
  key_links:
    - from: "marketing/package.json"
      to: "marketing/scripts/convert-images.mjs"
      via: "postbuild script chain"
      pattern: "node scripts/convert-images\\.mjs"
    - from: "marketing/scripts/convert-images.mjs"
      to: "sharp"
      via: "import"
      pattern: "import sharp from 'sharp'"
---

<objective>
Build-time image conversion pipeline using sharp

Purpose: Establish the build infrastructure that automatically converts PNG/JPG source images in `public/images/` to optimized WebP in `out/images/` during every build. This is primarily future-proofing infrastructure — the marketing site currently has zero images in `public/images/`, so the script must no-op gracefully when empty.

Output: `convert-images.mjs` script wired into postbuild, sharp installed as devDependency, `images: { unoptimized: true }` removed from next.config.ts, `public/images/.gitkeep` committed.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-image-pipeline/26-RESEARCH.md

@marketing/package.json
@marketing/next.config.ts
@marketing/scripts/validate-jsonld.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sharp and create convert-images.mjs script</name>
  <files>
    marketing/package.json
    marketing/package-lock.json
    marketing/scripts/convert-images.mjs
    marketing/public/images/.gitkeep
  </files>
  <action>
1. Install sharp as a devDependency:
   ```bash
   cd marketing && npm install --save-dev sharp
   ```
   Commit the updated package.json AND package-lock.json (lock file includes platform-specific binaries).

2. Create `marketing/public/images/.gitkeep` — empty file to establish the convention directory for source images.

3. Create `marketing/scripts/convert-images.mjs` — ES module script using sharp:

   **Source directory:** `public/images/` (relative to `process.cwd()`)
   **Output directory:** `out/images/` (relative to `process.cwd()`)
   **Excluded files (basename match):** `logo.png`, `opengraph-image.png` (belt-and-suspenders; these are not in `public/images/` anyway)
   **Extension mapping (per locked decision):**
   - `.png` → `sharp(input).webp({ lossless: true }).toFile(output)` — lossless for logos/icons
   - `.jpg` / `.jpeg` → `sharp(input).webp({ quality: 87, effort: 4 }).toFile(output)` — lossy at 87 (midpoint of locked 85-90 range)

   **Behavior:**
   - Use `readdir` with `{ withFileTypes: true, recursive: true }` (Node 18.17+) to find all `.png/.jpg/.jpeg` files in `public/images/`
   - If `public/images/` does not exist or is empty, print "Image pipeline: no images in public/images/ — skipping" and `process.exit(0)` (graceful no-op)
   - For each image: create output subdirectory with `mkdir(dir, { recursive: true })`, convert, print progress
   - On any conversion error: print error and increment fail counter
   - If any conversions failed: print "Image pipeline FAILED — N error(s)" and `process.exit(1)` (fail the build per discretion decision)
   - On success: print "Image pipeline: N image(s) converted successfully"

   Reference the exact code pattern from RESEARCH.md Pattern 1 (sharp API verified from official docs).
  </action>
  <verify>
1. `ls marketing/public/images/.gitkeep` — file exists
2. `node -e "require('sharp')"` in marketing/ dir — sharp loads without error
3. `cd marketing && node scripts/convert-images.mjs` — prints "no images in public/images/ — skipping" and exits 0
4. Test with a real image: create a test PNG, run the script, verify .webp output exists in out/images/
  </verify>
  <done>
convert-images.mjs exists and correctly no-ops when public/images/ is empty. Sharp is installed as devDependency. public/images/.gitkeep exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire postbuild chain and remove images.unoptimized escape hatch</name>
  <files>
    marketing/package.json
    marketing/next.config.ts
  </files>
  <action>
1. Update `marketing/package.json` postbuild script to include the conversion step:
   ```json
   "postbuild": "next-sitemap && node scripts/convert-images.mjs && node scripts/validate-jsonld.mjs"
   ```
   The conversion runs AFTER next-sitemap (needs `out/` to exist from `next build`) and BEFORE validate-jsonld (order does not matter between these two, but this preserves the existing chain with the new step inserted).

2. Remove the `images: { unoptimized: true }` line from `marketing/next.config.ts`. The config should become:
   ```typescript
   import type { NextConfig } from "next";

   const nextConfig: NextConfig = {
     output: "export",
     trailingSlash: true,
     reactStrictMode: true,
   };

   export default nextConfig;
   ```
   This is safe because there are zero `next/image` component usages in the marketing codebase (confirmed by grep in research). The `unoptimized: true` flag is only required when `next/image` is imported in a static export. Removing it satisfies PERF-06 success criterion SC4 ("no `images: { unoptimized: true }` escape hatch remains").

3. Run the full build to verify the chain works:
   ```bash
   cd marketing && npm run build
   ```
   Expected: `next build` succeeds, `next-sitemap` generates sitemap, `convert-images.mjs` prints "no images — skipping", `validate-jsonld.mjs` validates JSON-LD schemas. Overall exit 0.
  </action>
  <verify>
1. `grep -c "convert-images" marketing/package.json` returns 1
2. `grep -c "unoptimized" marketing/next.config.ts` returns 0
3. `cd marketing && npm run build` exits 0 — full build with postbuild chain succeeds
  </verify>
  <done>
postbuild chain includes convert-images.mjs. next.config.ts no longer contains images.unoptimized. Full build passes clean.
  </done>
</task>

</tasks>

<verification>
1. `cd marketing && npm run build` — exits 0, postbuild chain completes
2. Build output includes "Image pipeline: no images in public/images/ — skipping"
3. `grep "unoptimized" marketing/next.config.ts` returns nothing
4. `grep "convert-images" marketing/package.json` returns the postbuild line
5. `ls marketing/public/images/.gitkeep` — file exists
6. `cat marketing/scripts/convert-images.mjs | grep "lossless: true"` — lossless mode for PNG
7. `cat marketing/scripts/convert-images.mjs | grep "quality: 87"` — lossy quality 87 for JPG
</verification>

<success_criteria>
- sharp is installed as devDependency in marketing/package.json
- convert-images.mjs exists with correct no-op behavior and extension-mapped quality settings
- postbuild chain: next-sitemap → convert-images → validate-jsonld
- images.unoptimized removed from next.config.ts
- public/images/.gitkeep committed
- Full `npm run build` passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/26-image-pipeline/26-01-SUMMARY.md`
</output>
