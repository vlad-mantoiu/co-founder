---
phase: 26-image-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/lib/marketing-stack.ts
  - .github/workflows/deploy-marketing.yml
autonomous: true
requirements:
  - PERF-07

must_haves:
  truths:
    - "CloudFront has an images/* additional behavior with 1-year TTL cache policy"
    - "S3 sync in deploy pipeline excludes images/ from the main sync and handles images separately with Cache-Control immutable header"
    - "The images/* behavior reuses the existing assetCachePolicy (365-day TTL)"
    - "The deploy pipeline syncs images with Cache-Control: public, max-age=31536000, immutable"
  artifacts:
    - path: "infra/lib/marketing-stack.ts"
      provides: "CloudFront images/* additional behavior"
      contains: "'images/*'"
    - path: ".github/workflows/deploy-marketing.yml"
      provides: "Multi-pass S3 sync with per-type cache headers"
      contains: "--cache-control"
  key_links:
    - from: "infra/lib/marketing-stack.ts"
      to: "assetCachePolicy"
      via: "images/* behavior reusing existing cache policy"
      pattern: "images/\\*.*assetCachePolicy"
    - from: ".github/workflows/deploy-marketing.yml"
      to: "s3://getinsourced-marketing/images/"
      via: "second aws s3 sync pass"
      pattern: "s3 sync.*images/"
---

<objective>
CloudFront image cache behavior and deploy pipeline update

Purpose: Add a CloudFront `images/*` additional behavior with 1-year immutable cache (reusing the existing `assetCachePolicy`) and update the deploy pipeline to use multi-pass S3 sync so images get long-lived `Cache-Control` headers while HTML and other assets remain unaffected.

Output: Updated `marketing-stack.ts` with `images/*` behavior, updated `deploy-marketing.yml` with two-pass S3 sync.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-image-pipeline/26-RESEARCH.md

@infra/lib/marketing-stack.ts
@.github/workflows/deploy-marketing.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CloudFront images/* additional behavior in CDK</name>
  <files>
    infra/lib/marketing-stack.ts
  </files>
  <action>
Add an `images/*` entry to the `additionalBehaviors` object in the CloudFront Distribution (section 7 of marketing-stack.ts), alongside the existing `_next/static/*` behavior.

The new behavior:
```typescript
'images/*': {
  origin: s3Origin,
  viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
  cachePolicy: assetCachePolicy,  // reuse existing 365-day TTL policy
  compress: true,
  allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
},
```

Key details:
- Reuse `assetCachePolicy` (already defined: 365-day min/default/max TTL, gzip+brotli compression)
- Do NOT add `functionAssociations` — images do not need www-redirect or URL rewriting
- Do NOT add `responseHeadersPolicy` — images do not need the security headers override (CSP etc. are HTML-relevant)
- Place AFTER the `_next/static/*` entry for readability

After editing, verify the CDK synth works:
```bash
cd /Users/vladcortex/co-founder/infra && npx cdk synth CoFounderMarketing --quiet 2>&1 | tail -5
```
Expected: synthesizes without errors. Do NOT deploy — CDK deploy is a production action reserved for the deploy pipeline or manual trigger.
  </action>
  <verify>
1. `grep "images/\\*" infra/lib/marketing-stack.ts` — pattern exists
2. `grep -A3 "images/\\*" infra/lib/marketing-stack.ts | grep "assetCachePolicy"` — uses correct cache policy
3. `cd infra && npx cdk synth CoFounderMarketing --quiet` exits 0
  </verify>
  <done>
marketing-stack.ts has images/* additional behavior using assetCachePolicy. CDK synth succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update deploy-marketing.yml to multi-pass S3 sync with cache headers</name>
  <files>
    .github/workflows/deploy-marketing.yml
  </files>
  <action>
Replace the single "Sync to S3" step in `.github/workflows/deploy-marketing.yml` with two steps:

**Step 1: "Sync to S3 (HTML + assets)"**
```yaml
- name: Sync to S3 (HTML + assets)
  run: |
    aws s3 sync marketing/out/ s3://${{ env.S3_BUCKET }}/ \
      --delete \
      --exclude "images/*" \
      --region ${{ env.AWS_REGION }}
```
- `--delete` stays on this step — it handles all deletions
- `--exclude "images/*"` prevents this step from touching the images directory (so `--delete` does not remove images that are synced by the next step)

**Step 2: "Sync images to S3 (long-lived cache)"**
```yaml
- name: Sync images to S3 (long-lived cache)
  run: |
    aws s3 sync marketing/out/images/ s3://${{ env.S3_BUCKET }}/images/ \
      --cache-control "public, max-age=31536000, immutable" \
      --region ${{ env.AWS_REGION }}
```
- No `--delete` — deletions handled by first step's directory-level sync
- `--cache-control "public, max-age=31536000, immutable"` — 1-year browser cache, immutable (content-hash or stable filenames)
- If `marketing/out/images/` does not exist (no images in current build), `aws s3 sync` on a non-existent source is a no-op (exits 0)

The "Invalidate CloudFront cache" step stays unchanged after both sync steps.

Verify the YAML is valid:
```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-marketing.yml'))"
```
  </action>
  <verify>
1. `grep -c "s3 sync" .github/workflows/deploy-marketing.yml` returns 2 (two sync steps)
2. `grep "exclude.*images" .github/workflows/deploy-marketing.yml` — first sync excludes images
3. `grep "cache-control" .github/workflows/deploy-marketing.yml` — second sync sets immutable cache
4. `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-marketing.yml'))"` — valid YAML
  </verify>
  <done>
deploy-marketing.yml uses two-pass S3 sync: first pass excludes images (with --delete), second pass syncs images with 1-year immutable cache-control header. Valid YAML.
  </done>
</task>

</tasks>

<verification>
1. `grep "images/\\*" infra/lib/marketing-stack.ts` — CloudFront behavior exists
2. `cd infra && npx cdk synth CoFounderMarketing --quiet` — CDK synth succeeds
3. `grep -c "s3 sync" .github/workflows/deploy-marketing.yml` — returns 2
4. `grep "max-age=31536000, immutable" .github/workflows/deploy-marketing.yml` — cache header present
5. `grep "exclude.*images" .github/workflows/deploy-marketing.yml` — first sync excludes images
6. YAML validation passes
</verification>

<success_criteria>
- CloudFront distribution has `images/*` additional behavior with 365-day cache (assetCachePolicy)
- CDK synth succeeds without errors
- Deploy pipeline uses two-pass S3 sync: main sync excludes images, image sync sets immutable cache headers
- deploy-marketing.yml is valid YAML
</success_criteria>

<output>
After completion, create `.planning/phases/26-image-pipeline/26-02-SUMMARY.md`
</output>
