---
phase: 22.1-end-to-end-flow
plan: "02"
subsystem: api
tags: [python, fastapi, background-tasks, llm, anthropic, runner-real, generation-pipeline, polling]

# Dependency graph
requires:
  - phase: 22.1-01
    provides: "ArtifactType.STRATEGY_GRAPH/MVP_TIMELINE/APP_ARCHITECTURE enum values and Runner protocol methods"
provides:
  - RunnerReal.generate_strategy_graph (verbatim-phrase anchor nodes, 8-12 strategy nodes, LLM-generated)
  - RunnerReal.generate_mvp_timeline (tier-adapted, relative-week milestones, no calendar dates)
  - RunnerReal.generate_app_architecture (plain-English components, cost estimates, managed-service recommendations)
  - finalize_interview auto-creates 3 artifact rows with generation_status="generating" before returning
  - _background_generate_e2e_artifacts: generates all 3 artifacts with 3 silent retries each
  - understanding_service.finalize returns project_id, idea_text, onboarding_answers, tier
  - GET /api/artifacts/project/{project_id}/generation-status polling endpoint
affects:
  - 22.1-03 (frontend display — polls generation-status, renders all 3 artifact types)
  - 22.1-04 (E2E tests — tests background generation flow and retry logic)
  - 22.1-05 (integration — exercises RunnerReal with real Anthropic API)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Pre-create artifact rows before background task — avoids polling race condition (rows exist immediately)"
    - "Silent retry in background task — 3 attempts per artifact, mark failed only on all exhausted"
    - "Return dict enrichment — service returns all fields needed by route without extra DB queries"
    - "Route ordering critical — /project/{project_id}/generation-status placed before /{artifact_id} to avoid path conflict"

key-files:
  created: []
  modified:
    - backend/app/agent/runner_real.py
    - backend/app/api/routes/understanding.py
    - backend/app/services/understanding_service.py
    - backend/app/api/routes/artifacts.py

key-decisions:
  - "Pre-create artifact rows in route (not background task) — finalize route creates 3 rows with generation_status='generating' BEFORE add_task() so frontend polling never gets 'not_started' after finalize returns"
  - "Silent retry in background: 3 attempts per artifact, logs warning only on final failure — user experience unaffected by transient LLM failures"
  - "generate_strategy_graph uses verbatim phrase extraction — anchor nodes use exact founder words, strategy nodes connect them to go-to-market steps"
  - "Tier-based timeline guidance: bootstrapper=8-12w (no-code validation sprint), partner=6-8w, cto_scale=4-6w (compressed, technical team assumed)"
  - "generate_app_architecture always simplified by default — plain English component names, no jargon, managed services (Vercel/Render/Supabase) recommended for all tiers"

patterns-established:
  - "E2E generation pipeline: finalize triggers pre-creation + background task; polling endpoint at /project/{id}/generation-status"
  - "Background artifact retry pattern: max_retries=3, silent per-attempt, log.warning on final failure"
  - "Service return dict enrichment: finalize service returns all downstream data (project_id, idea_text, tier, onboarding_answers) to avoid double-querying"

requirements-completed:
  - E2E-GENERATE
  - E2E-TRIGGER

# Metrics
duration: 15min
completed: 2026-02-21
---

# Phase 22.1 Plan 02: E2E Generation Pipeline Summary

**RunnerReal wired to Anthropic LLM for strategy graph, timeline, and architecture generation with finalize auto-triggering background creation of 3 artifact rows and a polling status endpoint**

## Performance

- **Duration:** ~15 min
- **Started:** 2026-02-20T21:49:47Z
- **Completed:** 2026-02-20T22:04:00Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Implemented 3 RunnerReal LLM generation methods (generate_strategy_graph, generate_mvp_timeline, generate_app_architecture) following the exact existing pattern (create_tracked_llm, COFOUNDER_SYSTEM, _invoke_with_retry, _parse_json_response, silent JSON retry)
- Wired finalize_interview to auto-create 3 artifact rows with generation_status="generating" before launching background task — eliminates polling race condition where frontend could see "not_started" immediately after finalize returns
- Added GET /api/artifacts/project/{project_id}/generation-status polling endpoint (placed before /{artifact_id} route to avoid path conflict) returning per-artifact status with all_complete and any_failed flags
- Extended understanding_service.finalize return dict to include project_id, idea_text, onboarding_answers, and tier — eliminating extra DB queries in the route

## Task Commits

Each task was committed atomically:

1. **Task 1: Implement RunnerReal LLM generation for 3 new artifact types** - `699a44b` (feat)
2. **Task 2: Wire auto-trigger from finalize + generation status endpoint** - `4cba394` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified
- `backend/app/agent/runner_real.py` - Added generate_strategy_graph (verbatim phrases as anchors), generate_mvp_timeline (tier-adapted relative-week timeline), generate_app_architecture (plain-English components with cost estimates)
- `backend/app/api/routes/understanding.py` - Added BackgroundTasks import, UUID import, ArtifactType import; added _background_generate_e2e_artifacts function; modified finalize_interview to pre-create artifact rows and launch background task
- `backend/app/services/understanding_service.py` - Extended finalize() return dict with project_id, idea_text, onboarding_answers, tier
- `backend/app/api/routes/artifacts.py` - Added ArtifactType import; added GET /project/{project_id}/generation-status endpoint before /{artifact_id}

## Decisions Made
- Pre-create artifact rows in the route (not background task): rows exist before add_task() so frontend polling never gets "not_started" after finalize returns. This prevents the race condition documented in Plan 01 research.
- Background task uses 3 silent retries per artifact: log.warning only fires on final failure. User experience is unaffected by transient Anthropic 529/overloaded errors.
- Verbatim phrase extraction in strategy graph: anchor nodes use exact founder words so users immediately recognize their own language in the generated graph.
- Tier-based timeline adaptation embedded in prompt: bootstrapper gets 8-12 weeks with no-code validation sprint; cto_scale gets 4-6 weeks compressed for technical teams.
- generate_app_architecture defaults to "simplified" detail level: plain English component names for non-technical founders regardless of tier.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Pre-existing asyncpg event loop mismatch in test infrastructure caused 40 test failures (all databases connection teardown issues, not logic failures). Confirmed pre-existing by reverting our changes and observing same failures. Scope: out of scope per deviation rules.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Plan 03 (frontend display) can now poll GET /api/artifacts/project/{project_id}/generation-status every 2 seconds
- RunnerReal will be called with real Anthropic API key in production — all 3 methods verified to exist with correct signatures
- RunnerFake still works for all tests (unchanged from Plan 01)
- The 3 artifact types (strategy_graph, mvp_timeline, app_architecture) now have full DB + LLM + polling pipeline

---
*Phase: 22.1-end-to-end-flow*
*Completed: 2026-02-21*
