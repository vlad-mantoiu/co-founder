---
phase: 22.1-end-to-end-flow
plan: 05
type: execute
wave: 3
depends_on:
  - "22.1-02"
  - "22.1-03"
  - "22.1-04"
files_modified:
  - frontend/src/components/generation/GenerationOverlay.tsx
  - frontend/src/components/generation/GuidedWalkthrough.tsx
  - frontend/src/app/(dashboard)/projects/[id]/understanding/page.tsx
  - frontend/src/hooks/useGenerationStatus.ts
autonomous: true
requirements:
  - E2E-OVERLAY
  - E2E-WALKTHROUGH
must_haves:
  truths:
    - "After Understanding finalize, a progress overlay appears showing step-by-step generation ('Analyzing your idea...')"
    - "Overlay polls generation-status endpoint every 2 seconds and updates progress steps"
    - "When all 3 artifacts complete, overlay transitions to guided walkthrough"
    - "Guided walkthrough reveals artifacts one by one ('Here is your Strategy' -> next -> 'Here is your Timeline' -> next -> 'Here is your Architecture')"
    - "User never sees generation failure unless all 3 retries fail"
  artifacts:
    - path: "frontend/src/components/generation/GenerationOverlay.tsx"
      provides: "Step-by-step generation progress UI"
      contains: "Analyzing your idea|Building strategy|Creating timeline"
    - path: "frontend/src/components/generation/GuidedWalkthrough.tsx"
      provides: "Step-through artifact reveal UI"
      contains: "walkthrough.*step|strategy.*timeline.*architecture"
    - path: "frontend/src/hooks/useGenerationStatus.ts"
      provides: "Polling hook for generation status"
      contains: "generation-status.*setInterval|polling"
  key_links:
    - from: "frontend/src/hooks/useGenerationStatus.ts"
      to: "/api/artifacts/project/{project_id}/generation-status"
      via: "apiFetch polling every 2 seconds"
      pattern: "apiFetch.*generation-status.*setInterval"
    - from: "frontend/src/components/generation/GenerationOverlay.tsx"
      to: "frontend/src/hooks/useGenerationStatus.ts"
      via: "uses hook for status polling"
      pattern: "useGenerationStatus"
    - from: "frontend/src/app/(dashboard)/projects/[id]/understanding/page.tsx"
      to: "frontend/src/components/generation/GenerationOverlay.tsx"
      via: "shows overlay after finalize succeeds"
      pattern: "GenerationOverlay|showGeneration"
---

<objective>
Build the generation progress overlay and guided walkthrough UI that appears after Understanding finalize. The user sees their artifacts being generated step by step, then walks through each one.

Purpose: This is the emotional payoff — the "wow" moment where the founder sees the AI transforming their answers into real artifacts. The step-by-step progress builds anticipation, and the guided walkthrough reveals each artifact with context rather than dumping everything at once.

Output: GenerationOverlay component, GuidedWalkthrough component, useGenerationStatus polling hook, integration into understanding page.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22.1-end-to-end-flow-strategy-graph-timeline-architecture-from-real-data/22.1-02-SUMMARY.md
@.planning/phases/22.1-end-to-end-flow-strategy-graph-timeline-architecture-from-real-data/22.1-03-SUMMARY.md
@.planning/phases/22.1-end-to-end-flow-strategy-graph-timeline-architecture-from-real-data/22.1-04-SUMMARY.md
@frontend/src/app/(dashboard)/projects/[id]/understanding/page.tsx
@frontend/src/hooks/useUnderstandingInterview.ts
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generation status polling hook and progress overlay</name>
  <files>
    frontend/src/hooks/useGenerationStatus.ts
    frontend/src/components/generation/GenerationOverlay.tsx
  </files>
  <action>
    **Create `frontend/src/hooks/useGenerationStatus.ts`:**
    ```typescript
    "use client";
    import { useState, useEffect, useRef, useCallback } from "react";
    import { useAuth } from "@clerk/nextjs";
    import { apiFetch } from "@/lib/api";

    interface ArtifactStatus {
      status: "not_started" | "generating" | "idle" | "failed";
      has_content: boolean;
    }

    interface GenerationStatus {
      artifacts: Record<string, ArtifactStatus>;
      all_complete: boolean;
      any_failed: boolean;
    }

    export function useGenerationStatus(projectId: string | null) {
      const { getToken } = useAuth();
      const [status, setStatus] = useState<GenerationStatus | null>(null);
      const [polling, setPolling] = useState(false);
      const intervalRef = useRef<NodeJS.Timeout | null>(null);

      const startPolling = useCallback(() => { setPolling(true); }, []);
      const stopPolling = useCallback(() => {
        setPolling(false);
        if (intervalRef.current) clearInterval(intervalRef.current);
      }, []);

      useEffect(() => {
        if (!polling || !projectId) return;
        const poll = async () => {
          try {
            const res = await apiFetch(
              `/api/artifacts/project/${projectId}/generation-status`,
              getToken
            );
            if (res.ok) {
              const data: GenerationStatus = await res.json();
              setStatus(data);
              if (data.all_complete || data.any_failed) {
                stopPolling();
              }
            }
          } catch { /* non-fatal */ }
        };
        poll(); // immediate first poll
        intervalRef.current = setInterval(poll, 2000);
        return () => { if (intervalRef.current) clearInterval(intervalRef.current); };
      }, [polling, projectId, getToken, stopPolling]);

      return { status, startPolling, stopPolling, isPolling: polling };
    }
    ```

    **Create `frontend/src/components/generation/GenerationOverlay.tsx`:**
    A full-screen overlay (fixed inset-0 z-50) that shows generation progress:

    Props:
    ```typescript
    interface GenerationOverlayProps {
      projectId: string;
      onComplete: () => void;  // called when all artifacts are generated
      onFailed: () => void;    // called when generation fails after retries
    }
    ```

    The overlay has 3 phases:

    **Phase 1: Generating (while artifacts are being created)**
    - Dark semi-transparent backdrop (bg-black/80 backdrop-blur-sm)
    - Centered card with:
      - Animated brain/sparkle icon at top
      - Title: "Analyzing your idea..."
      - 3 step indicators, each mapping to an artifact type:
        1. "Building your strategy..." (strategy_graph)
        2. "Creating your timeline..." (mvp_timeline)
        3. "Designing your architecture..." (app_architecture)
      - Each step shows: spinner when generating, green checkmark when idle, red X when failed
      - Step labels update as each artifact completes:
        - Before: "Building your strategy..." with spinner
        - After: "Strategy built" with check icon
      - Subtle animated dots or pulse to show activity

    **Phase 2: Complete (all_complete = true)**
    - Steps all show green checks
    - Title changes to "Your plan is ready!"
    - "See your results" button appears with brand styling
    - Button click calls `onComplete()`

    **Phase 3: Failed (any_failed = true after all_complete is false and polling stops)**
    - Show which artifacts failed with red styling
    - Title: "Some artifacts couldn't be generated"
    - "Continue anyway" button calls `onComplete()` (still navigate — show whatever succeeded)

    Use `useGenerationStatus` hook for polling. Call `startPolling()` on mount.
    Use framer-motion for smooth transitions between phases (AnimatePresence).
  </action>
  <verify>
    Run: `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | head -20`
    TypeScript compiles. Both files exist at correct paths.
  </verify>
  <done>useGenerationStatus hook polls every 2 seconds and auto-stops when complete or failed. GenerationOverlay shows 3-step progress with animated transitions. Steps update in real-time as each artifact completes.</done>
</task>

<task type="auto">
  <name>Task 2: Guided walkthrough and understanding page integration</name>
  <files>
    frontend/src/components/generation/GuidedWalkthrough.tsx
    frontend/src/app/(dashboard)/projects/[id]/understanding/page.tsx
  </files>
  <action>
    **Create `frontend/src/components/generation/GuidedWalkthrough.tsx`:**

    A step-through component that reveals each artifact one at a time:

    Props:
    ```typescript
    interface WalkthroughStep {
      title: string;
      description: string;
      href: string;    // link to the full artifact page
      icon: React.ReactNode;
      preview?: React.ReactNode;  // optional preview content
    }

    interface GuidedWalkthroughProps {
      projectId: string;
      steps: WalkthroughStep[];
      onComplete: () => void;  // called when user finishes walkthrough
    }
    ```

    The walkthrough is a modal/overlay that shows one step at a time:

    - Step indicator: 3 dots at top showing current position (1/3, 2/3, 3/3)
    - Current step shows:
      - Large icon
      - Title (e.g., "Here's your Strategy")
      - Description (e.g., "We analyzed your idea and organized your key concepts into a strategic plan. Your exact words appear as anchor points.")
      - "View full Strategy" link button
      - "Next" button to advance
    - On last step, "Next" becomes "Go to Dashboard" which calls `onComplete()`
    - Animated slide transitions between steps (framer-motion)

    The 3 steps are:
    1. Strategy: icon=GitBranch, title="Here's your Strategy", desc="We analyzed your idea and organized your key concepts into a strategic plan. Your own words appear as anchor points in the graph.", href=`/projects/${projectId}/strategy`
    2. Timeline: icon=Clock, title="Here's your Timeline", desc="Your personalized MVP launch plan with concrete deliverables for each milestone. Adapted to your experience level and resources.", href=`/projects/${projectId}/timeline`
    3. Architecture: icon=Layers, title="Here's your Architecture", desc="The recommended tech stack for your idea, with cost estimates and alternatives. Simplified for clarity.", href=`/projects/${projectId}/architecture`

    **In understanding page.tsx:**

    The understanding page uses a `uiPhase` state machine (defined ~line 99). Current phases: `"interview" | "gate_open" | "plan_selection" | "plan_selected" | "parked"`. The `state.phase === "viewing_brief"` block renders at ~line 265 when `uiPhase === "interview"`.

    Concrete wiring steps:

    1. Import `GenerationOverlay` and `GuidedWalkthrough` from `@/components/generation/`
    2. Extend the `uiPhase` type to add two new phases:
       ```typescript
       const [uiPhase, setUiPhase] = useState<
         "interview" | "gate_open" | "plan_selection" | "plan_selected" | "parked" | "generating" | "walkthrough"
       >("interview");
       ```
    3. When `state.phase` transitions to `"viewing_brief"` (finalize succeeded), set `showGenerationOverlay = true`. Specifically: at the `viewing_brief` render block (~line 265), add a "Continue" button that calls `setUiPhase("generating")` to transition from the brief view to the generation overlay.
    4. Add a render block for `uiPhase === "generating"`:
       ```tsx
       {uiPhase === "generating" && (
         <GenerationOverlay
           projectId={projectId}
           onComplete={() => setUiPhase("walkthrough")}
           onFailed={() => setUiPhase("walkthrough")}
         />
       )}
       ```
    5. Add a render block for `uiPhase === "walkthrough"`:
       ```tsx
       {uiPhase === "walkthrough" && (
         <GuidedWalkthrough
           projectId={projectId}
           steps={[/* 3 steps defined above */]}
           onComplete={() => router.push(`/projects/${projectId}`)}
         />
       )}
       ```
    6. Place both new render blocks after the existing `uiPhase === "parked"` block (~line 378+), following the existing pattern of conditional renders keyed on `uiPhase`.
  </action>
  <verify>
    Run: `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | head -20`
    TypeScript compiles. Both new components exist. Understanding page imports and renders them.
  </verify>
  <done>GuidedWalkthrough steps through 3 artifacts one by one with smooth transitions. Understanding page shows GenerationOverlay after finalize, then transitions to walkthrough. User never sees generation failure unless all retries fail — walkthrough shows whatever succeeded.</done>
</task>

</tasks>

<verification>
- After finalize_interview succeeds, the generation overlay appears automatically
- Overlay shows 3 steps updating in real-time as each artifact completes
- When all complete, overlay transitions to "Your plan is ready!"
- Guided walkthrough reveals Strategy -> Timeline -> Architecture one by one
- Each walkthrough step links to the full artifact page
- Walkthrough completes by navigating to project dashboard
- If generation partially fails, user still sees walkthrough with available artifacts
</verification>

<success_criteria>
The complete "wow" experience works: Understanding finalize -> generation progress overlay -> guided walkthrough of 3 personalized artifacts. The user sees "Analyzing your idea... Building strategy... Creating timeline... Designing architecture..." with real-time progress, then walks through each result with context. No raw errors are ever shown to the user.
</success_criteria>

<output>
After completion, create `.planning/phases/22.1-end-to-end-flow-strategy-graph-timeline-architecture-from-real-data/22.1-05-SUMMARY.md`
</output>
