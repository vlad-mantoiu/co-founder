---
phase: 31-preview-iframe
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/api/routes/generation.py
  - backend/tests/test_preview_check.py
autonomous: true
requirements: [PREV-04]

must_haves:
  truths:
    - "Backend proxy endpoint checks X-Frame-Options on the sandbox preview URL and returns embeddability status"
    - "When X-Frame-Options is DENY or SAMEORIGIN, the response indicates iframe embedding is blocked"
  artifacts:
    - path: "backend/app/api/routes/generation.py"
      provides: "GET /api/generation/{job_id}/preview-check endpoint"
      contains: "preview-check"
    - path: "backend/tests/test_preview_check.py"
      provides: "Tests for preview-check endpoint"
      contains: "test_preview_check"
  key_links:
    - from: "backend/app/api/routes/generation.py"
      to: "frontend usePreviewPane hook"
      via: "REST API response with embeddable boolean"
      pattern: "preview.check"
---

<objective>
Create a backend proxy endpoint that performs a HEAD request to the sandbox preview URL and reports whether the iframe will be blocked by X-Frame-Options headers.

Purpose: Browsers cannot read cross-origin response headers (CORS blocks it). The only reliable way to detect if an E2B sandbox app sends X-Frame-Options: SAMEORIGIN (which Next.js does by default) is a server-side HEAD request. This endpoint gives the frontend a pre-check before rendering the iframe.
Output: `GET /api/generation/{job_id}/preview-check` endpoint that returns `{ embeddable: bool, preview_url: str, reason: str | null }`.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-preview-iframe/31-RESEARCH.md

Key files:
@backend/app/api/routes/generation.py
@backend/app/core/auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preview-check proxy endpoint with HEAD request and X-Frame-Options detection</name>
  <files>
    backend/app/api/routes/generation.py
    backend/tests/test_preview_check.py
  </files>
  <action>
**Backend — generation.py:**

1. Add a new Pydantic response model:
   ```python
   class PreviewCheckResponse(BaseModel):
       """Response for GET /api/generation/{job_id}/preview-check."""
       embeddable: bool
       preview_url: str
       reason: str | None = None
   ```

2. Add the endpoint after the existing cancel endpoint:
   ```python
   @router.get("/{job_id}/preview-check", response_model=PreviewCheckResponse)
   async def check_preview_embeddable(
       job_id: str,
       user: ClerkUser = Depends(require_auth),
       redis=Depends(get_redis),
   ):
   ```

3. Endpoint logic:
   - Get job from Redis via `JobStateMachine(redis).get_job(job_id)`
   - Verify ownership (`user_id` match) — 404 if not
   - Extract `preview_url` from `job_data.get("preview_url")` — 404 "No preview URL available" if None
   - Perform HEAD request using `httpx.AsyncClient(timeout=10.0, verify=False)`:
     - `await client.head(preview_url)` inside a try/except
     - On success: check response headers for `X-Frame-Options`
       - If header value is `DENY` or `SAMEORIGIN` (case-insensitive): `embeddable=False, reason="X-Frame-Options: {value}"`
       - Also check `Content-Security-Policy` header for `frame-ancestors` directive that would block embedding
       - Otherwise: `embeddable=True, reason=None`
     - On `httpx.ConnectError` or `httpx.TimeoutException`: `embeddable=False, reason="Sandbox unreachable (may have expired)"`
     - On any other exception: `embeddable=False, reason="Unable to verify preview"`
   - Add `import httpx` at the top of the file (httpx is already a project dependency, used in e2b_runtime.py)

**Tests — test_preview_check.py:**

4. Create `backend/tests/test_preview_check.py` with tests:
   - `test_preview_check_embeddable` — mock httpx HEAD returning 200 with no X-Frame-Options → embeddable=True
   - `test_preview_check_blocked_xframe` — mock httpx HEAD returning 200 with X-Frame-Options: SAMEORIGIN → embeddable=False, reason contains "X-Frame-Options"
   - `test_preview_check_sandbox_expired` — mock httpx HEAD raising ConnectError → embeddable=False, reason contains "unreachable"
   - `test_preview_check_no_preview_url` — job exists but has no preview_url → 404
   - `test_preview_check_not_found` — job doesn't exist → 404

   Use `unittest.mock.patch("httpx.AsyncClient.head")` or `unittest.mock.AsyncMock` to mock the HTTP calls. Use the existing test patterns from `backend/tests/` — override `require_auth` dependency with a mock user, set up Redis job data with `state_machine.transition()` or direct `hset`.

   Note: The test file should follow the same pattern as other route tests in the project:
   - Use `@pytest.fixture` for `client` (httpx.AsyncClient with the FastAPI app)
   - Override `require_auth` via `app.dependency_overrides`
   - Use `get_redis` fixture for Redis access
  </action>
  <verify>
- `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/test_preview_check.py -x -q --tb=short` — all 5 tests pass
- `grep -n "preview-check" backend/app/api/routes/generation.py` — endpoint exists
- `grep -n "PreviewCheckResponse" backend/app/api/routes/generation.py` — response model defined
- `grep -n "X-Frame-Options" backend/app/api/routes/generation.py` — header check logic present
  </verify>
  <done>
preview-check endpoint performs server-side HEAD request to sandbox URL, detects X-Frame-Options DENY/SAMEORIGIN, returns {embeddable, preview_url, reason}. All 5 tests pass. Frontend can call this before rendering iframe to decide between iframe and fallback card.
  </done>
</task>

</tasks>

<verification>
- GET /api/generation/{job_id}/preview-check endpoint registered and functional
- HEAD request to sandbox URL performed server-side (bypasses CORS)
- X-Frame-Options detection works (DENY, SAMEORIGIN → blocked)
- Timeout/connection errors → graceful "unreachable" response (not 500)
- Auth required (401 without token)
- Ownership verified (404 if not owner)
- All tests pass
</verification>

<success_criteria>
- preview-check endpoint exists at GET /api/generation/{job_id}/preview-check
- Returns {embeddable: bool, preview_url: str, reason: str | null}
- Correctly detects X-Frame-Options blocking
- Handles sandbox expiry (connect timeout) gracefully
- 5 tests pass covering: embeddable, blocked, expired, no-url, not-found
</success_criteria>

<output>
After completion, create `.planning/phases/31-preview-iframe/31-02-SUMMARY.md`
</output>
