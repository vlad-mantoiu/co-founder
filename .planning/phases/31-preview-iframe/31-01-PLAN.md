---
phase: 31-preview-iframe
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/api/routes/generation.py
  - backend/tests/test_generation_routes.py
  - frontend/next.config.ts
autonomous: true
requirements: [PREV-02]

must_haves:
  truths:
    - "GenerationStatusResponse includes sandbox_expires_at ISO8601 string when status is ready"
    - "Next.js app allows iframe embedding of https://*.e2b.app URLs via frame-src CSP directive"
  artifacts:
    - path: "backend/app/api/routes/generation.py"
      provides: "sandbox_expires_at field in GenerationStatusResponse"
      contains: "sandbox_expires_at"
    - path: "frontend/next.config.ts"
      provides: "CSP headers with frame-src for E2B sandbox iframes"
      contains: "frame-src"
  key_links:
    - from: "backend/app/api/routes/generation.py"
      to: "frontend/src/hooks/useBuildProgress.ts"
      via: "REST API JSON response field"
      pattern: "sandbox_expires_at"
---

<objective>
Add sandbox_expires_at to the generation status API response and configure CSP frame-src in Next.js to allow E2B sandbox iframes.

Purpose: Backend must expose when the sandbox expires so the frontend can show expiry warnings. Next.js must allow iframe embedding of E2B sandbox URLs or the browser will block them.
Output: Updated GenerationStatusResponse with sandbox_expires_at, Next.js config with CSP headers including frame-src for *.e2b.app.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-preview-iframe/31-RESEARCH.md

Key files:
@backend/app/api/routes/generation.py
@frontend/next.config.ts
@backend/app/queue/state_machine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sandbox_expires_at to GenerationStatusResponse and CSP frame-src to next.config.ts</name>
  <files>
    backend/app/api/routes/generation.py
    backend/tests/test_generation_routes.py
    frontend/next.config.ts
    frontend/src/hooks/useBuildProgress.ts
  </files>
  <action>
**Backend — generation.py:**

1. Add `sandbox_expires_at: str | None = None` to `GenerationStatusResponse` Pydantic model (after `debug_id`).

2. In `get_generation_status()` endpoint, after extracting `debug_id`, add sandbox expiry calculation:
   - Read `updated_at` from `job_data.get("updated_at")` — this is the ISO8601 timestamp stored by `JobStateMachine.transition()` on every state change.
   - When `status == "ready"` and `updated_at` is not None:
     - Parse `updated_at` with `datetime.fromisoformat(updated_at)`
     - Add `timedelta(seconds=3600)` (E2B sandbox default TTL is 1 hour)
     - Convert back to ISO8601 string: `sandbox_expires_at = expires_dt.isoformat()`
   - Otherwise: `sandbox_expires_at = None`
   - Add `import datetime` at top (from datetime import datetime, timedelta)
   - Pass `sandbox_expires_at=sandbox_expires_at` to the response constructor.

3. Write a test in `backend/tests/test_generation_routes.py` (create if needed, or add to existing test file for generation routes):
   - Test that when a job is in READY state with `updated_at` set, the response includes `sandbox_expires_at` as an ISO8601 string approximately 3600 seconds after `updated_at`.
   - Test that when a job is NOT in READY state, `sandbox_expires_at` is None.

**Frontend — next.config.ts:**

4. Add an `async headers()` function to the Next.js config that returns Content-Security-Policy for all routes:
   ```typescript
   async headers() {
     return [
       {
         source: "/(.*)",
         headers: [
           {
             key: "Content-Security-Policy",
             value: [
               "default-src 'self'",
               "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://clerk.cofounder.getinsourced.ai https://*.clerk.accounts.dev",
               "style-src 'self' 'unsafe-inline'",
               "font-src 'self'",
               "img-src 'self' data: https://*.clerk.com https://img.clerk.com",
               "connect-src 'self' https://api.cofounder.getinsourced.ai https://*.clerk.accounts.dev https://clerk.cofounder.getinsourced.ai",
               "frame-src https://*.e2b.app",
               "worker-src 'self' blob:",
               "child-src 'self' blob:",
               "frame-ancestors 'self'",
             ].join("; "),
           },
         ],
       },
     ];
   },
   ```
   Note: `'unsafe-eval'` is needed for Next.js dev mode. Clerk domains are needed for auth to continue working. The critical addition is `frame-src https://*.e2b.app` which allows E2B sandbox iframes.

**Frontend — useBuildProgress.ts:**

5. Add `sandbox_expires_at?: string | null` to the `GenerationStatusResponse` interface.
6. Add `sandboxExpiresAt: string | null` to the `BuildProgressState` interface (default `null`).
7. Map `data.sandbox_expires_at ?? null` into state in `fetchStatus()`.
8. Return `sandboxExpiresAt` from the hook.
  </action>
  <verify>
- `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/ -x -q --tb=short 2>&1 | tail -20` — all tests pass including new sandbox_expires_at tests
- `cd /Users/vladcortex/co-founder/frontend && npx next build 2>&1 | tail -10` — build succeeds with new headers() config
- `grep -n "sandbox_expires_at" backend/app/api/routes/generation.py` — field exists in response model and endpoint
- `grep -n "frame-src" frontend/next.config.ts` — CSP frame-src directive present
- `grep -n "sandboxExpiresAt" frontend/src/hooks/useBuildProgress.ts` — field exposed from hook
  </verify>
  <done>
GenerationStatusResponse includes sandbox_expires_at (ISO8601, 3600s after ready transition). Next.js CSP allows iframe embedding of *.e2b.app. useBuildProgress exposes sandboxExpiresAt to consuming components. All tests pass.
  </done>
</task>

</tasks>

<verification>
- Backend tests pass (existing + new sandbox_expires_at tests)
- Frontend builds without errors with CSP headers
- sandbox_expires_at appears in API response schema
- frame-src https://*.e2b.app in CSP header value
- useBuildProgress hook returns sandboxExpiresAt field
</verification>

<success_criteria>
- GenerationStatusResponse has sandbox_expires_at: str | None = None
- get_generation_status computes expiry as updated_at + 3600s when status is ready
- next.config.ts has headers() with frame-src https://*.e2b.app
- useBuildProgress exposes sandboxExpiresAt
- All tests pass, frontend builds clean
</success_criteria>

<output>
After completion, create `.planning/phases/31-preview-iframe/31-01-SUMMARY.md`
</output>
