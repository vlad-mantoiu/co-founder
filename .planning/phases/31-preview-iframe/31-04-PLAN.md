---
phase: 31-preview-iframe
plan: "04"
type: execute
wave: 3
depends_on: ["31-01", "31-03"]
files_modified:
  - frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
  - frontend/src/components/build/BuildSummary.tsx
autonomous: false
requirements: [PREV-01, PREV-02, PREV-03, PREV-04]

must_haves:
  truths:
    - "Build success page shows PreviewPane with iframe below build info when status is ready"
    - "PreviewPane appears with browser chrome mockup below the BuildSummary card"
    - "Device toggles in toolbar resize the iframe preview"
    - "Open in new tab icon works from the browser chrome toolbar"
    - "No CSP errors in browser console when loading E2B sandbox iframe"
  artifacts:
    - path: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      provides: "PreviewPane wired into build success state"
      contains: "PreviewPane"
    - path: "frontend/src/components/build/BuildSummary.tsx"
      provides: "Updated summary card (slimmer, above preview)"
      contains: "BuildSummary"
  key_links:
    - from: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      to: "frontend/src/components/build/PreviewPane.tsx"
      via: "Component import and render in success state"
      pattern: "PreviewPane"
    - from: "frontend/src/components/build/PreviewPane.tsx"
      to: "/api/generation/{job_id}/preview-check"
      via: "usePreviewPane hook fetch"
      pattern: "preview-check"
---

<objective>
Wire PreviewPane into the build page success state and update BuildSummary to work as a compact header above the full-width preview. Verify the complete visual experience with a human checkpoint.

Purpose: This is the final integration — a founder sees their running app embedded in the dashboard with browser chrome, device toggles, and all fallback states properly handled.
Output: Updated build page with PreviewPane below BuildSummary, visual verification of the complete preview experience.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-preview-iframe/31-CONTEXT.md

Prior plan SUMMARYs needed:
@.planning/phases/31-preview-iframe/31-01-SUMMARY.md (CSP + sandboxExpiresAt)
@.planning/phases/31-preview-iframe/31-03-SUMMARY.md (PreviewPane + BrowserChrome + usePreviewPane)

Key files:
@frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
@frontend/src/components/build/BuildSummary.tsx
@frontend/src/components/build/PreviewPane.tsx
@frontend/src/hooks/useBuildProgress.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire PreviewPane into build page and update BuildSummary layout</name>
  <files>
    frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
    frontend/src/components/build/BuildSummary.tsx
  </files>
  <action>
**BuildSummary.tsx updates:**

The existing BuildSummary is a full success card with confetti, "Your app is live!" headline, and "Open your app" external link CTA. Now that PreviewPane shows the app inline, BuildSummary should become a compact header above the preview:

1. Keep the confetti trigger on mount (unchanged).
2. Keep the success icon, build version badge, "Your app is live!" headline.
3. Remove the "Open your app" external link button (the BrowserChrome toolbar already has open-in-new-tab).
4. Keep the "View in Dashboard" secondary link.
5. Remove the build details section (fileCount, stack, features) — they clutter above the preview. These can be re-added later if needed.
6. The card should now be more compact — reduce padding from `p-8` to `p-6`, reduce gaps.
7. Remove the `previewUrl` prop from BuildSummaryProps since the external link button is removed. Keep it if still needed for any other purpose, but audit the component — if only used for the CTA, remove it.

Actually, keep `previewUrl` as a prop since it's still useful context, but remove the `<motion.a>` CTA button that opens it externally. The BrowserChrome toolbar handles that now.

**build/page.tsx updates:**

1. Import `PreviewPane` from `@/components/build/PreviewPane`.

2. Update the success state section (currently `{isSuccess && previewUrl && (...)}`):
   - Remove the `max-w-xl` constraint on the outer container. The success state should be full-width (`max-w-4xl` or `max-w-5xl`) to accommodate the preview iframe.
   - Structure the success state as:
     ```
     <BuildSummary ... />    <!-- compact card, centered -->
     <div className="mt-6 w-full">
       <PreviewPane
         previewUrl={previewUrl}
         sandboxExpiresAt={sandboxExpiresAt}
         jobId={jobId}
         projectId={projectId}
         getToken={getToken}
         onRebuild={handleRebuild}
         onIterate={handleIterate}
       />
     </div>
     ```

3. Extract `sandboxExpiresAt` from `useBuildProgress`:
   - Destructure `sandboxExpiresAt` from the hook return value (added in Plan 01).

4. Add `handleRebuild` and `handleIterate` callback functions:
   ```typescript
   function handleRebuild() {
     // Navigate to deploy page to trigger a fresh build
     window.location.href = `/projects/${projectId}/deploy`;
   }

   function handleIterate() {
     // Navigate to conversation/iterate flow
     window.location.href = `/projects/${projectId}/deploy?iterate=true`;
   }
   ```

5. Update the container width logic:
   - The building state uses `max-w-xl` (current — keep).
   - The success state should use `max-w-5xl` to give the preview iframe room.
   - Wrap the AnimatePresence children differently:
     - Building state: keep `<div className="w-full max-w-xl mx-auto px-4">`
     - Success state: use `<div className="w-full max-w-5xl mx-auto px-4">`
   - Move the width constraint inside each AnimatePresence child rather than wrapping all of them.

6. The "Success but no preview URL" edge case should remain as-is (narrow, informational).

7. The failure state should remain narrow (`max-w-xl`).

8. Ensure the production build passes: `npx next build`.
  </action>
  <verify>
- `grep -n "PreviewPane" frontend/src/app/(dashboard)/projects/[id]/build/page.tsx` — component imported and rendered
- `grep -n "sandboxExpiresAt" frontend/src/app/(dashboard)/projects/[id]/build/page.tsx` — prop wired from useBuildProgress
- `grep -n "handleRebuild\|handleIterate" frontend/src/app/(dashboard)/projects/[id]/build/page.tsx` — callbacks defined
- `grep -n "max-w-5xl" frontend/src/app/(dashboard)/projects/[id]/build/page.tsx` — wider container for preview
- `cd /Users/vladcortex/co-founder/frontend && npx next build 2>&1 | tail -10` — build succeeds
  </verify>
  <done>
PreviewPane wired into build page success state with sandboxExpiresAt from useBuildProgress, handleRebuild and handleIterate callbacks. BuildSummary simplified to compact header above preview. Success state uses max-w-5xl for iframe room. Frontend builds clean.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of preview iframe experience</name>
  <files>frontend/src/app/(dashboard)/projects/[id]/build/page.tsx</files>
  <action>
Human visual verification of the complete preview iframe experience. What was built:
- Browser chrome mockup with device toggles, iframe embedding of sandbox apps
- Fallback cards for blocked/expired states
- CSP configuration allowing E2B sandbox iframes
- Full build page integration with PreviewPane below BuildSummary

Steps to verify:
1. Start the frontend dev server: `cd frontend && npm run dev`
2. Navigate to a build page with a completed build: `/projects/{project_id}/build?job_id={job_id}` where the job is in READY state
3. Verify build success layout: BuildSummary card at top, confetti, PreviewPane below
4. Verify browser chrome: three dots, copy URL, device toggles, open-in-new-tab
5. Verify device toggles: desktop (full width), tablet (768px), mobile (375px)
6. Verify no CSP errors in browser console
7. Check console for React errors

Resume signal: Type "approved" to complete Phase 31, or describe any issues to fix.
  </action>
  <verify>Human visually confirms all 7 verification areas pass.</verify>
  <done>Visual verification approved — preview iframe experience meets all design requirements from the context decisions.</done>
</task>

</tasks>

<verification>
- PreviewPane renders in build success state below BuildSummary
- Browser chrome mockup visible with all toolbar elements
- Device toggles functional
- No CSP errors in console
- Build page handles all states (building, success with preview, success without preview, failure)
- TypeScript compiles, production build passes
</verification>

<success_criteria>
- Build success page shows compact BuildSummary + full-width PreviewPane
- Browser chrome looks like a mini browser with functional controls
- Device toggles resize the iframe width smoothly
- No CSP iframe-related errors in browser console
- Human visual verification passes
</success_criteria>

<output>
After completion, create `.planning/phases/31-preview-iframe/31-04-SUMMARY.md`
</output>
