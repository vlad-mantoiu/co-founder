---
phase: 06-artifact-generation-pipeline
plan: 04
type: execute
wave: 4
depends_on: ["06-03"]
files_modified:
  - backend/app/artifacts/templates/base.html
  - backend/app/artifacts/templates/brief.html
  - backend/app/artifacts/templates/mvp_scope.html
  - backend/app/artifacts/templates/milestones.html
  - backend/app/artifacts/templates/risk_log.html
  - backend/app/artifacts/templates/how_it_works.html
  - backend/app/artifacts/templates/combined.html
  - backend/app/artifacts/templates/styles/base.css
  - backend/app/artifacts/templates/styles/brand.css
  - backend/app/artifacts/exporter.py
  - backend/app/api/routes/artifacts.py
  - backend/tests/api/test_artifact_export.py
autonomous: true

must_haves:
  truths:
    - "GET /api/artifacts/{id}/export/pdf returns PDF bytes for a single artifact"
    - "GET /api/artifacts/project/{project_id}/export/pdf returns combined PDF with TOC and all 5 chapters"
    - "PDF has polished deck style: cover page, branded header/footer, section dividers, colored accents"
    - "Bootstrapper PDFs show Co-Founder branding; Partner/CTO get white-label with startup name"
    - "PDF generation runs non-blocking via asyncio.to_thread()"
  artifacts:
    - path: "backend/app/artifacts/exporter.py"
      provides: "PDFExporter with single and combined export"
      contains: "class PDFExporter"
    - path: "backend/app/artifacts/templates/base.html"
      provides: "Jinja2 base template with cover page and branding blocks"
      contains: "{% block content %}"
    - path: "backend/app/artifacts/templates/combined.html"
      provides: "Combined PDF template with TOC"
      contains: "toc"
    - path: "backend/app/artifacts/templates/styles/base.css"
      provides: "CSS with @page rules for headers/footers/page numbers"
      contains: "@page"
  key_links:
    - from: "backend/app/api/routes/artifacts.py"
      to: "backend/app/artifacts/exporter.py"
      via: "Export endpoint calls PDFExporter"
      pattern: "pdf_exporter\\."
    - from: "backend/app/artifacts/exporter.py"
      to: "backend/app/artifacts/templates/"
      via: "Jinja2 FileSystemLoader loads templates"
      pattern: "FileSystemLoader"
---

<objective>
WeasyPrint PDF export with Jinja2 templates for polished, tier-branded artifact documents.

Purpose: Creates the exportable deliverables that founders share with co-founders and advisors. Single artifact PDFs and a combined "Strategy Package" PDF with table of contents. Tier-dependent branding per locked decisions.
Output: Jinja2 templates, CSS styles, PDFExporter class, export API endpoints, tests.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-artifact-generation-pipeline/06-CONTEXT.md
@.planning/phases/06-artifact-generation-pipeline/06-RESEARCH.md
@.planning/phases/06-artifact-generation-pipeline/06-01-SUMMARY.md
@.planning/phases/06-artifact-generation-pipeline/06-02-SUMMARY.md
@.planning/phases/06-artifact-generation-pipeline/06-03-SUMMARY.md
@backend/app/schemas/artifacts.py
@backend/app/artifacts/exporter.py
@backend/app/api/routes/artifacts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Jinja2 templates and CSS styles for PDF generation</name>
  <files>
    backend/app/artifacts/templates/base.html
    backend/app/artifacts/templates/brief.html
    backend/app/artifacts/templates/mvp_scope.html
    backend/app/artifacts/templates/milestones.html
    backend/app/artifacts/templates/risk_log.html
    backend/app/artifacts/templates/how_it_works.html
    backend/app/artifacts/templates/combined.html
    backend/app/artifacts/templates/styles/base.css
    backend/app/artifacts/templates/styles/brand.css
  </files>
  <action>
Create the template directory structure:
```
backend/app/artifacts/templates/
  base.html
  brief.html
  mvp_scope.html
  milestones.html
  risk_log.html
  how_it_works.html
  combined.html
  styles/
    base.css
    brand.css
```

**backend/app/artifacts/templates/base.html** — Jinja2 base template:
- Cover page block: startup_name (h1), document_title (h2), generated_date
- Branding: `{{ branding }}` — "Powered by Co-Founder" for bootstrapper, empty for partner/cto (white-label per locked decision)
- Content block: `{% block content %}{% endblock %}`
- Links to base.css and brand.css
- Meta charset utf-8
- Use CSS custom properties for tier-dependent colors

**Per-artifact templates** (brief.html, mvp_scope.html, etc.):
- Each extends base.html
- Override `{% block document_title %}` with artifact name
- Override `{% block content %}` with sections from the artifact content
- Conditionally render business/strategic sections: `{% if artifact.market_analysis %}` (only present for higher tiers)
- Section dividers between major sections (colored accent lines per locked decision)
- "We" voice preserved in any template text
- Cross-reference callout boxes: styled blockquotes referencing other artifacts (e.g., "As noted in our Product Brief...")

**backend/app/artifacts/templates/combined.html:**
- Does NOT extend base.html (standalone template)
- Cover page with startup name and "Strategy Package" title
- Table of contents with anchor links to each chapter
- Each artifact as a `<section class="chapter">` with page-break-before: always
- Use `bookmark-level` and `bookmark-label` attributes for PDF bookmarks per research Pattern 6
- TOC entries with `target-counter(attr(href), page)` for automatic page numbers

**backend/app/artifacts/templates/styles/base.css:**
- @page rule: Letter size, 2cm margins
- @top-center: document title (using CSS string-set per research Pattern 5)
- @bottom-right: Page N of M using counter(page)/counter(pages)
- @bottom-left: `{{ branding }}` text
- Cover page: suppress headers/footers via @page cover { @top-center { content: none; } }
- Typography: clean sans-serif (system-ui, -apple-system, "Segoe UI"), 11pt body
- Section headers: bold, colored accent (#2563EB primary)
- Tables: alternating row backgrounds for readability
- Risk severity badges: colored labels (red high, amber medium, green low)
- Milestone timeline: styled list with week indicators
- Page-break-inside: avoid on sections
- Page-break-after: avoid on headings
- Font fallback for Unicode: include "Noto Sans" per research pitfall 2

**backend/app/artifacts/templates/styles/brand.css:**
- CSS custom properties for tier branding:
  - `--brand-primary`: color per tier
  - `--brand-accent`: secondary color
  - `--brand-footer`: branding text
- Bootstrapper: Co-Founder blue (#2563EB), "Powered by Co-Founder" footer
- Partner: Neutral professional (#1E293B), no branding footer (white-label per locked decision)
- CTO: Premium dark (#0F172A), no branding footer (white-label per locked decision)
- Cover page styling per tier: bootstrapper gets Co-Founder logo area, partner/cto get startup name prominently

All templates MUST render valid HTML that WeasyPrint can parse. Use only CSS that WeasyPrint 68.1+ supports (no flexbox/grid in paged media — use float/table layouts for compatibility).
  </action>
  <verify>
    ls backend/app/artifacts/templates/base.html backend/app/artifacts/templates/brief.html backend/app/artifacts/templates/combined.html backend/app/artifacts/templates/styles/base.css backend/app/artifacts/templates/styles/brand.css
    All 9 template files exist.
    python -c "from jinja2 import Environment, FileSystemLoader; env = Environment(loader=FileSystemLoader('backend/app/artifacts/templates')); t = env.get_template('brief.html'); print('Template loads OK')"
  </verify>
  <done>
    9 Jinja2 templates created: base, 5 artifact types, combined, and 2 CSS files. All templates load without errors. Templates use conditional tier-gated sections, cross-reference callouts, and WeasyPrint-compatible CSS.
  </done>
</task>

<task type="auto">
  <name>Task 2: PDFExporter and export API endpoints with tests</name>
  <files>
    backend/app/artifacts/exporter.py
    backend/app/api/routes/artifacts.py
    backend/tests/api/test_artifact_export.py
  </files>
  <action>
**First, install WeasyPrint** (check if already in requirements):
```bash
cd /Users/vladcortex/co-founder/backend
# Check pyproject.toml or requirements.txt for weasyprint
# If not present, add: weasyprint>=68.1, jinja2>=3.1.0
# jinja2 is likely already installed (FastAPI dependency)
pip install weasyprint>=68.1
```

If WeasyPrint system dependencies are missing on macOS, note them but do NOT block — tests can skip PDF byte verification if WeasyPrint is unavailable and test template rendering only.

**backend/app/artifacts/exporter.py:**

```python
import asyncio
from pathlib import Path
from uuid import UUID

from jinja2 import Environment, FileSystemLoader

TEMPLATE_DIR = Path(__file__).parent / "templates"

class PDFExporter:
    """Export artifacts as polished PDF documents.

    Uses Jinja2 for HTML templating and WeasyPrint for PDF rendering.
    All PDF generation runs in thread pool via asyncio.to_thread() to avoid
    blocking the event loop (research pitfall 4).
    """

    def __init__(self):
        self.env = Environment(
            loader=FileSystemLoader(str(TEMPLATE_DIR)),
            autoescape=True,
        )

    async def export_single(
        self,
        artifact_type: str,
        content: dict,
        tier: str,
        startup_name: str,
        generated_date: str,
    ) -> bytes:
        """Export a single artifact as PDF.

        Args:
            artifact_type: One of ArtifactType values
            content: Artifact current_content dict
            tier: User's subscription tier (affects branding)
            startup_name: For cover page and headers

        Returns:
            PDF file bytes

        Per locked decisions:
        - Polished deck style with cover page
        - Bootstrapper: Co-Founder branded
        - Partner/CTO: white-label with startup name
        """
        template = self.env.get_template(f"{artifact_type}.html")
        branding = "" if tier in ("partner", "cto_scale") else "Powered by Co-Founder"

        html_content = template.render(
            artifact=content,
            tier=tier,
            startup_name=startup_name,
            branding=branding,
            generated_date=generated_date,
        )

        # Non-blocking PDF generation (research pitfall 4)
        from weasyprint import HTML
        from weasyprint.text.fonts import FontConfiguration
        font_config = FontConfiguration()

        pdf_bytes = await asyncio.to_thread(
            lambda: HTML(string=html_content, base_url=str(TEMPLATE_DIR)).write_pdf(
                font_config=font_config,
            )
        )
        return pdf_bytes

    async def export_combined(
        self,
        artifacts: dict[str, dict],  # {artifact_type: content}
        tier: str,
        startup_name: str,
        generated_date: str,
    ) -> bytes:
        """Export all 5 artifacts as single PDF with table of contents.

        Per locked decisions:
        - One PDF with TOC and all 5 artifacts as chapters
        - Good for sharing with co-founders/advisors
        - Tier-dependent branding
        """
        template = self.env.get_template("combined.html")
        branding = "" if tier in ("partner", "cto_scale") else "Powered by Co-Founder"

        html_content = template.render(
            brief=artifacts.get("brief", {}),
            mvp_scope=artifacts.get("mvp_scope", {}),
            milestones=artifacts.get("milestones", {}),
            risk_log=artifacts.get("risk_log", {}),
            how_it_works=artifacts.get("how_it_works", {}),
            tier=tier,
            startup_name=startup_name,
            branding=branding,
            generated_date=generated_date,
        )

        from weasyprint import HTML
        from weasyprint.text.fonts import FontConfiguration
        font_config = FontConfiguration()

        pdf_bytes = await asyncio.to_thread(
            lambda: HTML(string=html_content, base_url=str(TEMPLATE_DIR)).write_pdf(
                font_config=font_config,
            )
        )
        return pdf_bytes
```

**Add export endpoints to backend/app/api/routes/artifacts.py:**

```python
# GET /api/artifacts/{artifact_id}/export/pdf
@router.get("/{artifact_id}/export/pdf")
async def export_artifact_pdf(
    artifact_id: UUID,
    user=Depends(require_auth),
    session_factory=Depends(get_session_factory_dep),
):
    """Export single artifact as PDF.

    Returns: StreamingResponse with application/pdf content type and
    Content-Disposition: attachment header.
    """
    # 1. Get artifact (user isolation)
    # 2. Get project for startup name
    # 3. Get user_settings for tier
    # 4. Call PDFExporter.export_single()
    # 5. Return StreamingResponse(BytesIO(pdf_bytes), media_type="application/pdf")

# GET /api/artifacts/project/{project_id}/export/pdf
@router.get("/project/{project_id}/export/pdf")
async def export_combined_pdf(
    project_id: UUID,
    user=Depends(require_auth),
    session_factory=Depends(get_session_factory_dep),
):
    """Export all project artifacts as combined PDF with TOC.

    Per locked decision: combined PDF with all 5 chapters.
    Returns: StreamingResponse with application/pdf content type.
    """
    # 1. Get all project artifacts (user isolation)
    # 2. Get project for startup name
    # 3. Get user_settings for tier
    # 4. Call PDFExporter.export_combined()
    # 5. Return StreamingResponse
```

**Tests in backend/tests/api/test_artifact_export.py:**

1. `test_export_single_pdf_returns_bytes` — GET /api/artifacts/{id}/export/pdf returns 200 with content-type application/pdf
2. `test_export_single_pdf_user_isolation` — Other user's artifact returns 404
3. `test_export_single_pdf_not_found` — Unknown ID returns 404
4. `test_export_combined_pdf_returns_bytes` — GET /api/artifacts/project/{id}/export/pdf returns 200 with application/pdf
5. `test_export_combined_pdf_empty_project` — Project with no artifacts returns 404 or empty PDF
6. `test_export_combined_pdf_user_isolation` — Other user's project returns 404
7. `test_pdf_exporter_renders_html_from_template` — Unit test: PDFExporter renders HTML string from Jinja2 template (test HTML output, not PDF bytes — avoids WeasyPrint system dependency in CI)
8. `test_pdf_exporter_tier_branding_bootstrapper` — HTML contains "Powered by Co-Founder"
9. `test_pdf_exporter_tier_branding_partner` — HTML does NOT contain "Powered by Co-Founder" (white-label)

For tests 1-6: If WeasyPrint is not installed (missing system libs), skip PDF byte assertions and only verify HTTP status and headers. Use `pytest.importorskip("weasyprint")` or try/except.

For tests 7-9: Test HTML rendering only (no WeasyPrint needed). Add a `render_html` method to PDFExporter that returns the HTML string before PDF conversion — useful for testing and debugging templates.

Commit: `feat(06-04): add Jinja2 templates and CSS for PDF export` then `feat(06-04): implement PDFExporter and export API endpoints`
  </action>
  <verify>
    cd /Users/vladcortex/co-founder && python -m pytest backend/tests/api/test_artifact_export.py -v
    At minimum: HTML rendering tests (7-9) pass. PDF byte tests (1-6) pass if WeasyPrint is installed.
    python -c "from app.artifacts.exporter import PDFExporter; print('OK')"
  </verify>
  <done>
    PDFExporter renders single and combined PDFs via Jinja2 + WeasyPrint. Templates have polished styling with cover pages, headers/footers, tier branding. Export endpoints return PDF bytes as StreamingResponse. Bootstrapper gets Co-Founder branding, Partner/CTO get white-label. asyncio.to_thread() prevents blocking. All export tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest backend/tests/api/test_artifact_export.py -v` — tests pass
2. `ls backend/app/artifacts/templates/*.html | wc -l` — 7 templates
3. `ls backend/app/artifacts/templates/styles/*.css | wc -l` — 2 CSS files
4. `python -c "from app.artifacts.exporter import PDFExporter; print('OK')"` — exporter importable
</verification>

<success_criteria>
- 7 Jinja2 templates: base + 5 artifact types + combined
- 2 CSS files: base (typography, @page rules) + brand (tier colors)
- PDFExporter with export_single() and export_combined() methods
- Non-blocking PDF generation via asyncio.to_thread()
- Tier-dependent branding: Co-Founder brand for bootstrapper, white-label for partner/cto
- Combined PDF has table of contents and chapter structure
- Export API endpoints with user isolation
- Tests pass (HTML rendering always, PDF bytes when WeasyPrint available)
</success_criteria>

<output>
After completion, create `.planning/phases/06-artifact-generation-pipeline/06-04-SUMMARY.md`
</output>
