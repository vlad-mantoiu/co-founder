---
phase: 06-artifact-generation-pipeline
plan: 05
type: tdd
wave: 4
depends_on: ["06-03"]
files_modified:
  - backend/app/artifacts/markdown_exporter.py
  - backend/app/artifacts/templates/markdown/readable.md.j2
  - backend/app/artifacts/templates/markdown/technical.md.j2
  - backend/app/artifacts/templates/markdown/readable_combined.md.j2
  - backend/app/artifacts/templates/markdown/technical_combined.md.j2
  - backend/app/api/routes/artifacts.py
  - backend/tests/api/test_artifact_markdown_export.py
autonomous: true

must_haves:
  truths:
    - "GET /api/artifacts/{id}/export/markdown?variant=readable returns clean Notion-pasteable markdown"
    - "GET /api/artifacts/{id}/export/markdown?variant=technical returns dev handoff markdown with specs format"
    - "GET /api/artifacts/project/{project_id}/export/markdown returns combined markdown"
    - "Cross-references rendered as text references in readable, as markdown anchors in technical"
    - "User isolation enforced on all export endpoints"
  artifacts:
    - path: "backend/app/artifacts/markdown_exporter.py"
      provides: "MarkdownExporter with readable and technical variants"
      contains: "class MarkdownExporter"
    - path: "backend/app/artifacts/templates/markdown/readable.md.j2"
      provides: "Readable markdown template (Notion-pasteable)"
      contains: "# Product Brief"
    - path: "backend/app/artifacts/templates/markdown/technical.md.j2"
      provides: "Technical markdown template (dev handoff)"
      contains: "## Technical Specifications"
  key_links:
    - from: "backend/app/api/routes/artifacts.py"
      to: "backend/app/artifacts/markdown_exporter.py"
      via: "Export endpoint calls MarkdownExporter"
      pattern: "markdown_exporter\\."
    - from: "backend/app/artifacts/markdown_exporter.py"
      to: "backend/app/artifacts/templates/markdown/"
      via: "Jinja2 loads .md.j2 templates"
      pattern: "FileSystemLoader"
---

<objective>
Markdown export with readable (Notion-pasteable) and technical (dev handoff) variants for artifact documents.

Purpose: Founders export artifacts as Markdown for different audiences. Readable variant pastes cleanly into Notion/Google Docs. Technical variant serves as developer handoff documentation with specs format.
Output: MarkdownExporter, Jinja2 markdown templates (4), export API endpoints, tests.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-artifact-generation-pipeline/06-CONTEXT.md
@.planning/phases/06-artifact-generation-pipeline/06-RESEARCH.md
@.planning/phases/06-artifact-generation-pipeline/06-01-SUMMARY.md
@.planning/phases/06-artifact-generation-pipeline/06-02-SUMMARY.md
@.planning/phases/06-artifact-generation-pipeline/06-03-SUMMARY.md
@backend/app/schemas/artifacts.py
@backend/app/api/routes/artifacts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Markdown templates and MarkdownExporter (RED then GREEN)</name>
  <files>
    backend/app/artifacts/markdown_exporter.py
    backend/app/artifacts/templates/markdown/readable.md.j2
    backend/app/artifacts/templates/markdown/technical.md.j2
    backend/app/artifacts/templates/markdown/readable_combined.md.j2
    backend/app/artifacts/templates/markdown/technical_combined.md.j2
    backend/tests/api/test_artifact_markdown_export.py
  </files>
  <action>
**RED: Write tests first in backend/tests/api/test_artifact_markdown_export.py:**

1. `test_readable_brief_has_clean_headings` — Readable export of brief has "# Product Brief" heading, no code blocks, clean paragraphs
2. `test_readable_brief_no_metadata` — No schema_version, no field IDs, no technical markup
3. `test_technical_brief_has_specs_format` — Technical export has "## Technical Specifications" section, code blocks for data models
4. `test_technical_brief_has_anchors` — Contains markdown anchors like `[See Problem Statement](01-brief.md#problem-statement)`
5. `test_readable_cross_references_as_text` — Cross-refs rendered as "As noted in the Product Brief..." (not links)
6. `test_technical_cross_references_as_links` — Cross-refs rendered as markdown links to other files
7. `test_readable_tier_filtering` — Bootstrapper readable export excludes business/strategic sections
8. `test_combined_readable_has_toc` — Combined readable has table of contents with all 5 document names
9. `test_combined_technical_has_file_links` — Combined technical TOC links to individual files
10. `test_exporter_returns_string` — MarkdownExporter.export_single() returns str, not bytes

Run tests: MUST fail (RED).

**GREEN: Create templates and exporter:**

Create directory: `backend/app/artifacts/templates/markdown/`

**readable.md.j2** — Clean, Notion-pasteable markdown per locked decision:
- `# {Document Title}` (Product Brief, MVP Scope, etc.)
- Clean prose paragraphs, no technical markup
- Bullet lists for list items (features, risks, milestones)
- Cross-references as natural text: "As we outlined in the Product Brief, our core problem is..."
- Conditional tier sections: `{% if artifact.market_analysis %}` renders business sections
- "We" voice preserved from content
- No frontmatter, no metadata, no schema_version
- Suitable for direct paste into Notion, Google Docs, or email

**technical.md.j2** — Dev handoff format per locked decision:
- `# {Document Title}` main heading
- `## Technical Specifications` section with structured data
- Code blocks for data models and schemas where relevant
- Milestone timeline as task list: `- [ ] Week 1: Foundation`
- Risk items with severity badges: `**[HIGH]** Risk title`
- Architecture section with code-formatted technology choices
- Cross-references as markdown links: `[Product Brief - Problem Statement](01-brief.md#problem-statement)`
- Includes frontmatter-style metadata block at top: `artifact_type`, `version`, `generated_date`

**readable_combined.md.j2** — All 5 artifacts in one file:
- Table of contents at top (linked to anchors)
- `---` horizontal rules between chapters
- Each artifact as its own section
- No file-based cross-references (all in one document, use `#anchor` links)

**technical_combined.md.j2** — All 5 artifacts combined, technical format:
- Table of contents with anchor links
- Each artifact section with technical formatting
- Cross-references use `#anchor` format (same document)

**backend/app/artifacts/markdown_exporter.py:**

```python
from pathlib import Path
from jinja2 import Environment, FileSystemLoader

MARKDOWN_TEMPLATE_DIR = Path(__file__).parent / "templates" / "markdown"

class MarkdownExporter:
    """Export artifacts as Markdown in readable or technical variants.

    Per locked decisions:
    - Readable: clean, Notion-pasteable format
    - Technical: dev handoff with specs format
    """

    def __init__(self):
        self.env = Environment(
            loader=FileSystemLoader(str(MARKDOWN_TEMPLATE_DIR)),
            autoescape=False,  # Markdown should NOT be escaped
            keep_trailing_newline=True,
        )

    def export_single(
        self,
        artifact_type: str,
        content: dict,
        tier: str,
        startup_name: str,
        generated_date: str,
        variant: str = "readable",  # "readable" or "technical"
    ) -> str:
        """Export a single artifact as Markdown string.

        Args:
            variant: "readable" (Notion-pasteable) or "technical" (dev handoff)

        Returns:
            Markdown string
        """
        template = self.env.get_template(f"{variant}.md.j2")
        return template.render(
            artifact_type=artifact_type,
            artifact=content,
            tier=tier,
            startup_name=startup_name,
            generated_date=generated_date,
        )

    def export_combined(
        self,
        artifacts: dict[str, dict],
        tier: str,
        startup_name: str,
        generated_date: str,
        variant: str = "readable",
    ) -> str:
        """Export all artifacts as combined Markdown.

        Returns:
            Combined Markdown string with TOC
        """
        template = self.env.get_template(f"{variant}_combined.md.j2")
        return template.render(
            brief=artifacts.get("brief", {}),
            mvp_scope=artifacts.get("mvp_scope", {}),
            milestones=artifacts.get("milestones", {}),
            risk_log=artifacts.get("risk_log", {}),
            how_it_works=artifacts.get("how_it_works", {}),
            tier=tier,
            startup_name=startup_name,
            generated_date=generated_date,
        )
```

Note: MarkdownExporter is synchronous (string rendering, no I/O) — no need for asyncio.to_thread.

Run tests: ALL 10 tests MUST pass (GREEN).

Commit: `test(06-05): add markdown export tests` then `feat(06-05): implement MarkdownExporter with readable and technical templates`
  </action>
  <verify>
    cd /Users/vladcortex/co-founder && python -m pytest backend/tests/api/test_artifact_markdown_export.py -v -k "not api"
    All 10 unit/template tests pass.
    python -c "from app.artifacts.markdown_exporter import MarkdownExporter; print('OK')"
  </verify>
  <done>
    MarkdownExporter with readable and technical variants. 4 Jinja2 markdown templates. Readable is Notion-pasteable, technical is dev handoff format. Cross-references handled differently per variant. All 10 tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Markdown export API endpoints with integration tests</name>
  <files>
    backend/app/api/routes/artifacts.py
    backend/tests/api/test_artifact_markdown_export.py
  </files>
  <action>
**Add Markdown export endpoints to backend/app/api/routes/artifacts.py:**

```python
# GET /api/artifacts/{artifact_id}/export/markdown
@router.get("/{artifact_id}/export/markdown")
async def export_artifact_markdown(
    artifact_id: UUID,
    variant: str = "readable",  # Query param: "readable" or "technical"
    user=Depends(require_auth),
    session_factory=Depends(get_session_factory_dep),
):
    """Export artifact as Markdown.

    Query params:
    - variant: "readable" (default, Notion-pasteable) or "technical" (dev handoff)

    Returns: PlainTextResponse with text/markdown content type
    """
    if variant not in ("readable", "technical"):
        raise HTTPException(status_code=400, detail="variant must be 'readable' or 'technical'")
    # 1. Get artifact (user isolation)
    # 2. Get project for startup name
    # 3. Get user_settings for tier
    # 4. Call MarkdownExporter.export_single()
    # 5. Return PlainTextResponse(content=md, media_type="text/markdown")

# GET /api/artifacts/project/{project_id}/export/markdown
@router.get("/project/{project_id}/export/markdown")
async def export_combined_markdown(
    project_id: UUID,
    variant: str = "readable",
    user=Depends(require_auth),
    session_factory=Depends(get_session_factory_dep),
):
    """Export all project artifacts as combined Markdown.

    Returns: PlainTextResponse with text/markdown content type
    """
    # 1. Get all project artifacts (user isolation)
    # 2. Get project for startup name
    # 3. Call MarkdownExporter.export_combined()
    # 4. Return PlainTextResponse
```

**Add API integration tests to backend/tests/api/test_artifact_markdown_export.py:**

11. `test_api_export_markdown_readable_returns_200` — GET /api/artifacts/{id}/export/markdown returns 200 with text/markdown
12. `test_api_export_markdown_technical_returns_200` — GET /api/artifacts/{id}/export/markdown?variant=technical returns 200
13. `test_api_export_markdown_invalid_variant_returns_400` — variant=foobar returns 400
14. `test_api_export_markdown_user_isolation` — Other user returns 404
15. `test_api_export_combined_markdown_returns_200` — GET /api/artifacts/project/{id}/export/markdown returns 200
16. `test_api_export_combined_markdown_user_isolation` — Other user returns 404

Run ALL tests: MUST pass.

Commit: `feat(06-05): add markdown export API endpoints and integration tests`
  </action>
  <verify>
    cd /Users/vladcortex/co-founder && python -m pytest backend/tests/api/test_artifact_markdown_export.py -v
    All 16 tests pass.
    python -c "from app.api.routes.artifacts import router; print(f'{len(router.routes)} routes')"
  </verify>
  <done>
    Markdown export endpoints added: single artifact (readable/technical) and combined. PlainTextResponse with text/markdown media type. Variant query parameter validated. User isolation enforced. All 16 tests pass (10 unit + 6 API integration).
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest backend/tests/api/test_artifact_markdown_export.py -v` — all 16 tests pass
2. `ls backend/app/artifacts/templates/markdown/*.md.j2 | wc -l` — 4 templates
3. `python -c "from app.artifacts.markdown_exporter import MarkdownExporter; print('OK')"` — exporter importable
4. Verify all artifact routes now include markdown endpoints
</verification>

<success_criteria>
- MarkdownExporter with export_single() and export_combined() methods
- 4 Jinja2 markdown templates (readable single, technical single, readable combined, technical combined)
- Readable variant: clean paragraphs, no metadata, text cross-references, Notion-pasteable
- Technical variant: specs format, code blocks, markdown anchor cross-references, severity badges
- Combined variants: table of contents, all 5 artifacts as sections
- API endpoints with variant query parameter and user isolation
- PlainTextResponse with text/markdown content type
- All 16 tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-artifact-generation-pipeline/06-05-SUMMARY.md`
</output>
