---
phase: 33-infrastructure-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/lib/screenshots-stack.ts
  - infra/bin/app.ts
  - infra/lib/compute-stack.ts
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02

must_haves:
  truths:
    - "ScreenshotsStack CDK stack synthesizes without errors"
    - "S3 bucket is configured with BLOCK_ALL public access and S3_MANAGED encryption"
    - "CloudFront distribution uses OAC with ResponseHeadersPolicy enforcing cache-control: max-age=31536000, immutable"
    - "ComputeStack receives screenshots bucket and CloudFront domain as props"
    - "ECS task role has PutObject grant on the screenshots bucket"
    - "Backend container environment includes SCREENSHOTS_BUCKET, SCREENSHOTS_CLOUDFRONT_DOMAIN, SCREENSHOT_ENABLED, DOCS_GENERATION_ENABLED"
  artifacts:
    - path: "infra/lib/screenshots-stack.ts"
      provides: "S3 + CloudFront OAC stack for build screenshots"
      min_lines: 50
    - path: "infra/bin/app.ts"
      provides: "ScreenshotsStack instantiation and ComputeStack dependency wiring"
      contains: "ScreenshotsStack"
    - path: "infra/lib/compute-stack.ts"
      provides: "IAM grantPut + screenshots env vars on backend container"
      contains: "screenshotsBucket"
  key_links:
    - from: "infra/lib/screenshots-stack.ts"
      to: "infra/bin/app.ts"
      via: "ScreenshotsStack export and instantiation"
      pattern: "new ScreenshotsStack"
    - from: "infra/bin/app.ts"
      to: "infra/lib/compute-stack.ts"
      via: "screenshotsBucket prop passed to ComputeStack"
      pattern: "screenshotsBucket.*screenshotsStack"
    - from: "infra/lib/compute-stack.ts"
      to: "ecs backend container environment"
      via: "grantPut and env injection"
      pattern: "grantPut.*taskRole"
---

<objective>
Create the ScreenshotsStack CDK stack (S3 + CloudFront OAC) and wire it into ComputeStack for IAM grants and environment variable injection.

Purpose: Phases 34 (ScreenshotService) and 35 (DocGenerationService) need an S3 bucket to store screenshots and a CloudFront distribution to serve them. The ECS worker needs IAM PutObject permission and environment variables to know where to upload.

Output: `infra/lib/screenshots-stack.ts` (new stack), updated `infra/bin/app.ts` (wiring), updated `infra/lib/compute-stack.ts` (IAM + env vars).
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-infrastructure-configuration/33-RESEARCH.md
@infra/lib/marketing-stack.ts
@infra/bin/app.ts
@infra/lib/compute-stack.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScreenshotsStack CDK stack with S3 + CloudFront OAC</name>
  <files>infra/lib/screenshots-stack.ts</files>
  <action>
Create `infra/lib/screenshots-stack.ts` following the exact pattern from `infra/lib/marketing-stack.ts` (OAC).

The stack must:

1. **S3 Bucket:**
   - `bucketName: 'cofounder-screenshots'`
   - `blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL`
   - `removalPolicy: cdk.RemovalPolicy.RETAIN`
   - `encryption: s3.BucketEncryption.S3_MANAGED` (NOT KMS — OAC KMS complexity per MarketingStack precedent)
   - `versioned: false`

2. **CloudFront OAC Origin:**
   - `origins.S3BucketOrigin.withOriginAccessControl(bucket)` — the L2 construct auto-creates OAC and scoped bucket policy

3. **CachePolicy:**
   - Name: `Screenshots-Immutable-1yr`
   - `defaultTtl: Duration.days(365)`, `minTtl: Duration.days(365)`, `maxTtl: Duration.days(365)`
   - `enableAcceptEncodingGzip: true`, `enableAcceptEncodingBrotli: false` (PNG is binary — brotli wastes CPU)
   - `queryStringBehavior: none()`, `cookieBehavior: none()`

4. **ResponseHeadersPolicy:**
   - Name: `Screenshots-ImmutableCache`
   - Custom header: `cache-control` = `max-age=31536000, immutable` with `override: true` (overrides S3 origin headers)

5. **CloudFront Distribution:**
   - Default behavior with the OAC origin, cache policy, response headers policy
   - `viewerProtocolPolicy: REDIRECT_TO_HTTPS`
   - `allowedMethods: ALLOW_GET_HEAD_OPTIONS`
   - `compress: false` (PNG already compressed)
   - `priceClass: PRICE_CLASS_200`
   - `minimumProtocolVersion: TLS_V1_2_2021`
   - Per user decision: default CloudFront domain (d1234abcd.cloudfront.net) — NO custom subdomain, no Route53 alias

6. **Exports:**
   - `public readonly screenshotsBucket: s3.Bucket`
   - `public readonly screenshotsDistributionDomain: string` (from `distribution.distributionDomainName`)
   - Two `CfnOutput`s: `ScreenshotsBucketName` and `ScreenshotsDistributionDomain`

Import pattern: `import * as s3 from 'aws-cdk-lib/aws-s3'`, `import * as cloudfront from 'aws-cdk-lib/aws-cloudfront'`, `import * as origins from 'aws-cdk-lib/aws-cloudfront-origins'`.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/infra && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Verify file structure matches MarketingStack OAC pattern</manual>
  </verify>
  <done>screenshots-stack.ts compiles without TypeScript errors; exports screenshotsBucket and screenshotsDistributionDomain</done>
</task>

<task type="auto">
  <name>Task 2: Wire ScreenshotsStack into app.ts and extend ComputeStack props</name>
  <files>infra/bin/app.ts, infra/lib/compute-stack.ts</files>
  <action>
**In `infra/bin/app.ts`:**

1. Add import: `import { ScreenshotsStack } from '../lib/screenshots-stack';`
2. Add ScreenshotsStack instantiation AFTER MarketingStack (item 8):
   ```
   const screenshotsStack = new ScreenshotsStack(app, 'CoFounderScreenshots', {
     env,
     description: 'S3 + CloudFront for build screenshots',
   });
   ```
3. Update ComputeStack instantiation — add two new props:
   ```
   screenshotsBucket: screenshotsStack.screenshotsBucket,
   screenshotsCloudFrontDomain: screenshotsStack.screenshotsDistributionDomain,
   ```
4. Add dependency: `computeStack.addDependency(screenshotsStack);`

**In `infra/lib/compute-stack.ts`:**

1. Add `import * as s3 from 'aws-cdk-lib/aws-s3';` at the top imports
2. Extend `ComputeStackProps` interface — add two new fields:
   ```
   screenshotsBucket?: s3.IBucket;
   screenshotsCloudFrontDomain?: string;
   ```
   Use optional (`?`) to avoid breaking existing CDK synth when ScreenshotsStack hasn't been deployed yet.

3. After `taskRole` creation and `appSecrets.grantRead(taskRole)`, add:
   ```
   if (props.screenshotsBucket) {
     props.screenshotsBucket.grantPut(taskRole);
   }
   ```
   This adds `s3:PutObject` and `s3:PutObjectAcl` (from grantPut) to the task role. ONLY PutObject needed — CloudFront + OAC handles reads. Using `grantPut()` (not `grantReadWrite()`) per least privilege.

4. In the `backendContainer.addContainer(...)` environment block, add four new env vars:
   ```
   SCREENSHOTS_BUCKET: props.screenshotsBucket?.bucketName ?? '',
   SCREENSHOTS_CLOUDFRONT_DOMAIN: props.screenshotsCloudFrontDomain ?? '',
   SCREENSHOT_ENABLED: 'true',
   DOCS_GENERATION_ENABLED: 'true',
   ```
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/infra && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Verify app.ts has ScreenshotsStack instantiation and ComputeStack has grantPut + env vars</manual>
  </verify>
  <done>app.ts instantiates ScreenshotsStack and passes props to ComputeStack; ComputeStack calls grantPut(taskRole) and injects 4 screenshots env vars into backend container; tsc compiles clean</done>
</task>

</tasks>

<verification>
1. `cd infra && npx tsc --noEmit` — zero TypeScript errors across all three files
2. `grep -n 'screenshotsBucket' infra/lib/compute-stack.ts` — confirms grantPut and env injection
3. `grep -n 'ScreenshotsStack' infra/bin/app.ts` — confirms import, instantiation, and dependency
4. `grep -n 'immutable' infra/lib/screenshots-stack.ts` — confirms cache-control header policy
</verification>

<success_criteria>
- ScreenshotsStack CDK stack compiles and exports bucket + CF domain
- ComputeStack accepts optional screenshots props without breaking existing synth
- ECS task role gets PutObject on screenshots bucket
- Backend container environment includes SCREENSHOTS_BUCKET, SCREENSHOTS_CLOUDFRONT_DOMAIN, SCREENSHOT_ENABLED, DOCS_GENERATION_ENABLED
- All TypeScript compiles clean (npx tsc --noEmit returns 0)
</success_criteria>

<output>
After completion, create `.planning/phases/33-infrastructure-configuration/33-01-SUMMARY.md`
</output>
