---
phase: 33-infrastructure-configuration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/core/config.py
  - backend/app/api/routes/generation.py
  - backend/tests/api/test_generation_routes.py
autonomous: true
requirements:
  - INFRA-04
  - INFRA-05

must_haves:
  truths:
    - "Settings class has screenshot_enabled, docs_generation_enabled, screenshots_bucket, and screenshots_cloudfront_domain fields"
    - "GenerationStatusResponse includes snapshot_url (str|None) and docs_ready (bool) fields"
    - "GET /api/generation/{job_id}/status returns snapshot_url from Redis hash"
    - "GET /api/generation/{job_id}/docs returns DocsResponse with overview, features, getting_started, faq (all nullable)"
    - "Docs endpoint reads from job:{job_id}:docs Redis hash"
    - "All existing generation route tests still pass"
  artifacts:
    - path: "backend/app/core/config.py"
      provides: "Feature flags and screenshots env var fields"
      contains: "screenshot_enabled"
    - path: "backend/app/api/routes/generation.py"
      provides: "Extended GenerationStatusResponse + DocsResponse + /docs endpoint"
      contains: "DocsResponse"
    - path: "backend/tests/api/test_generation_routes.py"
      provides: "Tests for snapshot_url, docs_ready, and /docs endpoint"
      contains: "test_docs_endpoint"
  key_links:
    - from: "backend/app/core/config.py"
      to: "ECS environment"
      via: "Pydantic Settings auto-binds SCREENSHOT_ENABLED, SCREENSHOTS_BUCKET env vars"
      pattern: "screenshot_enabled.*bool"
    - from: "backend/app/api/routes/generation.py"
      to: "Redis hash job:{job_id}:docs"
      via: "hgetall in get_generation_docs endpoint"
      pattern: "hgetall.*job.*docs"
    - from: "backend/app/api/routes/generation.py"
      to: "Redis hash job:{job_id}"
      via: "snapshot_url read in get_generation_status"
      pattern: "snapshot_url.*job_data"
---

<objective>
Add feature flag Settings fields, extend GenerationStatusResponse with snapshot_url/docs_ready, and create the /docs endpoint contract.

Purpose: Phase 34 (ScreenshotService) needs `screenshot_enabled` and `screenshots_bucket` Settings fields. Phase 35 (DocGenerationService) needs `docs_generation_enabled` and the `/docs` endpoint to read from. The API contract must exist before services write to it.

Output: Updated `config.py`, `generation.py`, and test coverage for the new fields and endpoint.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-infrastructure-configuration/33-RESEARCH.md
@backend/app/core/config.py
@backend/app/api/routes/generation.py
@backend/tests/api/test_generation_routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Settings with feature flags and screenshots env vars</name>
  <files>backend/app/core/config.py</files>
  <action>
Add four new fields to the `Settings` class in `backend/app/core/config.py`, placed after the `log_archive_bucket` field and before `default_feature_flags`:

```python
# Screenshots & documentation infrastructure (Phase 33: INFRA-04, INFRA-05)
screenshot_enabled: bool = True         # env: SCREENSHOT_ENABLED
docs_generation_enabled: bool = True    # env: DOCS_GENERATION_ENABLED
screenshots_bucket: str = ""            # env: SCREENSHOTS_BUCKET
screenshots_cloudfront_domain: str = "" # env: SCREENSHOTS_CLOUDFRONT_DOMAIN
```

**Key behaviors:**
- `pydantic_settings` auto-binds field names to uppercase env vars (e.g., `screenshot_enabled` → `SCREENSHOT_ENABLED`)
- Defaults: both flags `True` (feature on by default); bucket/domain empty string (harmless no-op when CDK hasn't deployed yet)
- `lru_cache` on `get_settings()` means values are read once at process start — a rolling ECS deploy is required to pick up new env var values, which matches the "toggle without code deploy" requirement (INFRA-04)

Do NOT change any existing fields or the `model_config` block.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder && python -c "from app.core.config import Settings; s = Settings(); print(s.screenshot_enabled, s.docs_generation_enabled, repr(s.screenshots_bucket), repr(s.screenshots_cloudfront_domain))"</automated>
  </verify>
  <done>Settings has 4 new fields; default instantiation prints "True True '' ''"; no import or validation errors</done>
</task>

<task type="auto">
  <name>Task 2: Extend GenerationStatusResponse + create /docs endpoint + tests</name>
  <files>backend/app/api/routes/generation.py, backend/tests/api/test_generation_routes.py</files>
  <action>
**In `backend/app/api/routes/generation.py`:**

1. **Extend `GenerationStatusResponse`** — add two fields after `sandbox_paused`:
   ```python
   snapshot_url: str | None = None    # null until first screenshot uploaded (Phase 34 writes this)
   docs_ready: bool = False           # True when at least one docs section exists in Redis
   ```

2. **Update `get_generation_status()` endpoint** — after reading `sandbox_paused`, add:
   ```python
   snapshot_url = job_data.get("snapshot_url")
   # Check if any docs sections exist
   docs_keys = await redis.hkeys(f"job:{job_id}:docs")
   docs_ready = len(docs_keys) > 0
   ```
   And add `snapshot_url=snapshot_url` and `docs_ready=docs_ready` to the `GenerationStatusResponse(...)` constructor call.

3. **Add `DocsResponse` model** after `SnapshotResponse`:
   ```python
   class DocsResponse(BaseModel):
       """Response for GET /api/generation/{job_id}/docs."""
       overview: str | None = None
       features: str | None = None
       getting_started: str | None = None
       faq: str | None = None
   ```

4. **Add `/docs` endpoint** at the end of the endpoints section (before the internal DB helpers):
   ```python
   @router.get("/{job_id}/docs", response_model=DocsResponse)
   async def get_generation_docs(
       job_id: str,
       user: ClerkUser = Depends(require_auth),
       redis=Depends(get_redis),
   ) -> DocsResponse:
       """Return generated documentation sections for a build.

       Sections not yet generated are null. Phase 35 (DocGenerationService)
       writes to the job:{job_id}:docs Redis hash; this endpoint reads it.
       """
       state_machine = JobStateMachine(redis)
       job_data = await state_machine.get_job(job_id)

       if not job_data or job_data.get("user_id") != user.user_id:
           raise HTTPException(status_code=404, detail="Job not found")

       docs_data = await redis.hgetall(f"job:{job_id}:docs")
       return DocsResponse(
           overview=docs_data.get("overview"),
           features=docs_data.get("features"),
           getting_started=docs_data.get("getting_started"),
           faq=docs_data.get("faq"),
       )
   ```
   Per locked decision: returns all sections at once, ungenerated sections are null. No screenshot history.

**In `backend/tests/api/test_generation_routes.py`:**

Add three new test functions at the end of the file:

1. **`test_get_generation_status_includes_snapshot_url`** — Create a job in Redis with `snapshot_url` set to a CloudFront URL. Call `GET /api/generation/{job_id}/status`. Assert response includes `snapshot_url` matching the value and `docs_ready=False` (no docs hash).

2. **`test_docs_endpoint_returns_null_sections`** — Create a job in Redis. Call `GET /api/generation/{job_id}/docs` with no docs hash written. Assert 200 with all four sections null.

3. **`test_docs_endpoint_returns_partial_sections`** — Create a job in Redis. Write `overview` and `features` to `job:{job_id}:docs` hash. Call `GET /api/generation/{job_id}/docs`. Assert `overview` and `features` are the written strings; `getting_started` and `faq` are null.

Follow existing test patterns: use `fake_redis` fixture, `FakeAsyncRedis`, `TestClient`, auth override with `user_a`. Register the generation router on a fresh FastAPI app.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder && python -m pytest backend/tests/api/test_generation_routes.py -x -v 2>&1 | tail -30</automated>
  </verify>
  <done>All existing tests pass; 3 new tests pass (snapshot_url in status, null docs, partial docs); GenerationStatusResponse includes snapshot_url and docs_ready; /docs endpoint returns DocsResponse</done>
</task>

</tasks>

<verification>
1. `python -m pytest backend/tests/api/test_generation_routes.py -x -v` — all tests pass including 3 new ones
2. `python -c "from app.core.config import Settings; s = Settings(); assert hasattr(s, 'screenshot_enabled')"` — Settings has new fields
3. `python -c "from app.api.routes.generation import DocsResponse; print(DocsResponse.model_fields.keys())"` — DocsResponse model exists
4. `grep -n 'snapshot_url' backend/app/api/routes/generation.py` — confirms field in response model and status endpoint
</verification>

<success_criteria>
- Settings has screenshot_enabled (bool), docs_generation_enabled (bool), screenshots_bucket (str), screenshots_cloudfront_domain (str)
- GenerationStatusResponse includes snapshot_url and docs_ready
- /docs endpoint reads from Redis hash and returns DocsResponse
- All existing + 3 new tests pass
- No import errors, no typing errors
</success_criteria>

<output>
After completion, create `.planning/phases/33-infrastructure-configuration/33-02-SUMMARY.md`
</output>
