---
phase: 35-docgenerationservice
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - backend/app/services/generation_service.py
  - backend/tests/services/test_doc_generation_wiring.py
autonomous: true
requirements: [DOCS-03]

must_haves:
  truths:
    - "DocGenerationService.generate() is launched via asyncio.create_task() inside execute_build() immediately after SCAFFOLD stage completes — before CODE transition"
    - "The create_task() call is gated by settings.docs_generation_enabled feature flag"
    - "The task is never awaited — it runs concurrently with the rest of the build pipeline and handles its own errors"
    - "execute_build() continues to work identically when docs_generation_enabled is False — no side effects"
  artifacts:
    - path: "backend/app/services/generation_service.py"
      provides: "asyncio.create_task() call for DocGenerationService in execute_build()"
      contains: "asyncio.create_task"
    - path: "backend/tests/services/test_doc_generation_wiring.py"
      provides: "Tests verifying task launch timing, feature flag gating, and non-blocking behavior"
      min_lines: 60
  key_links:
    - from: "backend/app/services/generation_service.py"
      to: "backend/app/services/doc_generation_service.py"
      via: "asyncio.create_task(doc_service.generate(...))"
      pattern: "create_task.*generate"
    - from: "backend/app/services/generation_service.py"
      to: "app.core.config.get_settings()"
      via: "settings.docs_generation_enabled feature flag check"
      pattern: "docs_generation_enabled"
---

<objective>
Wire DocGenerationService into the build pipeline by injecting an `asyncio.create_task()` call into `GenerationService.execute_build()` immediately after the SCAFFOLD stage completes. This ensures documentation generation starts early (founders see content while the longer CODE/DEPS/CHECKS stages run) and never blocks or fails the build.

Purpose: DOCS-03 requires documentation generation starts at scaffold.completed. The task must be fire-and-forget — never awaited, never raising to the caller.

Output: Modified `generation_service.py` with task launch + new test file verifying the wiring.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-docgenerationservice/35-RESEARCH.md
@.planning/phases/35-docgenerationservice/35-01-SUMMARY.md

# Source files to modify/reference:
@backend/app/services/generation_service.py     # Insertion target: execute_build() after SCAFFOLD transition
@backend/app/services/doc_generation_service.py  # Created in Plan 01 — import and instantiate
@backend/app/core/config.py                      # get_settings().docs_generation_enabled
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire DocGenerationService into execute_build() with asyncio.create_task()</name>
  <files>backend/app/services/generation_service.py, backend/tests/services/test_doc_generation_wiring.py</files>
  <action>
    **In `generation_service.py`:**

    1. Add imports at the top of the file:
       ```python
       import asyncio
       from app.services.doc_generation_service import DocGenerationService
       ```

    2. Create a module-level singleton instance (same pattern as would be used for ScreenshotService):
       ```python
       _doc_generation_service = DocGenerationService()
       ```

    3. In `execute_build()`, insert the task launch AFTER the SCAFFOLD transition and `create_initial_state()` call, BEFORE the CODE transition (between current line ~100 `agent_state = create_initial_state(...)` and line ~103 `await state_machine.transition(job_id, JobStatus.CODE, ...)`):
       ```python
       # DOCS-03: Start doc generation as background task after scaffold completes
       # Fire-and-forget — task handles its own errors, never blocks the build
       from app.core.config import get_settings as _get_settings
       _settings = _get_settings()
       if _settings.docs_generation_enabled:
           asyncio.create_task(
               _doc_generation_service.generate(
                   job_id=job_id,
                   spec=job_data.get("goal", ""),
                   redis=_redis,
               )
           )
       ```

    4. Do NOT add any await, try/except, or result handling around the create_task call. The task manages itself internally.

    5. Do NOT modify `execute_iteration_build()` — iteration doc strategy is deferred to Claude's discretion per CONTEXT.md (future enhancement).

    **In `test_doc_generation_wiring.py`:**

    Create a test file that verifies the wiring behavior without running the actual DocGenerationService:

    1. `test_doc_generation_task_launched_after_scaffold` — Patch `DocGenerationService.generate` as AsyncMock. Run a minimal execute_build flow (mock Runner, mock sandbox). Verify `generate` was called with correct job_id and spec from job_data["goal"]. Verify it was called exactly once.

    2. `test_doc_generation_skipped_when_disabled` — Patch `get_settings()` to return `docs_generation_enabled=False`. Run execute_build. Verify `DocGenerationService.generate` was NOT called.

    3. `test_doc_generation_does_not_block_build` — Patch `DocGenerationService.generate` to sleep for 5 seconds (simulating slow API). Verify execute_build completes in well under 5 seconds (proving the task is not awaited).

    Use the same test patterns as `test_generation_service.py` — mock Runner with RunnerFake, mock sandbox with factory returning AsyncMock.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_doc_generation_wiring.py -x -v</automated>
    <manual>Verify generation_service.py has asyncio.create_task() call between SCAFFOLD and CODE stages</manual>
  </verify>
  <done>
    - asyncio.create_task() call exists in execute_build() between SCAFFOLD and CODE transitions
    - Feature flag check gates the task launch
    - Task is never awaited (fire-and-forget)
    - 3 tests pass: task launched, task skipped when disabled, task does not block build
    - Existing execute_build tests still pass (no regression)
  </done>
</task>

</tasks>

<verification>
```bash
# Wiring tests
cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_doc_generation_wiring.py -x -v

# Regression: existing generation service tests still pass
cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_generation_service.py -x -v

# Full doc generation test suite (Plan 01 + Plan 02 combined)
cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_doc_generation_service.py tests/services/test_doc_generation_wiring.py -x -v
```
</verification>

<success_criteria>
- `asyncio.create_task(_doc_generation_service.generate(...))` call exists in execute_build() after SCAFFOLD, before CODE
- Feature flag `docs_generation_enabled` gates the call
- Task is fire-and-forget (not awaited, no try/except around it)
- All wiring tests pass
- All existing generation_service tests pass (no regression)
- execute_build still returns correct build results when docs_generation_enabled is True or False
</success_criteria>

<output>
After completion, create `.planning/phases/35-docgenerationservice/35-02-SUMMARY.md`
</output>
