---
phase: 36-generationservice-wiring-api-routes
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/doc_generation_service.py
  - backend/tests/services/test_doc_generation_service.py
  - backend/tests/services/test_narration_service.py
autonomous: true
gap_closure: true
requirements: [NARR-08]

must_haves:
  truths:
    - "Narration and documentation text containing /workspace/ paths has those paths stripped"
    - "Stack trace boilerplate text (Traceback, raise RuntimeError) is stripped from narration and documentation"
    - "Secret-shaped strings (sk-ant-api03-..., AKIA...) are caught and stripped"
  artifacts:
    - path: "backend/app/services/doc_generation_service.py"
      provides: "Extended _SAFETY_PATTERNS with workspace paths, stack trace headers, and secret patterns"
      contains: "workspace"
    - path: "backend/tests/services/test_doc_generation_service.py"
      provides: "Tests for new safety patterns"
      contains: "test_strips_unix_workspace_path"
    - path: "backend/tests/services/test_narration_service.py"
      provides: "Tests for new safety patterns in narration context"
      contains: "test_strips_workspace_path"
  key_links:
    - from: "backend/app/services/narration_service.py"
      to: "backend/app/services/doc_generation_service.py"
      via: "from app.services.doc_generation_service import _SAFETY_PATTERNS"
      pattern: "_SAFETY_PATTERNS"
---

<objective>
Close the one verification gap from 36-VERIFICATION.md: extend `_SAFETY_PATTERNS` in `doc_generation_service.py` to cover `/workspace/` paths, stack trace boilerplate text, and secret-shaped API key strings.

Purpose: NARR-08 requires safety guardrails strip internal paths, stack traces, and secrets. The current regex covers `/app/` and `/src/` but omits `/workspace/` — the actual build directory in E2B sandboxes. Stack trace headers and secret-shaped strings also pass through unfiltered.

Output: Updated `_SAFETY_PATTERNS` with 3 new patterns, tests proving each pattern works in both doc generation and narration safety filter contexts.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-generationservice-wiring-api-routes/36-VERIFICATION.md
@.planning/phases/36-generationservice-wiring-api-routes/36-01-SUMMARY.md
@backend/app/services/doc_generation_service.py
@backend/tests/services/test_doc_generation_service.py
@backend/tests/services/test_narration_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add /workspace/ path, stack trace, and secret patterns to _SAFETY_PATTERNS with tests</name>
  <files>
    backend/app/services/doc_generation_service.py
    backend/tests/services/test_doc_generation_service.py
    backend/tests/services/test_narration_service.py
  </files>
  <action>
**In `backend/app/services/doc_generation_service.py`**, modify the `_SAFETY_PATTERNS` list (around line 85-103):

1. **Extend the unix path regex** to include `workspace`:
   - Change: `(re.compile(r"/(home|usr|var|tmp|app|src)/\S+"), "")`
   - To: `(re.compile(r"/(home|usr|var|tmp|app|src|workspace)/\S+"), "")`

2. **Add a stack trace header pattern** after the unix paths pattern:
   ```python
   # Stack trace boilerplate: "Traceback (most recent call last):", "raise SomeError", "File \"...\""
   (re.compile(r"^\s*(Traceback \(most recent call last\):.*|raise \w+.*|File \".*\",\s*line \d+.*)$", re.MULTILINE), ""),
   ```

3. **Add a secret-shaped string pattern** after the stack trace pattern:
   ```python
   # Secret-shaped strings: API keys (sk-ant-..., sk-proj-..., AKIA...), high-entropy tokens
   (re.compile(r"\b(sk-(?:ant|proj|live|test)-[a-zA-Z0-9_-]{10,}|AKIA[A-Z0-9]{16}|ghp_[a-zA-Z0-9]{36}|xoxb-[a-zA-Z0-9-]+)\b"), "[REDACTED]"),
   ```
   Note: Replace secret-shaped strings with `[REDACTED]` not empty string — preserves sentence flow ("Using key [REDACTED] for..." vs "Using key  for...").

**In `backend/tests/services/test_doc_generation_service.py`**, add tests to the existing `TestSafetyFilter` class:

4. Add `test_strips_unix_workspace_path()`:
   - Input: `"Check /workspace/project/src/main.py for details."`
   - Assert: `"/workspace/"` not in result

5. Add `test_strips_stack_trace_header()`:
   - Input: `"Error: Traceback (most recent call last):\n  File \"/app/main.py\", line 42"`
   - Assert: `"Traceback"` not in result

6. Add `test_strips_raise_statement()`:
   - Input: `"We encountered raise RuntimeError in the build."`
   - Assert: `"raise RuntimeError"` not in result

7. Add `test_redacts_anthropic_api_key()`:
   - Input: `"Using key sk-ant-api03-abc123def456ghi789jkl012mno345 for generation."`
   - Assert: `"sk-ant-"` not in result
   - Assert: `"[REDACTED]"` in result

8. Add `test_redacts_aws_access_key()`:
   - Input: `"Configured with AKIAIOSFODNN7EXAMPLE for S3 access."`
   - Assert: `"AKIA"` not in result

**In `backend/tests/services/test_narration_service.py`**, add tests to the existing `TestSafetyFilter` class:

9. Add `test_strips_workspace_path()`:
   - Input: `"We're updating /workspace/project/package.json with dependencies."`
   - Assert: `"/workspace/"` not in result

10. Add `test_strips_stack_trace_text()`:
    - Input: `"We found Traceback (most recent call last): in your build output."`
    - Assert: `"Traceback"` not in result

11. Add `test_redacts_secret_shaped_strings()`:
    - Input: `"We're using sk-ant-api03-abcdefghijklmnop for the API call."`
    - Assert: `"sk-ant-"` not in result

Both test files' `TestSafetyFilter` classes import and use `_SAFETY_PATTERNS` from `doc_generation_service.py`. The NarrationService tests call `self.service._apply_safety_filter(text)` which internally uses the same imported `_SAFETY_PATTERNS`. No separate import changes needed in narration_service.py — it already imports from doc_generation_service.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_doc_generation_service.py::TestSafetyFilter tests/services/test_narration_service.py::TestSafetyFilter -x -v --tb=short 2>&1 | tail -40</automated>
    <manual>Verify /workspace/ path, Traceback text, and sk-ant- key are all absent from filter output</manual>
    <sampling_rate>run after this task commits, before summary</sampling_rate>
  </verify>
  <done>
    - /workspace/ paths stripped by _SAFETY_PATTERNS regex
    - Stack trace boilerplate text (Traceback, raise, File lines) stripped
    - Secret-shaped strings (sk-ant-..., AKIA..., ghp_...) replaced with [REDACTED]
    - All new tests pass in both doc_generation and narration test suites
    - Existing tests continue to pass (no regressions)
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_doc_generation_service.py::TestSafetyFilter -x -v` — all safety filter tests pass including new ones
2. `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_narration_service.py::TestSafetyFilter -x -v` — all narration safety filter tests pass including new ones
3. `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/ -x -m unit --tb=short` — full unit suite green, no regressions
4. Manual check: `python -c "from app.services.doc_generation_service import _SAFETY_PATTERNS; print(len(_SAFETY_PATTERNS))"` — should return 9 (was 6, +3 new patterns)
</verification>

<success_criteria>
- _SAFETY_PATTERNS contains 9 compiled patterns (6 existing + 3 new)
- "/workspace/project/src/main.py" is fully stripped (not just the /src/ portion)
- "Traceback (most recent call last):" lines are stripped
- "raise RuntimeError" lines are stripped
- "sk-ant-api03-..." strings are replaced with [REDACTED]
- "AKIAIOSFODNN7EXAMPLE" strings are caught
- All existing safety filter tests still pass (no regressions)
- NarrationService inherits all fixes automatically via shared _SAFETY_PATTERNS import
</success_criteria>

<output>
After completion, create `.planning/phases/36-generationservice-wiring-api-routes/36-04-SUMMARY.md`
</output>
