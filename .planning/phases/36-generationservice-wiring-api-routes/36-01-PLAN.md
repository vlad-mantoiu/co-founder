---
phase: 36-generationservice-wiring-api-routes
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/app/services/narration_service.py
  - backend/tests/services/test_narration_service.py
autonomous: true
requirements: [NARR-02, NARR-04, NARR-08]

must_haves:
  truths:
    - "NarrationService.narrate() generates a Claude Haiku sentence for any of the 5 build stages"
    - "Narration text uses collaborative 'we' pronoun and calm expert tone"
    - "SSE event emitted contains agent_role, time_estimate, narration, and stage fields"
    - "Safety filter strips internal paths, stack traces, framework names from narration"
    - "On any failure, a fallback narration sentence is emitted — narrate() never raises"
  artifacts:
    - path: "backend/app/services/narration_service.py"
      provides: "NarrationService with narrate(), _call_claude(), _apply_safety_filter(), _build_prompt()"
      min_lines: 120
    - path: "backend/tests/services/test_narration_service.py"
      provides: "Unit tests covering narration generation, safety filter, fallback, SSE event emission"
      min_lines: 200
  key_links:
    - from: "backend/app/services/narration_service.py"
      to: "anthropic.AsyncAnthropic"
      via: "messages.create() with claude-3-5-haiku-20241022"
      pattern: "AsyncAnthropic.*messages.create"
    - from: "backend/app/services/narration_service.py"
      to: "backend/app/queue/state_machine.py"
      via: "publish_event() with SSEEventType.BUILD_STAGE_STARTED"
      pattern: "publish_event.*BUILD_STAGE_STARTED"
    - from: "backend/app/services/narration_service.py"
      to: "backend/app/services/doc_generation_service.py"
      via: "imports _SAFETY_PATTERNS for content filtering"
      pattern: "from app.services.doc_generation_service import _SAFETY_PATTERNS"
---

<objective>
Build NarrationService — a stateless async service that generates one Claude Haiku sentence per build stage transition, emits an enriched `build.stage.started` SSE event via JobStateMachine.publish_event(), and never raises (safe for asyncio.create_task fire-and-forget).

Purpose: NARR-02 (Claude generates idea-specific narration per stage), NARR-04 (first-person co-founder voice with agent role), NARR-08 (safety guardrails strip paths/traces/secrets).
Output: `narration_service.py` module + comprehensive test suite.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-generationservice-wiring-api-routes/36-CONTEXT.md
@.planning/phases/36-generationservice-wiring-api-routes/36-RESEARCH.md
@.planning/phases/35-docgenerationservice/35-01-SUMMARY.md
@backend/app/services/doc_generation_service.py
@backend/app/queue/state_machine.py
</context>

<feature>
  <name>NarrationService — Claude Haiku stage narration with safety filter</name>
  <files>backend/app/services/narration_service.py, backend/tests/services/test_narration_service.py</files>
  <behavior>
    NarrationService mirrors DocGenerationService architecture:
    - Zero-arg constructor (stateless, Redis passed per-call)
    - Module-level singleton pattern (`_narration_service = NarrationService()`)
    - All exceptions caught — narrate() NEVER raises

    Constants:
    - NARRATION_MODEL = "claude-3-5-haiku-20241022"
    - NARRATION_MAX_TOKENS = 80  (one sentence, 10-20 words)
    - NARRATION_TIMEOUT_SECONDS = 10.0  (short — single sentence)
    - STAGE_AGENT_ROLES = {"scaffold": "Architect", "code": "Coder", "deps": "Coder", "checks": "Reviewer", "ready": "Reviewer"}
    - STAGE_TIME_ESTIMATES = {"scaffold": "~15s", "code": "~60s", "deps": "~45s", "checks": "~20s", "ready": "~5s"}
    - _FALLBACK_NARRATIONS = per-stage generic sentences (used on any failure)

    narrate(job_id, stage, spec, redis) -> None:
    1. Truncate spec to first 300 chars (lightweight input per locked decision)
    2. Call _call_claude(stage, spec) wrapped in asyncio.wait_for(timeout=NARRATION_TIMEOUT_SECONDS)
    3. Apply _apply_safety_filter() to result (reuse _SAFETY_PATTERNS from doc_generation_service)
    4. On any exception, use _FALLBACK_NARRATIONS[stage]
    5. Emit enriched build.stage.started event via JobStateMachine(redis).publish_event():
       {"type": SSEEventType.BUILD_STAGE_STARTED, "stage": stage, "narration": text, "agent_role": STAGE_AGENT_ROLES[stage], "time_estimate": STAGE_TIME_ESTIMATES[stage]}

    _call_claude(stage, spec) -> str:
    - System prompt: "You are a calm, expert technical co-founder giving a brief status update. Use 'we' (not 'I'). Write exactly ONE sentence, 10-20 words. Reference the product's actual features when possible. Always sound confident — never apologize or acknowledge delays. Do NOT include code, file paths, framework names, or technical jargon."
    - User prompt: f"Stage: {stage}\nProduct: {spec[:300]}\nWrite one sentence describing what we're doing in this stage."
    - anthropic.AsyncAnthropic(api_key=settings.anthropic_api_key).messages.create()
    - One retry with 2.5s backoff on RateLimitError/APITimeoutError/asyncio.TimeoutError (mirror DocGenerationService)
    - Return response.content[0].text.strip()

    _apply_safety_filter(text) -> str:
    - Import _SAFETY_PATTERNS from doc_generation_service
    - Apply each pattern, strip whitespace
    - Return filtered text

    Test cases (RED phase writes these):
    - test_narration_constants: STAGE_AGENT_ROLES has all 5 stages, STAGE_TIME_ESTIMATES has all 5, _FALLBACK_NARRATIONS has all 5
    - test_narration_happy_path: Mock Claude response, verify narrate() emits publish_event with correct type/stage/narration/agent_role/time_estimate
    - test_narration_uses_correct_model: Verify messages.create called with model=NARRATION_MODEL
    - test_narration_truncates_spec: Spec longer than 300 chars is truncated in the prompt
    - test_narration_fallback_on_api_error: Mock Claude to raise, verify fallback sentence emitted
    - test_narration_fallback_on_timeout: Mock asyncio.wait_for to raise TimeoutError, verify fallback
    - test_narration_never_raises: Mock publish_event to raise, verify narrate() returns None without exception
    - test_narration_safety_filter_strips_paths: Input with /app/src/main.py stripped
    - test_narration_safety_filter_strips_framework_names: "React component" -> "component"
    - test_narration_safety_filter_preserves_clean_text: "We're building your dashboard" unchanged
    - test_narration_event_includes_agent_role: Each stage maps to correct role (Architect/Coder/Reviewer)
    - test_narration_event_includes_time_estimate: Each stage has time_estimate in event
  </behavior>
  <implementation>
    RED: Write test file with all test cases. Tests import NarrationService (will fail — module doesn't exist yet).
    GREEN: Create narration_service.py implementing all methods. All tests pass.
    REFACTOR: Clean up if needed. Ensure ruff compliance.
  </implementation>
</feature>

<verification>
```bash
cd backend && python -m pytest tests/services/test_narration_service.py -x -v --tb=short
```
All tests pass. No warnings.
</verification>

<success_criteria>
- NarrationService.narrate() generates stage-specific narration and emits enriched SSE event
- Safety filter reuses _SAFETY_PATTERNS from doc_generation_service (no duplication)
- Every failure path (API error, timeout, publish failure) falls back to generic sentence — never raises
- Agent role (Architect/Coder/Reviewer) and time estimate included in every SSE event
- All tests green, ruff clean
</success_criteria>

<output>
After completion, create `.planning/phases/36-generationservice-wiring-api-routes/36-01-SUMMARY.md`
</output>
