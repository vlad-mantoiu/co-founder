# Phase 36: GenerationService Wiring & API Routes - Context

**Gathered:** 2026-02-24
**Status:** Ready for planning

<domain>
## Phase Boundary

Wire ScreenshotService and DocGenerationService into the live build pipeline at the correct insertion points, generate Claude-powered narration per stage transition, emit typed SSE events for frontend consumption, and expose REST endpoints for docs and build events. Generate iteration changelogs for v0.2+ builds. Panel components and frontend hooks that consume these events are Phase 37-38 concerns.

</domain>

<decisions>
## Implementation Decisions

### Narration voice & personality
- Calm expert personality — confident, measured, like a senior engineer calmly explaining progress
- Collaborative "we" pronoun — "We're setting up your project structure now." Not "I" or passive
- One sentence per narration, 10-20 words. Scannable, not essays
- Project-specific references — mention actual features/pages from the spec. "We're creating your dashboard and team management pages."
- Claude-generated fresh on each stage transition (not templates)
- Always confident tone — never acknowledge delays, never apologize
- No narration on build completion (UI state change handles that)
- No narration on build failure (UI error state handles that, avoids awkward AI apologizing)

### Stage-to-narration mapping
- All 5 stages get narration: SCAFFOLD, CODE, DEPS, CHECKS, READY
- Stage-to-agent-role mapping: SCAFFOLD → Architect, CODE → Coder, DEPS → Coder, CHECKS → Reviewer, READY → Reviewer
- Agent role label included alongside narration sentence (e.g., "Architect: Setting up your project layout with the pages you described.")
- Rough time estimates included per stage (from historical averages or sensible defaults)
- Haiku model for narration generation (same as doc generation)
- Lightweight spec summary as input — project name + key features list, not full spec
- One narration per stage transition, generated on-demand (not pre-generated upfront)
- Non-fatal: if narration generation fails, emit event with a generic fallback sentence. Build never blocked
- Same safety guardrails as doc generation — strip internal paths, stack traces, secrets, framework names

### Changelog content
- Spec diff comparison — compare v0.1 spec to v0.2 spec, highlight what founder asked to change/add
- Added/Changed/Removed list format (classic changelog style)
- Stored as fifth Redis hash key: `changelog` in `job:{id}:docs`
- Omitted entirely for v0.1 (first build) — no `changelog` key written. Frontend checks key existence
- Generated by Haiku (same pattern as doc generation) with both specs as input
- Version-labeled: "v0.2 Changes" header followed by the list
- Same founder-safe content rules as docs — dual-layer safety filter applies to changelog too

### SSE event payloads
- Rich payloads — each event carries everything frontend needs to render, no follow-up API calls needed
- `build.stage.started`: includes narration text, agent role, stage name, time estimate
- `build.stage.completed`: includes stage name, actual duration
- `snapshot.updated`: includes CloudFront URL for the latest screenshot
- `documentation.updated`: includes section key that was just written (e.g., "overview")
- 15-second heartbeat keepalive to stay within ALB idle timeout (60s default)
- Bootstrap from REST then stream — frontend calls GET /api/jobs/{id}/docs and GET /api/generation/{id}/status first, then opens SSE. No replay/Last-Event-ID mechanism in SSE itself
- Authenticated via Clerk JWT — same auth as all other endpoints

### Claude's Discretion
- Exact generic fallback narration sentences when generation fails
- Specific time estimate values per stage (reasonable defaults)
- Narration prompt structure and system prompt content

</decisions>

<specifics>
## Specific Ideas

- Narration should feel like a calm, competent co-founder giving status updates — not a chatbot, not a progress bar with words
- Agent roles (Architect, Coder, Reviewer) add character — the founder feels like a small team is working on their project
- Changelog should feel like release notes from a product you use, not a git diff

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 36-generationservice-wiring-api-routes*
*Context gathered: 2026-02-24*
