---
phase: 43-token-budget-sleep-wake-daemon
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/db/models/agent_checkpoint.py
  - backend/app/db/models/agent_session.py
  - backend/app/db/models/__init__.py
  - backend/app/db/models/user_settings.py
  - backend/alembic/versions/add_agent_checkpoint_session_and_renewal_date.py
  - backend/app/api/routes/agent.py
  - backend/tests/agent/test_agent_models.py
autonomous: true
requirements: [BDGT-04, BDGT-05]

must_haves:
  truths:
    - "AgentCheckpoint table stores full message history, sandbox_id, current_phase, retry_counts, and budget state per session"
    - "AgentSession table records model_used and tier fixed at session start"
    - "UserSettings has subscription_renewal_date column for daily budget calculation"
    - "SESSION_TTL in agent.py is 90_000 (25h) so Redis session keys survive overnight sleep"
  artifacts:
    - path: "backend/app/db/models/agent_checkpoint.py"
      provides: "AgentCheckpoint ORM model"
      contains: "class AgentCheckpoint"
    - path: "backend/app/db/models/agent_session.py"
      provides: "AgentSession ORM model with tier and model_used"
      contains: "class AgentSession"
    - path: "backend/alembic/versions/add_agent_checkpoint_session_and_renewal_date.py"
      provides: "Alembic migration creating agent_checkpoints, agent_sessions tables and adding subscription_renewal_date to user_settings"
    - path: "backend/tests/agent/test_agent_models.py"
      provides: "Model instantiation and field validation tests"
  key_links:
    - from: "backend/app/db/models/__init__.py"
      to: "agent_checkpoint.py, agent_session.py"
      via: "Re-export imports"
      pattern: "from app.db.models.agent_checkpoint import AgentCheckpoint"
    - from: "backend/app/api/routes/agent.py"
      to: "SESSION_TTL"
      via: "Constant value"
      pattern: "SESSION_TTL = 90_000"
---

<objective>
Create the PostgreSQL persistence models (AgentCheckpoint + AgentSession), extend UserSettings with subscription_renewal_date, write the Alembic migration, and fix SESSION_TTL to 90_000.

Purpose: The budget daemon and sleep/wake lifecycle depend on durable PostgreSQL storage for message history, sandbox state, and per-error retry counts. The AgentSession model records model-per-tier (BDGT-05). The SESSION_TTL fix is a prerequisite flagged in STATE.md — Redis session keys must survive overnight sleep.

Output: Two new ORM models, one migration, one column addition to UserSettings, SESSION_TTL fixed, all validated with model instantiation tests.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/db/models/__init__.py
@backend/app/db/models/user_settings.py
@backend/app/api/routes/agent.py
@backend/alembic/versions/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AgentCheckpoint + AgentSession models, extend UserSettings, fix SESSION_TTL</name>
  <files>
    backend/app/db/models/agent_checkpoint.py
    backend/app/db/models/agent_session.py
    backend/app/db/models/__init__.py
    backend/app/db/models/user_settings.py
    backend/app/api/routes/agent.py
  </files>
  <action>
    Create `backend/app/db/models/agent_checkpoint.py`:
    - Class `AgentCheckpoint(Base)` with `__tablename__ = "agent_checkpoints"`
    - Fields: `id` (Integer PK autoincrement), `session_id` (String(255) NOT NULL, indexed), `job_id` (String(255) NOT NULL, indexed), `message_history` (JSON NOT NULL, default=list), `sandbox_id` (String(255) nullable), `current_phase` (String(255) nullable), `retry_counts` (JSON NOT NULL, default=dict), `session_cost_microdollars` (Integer NOT NULL, default=0), `daily_budget_microdollars` (Integer NOT NULL, default=0), `iteration_number` (Integer NOT NULL, default=0), `agent_state` (String(50) NOT NULL, default="working"), `created_at` (DateTime(timezone=True) NOT NULL, server_default=func.now()), `updated_at` (DateTime(timezone=True) NOT NULL, server_default=func.now(), onupdate=func.now())
    - Follow existing model patterns: import from `app.db.base import Base`, use `sqlalchemy` Column/types

    Create `backend/app/db/models/agent_session.py`:
    - Class `AgentSession(Base)` with `__tablename__ = "agent_sessions"`
    - Fields: `id` (String(255) PK — UUID passed from context, NOT autoincrement), `job_id` (String(255) NOT NULL, indexed), `clerk_user_id` (String(255) NOT NULL, indexed), `tier` (String(50) NOT NULL — "bootstrapper", "partner", or "cto_scale"), `model_used` (String(100) NOT NULL — fixed at session start per BDGT-05), `status` (String(50) NOT NULL, default="working" — one of working/sleeping/budget_exceeded/completed), `cumulative_cost_microdollars` (Integer NOT NULL, default=0), `daily_budget_microdollars` (Integer NOT NULL, default=0), `started_at` (DateTime(timezone=True) NOT NULL, server_default=func.now()), `last_checkpoint_at` (DateTime(timezone=True) nullable), `completed_at` (DateTime(timezone=True) nullable)

    Update `backend/app/db/models/__init__.py`:
    - Add imports for AgentCheckpoint and AgentSession
    - Add both to `__all__`

    Update `backend/app/db/models/user_settings.py`:
    - Add `subscription_renewal_date = Column(DateTime(timezone=True), nullable=True)` after the Stripe fields block (after line 24, before the Admin overrides comment)

    Update `backend/app/api/routes/agent.py`:
    - Change `SESSION_TTL = 3600` (line 27) to `SESSION_TTL = 90_000  # 25 hours — must survive overnight agent sleep`
    - This is a STATE.md-flagged fix: "app/api/routes/agent.py session TTL currently 3600s — must update to 86400s minimum"
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder && python -c "from app.db.models.agent_checkpoint import AgentCheckpoint; from app.db.models.agent_session import AgentSession; print('Models import OK')"</automated>
    <manual>Verify SESSION_TTL is 90_000 in agent.py</manual>
  </verify>
  <done>AgentCheckpoint and AgentSession models are importable, UserSettings has subscription_renewal_date, SESSION_TTL is 90_000</done>
</task>

<task type="auto">
  <name>Task 2: Create Alembic migration + model instantiation tests</name>
  <files>
    backend/alembic/versions/add_agent_checkpoint_session_and_renewal_date.py
    backend/tests/agent/test_agent_models.py
  </files>
  <action>
    Create Alembic migration `backend/alembic/versions/add_agent_checkpoint_session_and_renewal_date.py`:
    - Generate revision ID using `alembic revision --autogenerate -m "add agent_checkpoints, agent_sessions, and subscription_renewal_date"` OR create manually with a unique hex revision ID
    - `upgrade()`:
      - `op.create_table("agent_checkpoints", ...)` with all columns from the model, PK constraint, indexes on session_id and job_id
      - `op.create_table("agent_sessions", ...)` with all columns from the model, PK constraint, indexes on job_id and clerk_user_id
      - `op.add_column("user_settings", sa.Column("subscription_renewal_date", sa.DateTime(timezone=True), nullable=True))`
    - `downgrade()`:
      - `op.drop_column("user_settings", "subscription_renewal_date")`
      - `op.drop_table("agent_sessions")`
      - `op.drop_table("agent_checkpoints")`
    - Follow existing migration patterns in `backend/alembic/versions/` — import sa, op from alembic

    Create `backend/tests/agent/test_agent_models.py`:
    - Test `test_agent_checkpoint_defaults` — instantiate AgentCheckpoint with only required fields (session_id, job_id), verify defaults: message_history=[], retry_counts={}, session_cost_microdollars=0, daily_budget_microdollars=0, iteration_number=0, agent_state="working"
    - Test `test_agent_session_defaults` — instantiate AgentSession with id/job_id/clerk_user_id/tier/model_used, verify status="working", cumulative_cost_microdollars=0
    - Test `test_agent_checkpoint_tablename` — verify `AgentCheckpoint.__tablename__ == "agent_checkpoints"`
    - Test `test_agent_session_tablename` — verify `AgentSession.__tablename__ == "agent_sessions"`
    - Test `test_user_settings_has_renewal_date` — verify `hasattr(UserSettings, "subscription_renewal_date")`
    - These are unit tests testing ORM model shape — no database connection needed
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -m pytest tests/agent/test_agent_models.py -x -v</automated>
  </verify>
  <done>Migration file exists with upgrade/downgrade, 5 model instantiation tests pass</done>
</task>

</tasks>

<verification>
1. `python -c "from app.db.models import AgentCheckpoint, AgentSession"` succeeds
2. `grep SESSION_TTL backend/app/api/routes/agent.py` shows 90_000
3. `python -m pytest tests/agent/test_agent_models.py -x -v` — 5 tests pass
4. Migration file exists in `backend/alembic/versions/`
</verification>

<success_criteria>
- AgentCheckpoint model has all required fields (session_id, job_id, message_history, sandbox_id, current_phase, retry_counts, session_cost_microdollars, daily_budget_microdollars, iteration_number, agent_state, created_at, updated_at)
- AgentSession model has tier and model_used (BDGT-05) with status enum values
- UserSettings has subscription_renewal_date column
- SESSION_TTL = 90_000 in agent.py
- Alembic migration creates both tables and adds the column
- All model tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/43-token-budget-sleep-wake-daemon/43-01-SUMMARY.md`
</output>
