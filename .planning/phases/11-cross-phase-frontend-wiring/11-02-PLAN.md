---
phase: 11-cross-phase-frontend-wiring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/useOnboarding.ts
  - frontend/src/hooks/useUnderstandingInterview.ts
  - frontend/src/app/(dashboard)/projects/[id]/understanding/page.tsx
  - frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
  - frontend/src/app/(dashboard)/projects/[id]/deploy/page.tsx
  - frontend/src/app/(dashboard)/projects/[id]/strategy/page.tsx
  - frontend/src/app/(dashboard)/projects/[id]/timeline/page.tsx
  - frontend/src/app/(dashboard)/understanding/page.tsx
  - frontend/src/components/understanding/IdeaBriefCard.tsx
  - frontend/src/components/ui/brand-nav.tsx
  - frontend/src/components/timeline/TimelineCard.tsx
  - frontend/src/app/(dashboard)/dashboard/page.tsx
  - frontend/src/app/(dashboard)/timeline/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Onboarding completion redirects to /projects/{project_id}/understanding with sessionId"
    - "Understanding page reads projectId from URL path segment params.id (not query param)"
    - "Brief section editing calls PATCH /api/understanding/{projectId}/brief with correct projectId"
    - "Brief edit does not revert user text on failure (keeps optimistic update)"
    - "Toast notification shown on successful brief edit ('Section updated')"
    - "Toast notification shown on failed brief edit with retry action"
    - "Brief sections save on blur (auto-save when user clicks away)"
    - "All project-scoped pages live under /projects/[id]/... pattern"
    - "Navigating to /projects/[id]/understanding without onboarding shows message with link back"
    - "Strategy and Timeline nav links work from /projects/[id]/... context"
    - "View-in-graph links from timeline use project-scoped strategy URL"
  artifacts:
    - path: "frontend/src/app/(dashboard)/projects/[id]/understanding/page.tsx"
      provides: "Project-scoped understanding page"
      contains: "useParams"
    - path: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      provides: "Project-scoped build page"
      contains: "useParams"
    - path: "frontend/src/app/(dashboard)/projects/[id]/strategy/page.tsx"
      provides: "Project-scoped strategy page"
      contains: "useParams"
    - path: "frontend/src/app/(dashboard)/projects/[id]/timeline/page.tsx"
      provides: "Project-scoped timeline page"
      contains: "useParams"
  key_links:
    - from: "frontend/src/hooks/useOnboarding.ts"
      to: "/projects/{id}/understanding"
      via: "window.location.href redirect"
      pattern: "/projects/.*understanding"
    - from: "frontend/src/hooks/useUnderstandingInterview.ts"
      to: "/api/understanding/{projectId}/brief"
      via: "apiFetch PATCH with projectId param"
      pattern: "api/understanding/.*/brief"
    - from: "frontend/src/components/understanding/IdeaBriefCard.tsx"
      to: "editBriefSection"
      via: "onBlur handler calling onEdit"
      pattern: "onBlur"
---

<objective>
Unify all project-scoped routes under /projects/[id]/... and fix the brief edit 404 with blur-save and toast notifications.

Purpose: Onboarding discards project_id on redirect (routing to /dashboard instead of /projects/{id}/understanding). Brief editing sends artifactId to a route expecting project_id, causing 404. Project pages are scattered across /understanding, /company/[id]/build, /strategy, /timeline instead of unified under /projects/[id]/.

Output: Unified route structure, working onboarding-to-understanding flow, and functional brief editing with blur-save and toast.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-cross-phase-frontend-wiring/11-RESEARCH.md

@frontend/src/hooks/useOnboarding.ts
@frontend/src/hooks/useUnderstandingInterview.ts
@frontend/src/app/(dashboard)/understanding/page.tsx
@frontend/src/app/(dashboard)/company/[id]/build/page.tsx
@frontend/src/app/(dashboard)/company/[id]/deploy/page.tsx
@frontend/src/app/(dashboard)/strategy/page.tsx
@frontend/src/app/(dashboard)/timeline/page.tsx
@frontend/src/components/understanding/IdeaBriefCard.tsx
@frontend/src/components/understanding/IdeaBriefView.tsx
@frontend/src/components/ui/brand-nav.tsx
@frontend/src/components/timeline/TimelineCard.tsx
@frontend/src/app/(dashboard)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unify project-scoped routes under /projects/[id]/... and fix onboarding redirect</name>
  <files>
    frontend/src/hooks/useOnboarding.ts
    frontend/src/app/(dashboard)/projects/[id]/understanding/page.tsx
    frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
    frontend/src/app/(dashboard)/projects/[id]/deploy/page.tsx
    frontend/src/app/(dashboard)/projects/[id]/strategy/page.tsx
    frontend/src/app/(dashboard)/projects/[id]/timeline/page.tsx
    frontend/src/app/(dashboard)/understanding/page.tsx
    frontend/src/components/ui/brand-nav.tsx
    frontend/src/components/timeline/TimelineCard.tsx
    frontend/src/app/(dashboard)/dashboard/page.tsx
    frontend/src/app/(dashboard)/timeline/page.tsx
  </files>
  <action>
**Step 1: Fix onboarding redirect (useOnboarding.ts)**

In `useOnboarding.ts`, find the `createProject` function around line 454-460. Change the success redirect from:
```typescript
window.location.href = "/dashboard";
```
to:
```typescript
window.location.href = `/projects/${data.project_id}/understanding?sessionId=${state.sessionId}`;
```
This preserves the project_id AND sessionId for the understanding interview page.

**Step 2: Create project-scoped understanding page**

Create `frontend/src/app/(dashboard)/projects/[id]/understanding/page.tsx`:
- Copy the content from the existing `understanding/page.tsx`
- Change how `projectId` is obtained: replace `searchParams.get("projectId") || ""` with `useParams<{ id: string }>().id`
- Import `useParams` from `next/navigation`
- Add a guard for missing onboarding session (locked decision): if no `onboardingSessionId` and state is `idle`, show an inline message "Complete onboarding first" with a Link to `/onboarding` (not a redirect)
- The `onboardingSessionId` still comes from `searchParams.get("sessionId")` — this is the onboarding session continuation param
- All `router.push("/dashboard")` calls in the page remain as-is (those are exit navigation)

**Step 3: Create project-scoped build page**

Create `frontend/src/app/(dashboard)/projects/[id]/build/page.tsx`:
- Copy content from existing `company/[id]/build/page.tsx`
- The page already uses `useParams<{ id: string }>()` for projectId — no change needed to params
- Update the deploy link: change `href={/company/${projectId}/deploy}` or any back links to use `/projects/${projectId}/deploy`

**Step 4: Create project-scoped deploy page**

Create `frontend/src/app/(dashboard)/projects/[id]/deploy/page.tsx`:
- Copy content from existing `company/[id]/deploy/page.tsx`
- The page already uses `useParams()` for projectId — update the back link from `href={/company/${projectId}}` to `href={/projects/${projectId}/build}`

**Step 5: Create project-scoped strategy page**

Create `frontend/src/app/(dashboard)/projects/[id]/strategy/page.tsx`:
- Copy content from existing `strategy/page.tsx`
- The current strategy page gets `project` from `searchParams.get("project")`. Change to: read `projectId` from `useParams<{ id: string }>().id`
- Keep `highlight` from `searchParams.get("highlight")` — that stays as a query param
- Remove the "Select a Project" empty state (since project is in the URL, it's always present)
- Update the "Select a Project" fallback to show the graph for `params.id` directly

**Step 6: Create project-scoped timeline page**

Create `frontend/src/app/(dashboard)/projects/[id]/timeline/page.tsx`:
- Copy content from existing `timeline/page.tsx`
- Change project selection: read `projectId` from `useParams<{ id: string }>().id` instead of fetching project list and selecting
- Remove the project selector dropdown (since project is in URL)
- Update the "View in graph" navigation from `router.push(/strategy?project=${projectId}&highlight=${nodeId})` to `router.push(/projects/${projectId}/strategy?highlight=${nodeId})`

**Step 7: Convert old routes to redirects**

Update `frontend/src/app/(dashboard)/understanding/page.tsx` to a simple redirect page:
```typescript
"use client";
import { useSearchParams } from "next/navigation";
import { redirect } from "next/navigation";

export default function UnderstandingRedirect() {
  const searchParams = useSearchParams();
  const projectId = searchParams.get("projectId");
  if (projectId) {
    redirect(`/projects/${projectId}/understanding?${searchParams.toString()}`);
  }
  redirect("/dashboard");
}
```

**Step 8: Update BrandNav links**

In `brand-nav.tsx`, the `navLinks` array currently has flat routes for `/strategy` and `/timeline`. These are now project-scoped and shouldn't appear as static nav links since they need a project ID. Two options:
- Keep them in nav but they'll lead to the project list (user picks a project) — this is simpler
- Remove them from nav

**Decision (Claude's discretion):** Keep `/strategy` and `/timeline` in BrandNav as-is. The existing flat-route pages at `/strategy` and `/timeline` will remain functional — they have project selectors. The new `/projects/[id]/strategy` and `/projects/[id]/timeline` pages are accessed from within project context (dashboard cards, build page, etc). No BrandNav change needed.

**Step 9: Update internal navigation links**

1. `frontend/src/app/(dashboard)/dashboard/page.tsx` line 219: Change `href={/understanding?projectId=${pendingGateProjects[0].id}}` to `href={/projects/${pendingGateProjects[0].id}/understanding}`

2. `frontend/src/components/timeline/TimelineCard.tsx` line 63: Change `href={/strategy?project=${item.project_id}&highlight=${item.graph_node_id}}` to `href={/projects/${item.project_id}/strategy?highlight=${item.graph_node_id}}`

3. `frontend/src/app/(dashboard)/timeline/page.tsx` line 126: Change `router.push(/strategy?project=${projectId}&highlight=${nodeId})` to `router.push(/projects/${projectId}/strategy?highlight=${nodeId})`
  </action>
  <verify>
1. `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit` — no TypeScript errors
2. Verify new files exist: `ls frontend/src/app/(dashboard)/projects/[id]/understanding/page.tsx frontend/src/app/(dashboard)/projects/[id]/build/page.tsx frontend/src/app/(dashboard)/projects/[id]/strategy/page.tsx frontend/src/app/(dashboard)/projects/[id]/timeline/page.tsx frontend/src/app/(dashboard)/projects/[id]/deploy/page.tsx`
3. Grep for `window.location.href = "/dashboard"` in useOnboarding.ts — should NOT exist
4. Grep for `data.project_id` in useOnboarding.ts — should exist in redirect
5. Grep for `searchParams.get("projectId")` in the new understanding page — should NOT exist (uses params.id)
6. Grep for `useParams` in the new understanding page — should exist
  </verify>
  <done>
All project-scoped pages live under /projects/[id]/... pattern. Onboarding redirect preserves project_id and sessionId. Understanding page reads projectId from URL path segment. Old /understanding route redirects to new location. Internal navigation links updated. Strategy and Timeline accessible both from nav (with project selector) and from project context (via /projects/[id]/...).
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix brief edit 404 with blur-save and toast notifications</name>
  <files>
    frontend/src/hooks/useUnderstandingInterview.ts
    frontend/src/components/understanding/IdeaBriefCard.tsx
    frontend/src/components/understanding/IdeaBriefView.tsx
  </files>
  <action>
**Step 1: Fix editBriefSection in useUnderstandingInterview.ts**

The current `editBriefSection` at line 310 sends `state.artifactId` to `PATCH /api/understanding/${state.artifactId}/brief`. The backend expects `project_id`, not `artifactId`.

1. Change `editBriefSection` signature to accept `projectId` as the first parameter:
   ```typescript
   const editBriefSection = useCallback(
     async (projectId: string, sectionKey: string, newContent: string) => {
   ```

2. Change the API call from:
   ```typescript
   `/api/understanding/${state.artifactId}/brief`
   ```
   to:
   ```typescript
   `/api/understanding/${projectId}/brief`
   ```

3. Remove `state.artifactId` from the guard at top: change `if (!state.artifactId) return;` to `if (!projectId) return;`

4. Add toast notifications (locked decision):
   - Import `toast` from `sonner` at the top of the file
   - On success (after updating confidence scores): add `toast.success("Section updated");`
   - On failure: **do NOT revert the optimistic update** (locked decision — keep user's text visible). Remove the current error-only setState and replace with:
     ```typescript
     catch (err) {
       // Do NOT revert state — keep user's text visible (locked decision)
       toast.error("Failed to save section. Tap to retry.", {
         action: {
           label: "Retry",
           onClick: () => editBriefSection(projectId, sectionKey, newContent),
         },
       });
     }
     ```
   - The existing `setState` in the catch that sets `error` can remain for debug purposes, but the brief state must NOT be reverted.

5. Update `useCallback` deps: remove `state.artifactId`, keep `getToken`.

6. Update the return type / hook return: `editBriefSection` now takes 3 args `(projectId, sectionKey, newContent)` instead of 2.

**Step 2: Update IdeaBriefView to pass projectId to editBriefSection**

In `IdeaBriefView.tsx`, the `onEditSection` prop is typed as `(sectionKey: string, newContent: string) => void`. Update:

1. Change prop type to `(projectId: string, sectionKey: string, newContent: string) => void`
2. In the JSX where `IdeaBriefCard` receives `onEdit`, change from `onEdit={onEditSection}` to pass projectId:
   ```typescript
   onEdit={(sectionKey, newContent) => onEditSection(projectId, sectionKey, newContent)}
   ```
   The `projectId` prop is already passed to `IdeaBriefView` — it's in the interface.

**Step 3: Update IdeaBriefCard for blur-save (locked decision: save on blur)**

In `IdeaBriefCard.tsx`:

1. Add `onBlur={handleSave}` to the textarea element (line ~78-82):
   ```tsx
   <textarea
     value={editValue}
     onChange={(e) => setEditValue(e.target.value)}
     onBlur={handleSave}
     className="..."
     rows={6}
   />
   ```

2. Keep the existing Save and Cancel buttons — blur-save is the PRIMARY trigger but explicit save is still available.

3. The `handleSave` function already calls `onEdit(section.key, editValue)` and sets `isEditMode(false)` — no change needed to the save logic itself.

**Step 4: Update the understanding page call site**

In the **new** `/projects/[id]/understanding/page.tsx` (created in Task 1), the `editBriefSection` is called via the `useUnderstandingInterview` hook. The page passes it to `IdeaBriefView` as `onEditSection`. Since `editBriefSection` now takes `projectId` as first arg, ensure the page passes it correctly:

```typescript
<IdeaBriefView
  brief={state.brief}
  onEditSection={editBriefSection}
  ...
  projectId={projectId}
/>
```

This should work because `editBriefSection` from the hook already has the right signature `(projectId, sectionKey, newContent)`, and `IdeaBriefView` wraps it with `projectId` from its props when passing to `IdeaBriefCard`.
  </action>
  <verify>
1. `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit` — no TypeScript errors
2. Grep for `state.artifactId` in `editBriefSection` function — should NOT appear in the PATCH URL
3. Grep for `api/understanding/${projectId}/brief` in `useUnderstandingInterview.ts` — should match
4. Grep for `toast.success` in `useUnderstandingInterview.ts` — should match
5. Grep for `toast.error` in `useUnderstandingInterview.ts` — should match
6. Grep for `onBlur` in `IdeaBriefCard.tsx` — should match
7. Verify no brief state revert in catch block of editBriefSection — grep for `brief:` in the catch — should NOT revert to old brief
  </verify>
  <done>
Brief section editing sends correct projectId to PATCH endpoint (no more 404). Toast notifications: "Section updated" on success, "Failed to save section. Tap to retry." with retry action on failure. User text preserved on failure (no revert). Blur-save triggers auto-save when user clicks away from textarea field. Explicit Save/Cancel buttons still available.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `cd frontend && npx tsc --noEmit`
2. New route files exist at frontend/src/app/(dashboard)/projects/[id]/{understanding,build,deploy,strategy,timeline}/page.tsx
3. Onboarding redirect goes to /projects/{id}/understanding (not /dashboard)
4. Understanding page reads projectId from useParams (not searchParams)
5. Brief edit calls /api/understanding/{projectId}/brief (not artifactId)
6. Toast notifications fire on brief edit success and failure
7. Blur-save on textarea triggers save
8. Brief state not reverted on edit failure
9. Internal links updated: dashboard gate link, timeline graph links
10. Old /understanding route redirects to new location
</verification>

<success_criteria>
- Onboarding → understanding transition preserves project_id in URL
- Understanding page gets projectId from URL path (never empty)
- Brief section editing persists successfully (no 404)
- "Section updated" toast on success, error toast with retry on failure
- User text preserved on failure (no revert, no lost typing)
- Blur-save auto-saves when user clicks away from field
- All project pages accessible via /projects/[id]/{page} pattern
- Navigating to understanding without completing onboarding shows message (not redirect)
- Internal navigation links use new project-scoped URLs
</success_criteria>

<output>
After completion, create `.planning/phases/11-cross-phase-frontend-wiring/11-02-SUMMARY.md`
</output>
