---
phase: 46-ui-integration
plan: 05
type: execute
wave: 4
depends_on:
  - 46-03
  - 46-04
files_modified:
  - frontend/src/components/build/AutonomousBuildView.tsx
  - frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
autonomous: false
requirements:
  - UIAG-01
  - UIAG-02
  - UIAG-03
  - UIAG-04
  - UIAG-05

must_haves:
  truths:
    - "AutonomousBuildView composes all hooks and wires data to sidebar, feed, badge, and escalation components"
    - "Build page routes to AutonomousBuildView when job is autonomous, existing BuildPage otherwise"
    - "Empty state shows illustration + Start Build CTA before any build"
    - "Returning to running build loads full history from REST + scrolls to latest"
    - "Returning with pending escalations shows attention banner"
    - "Build completion triggers confetti celebration"
    - "Preview toggle adds third column with preview iframe"
    - "Browser push notification fires on first escalation"
    - "Below 768px sidebar collapses, escalation resolution works on mobile"
  artifacts:
    - path: "frontend/src/components/build/AutonomousBuildView.tsx"
      provides: "Top-level layout composing all hooks and child components"
      exports: ["AutonomousBuildView"]
    - path: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      provides: "Page routing autonomous vs non-autonomous build views"
  key_links:
    - from: "frontend/src/components/build/AutonomousBuildView.tsx"
      to: "useAgentEvents"
      via: "Single SSE connection with merged event handlers"
      pattern: "useAgentEvents"
    - from: "frontend/src/components/build/AutonomousBuildView.tsx"
      to: "GsdPhaseSidebar + AgentActivityFeed + AgentStateBadge"
      via: "Props from composed hooks"
      pattern: "GsdPhaseSidebar|AgentActivityFeed|AgentStateBadge"
    - from: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      to: "AutonomousBuildView"
      via: "Conditional render based on job type"
      pattern: "AutonomousBuildView"
---

<objective>
Build the AutonomousBuildView top-level layout component that composes all hooks and wires them to child components, integrate it into the existing build page with routing, and handle all lifecycle states (empty, first activation, running, sleeping, escalation, complete, mobile).

Purpose: This is the integration layer that ties everything together — hooks, sidebar, feed, badge, escalations, preview, empty states, notifications. It is the final plan that delivers the complete autonomous build dashboard.
Output: AutonomousBuildView composition component and modified build page with autonomous routing.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-ui-integration/46-RESEARCH.md
@.planning/phases/46-ui-integration/46-03-SUMMARY.md
@.planning/phases/46-ui-integration/46-04-SUMMARY.md
@frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
@frontend/src/components/build/PreviewPane.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build AutonomousBuildView composition component</name>
  <files>
    frontend/src/components/build/AutonomousBuildView.tsx
  </files>
  <action>
1. Create `frontend/src/components/build/AutonomousBuildView.tsx`:
   - Props: `{ jobId: string; projectId: string; projectName: string; getToken: () => Promise<string | null> }`
   - **Hook composition:** This is the ONLY component that calls the hooks directly.
     ```typescript
     // Phase hooks
     const { phases, activePhaseId, filterPhaseId, setFilterPhaseId, phaseEventHandlers } = useAgentPhases(jobId, getToken);
     // State hook
     const { state, elapsedMs, wakeAt, budgetPct, pendingEscalationCount, currentPhaseName, stateEventHandlers } = useAgentState(jobId, getToken);
     // Feed hook
     const { entries, isTyping, shouldAutoScroll, onUserScroll, jumpToLatest, feedEventHandlers } = useAgentActivityFeed(jobId, getToken);
     // Escalation hook
     const { escalations, pendingCount, resolve, escalationEventHandlers } = useAgentEscalations(jobId, getToken);
     // Single SSE connection — merge all handlers
     const { isConnected } = useAgentEvents(jobId, getToken, {
       ...phaseEventHandlers,
       ...stateEventHandlers,
       ...feedEventHandlers,
       ...escalationEventHandlers,
     });
     ```
   - **Layout:** Two-column by default: `[Sidebar 280px] [Feed flex-1]`. Three-column when preview active: `[Sidebar 280px] [Feed flex-1] [Preview 50%]`.
     ```html
     <div className="flex h-full">
       <GsdPhaseSidebar ... />
       <div className="flex-1 flex flex-col overflow-hidden">
         {/* Header bar */}
         {/* Escalation attention banner */}
         <AgentActivityFeed ... />
       </div>
       {showPreview && <div className="w-1/2 border-l border-white/10"><PreviewPane ... /></div>}
     </div>
     <AgentStateBadge ... />
     ```
   - **Header bar:** Compact bar at top of feed area. Breadcrumb: "Projects > {projectName} > Build". Preview toggle button on the right.
   - **Escalation attention banner:** When returning with pending escalations (pendingCount > 0 and page just loaded), show attention banner at top: "Your co-founder needs your input on {pendingCount} items" with a link to jump to the first pending escalation in the feed. Dismiss on click.
   - **Phase-to-feed wiring:** When user clicks a phase in sidebar, `setFilterPhaseId` updates both sidebar selection and feed filtering (shared state).
   - **Empty state (no job yet):** When jobId is null or job has no events yet:
     - Friendly illustration (a simple SVG or lucide-react Rocket icon, large, centered)
     - Text: "Your co-founder is ready to build"
     - Prominent "Start Build" CTA button (links to the existing start generation flow)
   - **Build complete state:** When `state === "completed"`:
     - Trigger confetti via `canvas-confetti` (already installed). Fire once on transition to completed.
     - Show completion CTAs in the feed: "View your app" (link to preview), "Download code" (if available), "Start new milestone".
   - **First activation animation:** When transitioning from empty to first entries arriving:
     - Timeline phases animate in one by one (stagger via framer-motion).
     - Feed shows first narration entry sliding in.
   - **Preview toggle:** State `showPreview` controls third column. Toggle button in header. Auto-refresh preview when agent deploys or updates sandbox (pass `refreshKey` to PreviewPane, increment on relevant events).
   - **Browser push notifications:** On first `agent.waiting_for_input` event, check `Notification.permission`. If "default", request permission. If "granted", send notification: "Your co-founder needs your help" with body from escalation problem summary. Only trigger on first escalation per page session (track with ref).
   - **"Wake now" handler:** When badge's onWakeNow is clicked, POST to an appropriate wake endpoint (if exists) or trigger via existing WebSocket/Redis mechanism. For now, wire the callback and add a `TODO` comment if the exact API endpoint is not yet confirmed.
   - **"Pause after current phase" handler:** Similar — wire callback with appropriate API call or TODO.

2. **Overall progress calculation:** `overallProgress = Math.round((phasesCompleted / phasesTotal) * 100)` — pass to sidebar.

3. **Mobile responsive:** Below `md` (768px):
   - Sidebar renders as compact horizontal strip at top (handled by GsdPhaseSidebar internally).
   - Feed takes full width.
   - Preview hidden (toggle disabled).
   - Badge same position (bottom-right).
   - Escalation resolution works (buttons/form are naturally responsive).

IMPORTANT: This component is the single source of truth for all state. No child components call hooks directly. All data flows down via props.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | tail -20</automated>
    <manual>Verify AutonomousBuildView composes all hooks, renders sidebar + feed + badge, wires phase click to feed filter, shows empty/complete states</manual>
  </verify>
  <done>AutonomousBuildView composes all 5 hooks with a single SSE connection, renders two/three-column layout with sidebar + feed + optional preview, wires phase-to-feed filtering, shows empty state with Start Build CTA, triggers confetti on completion, shows escalation attention banner on return, fires browser push notification on first escalation, handles mobile responsive layout.</done>
</task>

<task type="auto">
  <name>Task 2: Wire AutonomousBuildView into build page with routing</name>
  <files>
    frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
  </files>
  <action>
1. Modify the existing `frontend/src/app/(dashboard)/projects/[id]/build/page.tsx`:
   - Add import for `AutonomousBuildView` from `@/components/build/AutonomousBuildView`.
   - The existing page has a `PreBuildView` (shown before build starts) and `BuildPage` (shown during/after build).
   - Add logic to detect autonomous builds: check the job status response for an `autonomous` flag, OR check `AUTONOMOUS_AGENT` feature flag from the project/job data.
   - **Routing logic:**
     ```typescript
     // If no job yet: show PreBuildView (existing)
     // If job exists and is autonomous: show AutonomousBuildView
     // If job exists and is NOT autonomous: show existing BuildPage (legacy pipeline)
     ```
   - Pass required props to AutonomousBuildView: `jobId`, `projectId`, `projectName`, `getToken`.
   - The existing `useAuth()` from Clerk provides `getToken`. The existing page already has `jobId` from the build progress hook or API.
   - Ensure the page layout gives AutonomousBuildView full height: `h-[calc(100vh-64px)]` or similar (subtract header height).
   - Keep all existing non-autonomous build code intact — this is additive, not a replacement.

2. **Verify backward compatibility:**
   - Non-autonomous builds must still render the existing BuildPage with BuildProgressBar, BuildLogPanel, etc.
   - The `PreBuildView` still renders for projects without a started build.
   - No existing imports or components are deleted.

IMPORTANT: This is a MODIFY of an existing file. Read the full file first, then make surgical additions. Do not restructure the existing page layout for non-autonomous builds.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | tail -20</automated>
    <manual>Verify build page renders AutonomousBuildView for autonomous jobs and existing BuildPage for non-autonomous jobs. PreBuildView still works for projects without a build.</manual>
  </verify>
  <done>Build page routes to AutonomousBuildView when job is autonomous, existing BuildPage for non-autonomous, and PreBuildView when no build started. All existing functionality preserved. TypeScript compiles cleanly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of complete autonomous build dashboard</name>
  <files>frontend/src/components/build/AutonomousBuildView.tsx</files>
  <action>
Human verifies the complete autonomous build dashboard visually.

What was built: Kanban Timeline sidebar (vertical timeline with phase cards, connecting line, colored dots, progress bar), Activity Feed (chat-bubble narration, per-entry verbose expand, phase dividers, typing indicator, auto-scroll), Agent State Badge (floating badge with popover, countdown/elapsed timers, control actions), Escalation Flow (inline entries with decision buttons, resolution, attention banner), Empty/Complete states (illustration, confetti), Preview toggle, Mobile responsive layout, Browser push notifications for escalations.

Steps:
1. Start the frontend dev server: `cd frontend && npm run dev`
2. Navigate to `/projects/{id}/build` for a project with an autonomous build job
3. Sidebar: Verify vertical timeline shows phases with colored dots (green/blue/gray), connecting line, progress bar at top. Click a phase to filter the feed.
4. Activity Feed: Verify chat-bubble entries appear. Click an expand arrow to see verbose tool details (human-readable, not JSON). Scroll up — "Jump to latest" button should appear.
5. Agent State Badge: Verify floating badge in bottom-right shows correct state. Click to open popover with details and control actions.
6. Escalation: If an escalation is pending, verify inline entry with problem summary, expandable "What I tried", decision buttons. Click a decision to resolve.
7. Empty state: Navigate to a project without a build — verify "Your co-founder is ready to build" message with Start Build CTA.
8. Mobile: Resize browser below 768px. Verify sidebar collapses to horizontal strip, feed takes full width.
9. Non-autonomous fallback: Navigate to a project with a non-autonomous build — verify the existing BuildPage still renders correctly.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/frontend && npm run build 2>&1 | tail -10</automated>
    <manual>Visual verification of all 9 items listed in action steps</manual>
  </verify>
  <done>Human approves the autonomous build dashboard visual and functional quality. All layout, interaction, and responsive behaviors match CONTEXT.md decisions.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero type errors
2. `cd frontend && npm run build` — production build succeeds
3. AutonomousBuildView renders correctly with all subcomponents
4. Build page routes correctly between autonomous and non-autonomous views
5. Existing non-autonomous build functionality unbroken
6. Mobile responsive layout works at 768px breakpoint
7. Human visual verification of complete dashboard
</verification>

<success_criteria>
- AutonomousBuildView composes all hooks with single SSE connection
- Build page correctly routes autonomous vs non-autonomous builds
- All 5 requirements (UIAG-01 through UIAG-05) are satisfied end-to-end
- Empty state, running state, sleeping state, escalation state, complete state all render correctly
- Confetti on build completion via canvas-confetti
- Browser push notification on first escalation
- Preview toggle adds third column
- Mobile responsive below 768px
- Existing non-autonomous build page unbroken
- Human verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/46-ui-integration/46-05-SUMMARY.md`
</output>
