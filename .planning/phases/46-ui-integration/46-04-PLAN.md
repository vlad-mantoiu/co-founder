---
phase: 46-ui-integration
plan: 04
type: execute
wave: 3
depends_on:
  - 46-02
files_modified:
  - frontend/src/components/build/AgentActivityFeed.tsx
  - frontend/src/components/build/ActivityFeedEntry.tsx
  - frontend/src/components/build/EscalationEntry.tsx
autonomous: true
requirements:
  - UIAG-02
  - UIAG-03

must_haves:
  truths:
    - "Activity feed shows chat-bubble style narration entries with agent avatar"
    - "Each entry has a per-entry expand arrow revealing verbose tool details underneath"
    - "Verbose tool details show human-readable labels, not raw JSON"
    - "Escalation entries appear inline with problem summary, collapsible attempts, decision buttons"
    - "Phase dividers separate entries when a new GSD phase starts"
    - "Auto-scroll to latest entry stops when user scrolls up; Jump to latest button appears"
    - "Typing indicator shows animated dots when agent is between actions"
  artifacts:
    - path: "frontend/src/components/build/AgentActivityFeed.tsx"
      provides: "Scrollable feed container with auto-scroll, typing indicator, phase dividers"
      exports: ["AgentActivityFeed"]
    - path: "frontend/src/components/build/ActivityFeedEntry.tsx"
      provides: "Single feed entry with narration text and per-entry verbose expand"
      exports: ["ActivityFeedEntry"]
    - path: "frontend/src/components/build/EscalationEntry.tsx"
      provides: "Inline escalation entry with decision buttons and resolution state"
      exports: ["EscalationEntry"]
  key_links:
    - from: "frontend/src/components/build/AgentActivityFeed.tsx"
      to: "useAgentActivityFeed"
      via: "entries/isTyping/shouldAutoScroll props"
      pattern: "FeedEntry\\[\\]"
    - from: "frontend/src/components/build/EscalationEntry.tsx"
      to: "useAgentEscalations"
      via: "escalation prop + onResolve callback"
      pattern: "Escalation"
---

<objective>
Build the Activity Feed panel that shows narration entries in chat-bubble style, per-entry verbose tool details, inline escalation entries with decision buttons, phase dividers, typing indicator, and auto-scroll behavior.

Purpose: The activity feed is the primary way a founder follows the agent's work. It shows human-readable narration by default and reveals tool-level detail on demand per CONTEXT.md decisions (per-entry expand, not global toggle).
Output: 3 presentational components for the activity feed area of the autonomous build dashboard.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-ui-integration/46-RESEARCH.md
@.planning/phases/46-ui-integration/46-02-SUMMARY.md
@frontend/src/components/chat/ChatWindow.tsx
@frontend/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build ActivityFeedEntry and EscalationEntry components</name>
  <files>
    frontend/src/components/build/ActivityFeedEntry.tsx
    frontend/src/components/build/EscalationEntry.tsx
  </files>
  <action>
1. Create `frontend/src/components/build/ActivityFeedEntry.tsx`:
   - Props: `{ entry: FeedEntry }` (FeedEntry type from useAgentActivityFeed).
   - **Layout:** Chat-bubble style with agent avatar on the left. Avatar: small circle with "CF" initials or a bot icon (lucide-react `Bot`), brand color background.
   - **Narration entries (type: "narration"):**
     - Show narration `text` as main content in casual co-founder tone.
     - Timestamp on the right (relative: "2m ago", "just now").
     - If the entry has associated tool calls (toolName/toolLabel), show a subtle expand arrow (ChevronDown from lucide-react) on the right.
     - **Per-entry verbose expand:** Click the expand arrow to reveal tool details below the narration text. Use framer-motion for smooth height transition.
     - Verbose content: human-readable label (`toolLabel`) + summary (`toolSummary`). Format: `"Wrote 47 lines to app/auth/login.tsx"`, `"Ran: npm install"`, `"Searched for 'auth middleware'"`. NO raw JSON.
     - Use local `useState<boolean>` for expand/collapse per entry — NOT a global toggle.
   - **Tool call entries (type: "tool_call"):**
     - Slightly muted style (smaller text, dimmer). Shows `toolLabel` as primary text and `toolSummary` below.
     - Only visible when a narration entry above is expanded, OR as standalone entries in verbose view.
     - Tool icon: matching lucide-react icon per tool (FileText for read/write/edit, Terminal for bash, Search for grep/glob, Camera for screenshot, MessageCircle for narrate, FileText for document).
   - **Phase divider entries (type: "phase_divider"):**
     - Thin horizontal line with phase name text centered. Use `border-t border-white/10` with text `text-xs text-white/40 uppercase tracking-wider`.
   - **System entries (type: "system"):**
     - Italic, muted text. For system messages like "Build started", "Agent waking up".

2. Create `frontend/src/components/build/EscalationEntry.tsx`:
   - Props:
     ```typescript
     interface EscalationEntryProps {
       escalation: Escalation;
       onResolve: (escalationId: string, decision: string, guidance?: string) => Promise<void>;
     }
     ```
   - **Layout:** Distinct from normal feed entries. Colored left border: amber for pending, green for resolved. Slightly different background (amber-tinted glass for pending).
   - **Pending state:**
     - **Problem summary:** `escalation.plain_english_problem` in prominent text.
     - **What I tried:** Collapsible section (default collapsed) showing `escalation.attempts_summary` as a numbered list. Each attempt: approach + result.
     - **Recommended action:** Highlighted above the options in a distinct callout box (e.g., `bg-blue-900/30 border-l-2 border-blue-500`). Text: `escalation.recommended_action`.
     - **Decision buttons:** Render each option from `escalation.options` as a button. Options are one-click.
     - **Free-text guidance:** Only appears when founder clicks "Provide guidance" option (if such option exists in options list). Shows a text input + "Submit" button. Use `useState` for the guidance text.
     - On button click: call `onResolve(escalation.id, option.id, guidance?)`. Show loading spinner on the clicked button. Disable all buttons during resolution.
   - **Resolved state (`escalation.status === "resolved"`):**
     - Collapsed view with green check icon. Shows: "Resolved: {founder_decision}" as one-liner.
     - Expandable to show full escalation details (problem, attempts, decision made).
     - Decision buttons hidden. Green left border.
   - **Animation:** Pending escalation entry slides in with framer-motion `motion.div` initial opacity 0 + y offset.

IMPORTANT: No raw JSON anywhere. All escalation data is rendered with human-readable formatting. "What I tried" section shows attempt descriptions, not error hashes or stack traces.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | tail -20</automated>
    <manual>Verify ActivityFeedEntry shows chat-bubble with expand arrow, EscalationEntry shows problem/attempts/buttons with correct pending/resolved states</manual>
  </verify>
  <done>ActivityFeedEntry renders chat-bubble narration with per-entry verbose expand revealing human-readable tool details. EscalationEntry renders inline escalation with problem summary, collapsible attempts, recommended action callout, decision buttons for pending state, and collapsed resolved state with green check.</done>
</task>

<task type="auto">
  <name>Task 2: Build AgentActivityFeed container with auto-scroll and typing indicator</name>
  <files>
    frontend/src/components/build/AgentActivityFeed.tsx
  </files>
  <action>
1. Create `frontend/src/components/build/AgentActivityFeed.tsx`:
   - Props:
     ```typescript
     interface AgentActivityFeedProps {
       entries: FeedEntry[];
       escalations: Escalation[];
       isTyping: boolean;
       shouldAutoScroll: boolean;
       onUserScroll: (scrollTop: number, scrollHeight: number, clientHeight: number) => void;
       onJumpToLatest: () => void;
       onResolveEscalation: (escalationId: string, decision: string, guidance?: string) => Promise<void>;
       filterPhaseId: string | null;
     }
     ```
   - **Container:** Full height flex column. Scrollable area (`overflow-y-auto`) with ref for scroll tracking.
   - **Entry rendering:** Map over `entries`, rendering appropriate component per entry type:
     - `"narration"` / `"tool_call"` / `"system"` -> `<ActivityFeedEntry>`
     - `"phase_divider"` -> Phase divider (inline or via ActivityFeedEntry)
     - `"escalation"` -> Find matching escalation from `escalations` prop by `entry.escalationId`, render `<EscalationEntry>` with `onResolve` callback.
   - Use `entry.id` as React key (Redis stream entry ID per Pitfall 3 — no index keys).
   - **Phase filtering:** When `filterPhaseId` is set, only show entries where `entry.phaseId === filterPhaseId` (plus phase_divider for that phase). Show a subtle filter indicator at top: "Showing: {phaseName}" with an "x" clear button.
   - **Auto-scroll behavior:**
     - Track scroll position via `onScroll` handler on the container.
     - If user scrolls up (scrollTop < scrollHeight - clientHeight - 50), set `userScrolledUp = true` via the `onUserScroll` callback.
     - If `shouldAutoScroll` is true, scroll to bottom when new entries arrive. Use `useRef` for the scroll container + `scrollTop = scrollHeight`.
     - When `shouldAutoScroll` is false (user scrolled up), show a "Jump to latest" floating button at the bottom of the feed area. On click, call `onJumpToLatest`.
   - **Typing indicator:** At the bottom of the feed (below all entries), show animated dots when `isTyping` is true. Use framer-motion for 3 bouncing dots:
     ```tsx
     <AnimatePresence>
       {isTyping && (
         <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
           className="flex items-center gap-1 px-4 py-3">
           <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold text-white mr-3">CF</div>
           {[0, 1, 2].map((i) => (
             <motion.span key={i} className="w-2 h-2 rounded-full bg-white/40"
               animate={{ y: [0, -4, 0] }}
               transition={{ repeat: Infinity, duration: 0.6, delay: i * 0.15 }} />
           ))}
         </motion.div>
       )}
     </AnimatePresence>
     ```
   - **Empty state:** When entries is empty and not typing, show a centered message: "Activity will appear here as your co-founder works." with a subtle ghost icon.
   - **Loading history on refresh:** The parent passes pre-loaded entries from REST. The feed renders them immediately, then appends SSE-driven entries.

IMPORTANT: The feed container does NOT call any hooks directly. All data and callbacks come through props. This is a pure presentational component.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | tail -20</automated>
    <manual>Verify feed renders entries with correct component per type, auto-scroll stops on user scroll, typing indicator shows animated dots, Jump to latest button appears when scrolled up</manual>
  </verify>
  <done>AgentActivityFeed renders entries per type (narration, tool_call, escalation, phase_divider), handles auto-scroll with user-override detection, shows Jump to latest button when scrolled up, displays typing indicator with animated dots, supports phase filtering, and uses entry.id as React keys (no index collisions).</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero type errors
2. ActivityFeedEntry per-entry expand reveals tool details (not raw JSON)
3. EscalationEntry decision buttons call onResolve with correct params
4. AgentActivityFeed uses entry.id as React key (not index)
5. Typing indicator renders 3 animated dots
6. Auto-scroll behavior: scrolls on new entry, stops on user scroll up, Jump to latest works
</verification>

<success_criteria>
- Chat-bubble style narration entries with agent avatar
- Per-entry expand arrow revealing verbose tool details with human-readable labels
- Inline escalation entries with problem summary, collapsible attempts, decision buttons
- Resolved escalations show collapsed state with green check
- Phase dividers separate entries by GSD phase
- Auto-scroll with user-override and Jump to latest button
- Typing indicator with animated dots during agent.thinking
- Empty state message when no entries
- Phase filtering shows only entries for selected phase
</success_criteria>

<output>
After completion, create `.planning/phases/46-ui-integration/46-04-SUMMARY.md`
</output>
