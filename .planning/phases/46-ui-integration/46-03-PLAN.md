---
phase: 46-ui-integration
plan: 03
type: execute
wave: 3
depends_on:
  - 46-02
files_modified:
  - frontend/src/components/build/GsdPhaseSidebar.tsx
  - frontend/src/components/build/GsdPhaseCard.tsx
  - frontend/src/components/build/AgentStateBadge.tsx
autonomous: true
requirements:
  - UIAG-01
  - UIAG-04

must_haves:
  truths:
    - "GSD phases render as a vertical timeline sidebar with connecting line and colored dot nodes"
    - "Completed phases collapse to one-liner, in-progress phases show full details with blue animated indicator"
    - "Clicking a phase card filters the activity feed to that phase"
    - "Floating badge in bottom-right shows current agent state with correct icon and color"
    - "Clicking badge opens popover with full details including budget, phase progress, and control actions"
    - "Sidebar collapses to horizontal strip on mobile below 768px"
  artifacts:
    - path: "frontend/src/components/build/GsdPhaseSidebar.tsx"
      provides: "Vertical Kanban timeline sidebar with progress bar and phase list"
      exports: ["GsdPhaseSidebar"]
    - path: "frontend/src/components/build/GsdPhaseCard.tsx"
      provides: "Individual phase card with expand/collapse and status indicators"
      exports: ["GsdPhaseCard"]
    - path: "frontend/src/components/build/AgentStateBadge.tsx"
      provides: "Floating badge with popover for agent lifecycle state"
      exports: ["AgentStateBadge"]
  key_links:
    - from: "frontend/src/components/build/GsdPhaseSidebar.tsx"
      to: "useAgentPhases hook"
      via: "phases prop from parent"
      pattern: "GsdPhase\\[\\]"
    - from: "frontend/src/components/build/AgentStateBadge.tsx"
      to: "useAgentState hook"
      via: "state/elapsedMs/wakeAt/budgetPct props from parent"
      pattern: "AgentLifecycleState"
---

<objective>
Build the Kanban Timeline sidebar (vertical phase timeline with rich cards, progress bar, connecting line) and the Agent State Badge (floating bottom-right badge with details popover and control actions).

Purpose: These are the two primary ambient awareness UI elements — the sidebar shows build progress at a glance, the badge shows agent lifecycle state. Together they let a founder understand what's happening without reading the activity feed.
Output: 3 presentational components that receive data from hooks via props.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-ui-integration/46-RESEARCH.md
@.planning/phases/46-ui-integration/46-02-SUMMARY.md
@frontend/src/app/globals.css
@frontend/src/components/ui/glass-card.tsx
@frontend/src/components/timeline/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build GsdPhaseSidebar and GsdPhaseCard components</name>
  <files>
    frontend/src/components/build/GsdPhaseSidebar.tsx
    frontend/src/components/build/GsdPhaseCard.tsx
  </files>
  <action>
1. Create `frontend/src/components/build/GsdPhaseCard.tsx`:
   - Props: `{ phase: GsdPhase; isActive: boolean; isSelected: boolean; onClick: () => void }`
   - Import `GsdPhase` type from `useAgentPhases.ts` (or define locally and re-export).
   - Three visual states per CONTEXT.md:
     - **Completed (green):** Collapsed one-liner showing phase name + green check icon. Click to expand with full details.
     - **In-progress (blue, animated):** Expanded card showing phase name, plan progress (`2/3 plans`), elapsed time, one-liner goal description. Blue left border with subtle pulse animation using framer-motion.
     - **Pending (gray, dimmed):** Phase name only, dimmed text (text-white/40), no expand.
   - Expand/collapse: use framer-motion `AnimatePresence` + `motion.div` with `initial={{ height: 0, opacity: 0 }}` / `animate={{ height: "auto", opacity: 1 }}`.
   - Status icon: CheckCircle2 (green) for completed, Loader2 (blue, animate-spin) for in-progress, Circle (gray) for pending — all from lucide-react.
   - Clicking calls `onClick` prop (parent sets filterPhaseId).
   - Selected state: slightly brighter border/background to show which phase is filtering the feed.
   - Use Tailwind classes consistent with existing components. Use `cn()` utility for conditional classes.

2. Create `frontend/src/components/build/GsdPhaseSidebar.tsx`:
   - Props: `{ phases: GsdPhase[]; activePhaseId: string | null; selectedPhaseId: string | null; onPhaseClick: (phaseId: string | null) => void; overallProgress: number }`
   - **Progress bar at top:** Horizontal bar showing overall milestone completion. Use existing brand gradient. Label: "v0.7 — {overallProgress}%".
   - **Vertical timeline line:** Absolute-positioned thin line (w-0.5) running vertically through all phase cards. Colored segments: green for completed phases, blue for in-progress, gray for pending.
   - **Dot nodes:** Colored circles at each phase intersection on the timeline line. Green filled for completed, blue with ring animation for in-progress, gray outline for pending.
   - **Phase cards:** Render `GsdPhaseCard` for each phase.
   - **Auto-scroll:** When a new phase starts (activePhaseId changes), scroll the sidebar to show the active phase. Use `useRef` on the active card element + `scrollIntoView({ behavior: "smooth", block: "nearest" })`.
   - **Fixed width:** `w-[280px]` per CONTEXT.md. `overflow-y-auto` for scrollable content.
   - **Mobile responsive:** Below `md` breakpoint (768px), render as compact horizontal strip at top of viewport showing only phase dot indicators. Tap on a dot reveals full vertical timeline as an overlay. Use framer-motion for slide-in overlay animation.
   - Clicking a phase card: toggle filterPhaseId (click same phase again to clear filter).
   - Clicking "All phases" or a clear button at the top resets filter.

IMPORTANT: Components are purely presentational. All data comes via props from the parent. No direct hook calls inside these components.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | tail -20</automated>
    <manual>Verify GsdPhaseSidebar renders vertical timeline with dot nodes, GsdPhaseCard shows correct visual states, mobile view collapses to horizontal strip</manual>
  </verify>
  <done>GsdPhaseSidebar renders a fixed-width vertical Kanban timeline with progress bar, connecting line, colored dot nodes, and GsdPhaseCard components. Cards show completed/in-progress/pending states with correct colors and animations. Clicking a card triggers phase filtering. Mobile responsive with horizontal strip below 768px. Auto-scrolls to active phase.</done>
</task>

<task type="auto">
  <name>Task 2: Build AgentStateBadge with popover</name>
  <files>
    frontend/src/components/build/AgentStateBadge.tsx
  </files>
  <action>
1. Create `frontend/src/components/build/AgentStateBadge.tsx`:
   - Props:
     ```typescript
     interface AgentStateBadgeProps {
       state: AgentLifecycleState;
       elapsedMs: number;
       wakeAt: string | null;
       budgetPct: number | null;
       pendingEscalationCount: number;
       currentPhaseName: string | null;
       phasesCompleted: number;
       phasesTotal: number;
       onWakeNow?: () => void;
       onPauseAfterPhase?: () => void;
     }
     ```
   - **Badge (always visible):** Fixed position `bottom-6 right-6` (z-50). Rounded pill shape with icon + text.
   - Badge states per CONTEXT.md:
     - **Working (blue):** `"Building: {currentPhaseName} ({formatElapsed(elapsedMs)})"` with Loader2 spinner icon.
     - **Sleeping (indigo/muted):** `"Resting — wakes in {formatCountdown(wakeAt)}"` with Moon icon (lucide-react `Moon`).
     - **Waiting for input (amber):** `"Needs input"` with subtle pulse animation. If pendingEscalationCount > 1, show `"Needs input ({count})"`. Use `AlertCircle` icon.
     - **Error (red):** `"Error"` with `XCircle` icon. Visually distinct from amber.
     - **Idle/Completed:** `"Build complete"` with `CheckCircle2` icon (green).
   - Badge colors: Use Tailwind bg classes. Working: `bg-blue-600`, Sleeping: `bg-indigo-800`, Waiting: `bg-amber-600 animate-pulse`, Error: `bg-red-600`, Complete: `bg-green-600`.
   - **Popover (on click):** Use framer-motion AnimatePresence for entry/exit. Position: above the badge, right-aligned.
   - Popover content:
     - Current state label (large text)
     - Current phase name
     - Plan progress: `"{phasesCompleted}/{phasesTotal} phases"`
     - Elapsed time (if working)
     - Countdown to wake (if sleeping)
     - Token budget remaining: `"Budget: {budgetPct}% remaining"` — show progress bar
     - Pending escalations count with link/scroll action
     - **Control actions:**
       - When sleeping: "Wake now" button (calls `onWakeNow` prop)
       - When working: "Pause after current phase" button (calls `onPauseAfterPhase` prop)
   - **Countdown timer:** When state is "sleeping" and wakeAt is set, calculate remaining time using `setInterval` every second. Format as `Xh Ym` or `Xm Xs`.
   - **Elapsed timer:** When state is "working", display `formatElapsed(elapsedMs)` formatted as `Xm` or `Xh Ym`.
   - Helper: `formatElapsed(ms: number): string` — returns human-readable elapsed time.
   - Helper: `formatCountdown(wakeAt: string): string` — returns time remaining until wakeAt.
   - Use `useRef` and click-outside handler to close popover.

IMPORTANT: This is a presentational component. `onWakeNow` and `onPauseAfterPhase` are optional callbacks — actual API calls are wired at the page level. The badge does not call useAgentState directly.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | tail -20</automated>
    <manual>Verify badge renders in bottom-right, shows correct state labels and icons, popover opens on click with full details and control actions</manual>
  </verify>
  <done>AgentStateBadge renders a floating pill badge in bottom-right corner with correct icon, color, and label for each agent state. Click opens popover with current phase, plan progress, elapsed time, budget, escalation count, and control actions. Countdown timer for sleeping state and elapsed timer for working state update every second.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero type errors
2. GsdPhaseSidebar renders correctly with 0, 1, 5, and 10+ phases
3. GsdPhaseCard correctly shows green/blue/gray states
4. AgentStateBadge shows correct visual state for all 5 lifecycle states
5. Popover opens/closes correctly with click-outside dismiss
</verification>

<success_criteria>
- Vertical timeline sidebar with connecting line, colored dots, and rich phase cards
- Three visual states: completed (green, collapsed), in-progress (blue, animated, expanded), pending (gray, dimmed)
- Clicking phase card triggers filter callback
- Progress bar at top of sidebar
- Auto-scroll to active phase
- Mobile responsive: horizontal strip below 768px
- Floating badge showing all 5 agent states with correct icons and colors
- Popover with full details and control action buttons
- Countdown and elapsed timers updating in real time
</success_criteria>

<output>
After completion, create `.planning/phases/46-ui-integration/46-03-SUMMARY.md`
</output>
