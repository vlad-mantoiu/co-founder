---
phase: 45-self-healing-error-model
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/app/agent/error/__init__.py
  - backend/app/agent/error/classifier.py
  - backend/app/agent/error/tracker.py
  - backend/tests/agent/test_error_classifier.py
  - backend/tests/agent/test_error_tracker.py
autonomous: true
requirements: [AGNT-07]

must_haves:
  truths:
    - "classify_error() maps auth/permission errors to NEVER_RETRY category"
    - "classify_error() maps syntax/type/logic errors to CODE_ERROR category"
    - "classify_error() maps network/disk/timeout errors to ENV_ERROR category"
    - "build_error_signature() returns stable {project_id}:{error_type}:{hash} keys"
    - "ErrorSignatureTracker.record_and_check() returns should_escalate=True after 3 failures for the same signature"
    - "ErrorSignatureTracker.record_and_check() returns should_escalate=False for failures 1-3"
    - "ErrorSignatureTracker.should_escalate_immediately() returns True for NEVER_RETRY errors"
    - "ErrorSignatureTracker.global_threshold_exceeded() returns True when N total escalations reached"
    - "ErrorSignatureTracker.reset_signature() clears retry count for a specific signature"
    - "_build_retry_tool_result() returns structured replanning context with attempt number and instruction to try different approach"
    - "_build_escalation_options() returns multiple-choice options appropriate to error category"
  artifacts:
    - path: "backend/app/agent/error/classifier.py"
      provides: "ErrorCategory enum, classify_error(), build_error_signature()"
      exports: ["ErrorCategory", "classify_error", "build_error_signature"]
    - path: "backend/app/agent/error/tracker.py"
      provides: "ErrorSignatureTracker service + helper functions"
      exports: ["ErrorSignatureTracker", "MAX_RETRIES_PER_SIGNATURE", "GLOBAL_ESCALATION_THRESHOLD"]
    - path: "backend/tests/agent/test_error_classifier.py"
      provides: "Unit tests for error classification and signature hashing"
      min_lines: 60
    - path: "backend/tests/agent/test_error_tracker.py"
      provides: "Unit tests for ErrorSignatureTracker state machine"
      min_lines: 80
  key_links:
    - from: "backend/app/agent/error/tracker.py"
      to: "backend/app/agent/error/classifier.py"
      via: "import classify_error, build_error_signature, ErrorCategory"
      pattern: "from app\\.agent\\.error\\.classifier import"
---

<objective>
TDD implementation of ErrorSignatureTracker and error classifier — the core retry/escalate decision engine for the self-healing error model.

Purpose: Build the deterministic error classification and per-signature retry tracking logic that the TAOR loop will use to decide whether to retry with a different approach, escalate immediately, or escalate after 3 failures. This is pure business logic with defined I/O — ideal for RED-GREEN-REFACTOR.

Output: Two production modules (classifier.py, tracker.py) in `backend/app/agent/error/` with comprehensive unit tests. No external dependencies — all stdlib + existing project patterns.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-self-healing-error-model/45-RESEARCH.md
@backend/app/agent/loop/safety.py
@backend/app/db/models/agent_checkpoint.py
</context>

<feature>
  <name>Error Classifier + ErrorSignatureTracker</name>
  <files>
    backend/app/agent/error/__init__.py
    backend/app/agent/error/classifier.py
    backend/app/agent/error/tracker.py
    backend/tests/agent/test_error_classifier.py
    backend/tests/agent/test_error_tracker.py
  </files>
  <behavior>
    **Error Classification (classifier.py):**
    - ErrorCategory enum with 3 values: NEVER_RETRY, CODE_ERROR, ENV_ERROR
    - classify_error(error_type: str, error_message: str) -> ErrorCategory
      - "PermissionError" + "access denied" -> NEVER_RETRY
      - "SyntaxError" + "invalid syntax" -> CODE_ERROR
      - "ConnectionError" + "connection refused" -> ENV_ERROR
      - Unknown error type defaults to CODE_ERROR (safe default — retries allowed)
    - build_error_signature(project_id, error_type, error_message) -> str
      - Returns "{project_id}:{error_type}:{md5_8chars}"
      - Same inputs always produce same output (deterministic)
      - Different error messages produce different hashes

    **Never-retry patterns:** "permission denied", "authentication failed", "unauthorized", "forbidden", "invalid credentials", "rate limit exceeded", "subscription", "invalid subscription", "access denied"

    **Environment error patterns:** "connection refused", "network timeout", "timeout", "name resolution failed", "disk full", "no space left", "package registry", "registry down", "temporary failure", "service unavailable"

    **ErrorSignatureTracker (tracker.py):**
    - __init__(project_id, retry_counts, db_session=None, session_id="", job_id="")
    - should_escalate_immediately(error_type, error_message) -> bool
    - record_and_check(error_type, error_message) -> (should_escalate: bool, attempt_number: int)
      - First call for a signature: (False, 1)
      - Second call: (False, 2)
      - Third call: (False, 3)
      - Fourth call: (True, 4) — should escalate
    - global_threshold_exceeded() -> bool — True when _session_escalation_count >= GLOBAL_ESCALATION_THRESHOLD (5)
    - reset_signature(error_type, error_message) — removes key from retry_counts
    - record_escalation(error_type, error_message, attempts, recommended_action, plain_english_problem) -> str | None

    **Helper functions:**
    - _build_retry_tool_result(error_type, error_message, attempt_num, original_intent) -> str
      - Returns structured replanning prompt injection
      - Includes attempt number, original goal, instruction to try different approach
    - _build_escalation_options(error_type, category) -> list[dict]
      - NEVER_RETRY: provide_credentials + skip_feature
      - CODE_ERROR/ENV_ERROR: skip_feature + simpler_version + provide_guidance

    **Constants:**
    - MAX_RETRIES_PER_SIGNATURE = 3
    - GLOBAL_ESCALATION_THRESHOLD = 5

    **CRITICAL: retry_counts dict is a MUTABLE reference shared with CheckpointService.** The ErrorSignatureTracker must hold a reference to the SAME dict that gets saved. Do NOT create a copy.
  </behavior>
  <implementation>
    classifier.py:
    - Use StrEnum for ErrorCategory (Python 3.12)
    - Tuple of lowercase pattern strings for each category — match with `in combined.lower()`
    - hashlib.md5(message.encode(), usedforsecurity=False).hexdigest()[:8] for message hash
    - build_error_signature returns f"{project_id}:{error_type}:{msg_hash}"

    tracker.py:
    - ErrorSignatureTracker class holding project_id, retry_counts dict ref, db_session, session_id, job_id
    - _session_escalation_count int tracks global threshold across the session
    - should_escalate_immediately calls classify_error and returns True for NEVER_RETRY
    - record_and_check: build signature, increment count in retry_counts dict, check > MAX_RETRIES_PER_SIGNATURE
    - global_threshold_exceeded: _session_escalation_count >= GLOBAL_ESCALATION_THRESHOLD
    - reset_signature: pop key from retry_counts dict
    - record_escalation: async, creates AgentEscalation row via db_session (lazy import to avoid circular), returns id or None on failure
    - _build_retry_tool_result: module-level function, returns structured string with APPROACH N FAILED header + instruction
    - _build_escalation_options: module-level function, returns list of dicts based on category
  </implementation>
</feature>

<verification>
```bash
cd backend && python -m pytest tests/agent/test_error_classifier.py tests/agent/test_error_tracker.py -x -v
```
All tests pass. Zero imports from external libraries except stdlib hashlib, enum, and project internals.
</verification>

<success_criteria>
- classify_error() correctly categorizes all 3 error types with at least 3 test cases each
- build_error_signature() produces stable, deterministic keys
- ErrorSignatureTracker state machine: record_and_check returns correct tuple for attempts 1-4
- Global threshold fires at exactly GLOBAL_ESCALATION_THRESHOLD escalations
- reset_signature clears the key (founder input resets retry count)
- _build_retry_tool_result includes attempt number and replanning instruction
- _build_escalation_options returns correct options per category
- All tests pass: `python -m pytest tests/agent/test_error_classifier.py tests/agent/test_error_tracker.py -x -v`
</success_criteria>

<output>
After completion, create `.planning/phases/45-self-healing-error-model/45-01-SUMMARY.md`
</output>
