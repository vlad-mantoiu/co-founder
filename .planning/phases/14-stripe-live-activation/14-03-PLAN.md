---
phase: 14-stripe-live-activation
plan: 03
type: execute
wave: 2
depends_on:
  - "14-01"
files_modified:
  - backend/app/api/routes/billing.py
  - frontend/src/app/(dashboard)/billing/page.tsx
  - frontend/src/app/(dashboard)/dashboard/page.tsx
autonomous: true
requirements:
  - BILL-05
  - BILL-06
must_haves:
  truths:
    - "Billing page displays token usage vs plan limit as a visual meter"
    - "After successful checkout redirect, dashboard shows success toast notification"
    - "Unsubscribed founders see an upgrade-focused billing page"
  artifacts:
    - path: "backend/app/api/routes/billing.py"
      provides: "GET /api/billing/usage endpoint returning tokens_used_today, tokens_limit, plan_slug, plan_name, reset_at"
      contains: "get_billing_usage"
    - path: "frontend/src/app/(dashboard)/billing/page.tsx"
      provides: "Usage meter component and upgrade-focused layout for unsubscribed users"
      contains: "UsageMeter"
    - path: "frontend/src/app/(dashboard)/dashboard/page.tsx"
      provides: "Checkout success toast detection after Stripe redirect"
      contains: "checkout_success"
  key_links:
    - from: "frontend/src/app/(dashboard)/billing/page.tsx"
      to: "/api/billing/usage"
      via: "apiFetch in useEffect"
      pattern: "apiFetch.*billing/usage"
    - from: "frontend/src/app/(dashboard)/dashboard/page.tsx"
      to: "sonner toast"
      via: "useSearchParams reads checkout_success, triggers toast.success"
      pattern: "toast\\.success.*Subscription"
---

<objective>
Add the usage meter endpoint and billing page overhaul: token usage display, checkout success toast on dashboard redirect, and upgrade-focused layout for unsubscribed founders.

Purpose: Founders need to see their usage and confirm their subscription activated. The billing page is the primary post-checkout destination for plan management, and unsubscribed founders should see a compelling upgrade prompt.

Output: GET /api/billing/usage endpoint, enhanced billing page with usage meter, dashboard checkout success toast.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-stripe-live-activation/14-RESEARCH.md
@.planning/phases/14-stripe-live-activation/14-01-SUMMARY.md
@backend/app/api/routes/billing.py
@backend/app/db/models/usage_log.py
@backend/app/db/models/plan_tier.py
@backend/app/db/models/user_settings.py
@frontend/src/app/(dashboard)/billing/page.tsx
@frontend/src/app/(dashboard)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GET /api/billing/usage endpoint</name>
  <files>
    backend/app/api/routes/billing.py
  </files>
  <action>
    1. Add `UsageResponse` Pydantic schema to billing.py:
       ```python
       class UsageResponse(BaseModel):
           tokens_used_today: int
           tokens_limit: int  # -1 = unlimited
           plan_slug: str
           plan_name: str
           reset_at: str  # ISO 8601 — next midnight UTC
       ```

    2. Add new endpoint:
       ```python
       @router.get("/billing/usage", response_model=UsageResponse)
       async def get_billing_usage(user: ClerkUser = Depends(require_auth)):
       ```
       Implementation:
       - Import `func` from sqlalchemy and `datetime, timedelta` from datetime
       - Import `UsageLog` from `app.db.models.usage_log`
       - Query `SUM(usage_logs.total_tokens)` for today (UTC midnight to now) where `clerk_user_id = user.user_id`
       - Use `func.coalesce(func.sum(UsageLog.total_tokens), 0)` for NULL safety
       - Join `UserSettings` -> `PlanTier` to get plan limit (`max_tokens_per_day`)
       - Check `override_max_tokens_per_day` first; fall back to `plan_tier.max_tokens_per_day`
       - Compute `reset_at` as next midnight UTC in ISO 8601
       - Default for users with no settings: `tokens_used_today=0, tokens_limit=500_000, plan_slug="bootstrapper", plan_name="Bootstrapper"`
  </action>
  <verify>
    - `grep -n "get_billing_usage" /Users/vladcortex/co-founder/backend/app/api/routes/billing.py` shows the endpoint
    - `grep -n "UsageResponse" /Users/vladcortex/co-founder/backend/app/api/routes/billing.py` shows the schema
  </verify>
  <done>GET /api/billing/usage returns token usage vs plan limit for the authenticated user</done>
</task>

<task type="auto">
  <name>Task 2: Enhance billing page with usage meter and checkout success toast on dashboard</name>
  <files>
    frontend/src/app/(dashboard)/billing/page.tsx
    frontend/src/app/(dashboard)/dashboard/page.tsx
  </files>
  <action>
    1. **Billing page** (`billing/page.tsx`):
       - Add `UsageData` interface: `{ tokens_used_today: number; tokens_limit: number; plan_slug: string; plan_name: string; reset_at: string }`
       - Add `usage` state and fetch from `/api/billing/usage` alongside the existing `/api/billing/status` call
       - Create inline `UsageMeter` component:
         - If `tokens_limit === -1`: show "Unlimited" with no bar
         - Otherwise: compute percentage, show `{formatted_used}M / {formatted_limit}M tokens` with a progress bar
         - Color code: green (<70%), amber (70-90%), red (>90%)
         - Show "Resets at midnight UTC" text below
       - Place `UsageMeter` as the FIRST visual element for subscribed users (per locked decision: "token usage vs plan limit as the main visual")
       - For unsubscribed founders: show upgrade-focused layout (keep existing upgrade CTA but make it more prominent, remove "free tier" text — per locked decision: "bootstrapper is $99/mo, not free")

    2. **Dashboard page** (`dashboard/page.tsx`):
       - Add checkout success detection: read `checkout_success` from URL search params
       - If `checkout_success=true`: show `toast.success("Subscription activated! Welcome aboard.")` via sonner
       - Clean up URL without reload: `window.history.replaceState({}, "", url.toString())`
       - Wrap the search params reader in `<Suspense fallback={null}>` (Next.js 15 requirement)
       - Import `useSearchParams` from `next/navigation`, `Suspense` from `react`, `toast` from `sonner`
       - Create a `CheckoutSuccessDetector` client component that does the param check + toast + URL cleanup
  </action>
  <verify>
    - `grep -n "UsageMeter\|tokens_used_today\|billing/usage" /Users/vladcortex/co-founder/frontend/src/app/\(dashboard\)/billing/page.tsx` shows usage meter
    - `grep -n "checkout_success\|toast.success" /Users/vladcortex/co-founder/frontend/src/app/\(dashboard\)/dashboard/page.tsx` shows success detection
    - `grep -n "Suspense" /Users/vladcortex/co-founder/frontend/src/app/\(dashboard\)/dashboard/page.tsx` shows Suspense boundary
  </verify>
  <done>Billing page shows usage meter as primary visual; dashboard shows success toast after checkout redirect; Suspense boundary wraps useSearchParams</done>
</task>

</tasks>

<verification>
1. GET /api/billing/usage endpoint exists and returns UsageResponse schema
2. Billing page fetches usage data and renders a visual meter
3. Dashboard detects checkout_success param and shows toast
4. Suspense boundary around useSearchParams in dashboard
5. Unsubscribed founders see upgrade-focused billing page (not "free tier" language)
</verification>

<success_criteria>
- Token usage meter visible on billing page for subscribed founders
- Success toast appears on dashboard after Stripe checkout redirect
- Unsubscribed billing page promotes upgrading at $99/mo
</success_criteria>

<output>
After completion, create `.planning/phases/14-stripe-live-activation/14-03-SUMMARY.md`
</output>
