---
phase: 14-stripe-live-activation
plan: 02
type: tdd
wave: 2
depends_on:
  - "14-01"
files_modified:
  - backend/tests/api/test_billing_api.py
  - backend/tests/api/conftest.py
autonomous: true
requirements:
  - BILL-01
  - BILL-02
  - BILL-03
must_haves:
  truths:
    - "Test suite verifies duplicate webhook events are rejected with 200"
    - "Test suite verifies async Stripe SDK methods are called (not sync)"
    - "Test suite verifies PRICE_MAP startup validation raises on missing IDs"
  artifacts:
    - path: "backend/tests/api/test_billing_api.py"
      provides: "Billing API test suite"
      contains: "test_webhook_idempotency"
  key_links:
    - from: "backend/tests/api/test_billing_api.py"
      to: "backend/app/api/routes/billing.py"
      via: "httpx TestClient + mocked stripe SDK"
      pattern: "mock.*stripe"
---

<objective>
Write comprehensive tests for the hardened billing API: webhook idempotency, async SDK calls, PRICE_MAP validation, and payment failure behavior.

Purpose: TDD ensures the idempotency claim, async conversion, and startup validation all work correctly before deploying to production. These are the highest-risk behaviors in the billing system.

Output: test_billing_api.py with passing tests for all BILL-01, BILL-02, BILL-03 behaviors.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-stripe-live-activation/14-RESEARCH.md
@backend/app/api/routes/billing.py
@backend/tests/api/conftest.py
@backend/app/main.py
</context>

<feature>
  <name>Billing API Tests — Idempotency, Async SDK, Startup Validation</name>
  <files>backend/tests/api/test_billing_api.py, backend/tests/api/conftest.py</files>
  <behavior>
    Test cases:

    1. **Webhook idempotency (BILL-01)**
       - `test_webhook_idempotency_first_event_processes`: POST webhook with valid event -> 200, handler called
       - `test_webhook_idempotency_duplicate_event_skipped`: POST same event_id twice -> second returns 200, handler NOT called again
       - `test_webhook_rejects_invalid_signature`: POST with bad signature -> 400
       - `test_webhook_rejects_missing_signature`: POST without stripe-signature header -> 400

    2. **Async SDK (BILL-03)**
       - `test_checkout_uses_async_stripe`: Mock `stripe.checkout.Session.create_async` -> verify it's called (not `.create`)
       - `test_portal_uses_async_stripe`: Mock `stripe.billing_portal.Session.create_async` -> verify it's called
       - `test_customer_creation_uses_async`: Mock `stripe.Customer.create_async` -> verify it's called

    3. **Startup validation (BILL-02)**
       - `test_validate_price_map_raises_on_missing`: Call `validate_price_map()` with empty price IDs and `debug=False` -> raises RuntimeError
       - `test_validate_price_map_skips_in_debug`: Call with `debug=True` -> does NOT raise
       - `test_validate_price_map_passes_when_all_set`: Call with all 6 price IDs set -> does NOT raise

    4. **Payment failure (BILL-01 adjacent)**
       - `test_payment_failed_downgrades_to_bootstrapper`: Webhook with `invoice.payment_failed` -> user_settings.plan_tier_id set to bootstrapper

    All tests must mock:
    - `stripe.Webhook.construct_event` to return a fake event dict
    - `stripe.*.create_async` for checkout/portal/customer tests
    - Database session for webhook handler tests (use real DB via conftest or mock session factory)
  </behavior>
  <implementation>
    Create `backend/tests/api/test_billing_api.py`:

    - Import `pytest`, `unittest.mock`, `httpx.AsyncClient`
    - Use existing `conftest.py` test client fixture pattern
    - Mock stripe module methods using `unittest.mock.patch` or `pytest.monkeypatch`
    - For idempotency tests: first call inserts StripeWebhookEvent, second call hits IntegrityError
    - For async tests: patch `stripe.checkout.Session.create_async` and assert it was awaited
    - For startup validation: import `validate_price_map` from `app.main`, mock `get_settings()` return

    Update `backend/tests/api/conftest.py` if needed:
    - Add dummy `STRIPE_PRICE_*` env vars via `os.environ.setdefault()` at module level to prevent startup failures
  </implementation>
</feature>

<verification>
1. `cd /Users/vladcortex/co-founder && python -m pytest backend/tests/api/test_billing_api.py -v` — all tests pass
2. Test count >= 8 (covering idempotency, async, validation, payment failure)
</verification>

<success_criteria>
- All billing API tests pass
- Webhook idempotency behavior is verified with duplicate event_id test
- Async SDK usage is verified via mock assertions
- PRICE_MAP validation tested for all three cases (missing, debug, all-set)
</success_criteria>

<output>
After completion, create `.planning/phases/14-stripe-live-activation/14-02-SUMMARY.md`
</output>
