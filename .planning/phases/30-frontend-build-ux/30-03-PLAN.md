---
phase: 30-frontend-build-ux
plan: 03
type: execute
wave: 2
depends_on:
  - "30-01"
  - "30-02"
files_modified:
  - frontend/src/components/build/AutoFixBanner.tsx
  - frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
autonomous: false
requirements:
  - BUILD-04
  - BUILD-02
  - BUILD-03

must_haves:
  truths:
    - "When the Debugger agent retries, a yellow/orange banner appears above the stage bar: 'We found a small issue and are fixing it automatically (attempt N of 5)'"
    - "The attempt counter in the banner is visible and increments with each retry"
    - "The stage bar rewinds to the 'Writing code' stage when auto-fix is active — visually shows the retry is re-running"
    - "The log panel and stage indicators update without page refresh via SSE + polling"
    - "The log panel stays collapsed on failure — error summary is enough, founder can expand manually"
    - "All Phase 30 components integrate into the build page: stage bar, log panel, auto-fix banner, confetti, failure card"
  artifacts:
    - path: "frontend/src/components/build/AutoFixBanner.tsx"
      provides: "Yellow/orange auto-fix banner with attempt counter and reassuring tone"
      exports: ["AutoFixBanner"]
      min_lines: 25
    - path: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      provides: "Build page orchestrator wiring useBuildLogs, BuildLogPanel, AutoFixBanner, updated BuildProgressBar, confetti BuildSummary, and updated BuildFailureCard"
      min_lines: 100
  key_links:
    - from: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      to: "frontend/src/hooks/useBuildLogs.ts"
      via: "useBuildLogs(jobId, getToken) hook call"
      pattern: "useBuildLogs\\(jobId"
    - from: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      to: "frontend/src/components/build/BuildLogPanel.tsx"
      via: "BuildLogPanel component rendered with lines prop"
      pattern: "<BuildLogPanel"
    - from: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      to: "frontend/src/components/build/AutoFixBanner.tsx"
      via: "AutoFixBanner component rendered conditionally on autoFixAttempt"
      pattern: "<AutoFixBanner"
    - from: "frontend/src/components/build/AutoFixBanner.tsx"
      to: "frontend/src/hooks/useBuildLogs.ts"
      via: "autoFixAttempt prop sourced from useBuildLogs state"
      pattern: "attempt.*autoFixAttempt"
---

<objective>
Create the AutoFixBanner component, then wire all Phase 30 components (useBuildLogs, BuildLogPanel, AutoFixBanner, refactored BuildProgressBar, updated BuildSummary, updated BuildFailureCard) into the build page. This is the integration plan that brings everything together.

Purpose: Delivers BUILD-04 (auto-retry visibility) and completes the full integration of BUILD-02 and BUILD-03 into the live build page experience.
Output: `AutoFixBanner.tsx` component, fully wired `page.tsx` build orchestrator
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-frontend-build-ux/30-RESEARCH.md
@.planning/phases/30-frontend-build-ux/30-01-SUMMARY.md
@.planning/phases/30-frontend-build-ux/30-02-SUMMARY.md

# Components to wire
@frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
@frontend/src/hooks/useBuildLogs.ts
@frontend/src/hooks/useBuildProgress.ts
@frontend/src/components/build/BuildLogPanel.tsx
@frontend/src/components/build/BuildProgressBar.tsx
@frontend/src/components/build/BuildSummary.tsx
@frontend/src/components/build/BuildFailureCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AutoFixBanner + wire all Phase 30 components into build page</name>
  <files>
frontend/src/components/build/AutoFixBanner.tsx
frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
  </files>
  <action>
**Part A: Create `AutoFixBanner.tsx`**

Per locked decisions:
- Separate yellow/orange banner above the stage bar
- Text: "We found an issue and are fixing it automatically (attempt N of 5)"
- Reassuring tone — founder should not worry. Calm, confident messaging
- Attempt counter visible and incrementing

Create `frontend/src/components/build/AutoFixBanner.tsx`:

```typescript
"use client";

import { motion } from "framer-motion";
import { Wrench } from "lucide-react";

interface AutoFixBannerProps {
  attempt: number;        // 1-5 — current attempt number
  maxAttempts?: number;   // Default 5
}

export function AutoFixBanner({ attempt, maxAttempts = 5 }: AutoFixBannerProps) {
  return (
    <motion.div
      initial={{ opacity: 0, y: -8 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -8 }}
      transition={{ duration: 0.3 }}
      className="w-full mb-4 px-4 py-3 rounded-xl bg-amber-500/10 border border-amber-500/25 flex items-center gap-3"
    >
      <Wrench className="w-4 h-4 text-amber-400 flex-shrink-0" />
      <div className="flex-1 min-w-0">
        <p className="text-sm text-amber-300 font-medium">
          We found a small issue and are fixing it automatically
        </p>
        <p className="text-xs text-amber-400/70 mt-0.5">
          Attempt {attempt} of {maxAttempts} — this is normal, sit tight
        </p>
      </div>
    </motion.div>
  );
}
```

**Part B: Wire everything into `page.tsx`**

The build page currently has:
- `useBuildProgress(jobId, getToken)` — keep this (polling for stage status)
- `BuildProgressBar` — keep, now passes `autoFixAttempt` prop
- `BuildSummary` — keep (now has confetti from Plan 02)
- `BuildFailureCard` — keep (now has "Contact support" from Plan 02)

Add:
- `useBuildLogs(jobId, getToken)` — new hook for SSE log streaming
- `BuildLogPanel` — new component below the progress bar in building state
- `AutoFixBanner` — new component above the progress bar when auto-fix active

**Import additions:**
```typescript
import { useBuildLogs } from "@/hooks/useBuildLogs";
import { BuildLogPanel } from "@/components/build/BuildLogPanel";
import { AutoFixBanner } from "@/components/build/AutoFixBanner";
```

**Hook call in BuildPage component body:**
```typescript
const {
  lines: logLines,
  isConnected: logConnected,
  isDone: logDone,
  doneStatus,
  hasEarlierLines,
  autoFixAttempt,
  loadEarlier,
} = useBuildLogs(jobId, getToken);
```

**Building state layout update (inside the `isBuilding && (...)` block):**

The current structure is:
1. Header ("Building your MVP")
2. Reconnecting banner (connectionFailed)
3. BuildProgressBar

Update to:
1. Header ("Building your MVP" — keep as is)
2. Reconnecting banner (connectionFailed — keep as is)
3. **AutoFixBanner** — shown conditionally when `autoFixAttempt !== null` and `isBuilding`:
   ```tsx
   <AnimatePresence>
     {autoFixAttempt !== null && (
       <AutoFixBanner attempt={autoFixAttempt} />
     )}
   </AnimatePresence>
   ```
4. **BuildProgressBar** — now with `autoFixAttempt` prop:
   ```tsx
   <BuildProgressBar
     stageIndex={stageIndex}
     totalStages={totalStages}
     label={label}
     status={status}
     autoFixAttempt={autoFixAttempt}
   />
   ```
5. **BuildLogPanel** — below the progress bar, inside the building state card:
   ```tsx
   <BuildLogPanel
     lines={logLines}
     isConnected={logConnected}
     hasEarlierLines={hasEarlierLines}
     onLoadEarlier={loadEarlier}
   />
   ```

**Stage bar rewind during auto-fix** (locked decision: "Stage bar resets/rewinds to the failing stage when a retry starts"):
- Per research recommendation: when `autoFixAttempt` is non-null, the `stageIndex` prop passed to `BuildProgressBar` should be overridden to show the "Writing code" stage (backendIndex 3, which is `code`) as the active segment
- Implement this in page.tsx:
  ```typescript
  // When auto-fix is active, rewind visual stage to "code" (index 3 in STAGE_ORDER)
  // The debugger returns to coder which is the CODE stage
  const effectiveStageIndex = autoFixAttempt !== null && isBuilding
    ? 3  // STAGE_ORDER index for "code" — "Writing code" stage
    : stageIndex;
  ```
- Pass `effectiveStageIndex` to `BuildProgressBar` instead of `stageIndex`

**Failure state — log panel stays collapsed** (locked decision):
- Do NOT render `BuildLogPanel` in the failure state section — the error summary in `BuildFailureCard` is sufficient
- The founder can still open the expandable details in `BuildFailureCard` if curious

**Success state — no log panel:**
- Do NOT render `BuildLogPanel` in the success state — confetti celebration is the focus

**Keep the SSE connection running even when not displaying the log panel:**
- `useBuildLogs` is called unconditionally in the component body — the SSE connection runs regardless of whether BuildLogPanel is rendered
- This ensures `autoFixAttempt` detection works even when the log panel is collapsed (which it is by default)
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit` — no type errors
2. Grep for `useBuildLogs` in `page.tsx` — confirms hook is called
3. Grep for `<BuildLogPanel` in `page.tsx` — confirms component rendered in building state
4. Grep for `<AutoFixBanner` in `page.tsx` — confirms banner rendered conditionally
5. Grep for `effectiveStageIndex` in `page.tsx` — confirms stage rewind logic
6. Verify `AutoFixBanner` exports correctly: grep for `export function AutoFixBanner`
7. `npm run build` from frontend/ — confirms no build errors (catches SSR issues)
  </verify>
  <done>
`AutoFixBanner` component shows "We found a small issue and are fixing it automatically (attempt N of 5)" in a yellow/orange banner. Build page wires `useBuildLogs` for SSE streaming, renders `BuildLogPanel` below the progress bar, shows `AutoFixBanner` above the bar when auto-fix is detected, rewinds the stage bar to "Writing code" during retries, and keeps the log panel collapsed on failure.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of build UX</name>
  <files>frontend/src/app/(dashboard)/projects/[id]/build/page.tsx</files>
  <action>
Human verifies the complete Phase 30 Frontend Build UX visually. All automation is complete from Task 1. This checkpoint confirms the visual experience matches the locked decisions.

What was built: Horizontal segmented progress bar with 5 stages, collapsible "Technical details" log panel with color-coded output, auto-fix banner with attempt counter, confetti on success, "Contact support" on failure, elapsed timer during build.

Steps to verify:
1. Start the frontend dev server: `cd frontend && npm run dev`
2. Navigate to a project's build page with an active build (or trigger a new build)
3. **Stage bar** — Verify:
   - 5 horizontal segments with labels: Designing, Writing code, Installing dependencies, Starting app, Ready
   - Each stage has an icon (not emoji)
   - Active segment pulses, completed segments show a checkmark
   - Elapsed timer shows "Building... 0:42" format below the bar
4. **Log panel** — Verify:
   - "Technical details" expander is visible below the stage bar
   - Clicking it opens a scrollable log panel
   - Log lines appear in real time as the build progresses
   - stderr lines are red/orange, stdout is default, system events are blue
   - Auto-scrolls to latest line when open; pausing when you scroll up
   - "Load earlier output" button appears at top (if build has been running)
5. **Auto-fix** (if debugger retries during the build) — Verify:
   - Yellow/orange banner appears above the stage bar
   - Shows "We found a small issue and are fixing it automatically"
   - Attempt counter is visible: "Attempt N of 5"
   - Stage bar rewinds to "Writing code" stage
6. **Success** — Verify:
   - Confetti fires on build completion
   - Headline says "Your app is live!" with "Open your app" button
7. **Failure** — Verify:
   - Error summary shows at top
   - "Try again" button AND "Contact support" link both visible
   - Log panel is NOT auto-expanded on failure

Resume signal: Type "approved" if all checks pass, or describe issues found.
  </action>
  <verify>Human confirms visual experience matches all 7 verification areas above</verify>
  <done>All Phase 30 locked decisions verified visually: stage bar, log panel, auto-fix banner, success confetti, failure recovery, elapsed timer</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — full TypeScript compilation passes
2. `cd frontend && npm run build` — Next.js production build passes (catches SSR issues)
3. All imports resolve: useBuildLogs, BuildLogPanel, AutoFixBanner, updated BuildProgressBar, BuildSummary, BuildFailureCard
4. The build page orchestrates both data sources: polling (useBuildProgress) and SSE (useBuildLogs)
5. Auto-fix banner appears conditionally, stage bar rewinds during retry
6. Confetti fires on success, "Contact support" appears on failure
7. Human verification confirms visual experience matches locked decisions
</verification>

<success_criteria>
- The auto-fix banner shows "attempt N of 5" when the debugger retries
- Stage bar visually rewinds to "Writing code" during auto-fix
- All Phase 30 components render correctly on the build page
- SSE log streaming works alongside status polling without conflicts
- The build page does not refresh — all updates happen via SSE + polling
- Human visual verification passes
</success_criteria>

<output>
After completion, create `.planning/phases/30-frontend-build-ux/30-03-SUMMARY.md`
</output>
