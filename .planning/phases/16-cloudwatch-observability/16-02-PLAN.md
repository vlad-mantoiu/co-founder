---
phase: 16-cloudwatch-observability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/lib/observability-stack.ts
  - infra/bin/app.ts
  - infra/lib/compute-stack.ts
autonomous: true
requirements:
  - MON-01
  - MON-02
  - MON-03
  - MON-04
  - MON-05
  - MON-06

must_haves:
  truths:
    - "An SNS topic exists with an email subscription for ops alerts"
    - "ECS task count dropping to 0 triggers a CloudWatch alarm with SNS notification"
    - "ALB 5xx spike triggers a CloudWatch alarm with SNS notification"
    - "Backend CPU exceeding 85% triggers a CloudWatch alarm with SNS notification"
    - "ALB P99 latency exceeding 30s triggers a CloudWatch alarm with SNS notification"
    - "ERROR log lines are counted by a metric filter with an alarm on spike"
    - "Backend log retention is 30 days (ONE_MONTH)"
  artifacts:
    - path: "infra/lib/observability-stack.ts"
      provides: "CDK stack with SNS topic, 5 CloudWatch alarms, 1 metric filter"
      contains: "ObservabilityStack"
    - path: "infra/bin/app.ts"
      provides: "ObservabilityStack instantiation after ComputeStack"
      contains: "ObservabilityStack"
    - path: "infra/lib/compute-stack.ts"
      provides: "Log retention changed from ONE_WEEK to ONE_MONTH"
      contains: "ONE_MONTH"
  key_links:
    - from: "infra/lib/observability-stack.ts"
      to: "SNS topic"
      via: "EmailSubscription for ops alert email"
      pattern: "EmailSubscription"
    - from: "infra/lib/observability-stack.ts"
      to: "CloudWatch alarms"
      via: "SnsAction wired to each alarm"
      pattern: "addAlarmAction"
    - from: "infra/bin/app.ts"
      to: "infra/lib/observability-stack.ts"
      via: "new ObservabilityStack() instantiation with props"
      pattern: "new ObservabilityStack"

user_setup:
  - service: AWS SNS
    why: "Email subscription requires manual confirmation after CDK deploy"
    dashboard_config:
      - task: "Check inbox for SNS subscription confirmation email and click Confirm"
        location: "Personal email inbox (after cdk deploy CoFounderObservability)"
---

<objective>
Create the CDK ObservabilityStack with SNS alerting topic, 5 CloudWatch alarms (ECS task count, ALB 5xx, CPU, P99 latency, error log spike), and update backend log retention to 30 days.

Purpose: This is the infrastructure layer of observability — alarms fire on outages, error spikes, and performance degradation, sending email alerts via SNS before founders notice problems. The metric filter on ERROR log lines bridges the application logging (Plan 01) to the alerting pipeline.

Output: `infra/lib/observability-stack.ts` with all alarms, updated `infra/bin/app.ts`, log retention changed to ONE_MONTH in `infra/lib/compute-stack.ts`.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-cloudwatch-observability/16-RESEARCH.md
@infra/lib/compute-stack.ts
@infra/bin/app.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ObservabilityStack with SNS topic and all CloudWatch alarms</name>
  <files>infra/lib/observability-stack.ts</files>
  <action>
    Create `infra/lib/observability-stack.ts` following the pattern from 16-RESEARCH.md Pattern 4. This is a NEW file.

    **Stack props interface:**
    ```typescript
    export interface ObservabilityStackProps extends cdk.StackProps {
      alertEmail: string;
      backendLogGroupName: string;
      backendAlbSuffix: string;
      backendServiceName: string;
      clusterName: string;
    }
    ```

    **Constructs to create (in order):**

    1. **SNS Topic (MON-01):**
       - topicName: `"cofounder-ops-alerts"`
       - displayName: `"CoFounder Ops Alerts"`
       - Add `EmailSubscription(props.alertEmail)` — user confirms via email after deploy
       - Create `SnsAction` from the topic for reuse on all alarms

    2. **ECS Task Count Alarm (MON-02):**
       - Namespace: `"ECS/ContainerInsights"`
       - MetricName: `"RunningTaskCount"`
       - Dimensions: `ClusterName` + `ServiceName` (from props)
       - Statistic: `"Minimum"`, Period: 1 minute
       - Threshold: `1`, Comparison: `LESS_THAN_THRESHOLD`
       - EvaluationPeriods: `1`
       - treatMissingData: `BREACHING` (no metric = no tasks = bad)
       - alarmName: `"cofounder-backend-task-count-zero"`

    3. **ALB 5xx Alarm (MON-03):**
       - Namespace: `"AWS/ApplicationELB"`
       - MetricName: `"HTTPCode_ELB_5XX_Count"`
       - Dimensions: `LoadBalancer` = props.backendAlbSuffix
       - Statistic: `"Sum"`, Period: 5 minutes
       - Threshold: `10`, EvaluationPeriods: `1`
       - treatMissingData: `NOT_BREACHING` (no metric = no 5xx = good)
       - alarmName: `"cofounder-alb-5xx-spike"`

    4. **CPU Utilization Alarm (MON-04):**
       - Namespace: `"AWS/ECS"`
       - MetricName: `"CPUUtilization"`
       - Dimensions: `ClusterName` + `ServiceName`
       - Statistic: `"Average"`, Period: 5 minutes
       - Threshold: `85`, EvaluationPeriods: `2`
       - alarmName: `"cofounder-backend-cpu-high"`

    5. **P99 Latency Alarm (MON-05):**
       - Namespace: `"AWS/ApplicationELB"`
       - MetricName: `"TargetResponseTime"`
       - Dimensions: `LoadBalancer` = props.backendAlbSuffix
       - Statistic: `"p99"`, Period: 5 minutes
       - Threshold: `30` (seconds)
       - EvaluationPeriods: `2`
       - treatMissingData: `NOT_BREACHING`
       - alarmName: `"cofounder-alb-p99-latency-high"`

    6. **Error Log Metric Filter + Alarm (MON-06):**
       - Import backend log group via `LogGroup.fromLogGroupName()`
       - Create `MetricFilter` with pattern: `FilterPattern.anyTerm('ERROR', '"level":"error"')` — matches both structured JSON and any remaining stdlib logs
       - MetricNamespace: `"CoFounder/Logs"`, MetricName: `"ErrorCount"`, MetricValue: `"1"`, DefaultValue: `0`
       - Create alarm on the filter's metric: threshold `5` errors in 5 minutes
       - treatMissingData: `NOT_BREACHING`
       - alarmName: `"cofounder-backend-error-log-spike"`

    **Wire all 5 alarms** to the SNS topic via `alarm.addAlarmAction(snsAction)`.

    Use the exact physical IDs from 16-RESEARCH.md Discovered Infrastructure Facts section. These are hardcoded as props — NOT stack outputs or Fn.importValue.
  </action>
  <verify>
    Run: `cd /Users/vladcortex/co-founder/infra && npx tsc --noEmit` — should compile without TypeScript errors.
    Run: `grep -c 'addAlarmAction' infra/lib/observability-stack.ts` — should be 5 (one per alarm).
    Run: `grep 'EmailSubscription' infra/lib/observability-stack.ts` — should find the SNS email subscription.
    Run: `grep 'MetricFilter' infra/lib/observability-stack.ts` — should find the ERROR log filter.
  </verify>
  <done>ObservabilityStack defines 1 SNS topic with email subscription, 5 CloudWatch alarms (task count, 5xx, CPU, P99, error logs), all wired to SNS. TypeScript compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ObservabilityStack into CDK app and update log retention</name>
  <files>infra/bin/app.ts, infra/lib/compute-stack.ts</files>
  <action>
    **Step 1: Update `infra/bin/app.ts`**

    Add the ObservabilityStack instantiation AFTER the ComputeStack block:

    ```typescript
    import { ObservabilityStack } from "../lib/observability-stack";

    // 5. Observability Stack (CloudWatch alarms, SNS alerts)
    const observabilityStack = new ObservabilityStack(app, "CoFounderObservability", {
      env,
      alertEmail: "vlad@getinsourced.ai",  // Personal email per user decision
      backendLogGroupName: "CoFounderCompute-BackendTaskDefBackendLogGroup3DA27187-AzPTCt7RdOns",
      backendAlbSuffix: "app/CoFoun-Backe-n6gwgzoJnTEp/e397cf8dbd83a010",
      backendServiceName: "CoFounderCompute-BackendService2147DAF9-NvCs2OXdtYgG",
      clusterName: "cofounder-cluster",
      description: "CloudWatch alarms and SNS alerts for AI Co-Founder",
    });
    observabilityStack.addDependency(computeStack);
    ```

    The physical resource IDs come from 16-RESEARCH.md Discovered Infrastructure Facts. The `alertEmail` should be `"vlad@getinsourced.ai"` (personal email per locked decision).

    **Step 2: Update `infra/lib/compute-stack.ts` — change log retention to 30 days**

    Find both occurrences of `logRetention: logs.RetentionDays.ONE_WEEK` (backend at ~line 94, frontend at ~line 177) and change BOTH to:
    ```typescript
    logRetention: logs.RetentionDays.ONE_MONTH,
    ```

    Per locked decision: 30-day log retention in CloudWatch. ONE_MONTH = 30 days.

    Do NOT run `cdk deploy` — deploy pipeline handles that.
  </action>
  <verify>
    Run: `cd /Users/vladcortex/co-founder/infra && npx tsc --noEmit` — should compile without errors.
    Run: `grep 'ObservabilityStack' infra/bin/app.ts` — should find the import and instantiation.
    Run: `grep -c 'ONE_MONTH' infra/lib/compute-stack.ts` — should be 2 (backend + frontend).
    Run: `grep -c 'ONE_WEEK' infra/lib/compute-stack.ts` — should be 0 (all changed).
  </verify>
  <done>ObservabilityStack wired into CDK app with dependency on ComputeStack. Backend and frontend log retention changed from 7 days to 30 days. CDK compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `cd infra && npx tsc --noEmit` — CDK TypeScript compiles
2. `grep -c 'addAlarmAction' infra/lib/observability-stack.ts` — returns 5
3. `grep 'EmailSubscription' infra/lib/observability-stack.ts` — SNS email sub exists
4. `grep 'ObservabilityStack' infra/bin/app.ts` — stack instantiated
5. `grep -c 'ONE_MONTH' infra/lib/compute-stack.ts` — returns 2
6. `grep -c 'ONE_WEEK' infra/lib/compute-stack.ts` — returns 0
</verification>

<success_criteria>
- ObservabilityStack compiles and defines all 5 alarms + SNS topic
- Each alarm wired to SNS topic via addAlarmAction
- SNS topic has EmailSubscription (requires manual confirmation after deploy)
- ECS task count alarm uses BREACHING for missing data (service down = alarm)
- ALB and latency alarms use NOT_BREACHING for missing data (no traffic = OK)
- Error log MetricFilter matches both "ERROR" and '"level":"error"' patterns
- Log retention is ONE_MONTH (30 days) for both backend and frontend
</success_criteria>

<output>
After completion, create `.planning/phases/16-cloudwatch-observability/16-02-SUMMARY.md`
</output>
