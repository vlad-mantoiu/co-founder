---
phase: 08-understanding-interview-decision-gates
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/api/routes/projects.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Dashboard project list shows has_pending_gate, has_understanding_session, has_brief per project"
    - "Pending gate banner renders on dashboard when a project has a pending decision gate"
    - "Understanding interview status badge renders when a project has an active session without a brief"
  artifacts:
    - path: "backend/app/api/routes/projects.py"
      provides: "ProjectResponse with 3 boolean flags + join queries"
      contains: "has_pending_gate"
  key_links:
    - from: "backend/app/api/routes/projects.py"
      to: "DecisionGate, UnderstandingSession, Artifact tables"
      via: "SQLAlchemy subquery/exists joins in list_projects and get_project"
      pattern: "has_pending_gate.*has_understanding_session.*has_brief"
---

<objective>
Wire dashboard project context flags (has_pending_gate, has_understanding_session, has_brief) into ProjectResponse and backend queries.

Purpose: Gap 1 closure — SC4 failed because dashboard frontend reads p.has_pending_gate, p.has_understanding_session, p.has_brief but the API never returns them. Pending gate banners, interview status badges, and brief readiness indicators are dead code without these flags.

Output: Updated ProjectResponse schema and list_projects/get_project endpoints that join DecisionGate, UnderstandingSession, and Artifact tables to compute boolean flags per project.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-understanding-interview-decision-gates/08-VERIFICATION.md
@.planning/phases/08-understanding-interview-decision-gates/08-06-SUMMARY.md
@backend/app/api/routes/projects.py
@backend/app/db/models/decision_gate.py
@backend/app/db/models/understanding_session.py
@backend/app/db/models/artifact.py
@frontend/src/app/(dashboard)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add boolean flags to ProjectResponse and wire join queries</name>
  <files>backend/app/api/routes/projects.py</files>
  <action>
Update `backend/app/api/routes/projects.py` to add three boolean fields to ProjectResponse and compute them via subquery exists clauses.

1. Add imports at top:
   ```python
   from sqlalchemy import exists, and_
   from app.db.models.decision_gate import DecisionGate
   from app.db.models.understanding_session import UnderstandingSession
   from app.db.models.artifact import Artifact
   ```

2. Add 3 fields to `ProjectResponse`:
   ```python
   has_pending_gate: bool = False
   has_understanding_session: bool = False
   has_brief: bool = False
   ```

3. Create a helper function `_compute_project_flags(session, project_id)` that runs 3 efficient exists() subqueries:
   - `has_pending_gate`: `exists().where(and_(DecisionGate.project_id == project_id, DecisionGate.status == "pending"))`
   - `has_understanding_session`: `exists().where(and_(UnderstandingSession.project_id == project_id, UnderstandingSession.status == "in_progress"))`
   - `has_brief`: `exists().where(and_(Artifact.project_id == project_id, Artifact.artifact_type == "idea_brief"))`

   Each returns a scalar boolean. Use `session.execute(select(subquery))` to get the bool value.

4. Update `list_projects` endpoint: After fetching projects, loop through them and call `_compute_project_flags` for each project to populate the 3 boolean fields in the response.

   Performance note: For MVP scale (tens of projects per user), individual subqueries per project are acceptable. If this becomes a bottleneck, refactor to a single query with lateral joins. Do NOT over-optimize now.

5. Update `get_project` endpoint: Call `_compute_project_flags` for the single project and include the flags in the response.

6. Update `create_project` endpoint: Return `has_pending_gate=False, has_understanding_session=False, has_brief=False` (new projects always have no gates/sessions/briefs).

Do NOT modify the frontend — the dashboard already reads these fields (lines 178-181 of dashboard/page.tsx). This task only fixes the backend gap.
  </action>
  <verify>
Run: `cd /Users/vladcortex/co-founder/backend && python -c "from app.api.routes.projects import ProjectResponse; r = ProjectResponse(id='x', name='t', description='d', github_repo=None, created_at='2024-01-01', status='active'); print(r.has_pending_gate, r.has_understanding_session, r.has_brief)"`

Expected output: `False False False`

Also verify imports: `cd /Users/vladcortex/co-founder/backend && python -c "from app.api.routes.projects import list_projects, get_project; print('OK')"`
  </verify>
  <done>
ProjectResponse schema includes has_pending_gate, has_understanding_session, has_brief boolean fields. list_projects and get_project endpoints compute these flags via subquery joins against DecisionGate, UnderstandingSession, and Artifact tables. Dashboard frontend can now render pending gate banners, understanding interview badges, and brief readiness indicators.
  </done>
</task>

</tasks>

<verification>
1. `ProjectResponse` model includes `has_pending_gate: bool`, `has_understanding_session: bool`, `has_brief: bool`
2. `list_projects` endpoint joins DecisionGate, UnderstandingSession, and Artifact tables
3. `get_project` endpoint includes the same flags
4. No frontend changes needed (dashboard already reads these fields)
</verification>

<success_criteria>
- ProjectResponse has 3 new boolean fields (has_pending_gate, has_understanding_session, has_brief)
- list_projects and get_project endpoints compute flags from related tables
- Backend imports and schema validation pass
- SC4 gap (dashboard project context not wired) is closed
</success_criteria>

<output>
After completion, create `.planning/phases/08-understanding-interview-decision-gates/08-07-SUMMARY.md`
</output>
