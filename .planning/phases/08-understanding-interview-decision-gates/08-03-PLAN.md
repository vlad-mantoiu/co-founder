---
phase: 08-understanding-interview-decision-gates
plan: 03
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - backend/app/schemas/execution_plans.py
  - backend/app/services/execution_plan_service.py
  - backend/app/api/routes/execution_plans.py
  - backend/app/api/routes/__init__.py
  - backend/app/agent/runner.py
  - backend/app/agent/runner_fake.py
  - backend/tests/api/test_execution_plans_api.py
autonomous: true

must_haves:
  truths:
    - "Execution plan generation returns 2-3 options with tradeoffs and recommended flag"
    - "Each option has name, time_to_ship, engineering_cost, risk_level, scope_coverage, pros, cons, technical_approach"
    - "Attempting generation before gate decision returns 409"
    - "Selection required before build starts (409 if missing)"
    - "Founder can select one option or regenerate a fresh set"
    - "Deep Research button returns 402 if not enabled"
    - "Decision console templates show options with full breakdown"
  artifacts:
    - path: "backend/app/schemas/execution_plans.py"
      provides: "ExecutionOption and ExecutionPlanOptions Pydantic schemas"
      exports: ["ExecutionOption", "ExecutionPlanOptions", "SelectPlanRequest", "SelectPlanResponse", "GeneratePlansResponse"]
    - path: "backend/app/services/execution_plan_service.py"
      provides: "ExecutionPlanService with generation, selection, and 409 enforcement"
      exports: ["ExecutionPlanService"]
    - path: "backend/app/api/routes/execution_plans.py"
      provides: "Execution plan REST endpoints including Deep Research stub"
      exports: ["router"]
    - path: "backend/tests/api/test_execution_plans_api.py"
      provides: "Integration tests for execution plan and deep research APIs"
  key_links:
    - from: "backend/app/api/routes/execution_plans.py"
      to: "backend/app/services/gate_service.py"
      via: "Gate blocking check before generation"
      pattern: "check_gate_blocking|409"
    - from: "backend/app/services/execution_plan_service.py"
      to: "backend/app/agent/runner.py"
      via: "Runner protocol for plan generation"
      pattern: "runner\\.generate_execution_options"
---

<objective>
Build Execution Plan generation backend with 409 gate enforcement, Deep Research 402 stub, and decision console template data.

Purpose: After the founder proceeds through Decision Gate 1, they need to choose HOW to build. This plan provides 2-3 execution options with tradeoff analysis, enforces that the gate was resolved before allowing generation, and stubs Deep Research for future beta monetization.

Output: Execution plan schemas, service, 6 REST endpoints (including Deep Research stub), integration tests
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-understanding-interview-decision-gates/08-CONTEXT.md
@.planning/phases/08-understanding-interview-decision-gates/08-RESEARCH.md

@.planning/phases/08-understanding-interview-decision-gates/08-02-SUMMARY.md

@backend/app/agent/runner.py
@backend/app/agent/runner_fake.py
@backend/app/services/gate_service.py
@backend/app/schemas/decision_gates.py
@backend/app/db/models/artifact.py
@backend/app/api/routes/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execution Plan Schemas + Runner Extension + Service</name>
  <files>
    backend/app/schemas/execution_plans.py
    backend/app/agent/runner.py
    backend/app/agent/runner_fake.py
    backend/app/services/execution_plan_service.py
  </files>
  <action>
1. Create `schemas/execution_plans.py` with Pydantic models:
   - `ExecutionOption` — id: str, name: str, is_recommended: bool, time_to_ship: str, engineering_cost: str, risk_level: str (Literal["low", "medium", "high"]), scope_coverage: int (0-100), pros: list[str] (min 2, max 5), cons: list[str] (min 2, max 5), technical_approach: str, tradeoffs: list[str]
   - `ExecutionPlanOptions` — options: list[ExecutionOption] (min 2, max 3), recommended_id: str
   - `GeneratePlansRequest` — project_id: str, feedback: str | None = None (optional "why didn't you like these?" for regeneration)
   - `GeneratePlansResponse` — plan_set_id: str, options: list[ExecutionOption], recommended_id: str, generated_at: str
   - `SelectPlanRequest` — option_id: str
   - `SelectPlanResponse` — selected_option: ExecutionOption, plan_set_id: str, message: str
   - `DecisionConsoleOption` — Extends ExecutionOption with: engineering_impact: str, cost_note: str. For DCSN-02 compliance.

2. Extend Runner protocol in `runner.py` with 1 new method:
   - `generate_execution_options(brief: dict, feedback: str | None = None) -> dict` — Generate 2-3 execution plan options from the Idea Brief. Returns dict matching ExecutionPlanOptions schema. feedback param allows regeneration context.

3. Extend RunnerFake in `runner_fake.py`:
   - `generate_execution_options`: Return 3 realistic options:
     - "Fast MVP" (recommended, low risk, 70% scope, 3-4 weeks)
     - "Full-Featured Launch" (high risk, 95% scope, 8-10 weeks)
     - "Hybrid Approach" (medium risk, 85% scope, 5-6 weeks)
   - Each with realistic pros, cons, technical_approach, tradeoffs, engineering_impact, cost_note.
   - Respect scenario (llm_failure/rate_limited raise RuntimeError).

4. Create `services/execution_plan_service.py` (DI: runner + session_factory):
   - `generate_options(clerk_user_id, project_id, feedback)` — Check project ownership (404). Check gate blocking via GateService.check_gate_blocking — if pending gate exists, raise HTTPException(409, "Decision Gate 1 must be resolved before generating execution plans"). If gate resolved but decision != "proceed", raise 409 with message. Load Idea Brief artifact. Generate options via runner.generate_execution_options(brief, feedback). Store plan set as Artifact (artifact_type="execution_plan"). Return GeneratePlansResponse.
   - `select_option(clerk_user_id, project_id, option_id)` — Load execution plan Artifact. Find option by ID. Store selection in Artifact current_content (mark selected_option_id). Return SelectPlanResponse.
   - `get_selected_plan(clerk_user_id, project_id)` — Return the selected execution plan option, or None if not yet selected.
   - `check_plan_selected(project_id)` — Return True if an execution plan has been selected. Used by build services to enforce 409 (PLAN-02).
   - `regenerate_options(clerk_user_id, project_id, feedback)` — Version rotate existing execution plan Artifact. Generate fresh options with feedback context. Store new plan set. Return GeneratePlansResponse.

   Add EXECUTION_PLAN to ArtifactType enum if not already present.
  </action>
  <verify>
    Run `cd /Users/vladcortex/co-founder/backend && python -c "from app.schemas.execution_plans import ExecutionOption, ExecutionPlanOptions; print('Schemas OK')"` — imports succeed.
    Run `cd /Users/vladcortex/co-founder/backend && python -c "from app.agent.runner_fake import RunnerFake; import asyncio; f = RunnerFake(); opts = asyncio.run(f.generate_execution_options({})); print(f'{len(opts[\"options\"])} options, recommended: {opts[\"recommended_id\"]}')"` — 3 options returned.
    Run `cd /Users/vladcortex/co-founder/backend && python -c "from app.services.execution_plan_service import ExecutionPlanService; print('Service OK')"` — imports succeed.
  </verify>
  <done>
    ExecutionOption and ExecutionPlanOptions schemas validate with all required fields including engineering_impact and cost_note for decision console (DCSN-02). Runner protocol extended with generate_execution_options. RunnerFake returns 3 realistic options. ExecutionPlanService enforces 409 for ungated operations and handles generation, selection, and regeneration. EXECUTION_PLAN added to ArtifactType.
  </done>
</task>

<task type="auto">
  <name>Task 2: Execution Plan API Routes + Deep Research Stub + Tests</name>
  <files>
    backend/app/api/routes/execution_plans.py
    backend/app/api/routes/__init__.py
    backend/tests/api/test_execution_plans_api.py
  </files>
  <action>
1. Create `api/routes/execution_plans.py` with 6 endpoints:
   - `POST /api/plans/generate` — Generate execution plan options. Body: GeneratePlansRequest. Returns GeneratePlansResponse. Enforces 409 if gate not resolved with "proceed". (PLAN-01)
   - `POST /api/plans/{project_id}/select` — Select an option. Body: SelectPlanRequest. Returns SelectPlanResponse. (PLAN-02 enforcement happens here)
   - `GET /api/plans/{project_id}` — Get current execution plan options (latest generation).
   - `GET /api/plans/{project_id}/selected` — Get selected plan option. Returns 404 if none selected.
   - `POST /api/plans/regenerate` — Regenerate with feedback. Body: GeneratePlansRequest (with feedback field). Returns GeneratePlansResponse. (locked decision: "Generate different options" button)
   - `POST /api/plans/{project_id}/deep-research` — Deep Research stub. Always returns 402 with body: {"detail": "Deep Research requires CTO tier. Upgrade to unlock market research, competitor analysis, and technical feasibility reports.", "upgrade_url": "/billing"} (UNDR-06)

   All routes use require_auth dependency.
   All routes use get_runner() dependency.
   Error handling: 404 (not found/unauthorized), 409 (gate not resolved / plan not selected), 402 (deep research stub).

2. Register router in `api/routes/__init__.py`:
   - `from app.api.routes import execution_plans`
   - `api_router.include_router(execution_plans.router, prefix="/plans", tags=["execution-plans"])`

3. Create integration tests in `tests/api/test_execution_plans_api.py`:
   - test_generate_plans_returns_2_3_options (PLAN-01) — Verify 2-3 options returned with all required fields
   - test_generate_plans_has_recommended (PLAN-01) — One option is_recommended=True
   - test_generate_plans_before_gate_returns_409 (GATE-02) — 409 if gate pending
   - test_generate_plans_after_non_proceed_returns_409 — 409 if gate resolved as narrow/pivot/park
   - test_select_plan_persists_selection (PLAN-02)
   - test_build_before_selection_checkable (PLAN-02) — check_plan_selected returns False before selection
   - test_regenerate_returns_fresh_options — New options generated, old ones versioned
   - test_deep_research_returns_402 (UNDR-06)
   - test_user_isolation_returns_404
   - test_each_option_has_full_breakdown — time_to_ship, engineering_cost, risk_level, scope_coverage, pros, cons, technical_approach, tradeoffs, engineering_impact, cost_note (DCSN-02)
   - All tests use dependency_overrides for require_auth and get_runner.
  </action>
  <verify>
    Run `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/api/test_execution_plans_api.py -v` — all tests pass.
    Run `cd /Users/vladcortex/co-founder/backend && python -c "from app.api.routes import api_router; routes = [r.path for r in api_router.routes if 'plans' in str(r.path)]; print(f'{len(routes)} routes:', routes)"` — 6 routes registered.
  </verify>
  <done>
    6 execution plan API endpoints registered. Generation enforces 409 for ungated operations. Selection persisted and checkable. Regeneration with feedback supported. Deep Research returns 402. Each option includes full breakdown (time, cost, risk, scope, pros, cons, approach, tradeoffs, engineering_impact, cost_note). Integration tests cover PLAN-01 through PLAN-04, UNDR-06, GATE-02, DCSN-01, DCSN-02. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `python -c "from app.schemas.execution_plans import ExecutionOption"` succeeds
- `python -c "from app.services.execution_plan_service import ExecutionPlanService"` succeeds
- `python -m pytest tests/api/test_execution_plans_api.py -v` — all tests pass
- 6 routes registered under /api/plans/*
- POST /api/plans/generate returns 409 if gate not resolved
- POST /api/plans/{id}/deep-research returns 402
- Each option has all DCSN-02 fields
</verification>

<success_criteria>
- Execution plan generation returns 2-3 options with recommended flag (PLAN-01)
- 409 returned if gate not resolved or not "proceed" (GATE-02)
- Selection persisted and queryable (PLAN-02)
- Regeneration with feedback produces fresh options
- Deep Research returns 402 with upgrade message (UNDR-06)
- Decision console options include engineering_impact, time_to_ship, cost_note (DCSN-01, DCSN-02)
- Decisions recorded before execution can begin (DCSN-03)
</success_criteria>

<output>
After completion, create `.planning/phases/08-understanding-interview-decision-gates/08-03-SUMMARY.md`
</output>
