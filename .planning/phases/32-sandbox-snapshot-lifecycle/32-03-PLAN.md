---
phase: 32-sandbox-snapshot-lifecycle
plan: "03"
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - frontend/src/hooks/usePreviewPane.ts
  - frontend/src/hooks/useBuildProgress.ts
  - frontend/src/components/build/PreviewPane.tsx
  - frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
autonomous: true
requirements: [SBOX-04]

must_haves:
  truths:
    - "When sandbox_paused is true, PreviewPane shows 'Your preview is sleeping. Resume preview.' with a Resume button"
    - "Clicking Resume shows spinner with 'Resuming preview...' text in the preview pane area"
    - "After successful resume, iframe auto-reloads with the new preview URL — no extra click"
    - "On resume failure, PreviewPane shows 'Resume failed' with distinct messages for expired vs unreachable"
    - "Resume failure offers Rebuild button with confirmation: 'This will use 1 build credit. Continue?'"
  artifacts:
    - path: "frontend/src/hooks/usePreviewPane.ts"
      provides: "paused, resuming, resume_failed states + handleResume function"
      contains: "paused"
    - path: "frontend/src/hooks/useBuildProgress.ts"
      provides: "sandbox_paused field in GenerationStatusResponse interface"
      contains: "sandbox_paused"
    - path: "frontend/src/components/build/PreviewPane.tsx"
      provides: "PausedView, ResumingView, ResumeFailedView components"
      contains: "PausedView"
    - path: "frontend/src/app/(dashboard)/projects/[id]/build/page.tsx"
      provides: "sandboxPaused prop passed to PreviewPane"
      contains: "sandboxPaused"
  key_links:
    - from: "frontend/src/hooks/usePreviewPane.ts"
      to: "backend/app/api/routes/generation.py"
      via: "POST /api/generation/{jobId}/resume API call in handleResume"
      pattern: "resume"
    - from: "frontend/src/hooks/useBuildProgress.ts"
      to: "backend/app/api/routes/generation.py"
      via: "sandbox_paused field in GenerationStatusResponse"
      pattern: "sandbox_paused"
    - from: "frontend/src/components/build/PreviewPane.tsx"
      to: "frontend/src/hooks/usePreviewPane.ts"
      via: "state === 'paused' renders PausedView, handleResume callback"
      pattern: "paused"
---

<objective>
Add paused, resuming, and resume_failed states to the frontend preview system so founders can resume sleeping sandboxes from the build page.

Purpose: The frontend must detect paused sandboxes (via sandbox_paused API field) and provide a seamless resume experience with spinner, auto-reload, and failure handling. Without this, founders see a broken iframe for paused sandboxes.

Output: Updated usePreviewPane hook with 3 new states + handleResume, PreviewPane with PausedView/ResumingView/ResumeFailedView, build page passing sandboxPaused through.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-sandbox-snapshot-lifecycle/32-RESEARCH.md
@.planning/phases/31-preview-iframe/31-03-SUMMARY.md
@.planning/phases/31-preview-iframe/31-04-SUMMARY.md
@frontend/src/hooks/usePreviewPane.ts
@frontend/src/hooks/useBuildProgress.ts
@frontend/src/components/build/PreviewPane.tsx
@frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add paused/resuming/resume_failed states to usePreviewPane + sandbox_paused to useBuildProgress</name>
  <files>
    frontend/src/hooks/usePreviewPane.ts
    frontend/src/hooks/useBuildProgress.ts
  </files>
  <action>
1. In `frontend/src/hooks/useBuildProgress.ts`:
   - Add `sandbox_paused?: boolean;` to the `GenerationStatusResponse` interface
   - Add `sandboxPaused: boolean;` to the `BuildProgressState` interface
   - Initialize `sandboxPaused: false` in the useState default
   - In `fetchStatus()`, read `sandboxPaused: data.sandbox_paused ?? false` and include it in setState

2. In `frontend/src/hooks/usePreviewPane.ts`:
   - Extend `PreviewState` type union with 3 new states:
     ```typescript
     export type PreviewState =
       | "checking" | "loading" | "active" | "blocked" | "expired"
       | "paused"         // sandbox was beta_paused — show resume button
       | "resuming"       // resume API call in progress
       | "resume_failed"  // both retry attempts failed
       | "error";
     ```
   - Add new state for resume error tracking:
     ```typescript
     const [resumeErrorType, setResumeErrorType] = useState<"sandbox_expired" | "sandbox_unreachable" | null>(null);
     ```
   - Update function signature to accept `sandboxPaused`:
     ```typescript
     export function usePreviewPane(
       previewUrl: string,
       sandboxExpiresAt: string | null,
       sandboxPaused: boolean,   // NEW param
       jobId: string,
       getToken: () => Promise<string | null>,
     ): UsePreviewPaneReturn {
     ```
   - Add `sandboxPaused` to mount effect: if `sandboxPaused` is true on mount, skip preview-check and go straight to `"paused"` state. Otherwise call `runPreviewCheck()` as before:
     ```typescript
     useEffect(() => {
       if (sandboxPaused) {
         setState("paused");
         return;
       }
       runPreviewCheck();
       return () => { clearLoadingTimeout(); clearExpiryInterval(); };
     }, [sandboxPaused, runPreviewCheck, clearLoadingTimeout, clearExpiryInterval]);
     ```
   - Add `activePreviewUrl` state to track the current preview URL (may change after resume):
     ```typescript
     const [activePreviewUrl, setActivePreviewUrl] = useState(previewUrl);
     ```
     Return `activePreviewUrl` instead of `previewUrl` in the hook return.
   - Add `handleResume` callback:
     ```typescript
     const handleResume = useCallback(async () => {
       setState("resuming");
       setResumeErrorType(null);
       for (let attempt = 0; attempt < 2; attempt++) {
         try {
           const res = await apiFetch(`/api/generation/${jobId}/resume`, getToken, { method: "POST" });
           if (!res.ok) {
             const body = await res.json().catch(() => null);
             if (res.status === 503 && body?.detail?.error_type) {
               throw new Error(body.detail.error_type);
             }
             throw new Error(`HTTP ${res.status}`);
           }
           const data: { preview_url: string; sandbox_id: string } = await res.json();
           setActivePreviewUrl(data.preview_url);
           setState("loading");  // triggers iframe load → markLoaded → active
           return;
         } catch (err) {
           if (attempt === 0) {
             await new Promise(r => setTimeout(r, 5000));
             continue;
           }
           // Final failure — classify error
           const msg = err instanceof Error ? err.message : "";
           if (msg === "sandbox_expired") {
             setResumeErrorType("sandbox_expired");
           } else {
             setResumeErrorType("sandbox_unreachable");
           }
           setState("resume_failed");
         }
       }
     }, [jobId, getToken]);
     ```
   - Update `UsePreviewPaneReturn` interface to expose new fields:
     ```typescript
     export interface UsePreviewPaneReturn {
       state: PreviewState;
       deviceMode: DeviceMode;
       setDeviceMode: (mode: DeviceMode) => void;
       previewUrl: string;      // now returns activePreviewUrl
       blockReason: string | null;
       timeRemaining: number | null;
       markLoaded: () => void;
       onRetry: () => void;
       handleResume: () => void;           // NEW
       resumeErrorType: "sandbox_expired" | "sandbox_unreachable" | null;  // NEW
     }
     ```
  </action>
  <verify>
    - `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit` — no TypeScript errors
    - `grep -n "paused\|resuming\|resume_failed" frontend/src/hooks/usePreviewPane.ts` shows all 3 new states
    - `grep -n "sandbox_paused\|sandboxPaused" frontend/src/hooks/useBuildProgress.ts` shows the new field
    - `grep -n "handleResume" frontend/src/hooks/usePreviewPane.ts` shows the resume callback
  </verify>
  <done>usePreviewPane supports paused/resuming/resume_failed states. handleResume calls POST /resume with 2-attempt retry. useBuildProgress reads and exposes sandboxPaused from API response. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Add PausedView/ResumingView/ResumeFailedView to PreviewPane + wire sandboxPaused in build page</name>
  <files>
    frontend/src/components/build/PreviewPane.tsx
    frontend/src/app/(dashboard)/projects/[id]/build/page.tsx
  </files>
  <action>
1. In `frontend/src/components/build/PreviewPane.tsx`:
   - Add `Moon` to the lucide-react imports (for paused sleeping icon)
   - Update `PreviewPaneProps` to include `sandboxPaused: boolean`
   - Update `usePreviewPane()` call to pass `sandboxPaused` as the new third parameter
   - Destructure `handleResume` and `resumeErrorType` from the hook return

   - Add `PausedView` component (same card style as ExpiredView, different CTA per locked decision):
     ```tsx
     function PausedView({ onResume }: { onResume: () => void }) {
       return (
         <CenteredOverlay>
           <div className="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center">
             <Moon className="w-5 h-5 text-white/40" />
           </div>
           <div className="text-center space-y-1.5">
             <StatusHeading>Your preview is sleeping.</StatusHeading>
           </div>
           <ActionButton onClick={onResume} variant="primary">
             Resume preview
           </ActionButton>
         </CenteredOverlay>
       );
     }
     ```

   - Add `ResumingView` component:
     ```tsx
     function ResumingView() {
       return (
         <CenteredOverlay>
           <Loader2 className="w-7 h-7 text-white/40 animate-spin" />
           <StatusSubtext>Resuming preview...</StatusSubtext>
         </CenteredOverlay>
       );
     }
     ```

   - Add `ResumeFailedView` component (per locked decisions: distinct error messages, rebuild with confirmation):
     ```tsx
     function ResumeFailedView({
       errorType,
       onRebuild,
     }: {
       errorType: "sandbox_expired" | "sandbox_unreachable" | null;
       onRebuild: () => void;
     }) {
       const message =
         errorType === "sandbox_expired"
           ? "The sandbox has expired and can\u2019t be recovered."
           : "The sandbox couldn\u2019t be reached. It may be corrupted.";

       const handleRebuild = () => {
         if (window.confirm("This will use 1 build credit. Continue?")) {
           onRebuild();
         }
       };

       return (
         <CenteredOverlay>
           <AlertCircle className="w-8 h-8 text-red-400/80" />
           <div className="text-center space-y-1.5">
             <StatusHeading>Resume failed</StatusHeading>
             <StatusSubtext>{message}</StatusSubtext>
           </div>
           <ActionButton onClick={handleRebuild} variant="primary">
             Rebuild
           </ActionButton>
         </CenteredOverlay>
       );
     }
     ```

   - Wire the new views into the main render function. In the AnimatePresence section, add cases for "paused", "resuming", and "resume_failed":
     - `state === "paused"` → render `PausedView` as a full replacement card (NO BrowserChrome wrapper, same as expired — per locked decision "Same card style for paused and expired")
     - `state === "resuming"` → render `ResumingView` as a full replacement card
     - `state === "resume_failed"` → render `ResumeFailedView` as a full replacement card, pass `onRebuild` prop through

2. In `frontend/src/app/(dashboard)/projects/[id]/build/page.tsx`:
   - Destructure `sandboxPaused` from `useBuildProgress` return value
   - Pass `sandboxPaused={sandboxPaused}` as a prop to `PreviewPane`

   Find the PreviewPane usage and add the prop. It should look like:
   ```tsx
   <PreviewPane
     previewUrl={previewUrl!}
     sandboxExpiresAt={sandboxExpiresAt}
     sandboxPaused={sandboxPaused}
     jobId={jobId!}
     projectId={id}
     getToken={getToken}
     onRebuild={handleRebuild}
     onIterate={handleIterate}
   />
   ```

NOTE: Per locked decision, "Paused card copy is minimal: 'Your preview is sleeping. Resume preview.' — no technical explanation of why." Keep the paused view simple. "Dashboard job status stays 'Ready' for paused jobs" — the build page still shows the success state with the paused preview pane inside it.
  </action>
  <verify>
    - `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit` — no TypeScript errors
    - `grep -n "PausedView\|ResumingView\|ResumeFailedView" frontend/src/components/build/PreviewPane.tsx` shows all 3 components
    - `grep -n "sandboxPaused" frontend/src/app/(dashboard)/projects/\[id\]/build/page.tsx` shows prop being passed
    - `grep -n "Moon" frontend/src/components/build/PreviewPane.tsx` shows the sleeping icon import
  </verify>
  <done>PreviewPane renders PausedView (Moon icon + "Resume preview"), ResumingView (spinner + "Resuming preview..."), and ResumeFailedView (error message + Rebuild with confirmation). Build page passes sandboxPaused prop through. All states use full replacement cards (no BrowserChrome) per locked decision. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. PreviewState now includes "paused", "resuming", "resume_failed"
2. usePreviewPane detects sandboxPaused=true and enters "paused" state immediately (no preview-check)
3. handleResume calls POST /resume with 2-attempt retry, updates iframe URL on success
4. PausedView shows Moon icon + "Your preview is sleeping." + "Resume preview" button
5. ResumingView shows Loader2 spinner + "Resuming preview..."
6. ResumeFailedView shows distinct messages for expired vs unreachable + Rebuild with confirmation
7. Build page passes sandboxPaused from useBuildProgress to PreviewPane
8. TypeScript compiles with zero errors
</verification>

<success_criteria>
- Paused sandbox shows sleeping card with Resume button (no technical jargon)
- Clicking Resume shows spinner then auto-reloads iframe on success
- Resume failure shows contextual error + Rebuild with credit confirmation
- Build page still shows "Build complete!" success state — preview pane is paused inside it
- TypeScript clean
</success_criteria>

<output>
After completion, create `.planning/phases/32-sandbox-snapshot-lifecycle/32-03-SUMMARY.md`
</output>
