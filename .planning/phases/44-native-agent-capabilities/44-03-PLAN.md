---
phase: 44-native-agent-capabilities
plan: "03"
type: execute
wave: 1
depends_on: ["44-02"]
files_modified:
  - backend/app/services/generation_service.py
  - backend/tests/services/test_generation_service_dispatcher_wiring.py
autonomous: true
requirements: [AGNT-04, AGNT-05]
gap_closure: true

must_haves:
  truths:
    - "E2BToolDispatcher in production receives redis and state_machine — narrate() and document() calls emit SSE events and write to Redis"
    - "An integration-style test verifies E2BToolDispatcher is constructed with non-None redis and state_machine in the autonomous build path"
  artifacts:
    - path: "backend/app/services/generation_service.py"
      provides: "E2BToolDispatcher constructed with redis=_redis and state_machine=state_machine"
      contains: "redis=_redis"
    - path: "backend/tests/services/test_generation_service_dispatcher_wiring.py"
      provides: "Test verifying dispatcher wiring passes redis and state_machine"
      min_lines: 20
  key_links:
    - from: "backend/app/services/generation_service.py"
      to: "backend/app/agent/tools/e2b_dispatcher.py"
      via: "E2BToolDispatcher constructor kwargs"
      pattern: "E2BToolDispatcher\\(.*redis=.*state_machine="
---

<objective>
Close the single verification gap from Phase 44: E2BToolDispatcher is instantiated in generation_service.py without redis or state_machine, causing narrate() and document() tool calls to silently no-op in production.

Purpose: Without this fix, every narrate() and document() call the agent makes in production returns a confirmation string but emits zero SSE events and writes nothing to Redis — the founder's activity feed and docs panel receive no updates.

Output: generation_service.py passes redis=_redis and state_machine=state_machine to E2BToolDispatcher; a test proves the wiring is correct.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-native-agent-capabilities/44-01-SUMMARY.md
@.planning/phases/44-native-agent-capabilities/44-VERIFICATION.md
@backend/app/services/generation_service.py
@backend/app/agent/tools/e2b_dispatcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire redis and state_machine into E2BToolDispatcher construction</name>
  <files>
    backend/app/services/generation_service.py
    backend/tests/services/test_generation_service_dispatcher_wiring.py
  </files>
  <action>
    **Fix the gap (1-line change):**

    In `backend/app/services/generation_service.py`, find the E2BToolDispatcher construction at approximately line 170:

    ```python
    dispatcher = E2BToolDispatcher(
        runtime=sandbox,
        screenshot_service=_screenshot_service if _settings.screenshot_enabled else None,
        project_id=project_id,
        job_id=job_id,
        preview_url=None,  # Agent discovers preview URL via bash tools
    )
    ```

    Add `redis=_redis` and `state_machine=state_machine` to the constructor call:

    ```python
    dispatcher = E2BToolDispatcher(
        runtime=sandbox,
        screenshot_service=_screenshot_service if _settings.screenshot_enabled else None,
        project_id=project_id,
        job_id=job_id,
        preview_url=None,  # Agent discovers preview URL via bash tools
        redis=_redis,
        state_machine=state_machine,
    )
    ```

    Both `_redis` (local variable resolved at line 94 from `get_redis()`) and `state_machine` (parameter of `execute_build()` at line 70) are already in scope.

    **Write integration test:**

    Create `backend/tests/services/test_generation_service_dispatcher_wiring.py` to verify the dispatcher receives redis and state_machine. The test should:

    1. Import `GenerationService` and mock out `E2BToolDispatcher.__init__` to capture constructor kwargs
    2. Mock the sandbox runtime factory, Redis, runner, and state_machine
    3. Call `execute_build()` on the autonomous path (settings.autonomous_agent=True)
    4. Assert that E2BToolDispatcher was called with `redis=<mock_redis>` and `state_machine=<mock_state_machine>` — both non-None
    5. Mark the test with `@pytest.mark.unit` since it uses mocks, not live services

    Use the existing test patterns from `backend/tests/services/` for mocking generation_service dependencies. The key assertion is:

    ```python
    _, kwargs = mock_e2b_dispatcher_init.call_args
    assert kwargs.get("redis") is not None, "E2BToolDispatcher must receive redis"
    assert kwargs.get("state_machine") is not None, "E2BToolDispatcher must receive state_machine"
    ```
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_generation_service_dispatcher_wiring.py -x -q</automated>
    <manual>grep "redis=_redis" backend/app/services/generation_service.py returns a match near the E2BToolDispatcher construction</manual>
    <sampling_rate>run after this task commits</sampling_rate>
  </verify>
  <done>
    E2BToolDispatcher constructor in generation_service.py includes redis=_redis and state_machine=state_machine. A unit test proves both values are non-None when the autonomous build path executes. The full agent test suite still passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Full suite regression check + grep verification</name>
  <files>
    backend/app/services/generation_service.py
  </files>
  <action>
    Run the full test suite (excluding integration tests that require live PostgreSQL) to confirm no regressions:

    ```bash
    cd /Users/vladcortex/co-founder/backend && python -m pytest tests/ -x -q -m "not integration"
    ```

    Then verify the VERIFICATION.md gap is closed by running the exact grep from the verification report:

    ```bash
    grep -n "redis=_redis" backend/app/services/generation_service.py
    grep -n "state_machine=state_machine" backend/app/services/generation_service.py
    ```

    Both should match on the E2BToolDispatcher construction block. The combination of passing tests + grep confirmation closes the gap.

    No file modifications needed in this task — it is a verification-only step.
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -m pytest tests/ -x -q -m "not integration"</automated>
    <manual>grep confirms redis=_redis and state_machine=state_machine present in E2BToolDispatcher construction</manual>
    <sampling_rate>run after this task, before plan is marked complete</sampling_rate>
  </verify>
  <done>
    Full test suite passes with zero regressions. grep confirms both redis and state_machine are wired. The Phase 44 verification gap (E2BToolDispatcher missing redis/state_machine in production) is closed.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest tests/services/test_generation_service_dispatcher_wiring.py -x -q` — new wiring test passes
2. `cd backend && python -m pytest tests/agent/ -x -q` — all 175 agent tests pass (including narrate/document tool tests)
3. `cd backend && python -m pytest tests/ -x -q -m "not integration"` — full suite green
4. `grep -n "redis=_redis.*state_machine=state_machine\|state_machine=state_machine.*redis=_redis" backend/app/services/generation_service.py` — matches the E2BToolDispatcher block
</verification>

<success_criteria>
- E2BToolDispatcher in generation_service.py receives redis=_redis and state_machine=state_machine
- A dedicated test proves both values are non-None in the autonomous build path
- Full test suite passes with no regressions
- The Phase 44 VERIFICATION.md gap is resolved
</success_criteria>

<output>
After completion, create `.planning/phases/44-native-agent-capabilities/44-03-SUMMARY.md`
</output>
