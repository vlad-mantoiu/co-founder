---
phase: 44-native-agent-capabilities
plan: 02
type: execute
wave: 2
depends_on: ["44-01"]
files_modified:
  - backend/app/services/generation_service.py
  - backend/app/services/narration_service.py
  - backend/app/services/doc_generation_service.py
  - backend/tests/services/test_narration_service.py
  - backend/tests/services/test_narration_wiring.py
  - backend/tests/services/test_doc_generation_service.py
  - backend/tests/services/test_doc_generation_wiring.py
  - backend/tests/services/test_changelog_wiring.py
autonomous: true
requirements: [AGNT-04, AGNT-05]

must_haves:
  truths:
    - "NarrationService and DocGenerationService files are deleted from the codebase"
    - "Zero remaining imports of NarrationService or DocGenerationService anywhere in the codebase"
    - "generation_service.py no longer creates background tasks for narration or doc generation"
    - "The full pytest suite passes with no import errors from deleted modules"
    - "The job:{id}:docs Redis hash is still populated — by agent document() tool calls, not DocGenerationService"
  artifacts:
    - path: "backend/app/services/generation_service.py"
      provides: "Clean generation service with no NarrationService/DocGenerationService references"
      contains: "execute_build"
  key_links:
    - from: "backend/app/services/generation_service.py"
      to: "backend/app/agent/tools/dispatcher.py"
      via: "narrate() and document() tools dispatched inside TAOR loop replace old service calls"
      pattern: "dispatcher"
---

<objective>
Delete NarrationService and DocGenerationService files, remove all imports and usages from generation_service.py, and delete their associated test files — completing the transition to native agent tools.

Purpose: The old services are replaced by narrate() and document() tools added in Plan 01. Leaving the files creates dead code, potential import confusion, and maintenance burden. Per CONTEXT.md locked decision: "Full deletion of NarrationService and DocGenerationService — delete files, remove all imports, delete their tests, remove route references. grep for zero remaining references."

Output: 7 files deleted, generation_service.py scrubbed clean, full test suite passing.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-native-agent-capabilities/44-RESEARCH.md
@.planning/phases/44-native-agent-capabilities/44-01-SUMMARY.md
@backend/app/services/generation_service.py
@backend/app/services/narration_service.py
@backend/app/services/doc_generation_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scrub generation_service.py — remove all narration/doc-gen imports and calls</name>
  <files>
    backend/app/services/generation_service.py
  </files>
  <action>
Edit `generation_service.py` to remove ALL references to NarrationService and DocGenerationService. This must be done BEFORE the service files are deleted (to avoid ImportError).

**Remove these imports (lines ~34-36):**
```python
from app.services.doc_generation_service import DocGenerationService
from app.services.narration_service import NarrationService
```

**Remove these module-level singletons (lines ~42-44):**
```python
_doc_generation_service = DocGenerationService()
_narration_service = NarrationService()
```

**Remove ALL `asyncio.create_task()` blocks that invoke `_narration_service.narrate()` or `_doc_generation_service.generate()` or `_doc_generation_service.generate_changelog()`.**

There are approximately 11 call sites (identified by grep):
- Line ~129: `_doc_generation_service.generate(...)` in scaffold section
- Line ~139: `_narration_service.narrate(...)` in scaffold section
- Line ~293: `_narration_service.narrate(...)` in code section
- Line ~323: `_narration_service.narrate(...)` in deps section
- Line ~351: `_narration_service.narrate(...)` in checks section
- Line ~533: `_doc_generation_service.generate(...)` in iteration section
- Line ~543: `_narration_service.narrate(...)` in iteration scaffold section
- Line ~559: `_narration_service.narrate(...)` in iteration code section
- Line ~602: `_narration_service.narrate(...)` in iteration deps section
- Line ~624: `_narration_service.narrate(...)` in iteration checks section
- Line ~716: `_doc_generation_service.generate_changelog(...)` in iteration post-build

For each call site, remove the entire `if _settings.narration_enabled and _redis is not None:` or `if _settings.docs_generation_enabled and _redis is not None:` block — including the `asyncio.create_task()` wrapper and the service call inside it. Leave the surrounding code (stage transitions, streamer writes) intact.

**IMPORTANT:** The autonomous agent path (inside `if _settings.autonomous_agent:` block starting at ~line 148) does NOT contain any narration/doc-gen calls — those are only in the legacy (else) path. Both paths must be scrubbed, but only the legacy path has the calls.

After editing, verify the file still has valid Python syntax: `python -c "import ast; ast.parse(open('backend/app/services/generation_service.py').read()); print('OK')"`

Then run: `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/services/test_generation_service.py -x -q`
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && python -c "import ast; ast.parse(open('app/services/generation_service.py').read()); print('Syntax OK')" && python -m pytest tests/services/test_generation_service.py -x -q</automated>
    <manual>Verify no NarrationService or DocGenerationService references remain in generation_service.py</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>generation_service.py has zero references to NarrationService, DocGenerationService, _narration_service, _doc_generation_service. test_generation_service.py still passes.</done>
</task>

<task type="auto">
  <name>Task 2: Delete service files and test files, verify zero remaining references</name>
  <files>
    backend/app/services/narration_service.py
    backend/app/services/doc_generation_service.py
    backend/tests/services/test_narration_service.py
    backend/tests/services/test_narration_wiring.py
    backend/tests/services/test_doc_generation_service.py
    backend/tests/services/test_doc_generation_wiring.py
    backend/tests/services/test_changelog_wiring.py
  </files>
  <action>
**Step 1: Delete 7 files:**
```bash
cd /Users/vladcortex/co-founder/backend
rm app/services/narration_service.py
rm app/services/doc_generation_service.py
rm tests/services/test_narration_service.py
rm tests/services/test_narration_wiring.py
rm tests/services/test_doc_generation_service.py
rm tests/services/test_doc_generation_wiring.py
rm tests/services/test_changelog_wiring.py
```

**Step 2: Grep for orphan references:**
```bash
grep -r "narration_service\|doc_generation_service\|NarrationService\|DocGenerationService\|_SAFETY_PATTERNS" backend/ --include="*.py" | grep -v __pycache__ | grep -v ".pyc"
```
This MUST return zero results. If any file still imports from the deleted modules, fix it.

**Potential orphans to check:**
- `narration_service.py` imported `_SAFETY_PATTERNS` from `doc_generation_service.py`. Since `narration_service.py` is also deleted, this import chain is broken cleanly.
- `generation_service.py` was scrubbed in Task 1 — verify no references remain.
- Check `backend/app/queue/state_machine.py` — the RESEARCH.md notes it may have benign docstring references. If found, those are in comments about DOCUMENTATION_UPDATED event type — leave them (they describe the event, not import the service).

**Step 3: Run the full test suite:**
```bash
cd /Users/vladcortex/co-founder/backend && python -m pytest tests/ -x -q
```
This must pass. The deleted test files (~60 tests) will not run. The remaining suite must have zero import errors, zero failures related to the deleted modules.

**Step 4: Final verification count:**
```bash
cd /Users/vladcortex/co-founder/backend && python -m pytest tests/ --co -q | tail -5
```
Report the new total test count (should be ~530-570 — original ~590 minus deleted tests plus the 14 new narrate/document tests from Plan 01).
  </action>
  <verify>
    <automated>cd /Users/vladcortex/co-founder/backend && grep -r "NarrationService\|DocGenerationService\|narration_service\|doc_generation_service" --include="*.py" . | grep -v __pycache__ | grep -v ".pyc" && echo "FAIL: orphan references found" || echo "PASS: zero references" && python -m pytest tests/ -x -q</automated>
    <manual>Confirm 7 files deleted, zero grep hits, full suite passes</manual>
    <sampling_rate>run after this task commits</sampling_rate>
  </verify>
  <done>7 files deleted: 2 service files + 5 test files. Zero remaining references to NarrationService or DocGenerationService in the codebase. Full pytest suite passes. The agent's narrate() and document() tools (from Plan 01) are the sole providers of narration and documentation functionality.</done>
</task>

</tasks>

<verification>
1. `ls backend/app/services/narration_service.py backend/app/services/doc_generation_service.py 2>&1` — both return "No such file"
2. `grep -r "NarrationService\|DocGenerationService\|narration_service\|doc_generation_service" backend/ --include="*.py" | grep -v __pycache__` — returns zero results
3. `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/ -x -q` — full suite passes
4. `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/agent/test_narrate_tool.py tests/agent/test_document_tool.py -x -q` — narrate/document tools still work (Plan 01 tests pass)
</verification>

<success_criteria>
- narration_service.py and doc_generation_service.py do not exist in the filesystem
- 5 associated test files deleted (test_narration_service, test_narration_wiring, test_doc_generation_service, test_doc_generation_wiring, test_changelog_wiring)
- generation_service.py has zero narration/doc-gen imports, singletons, or create_task calls
- `grep -r` across backend/ returns zero hits for deleted module names
- Full pytest suite passes with no import errors
</success_criteria>

<output>
After completion, create `.planning/phases/44-native-agent-capabilities/44-02-SUMMARY.md`
</output>
