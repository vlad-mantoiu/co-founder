---
phase: 15-ci-cd-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/Makefile
  - backend/tests/conftest.py
  - backend/tests/domain/test_agent.py
  - backend/tests/domain/test_runner_protocol.py
  - backend/tests/domain/test_runner_fake.py
  - backend/tests/domain/test_stages.py
  - backend/tests/domain/test_progress.py
  - backend/tests/domain/test_gates.py
  - backend/tests/domain/test_journey_service.py
  - backend/tests/domain/test_provisioning.py
  - backend/tests/domain/test_feature_flags.py
  - backend/tests/domain/test_onboarding_models.py
  - backend/tests/domain/test_queue_schemas.py
  - backend/tests/domain/test_semaphore.py
  - backend/tests/domain/test_queue_manager.py
  - backend/tests/domain/test_job_state_machine.py
  - backend/tests/domain/test_estimator.py
  - backend/tests/domain/test_usage_counters.py
  - backend/tests/domain/test_artifact_models.py
  - backend/tests/domain/test_artifact_generator.py
  - backend/tests/domain/test_alignment.py
  - backend/tests/domain/test_deploy_checks.py
  - backend/tests/domain/test_risks.py
  - backend/tests/api/test_auth.py
  - backend/tests/api/test_auth_middleware.py
  - backend/tests/api/test_user_isolation.py
  - backend/tests/api/test_onboarding_api.py
  - backend/tests/api/test_project_creation_from_onboarding.py
  - backend/tests/api/test_jobs_api.py
  - backend/tests/api/test_jobs_integration.py
  - backend/tests/api/test_artifact_service.py
  - backend/tests/api/test_artifacts_api.py
  - backend/tests/api/test_artifact_markdown_export.py
  - backend/tests/api/test_artifact_export.py
  - backend/tests/api/test_correlation_middleware.py
  - backend/tests/api/test_dashboard_api.py
  - backend/tests/api/test_decision_gates_api.py
  - backend/tests/api/test_understanding_api.py
  - backend/tests/api/test_execution_plans_api.py
  - backend/tests/api/test_response_contracts.py
  - backend/tests/api/test_beta_gating.py
  - backend/tests/api/test_deploy_readiness.py
  - backend/tests/api/test_generation_routes.py
  - backend/tests/api/test_billing_api.py
  - backend/tests/services/test_generation_service.py
  - backend/tests/services/test_mvp_built_transition.py
  - backend/tests/services/test_gate2_and_change_requests.py
  - backend/tests/services/test_iteration_build.py
  - backend/tests/test_llm_helpers.py
  - backend/tests/agent/test_runner_real.py
  - backend/tests/agent/test_llm_retry.py
autonomous: true
requirements:
  - CICD-08
  - CICD-09

must_haves:
  truths:
    - "pytest-asyncio scope warning about asyncio_default_fixture_loop_scope=None no longer appears"
    - "Running 'pytest -m unit' executes only unit-marked tests with no unmarked tests collected"
    - "Running 'pytest -m integration' executes only integration-marked tests"
    - "'pytest --strict-markers' fails if an unregistered marker is used"
    - "All unit tests pass when run with 'pytest -m unit'"
    - "pytest -m integration passes with all previously-deferred integration tests"
  artifacts:
    - path: "backend/pyproject.toml"
      provides: "pytest-asyncio scope fix + marker registration"
      contains: "asyncio_default_fixture_loop_scope"
    - path: "backend/Makefile"
      provides: "test-unit and test-integration targets"
      contains: "test-unit"
  key_links:
    - from: "backend/pyproject.toml"
      to: "pytest marker system"
      via: "markers config + strict-markers"
      pattern: 'markers.*=.*\["unit'
---

<objective>
Fix pytest-asyncio event loop scope and add unit/integration test markers to every test file.

Purpose: The test gate (Plan 03) is only useful if the tests themselves are reliable and properly categorized. The asyncio_default_fixture_loop_scope=None causes cross-test event loop contamination, and without markers, CI cannot run only unit tests (fast, no external services) while deferring integration tests to nightly.

Output: All test files marked as `@pytest.mark.unit` or `@pytest.mark.integration`, pyproject.toml configured with scope fix and strict markers, Makefile updated with `test-unit` and `test-integration` targets.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-ci-cd-hardening/15-RESEARCH.md
@backend/pyproject.toml
@backend/Makefile
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pytest-asyncio scope and register markers in pyproject.toml</name>
  <files>backend/pyproject.toml, backend/Makefile</files>
  <action>
    In `backend/pyproject.toml`, update the `[tool.pytest.ini_options]` section to:
    ```toml
    [tool.pytest.ini_options]
    asyncio_mode = "auto"
    asyncio_default_fixture_loop_scope = "function"
    testpaths = ["tests"]
    markers = [
        "unit: Unit tests - no external services required (fakeredis OK)",
        "integration: Integration tests - require real database and Redis",
    ]
    addopts = "--strict-markers"
    ```

    Key changes:
    - Add `asyncio_default_fixture_loop_scope = "function"` — this ensures each test gets its own event loop, preventing "Task got Future attached to a different loop" errors
    - Register `unit` and `integration` markers
    - Add `--strict-markers` to fail on unregistered marker typos

    In `backend/Makefile`, add two new targets (keep existing targets):
    ```makefile
    test-unit:
    	python -m pytest tests/ -m unit -v

    test-integration:
    	python -m pytest tests/ -m integration -v
    ```

    Also update the existing `test:` target to run all non-e2e tests:
    ```makefile
    test:
    	python -m pytest tests/ --ignore=tests/e2e -v
    ```
  </action>
  <verify>
    Run: `cd /Users/vladcortex/co-founder/backend && python -m pytest --co -q 2>&1 | head -5` — should NOT contain the "asyncio_default_fixture_loop_scope is not set" warning.
    Run: `cd /Users/vladcortex/co-founder/backend && python -m pytest --markers 2>&1 | grep -E "unit|integration"` — should show both custom markers.
  </verify>
  <done>pyproject.toml has asyncio_default_fixture_loop_scope = "function", both markers registered, strict-markers enabled. Makefile has test-unit and test-integration targets.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit/integration markers to all test files</name>
  <files>All test files under backend/tests/ (excluding __init__.py, conftest.py, e2e/)</files>
  <action>
    Categorize and mark every test file. The rule:
    - **unit**: Tests that use only mocks, fakes, fakeredis, or in-memory state. These do NOT require a running PostgreSQL or Redis service.
    - **integration**: Tests that use the `api_client` fixture (which spins up TestClient with full app lifespan), `db_session` fixture connected to real PostgreSQL, or real Redis connections.

    **Category assignments (based on fixture analysis):**

    UNIT tests (add `pytestmark = pytest.mark.unit` at module level, after imports):
    - `tests/domain/test_agent.py` — pure domain logic
    - `tests/domain/test_runner_protocol.py` — protocol contract checks
    - `tests/domain/test_runner_fake.py` — RunnerFake tests
    - `tests/domain/test_stages.py` — enum/stage logic
    - `tests/domain/test_progress.py` — progress calculation
    - `tests/domain/test_gates.py` — gate logic
    - `tests/domain/test_provisioning.py` — provisioning logic
    - `tests/domain/test_feature_flags.py` — feature flag logic
    - `tests/domain/test_onboarding_models.py` — Pydantic model tests
    - `tests/domain/test_queue_schemas.py` — schema validation
    - `tests/domain/test_semaphore.py` — semaphore logic
    - `tests/domain/test_queue_manager.py` — queue manager (uses fakeredis)
    - `tests/domain/test_job_state_machine.py` — state machine logic
    - `tests/domain/test_estimator.py` — estimation logic
    - `tests/domain/test_usage_counters.py` — usage counter logic (uses fakeredis)
    - `tests/domain/test_artifact_models.py` — model validation
    - `tests/domain/test_artifact_generator.py` — generator logic
    - `tests/domain/test_alignment.py` — alignment logic
    - `tests/domain/test_deploy_checks.py` — deploy check logic
    - `tests/domain/test_risks.py` — risk detection logic
    - `tests/test_llm_helpers.py` — LLM helper utilities (mocked)
    - `tests/agent/test_runner_real.py` — RunnerReal tests (mocked LLM)
    - `tests/agent/test_llm_retry.py` — retry logic (mocked)

    INTEGRATION tests (add `pytestmark = pytest.mark.integration` at module level, after imports):
    - `tests/api/test_auth.py` — uses api_client
    - `tests/api/test_auth_middleware.py` — uses api_client
    - `tests/api/test_user_isolation.py` — uses api_client + DB
    - `tests/api/test_onboarding_api.py` — uses api_client + DB
    - `tests/api/test_project_creation_from_onboarding.py` — uses api_client + DB
    - `tests/api/test_jobs_api.py` — uses api_client + DB
    - `tests/api/test_jobs_integration.py` — uses api_client + DB
    - `tests/api/test_artifact_service.py` — uses api_client + DB
    - `tests/api/test_artifacts_api.py` — uses api_client + DB
    - `tests/api/test_artifact_markdown_export.py` — uses api_client + DB
    - `tests/api/test_artifact_export.py` — uses api_client + DB
    - `tests/api/test_correlation_middleware.py` — uses api_client
    - `tests/api/test_dashboard_api.py` — uses api_client + DB
    - `tests/api/test_decision_gates_api.py` — uses api_client + DB
    - `tests/api/test_understanding_api.py` — uses api_client + DB
    - `tests/api/test_execution_plans_api.py` — uses api_client + DB
    - `tests/api/test_response_contracts.py` — uses api_client
    - `tests/api/test_beta_gating.py` — uses api_client
    - `tests/api/test_deploy_readiness.py` — uses api_client + DB
    - `tests/api/test_generation_routes.py` — uses api_client
    - `tests/api/test_billing_api.py` — uses api_client
    - `tests/services/test_generation_service.py` — uses DB session
    - `tests/services/test_mvp_built_transition.py` — uses DB session
    - `tests/services/test_gate2_and_change_requests.py` — uses DB session
    - `tests/services/test_iteration_build.py` — uses DB session

    For each file, add `import pytest` (if not already imported) and add `pytestmark = pytest.mark.unit` or `pytestmark = pytest.mark.integration` on the line after the last import.

    **IMPORTANT:** Before marking, inspect `tests/domain/test_journey_service.py` — if it uses `db_session` or `api_client`, mark as integration. If it uses mocks only, mark as unit. Apply the same inspection to any file where the category is ambiguous.

    **Verify categorization is correct:** After marking, run `pytest -m unit --co -q` and confirm no test that requires DB/Redis fixtures is collected. If any unit-marked test imports from conftest fixtures that create real DB connections, recategorize it as integration.
  </action>
  <verify>
    Run: `cd /Users/vladcortex/co-founder/backend && python -m pytest -m unit --co -q 2>&1 | tail -5` — should list collected unit tests with no warnings about unknown markers.
    Run: `cd /Users/vladcortex/co-founder/backend && python -m pytest -m integration --co -q 2>&1 | tail -5` — should list collected integration tests.
    Run: `cd /Users/vladcortex/co-founder/backend && python -m pytest -m "not unit and not integration" --co -q --ignore=tests/e2e 2>&1` — should collect 0 tests (every non-e2e test must be marked).
    Run: `cd /Users/vladcortex/co-founder/backend && python -m pytest -m unit -v 2>&1 | tail -20` — unit tests should pass without DB/Redis services.
    Run: `cd /Users/vladcortex/co-founder/backend && python -m pytest tests/ -m integration -v 2>&1 | tail -30` — all previously-deferred integration tests must pass (confirms asyncio scope fix resolves the deferred failures).
  </verify>
  <done>Every test file (except e2e and conftest) has a pytestmark for unit or integration. `pytest -m "not unit and not integration" --ignore=tests/e2e` collects 0 tests. Unit tests pass without external services. Integration tests pass with postgres + redis services available.</done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest --co -q 2>&1 | head -3` — no asyncio_default_fixture_loop_scope warning
2. `cd backend && python -m pytest -m unit -v` — all unit tests pass
3. `cd backend && python -m pytest -m "not unit and not integration" --co -q --ignore=tests/e2e` — 0 tests collected (full coverage)
4. `cd backend && make test-unit` — runs unit tests only
</verification>

<success_criteria>
- asyncio_default_fixture_loop_scope = "function" eliminates the scope warning
- Every non-e2e test file has a pytestmark (unit or integration)
- `pytest -m unit` runs without requiring PostgreSQL or Redis services
- strict-markers catches any marker typos
</success_criteria>

<output>
After completion, create `.planning/phases/15-ci-cd-hardening/15-01-SUMMARY.md`
</output>
