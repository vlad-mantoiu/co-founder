---
phase: 15-ci-cd-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/main.py
  - backend/app/api/routes/health.py
  - infra/lib/compute-stack.ts
autonomous: true
requirements:
  - CICD-06
  - CICD-07

must_haves:
  truths:
    - "When SIGTERM is sent to the backend process, the health endpoint immediately returns 503"
    - "ALB deregistration delay is 60 seconds for both backend and frontend target groups"
    - "In-flight requests complete before the process exits"
  artifacts:
    - path: "backend/app/main.py"
      provides: "SIGTERM signal handler in lifespan"
      contains: "signal.SIGTERM"
    - path: "backend/app/api/routes/health.py"
      provides: "Shutdown-aware health check returning 503"
      contains: "shutting_down"
    - path: "infra/lib/compute-stack.ts"
      provides: "ALB deregistration delay configuration"
      contains: "deregistration_delay.timeout_seconds"
  key_links:
    - from: "backend/app/main.py"
      to: "backend/app/api/routes/health.py"
      via: "app.state.shutting_down flag set by SIGTERM handler"
      pattern: "app.state.shutting_down"
    - from: "infra/lib/compute-stack.ts"
      to: "ALB target group"
      via: "setAttribute for deregistration delay"
      pattern: "deregistration_delay"
---

<objective>
Add graceful shutdown handling to the backend and configure ALB deregistration delay so rolling deploys produce zero 502 errors.

Purpose: During ECS rolling deploys, the old task receives SIGTERM. Without a handler, the health check keeps returning 200 and the ALB keeps routing traffic to a dying container. The SIGTERM handler flips the health check to 503 immediately, ALB stops routing new traffic, and the 60-second deregistration delay allows in-flight requests to complete.

Output: SIGTERM handler in FastAPI lifespan, shutdown-aware health endpoint, CDK deregistration delay set to 60s on both target groups.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-ci-cd-hardening/15-RESEARCH.md
@backend/app/main.py
@backend/app/api/routes/health.py
@infra/lib/compute-stack.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SIGTERM handler and shutdown-aware health check</name>
  <files>backend/app/main.py, backend/app/api/routes/health.py</files>
  <action>
    **In `backend/app/main.py`:**

    1. Add `import signal` to the imports at the top of the file.

    2. Inside the `lifespan` function, BEFORE the existing startup code (before `settings = get_settings()`), add:
    ```python
    app.state.shutting_down = False

    def handle_sigterm(signum, frame):
        app.state.shutting_down = True
        logger.info("SIGTERM received - health check will return 503, draining connections")

    signal.signal(signal.SIGTERM, handle_sigterm)
    ```

    This sets the flag on the app.state that the health endpoint will check. The signal handler runs in the main thread (signal handlers always do), and `app.state.shutting_down` is a simple boolean attribute read — thread-safe for this use case.

    **In `backend/app/api/routes/health.py`:**

    1. Add `Request` to the FastAPI imports: `from fastapi import APIRouter, Request`

    2. Modify the `health_check` function to accept `request: Request` and check for shutdown state:
    ```python
    @router.get("/health")
    async def health_check(request: Request):
        """Health check endpoint for load balancer.

        Returns 503 during graceful shutdown so ALB stops routing traffic.
        """
        if getattr(request.app.state, "shutting_down", False):
            return JSONResponse(
                status_code=503,
                content={"status": "shutting_down", "service": "cofounder-backend"},
            )
        return {"status": "healthy", "service": "cofounder-backend"}
    ```

    The `getattr` with default `False` is defensive — if the attribute is not set (e.g., during testing without lifespan), it returns healthy.

    **Shutdown sequence after these changes:**
    1. ECS sends SIGTERM to uvicorn process
    2. `handle_sigterm` sets `shutting_down = True`
    3. ALB health check hits `/api/health` → gets 503 → marks task unhealthy
    4. ALB deregistration delay (60s from Task 2) drains in-flight requests
    5. Uvicorn finishes in-flight requests and exits cleanly
  </action>
  <verify>
    Run: `cd /Users/vladcortex/co-founder/backend && python -c "from app.main import app; print('SIGTERM handler registered')"` — should print without errors.
    Run: `cd /Users/vladcortex/co-founder/backend && grep -n 'signal.SIGTERM' app/main.py` — should find the signal handler registration.
    Run: `cd /Users/vladcortex/co-founder/backend && grep -n 'shutting_down' app/api/routes/health.py` — should find the shutdown check.
  </verify>
  <done>SIGTERM handler registered in lifespan, health endpoint returns 503 when shutting_down is True, defensive getattr ensures backward compatibility in tests.</done>
</task>

<task type="auto">
  <name>Task 2: Set ALB deregistration delay to 60s in CDK</name>
  <files>infra/lib/compute-stack.ts</files>
  <action>
    In `infra/lib/compute-stack.ts`, add deregistration delay configuration for BOTH target groups.

    **After the backend health check configuration** (after line `this.backendService.targetGroup.configureHealthCheck({...})`), add:
    ```typescript
    // Graceful shutdown: allow 60s for in-flight requests to complete during rolling deploys
    this.backendService.targetGroup.setAttribute(
      'deregistration_delay.timeout_seconds',
      '60'
    );
    ```

    **After the `frontendService` creation** (after the `ApplicationLoadBalancedFargateService` constructor for frontend, around line 279), add:
    ```typescript
    // Graceful shutdown: allow 60s for in-flight requests to complete during rolling deploys
    frontendService.targetGroup.setAttribute(
      'deregistration_delay.timeout_seconds',
      '60'
    );
    ```

    Note: `setAttribute` is the documented workaround because `ApplicationLoadBalancedFargateService` does not expose `deregistrationDelay` as a first-class CDK property (see AWS CDK Issue #4015).

    Do NOT run `cdk deploy` — the deploy workflow will handle that.
  </action>
  <verify>
    Run: `cd /Users/vladcortex/co-founder/infra && grep -n 'deregistration_delay' lib/compute-stack.ts` — should find two occurrences (backend and frontend).
    Run: `cd /Users/vladcortex/co-founder/infra && npx tsc --noEmit` — CDK TypeScript should compile without errors.
  </verify>
  <done>Both backend and frontend target groups have deregistration_delay.timeout_seconds set to 60. CDK compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `grep 'signal.SIGTERM' backend/app/main.py` — SIGTERM handler registered
2. `grep 'shutting_down' backend/app/api/routes/health.py` — health check is shutdown-aware
3. `grep -c 'deregistration_delay' infra/lib/compute-stack.ts` — returns 2 (backend + frontend)
4. `cd infra && npx tsc --noEmit` — CDK compiles
</verification>

<success_criteria>
- SIGTERM sets app.state.shutting_down = True immediately
- Health endpoint returns 503 when shutting_down is True, 200 otherwise
- Both ALB target groups have 60-second deregistration delay
- CDK compiles without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-ci-cd-hardening/15-02-SUMMARY.md`
</output>
