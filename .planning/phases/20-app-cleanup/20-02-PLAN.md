---
phase: 20-app-cleanup
plan: 02
type: execute
wave: 2
depends_on: [20-01]
files_modified: []
autonomous: false
requirements: [APP-01, APP-02, APP-03, APP-04]

must_haves:
  truths:
    - "cofounder.getinsourced.ai/ redirects unauthenticated users to /sign-in"
    - "cofounder.getinsourced.ai/pricing returns 308 redirect to getinsourced.ai/pricing"
    - "cofounder.getinsourced.ai/about returns 308 redirect to getinsourced.ai/about"
    - "cofounder.getinsourced.ai/sign-in returns 200"
    - "cofounder.getinsourced.ai/sign-up returns 200"
    - "cofounder.getinsourced.ai/nonexistent returns 404 with app-context page"
    - "getinsourced.ai CTA links to cofounder.getinsourced.ai/sign-up work"
  artifacts: []
  key_links:
    - from: "ECS frontend service"
      to: "cofounder.getinsourced.ai"
      via: "ALB routing"
      pattern: "HTTP 200 on /sign-in"
---

<objective>
Deploy the cleaned-up frontend to ECS and verify all redirects, auth flows, and marketing site CTA links work in production.

Purpose: Code changes from Plan 01 must be deployed and verified live. This confirms the root redirect, marketing path redirects, narrowed middleware, and 404 page all work on the real domain. Also verifies marketing site CTAs still reach the app correctly.

Output: Deployed frontend on ECS with all Phase 20 changes live. Curl verification results. Browser checkpoint confirmation.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-app-cleanup/20-RESEARCH.md
@.planning/phases/20-app-cleanup/20-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build and deploy frontend to ECS</name>
  <files></files>
  <action>
    Deploy the updated frontend to ECS using the standard deploy flow. All commands run from the repo root.

    1. Login to ECR:
       ```bash
       AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text --region us-east-1)
       ECR_URI="$AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com"
       aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $ECR_URI
       ```

    2. Build frontend Docker image for linux/amd64 (ECS Fargate requirement):
       ```bash
       docker buildx build --platform linux/amd64 --load \
         -f docker/Dockerfile.frontend \
         --build-arg NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY} \
         --build-arg NEXT_PUBLIC_API_URL=https://api.cofounder.getinsourced.ai \
         -t $ECR_URI/cofounder-frontend:latest .
       ```
       If NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY is not set in the environment, read it from `.env` or `.env.local` in the frontend directory.

    3. Push to ECR:
       ```bash
       docker push $ECR_URI/cofounder-frontend:latest
       ```

    4. Force ECS redeployment (frontend service only):
       ```bash
       FRONTEND_SERVICE=$(aws ecs list-services --cluster cofounder-cluster --region us-east-1 \
         --query 'serviceArns[?contains(@, `Frontend`)]' --output text | xargs basename)
       aws ecs update-service \
         --cluster cofounder-cluster \
         --service "$FRONTEND_SERVICE" \
         --force-new-deployment \
         --region us-east-1
       ```

    5. Wait for service stability (new task running, old task drained):
       ```bash
       aws ecs wait services-stable \
         --cluster cofounder-cluster \
         --services "$FRONTEND_SERVICE" \
         --region us-east-1
       ```

    6. Run automated curl verification checks:
       ```bash
       # Root unauthenticated -> should redirect to /sign-in
       curl -sI https://cofounder.getinsourced.ai/ | grep -E "^HTTP|^location"

       # Marketing paths -> should 308 redirect to getinsourced.ai
       curl -sI https://cofounder.getinsourced.ai/pricing | grep -E "^HTTP|^location"
       curl -sI https://cofounder.getinsourced.ai/about | grep -E "^HTTP|^location"
       curl -sI https://cofounder.getinsourced.ai/contact | grep -E "^HTTP|^location"
       curl -sI https://cofounder.getinsourced.ai/privacy | grep -E "^HTTP|^location"
       curl -sI https://cofounder.getinsourced.ai/terms | grep -E "^HTTP|^location"

       # /signin -> should redirect to /sign-in
       curl -sI https://cofounder.getinsourced.ai/signin | grep -E "^HTTP|^location"

       # Auth pages still accessible
       curl -sI https://cofounder.getinsourced.ai/sign-in | grep "^HTTP"
       curl -sI https://cofounder.getinsourced.ai/sign-up | grep "^HTTP"

       # Unknown path -> 404
       curl -sI https://cofounder.getinsourced.ai/nonexistent-test-page | grep "^HTTP"
       ```

    Expected results:
    - `/` -> 307 redirect to `/sign-in` (Next.js middleware default status)
    - `/pricing` -> 308 redirect to `https://getinsourced.ai/pricing`
    - `/about` -> 308 redirect to `https://getinsourced.ai/about`
    - `/contact` -> 308 redirect to `https://getinsourced.ai/contact`
    - `/privacy` -> 308 redirect to `https://getinsourced.ai/privacy`
    - `/terms` -> 308 redirect to `https://getinsourced.ai/terms`
    - `/signin` -> 308 redirect to `/sign-in`
    - `/sign-in` -> 200
    - `/sign-up` -> 200
    - `/nonexistent-test-page` -> 404
  </action>
  <verify>
    All 10 curl checks produce expected HTTP status codes and redirect locations. ECS service is stable with new deployment.
  </verify>
  <done>
    Frontend deployed to ECS. Automated curl checks confirm: root redirects to /sign-in, marketing paths redirect to getinsourced.ai, auth pages return 200, unknown paths return 404.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Browser verification of live behavior and CTA flow</name>
  <files></files>
  <action>
    CHECKPOINT: Pause for human browser verification of the deployed frontend.

    What was built:
    - Root redirect (/ to /dashboard or /sign-in based on auth state)
    - Marketing path redirects to getinsourced.ai (308 permanent)
    - Narrowed Clerk middleware (isProtectedRoute pattern)
    - App-context 404 page ("Page not found - go to dashboard")
    - force-dynamic removed from root and dashboard layouts

    Steps for human to verify:
    1. Open an incognito/private browser window (no Clerk session)
    2. Visit https://cofounder.getinsourced.ai/ — should redirect to /sign-in WITHOUT a visible flash or intermediate page
    3. Visit https://cofounder.getinsourced.ai/pricing — should redirect to https://getinsourced.ai/pricing
    4. Visit https://cofounder.getinsourced.ai/about — should redirect to https://getinsourced.ai/about
    5. Visit https://cofounder.getinsourced.ai/some-fake-page — should show 404 page with "Page not found" heading and "Go to dashboard" link
    6. Sign in at https://cofounder.getinsourced.ai/sign-in — after signing in, should land on /dashboard
    7. While authenticated, visit https://cofounder.getinsourced.ai/ — should redirect to /dashboard (no flash)
    8. MARKETING CTA END-TO-END: Visit https://getinsourced.ai/cofounder and click a CTA button — should navigate to https://cofounder.getinsourced.ai/sign-up
    9. Visit https://getinsourced.ai/pricing and click a checkout CTA — should navigate to cofounder.getinsourced.ai/sign-up
    10. Verify /sign-in and /sign-up pages load quickly — no unnecessary Clerk overhead
  </action>
  <verify>
    User reports "approved" after completing all 10 browser verification steps.
  </verify>
  <done>
    User confirms: root redirect works without flash, marketing redirects land on getinsourced.ai, 404 shows app-context page, auth pages load fast, marketing CTAs reach app correctly.
  </done>
</task>

</tasks>

<verification>
1. ECS frontend service deployed and stable
2. Curl checks confirm all redirect status codes and destinations
3. Browser verification confirms no visual flash on root redirect
4. Marketing site CTA links reach cofounder.getinsourced.ai correctly
5. 404 page displays app-context messaging
6. Auth pages (sign-in, sign-up) load without issues
</verification>

<success_criteria>
- Frontend deployed to ECS with zero-downtime rolling update
- All marketing paths redirect to getinsourced.ai with 308 status
- Root path redirects based on auth state (no flash)
- Auth pages load correctly
- Marketing site CTAs work end-to-end
- User approves browser verification checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/20-app-cleanup/20-02-SUMMARY.md`
</output>
