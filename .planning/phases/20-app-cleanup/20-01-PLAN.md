---
phase: 20-app-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/app/(marketing)/layout.tsx
  - frontend/src/app/(marketing)/page.tsx
  - frontend/src/app/(marketing)/about/page.tsx
  - frontend/src/app/(marketing)/contact/page.tsx
  - frontend/src/app/(marketing)/pricing/page.tsx
  - frontend/src/app/(marketing)/privacy/page.tsx
  - frontend/src/app/(marketing)/terms/page.tsx
  - frontend/src/app/(marketing)/signin/page.tsx
  - frontend/src/components/marketing/fade-in.tsx
  - frontend/src/components/marketing/footer.tsx
  - frontend/src/components/marketing/home-content.tsx
  - frontend/src/components/marketing/insourced-home-content.tsx
  - frontend/src/components/marketing/navbar.tsx
  - frontend/src/components/marketing/pricing-content.tsx
  - frontend/src/app/not-found.tsx
  - frontend/src/middleware.ts
  - frontend/next.config.ts
  - frontend/src/app/layout.tsx
  - frontend/src/app/(dashboard)/layout.tsx
autonomous: true
requirements: [APP-01, APP-02, APP-03, APP-04]

must_haves:
  truths:
    - "Marketing routes (/pricing, /about, /contact, /privacy, /terms) are not served by the frontend app — they redirect to getinsourced.ai"
    - "Root path / redirects to /dashboard for authenticated users or /sign-in for unauthenticated users"
    - "/signin (no hyphen) redirects to /sign-in"
    - "Unknown routes show app-context 404 page with link to dashboard"
    - "Clerk middleware only calls auth.protect() on protected routes, not removed marketing paths"
    - "force-dynamic removed from root layout and dashboard layout"
    - "sign-in and sign-up pages load without auth checks"
  artifacts:
    - path: "frontend/src/middleware.ts"
      provides: "Auth-aware root redirect + isProtectedRoute pattern"
      contains: "isProtectedRoute"
    - path: "frontend/next.config.ts"
      provides: "Static marketing path redirects to getinsourced.ai"
      contains: "getinsourced.ai"
    - path: "frontend/src/app/not-found.tsx"
      provides: "App-context 404 page"
      contains: "Go to dashboard"
  key_links:
    - from: "frontend/src/middleware.ts"
      to: "/dashboard or /sign-in"
      via: "auth() userId check on pathname === '/'"
      pattern: "pathname === \"/\""
    - from: "frontend/next.config.ts"
      to: "https://getinsourced.ai"
      via: "permanent redirect config"
      pattern: "getinsourced\\.ai"
---

<objective>
Strip marketing routes from the frontend app, add redirect logic, and narrow Clerk middleware scope.

Purpose: After the marketing site moved to getinsourced.ai (Phases 18-19), cofounder.getinsourced.ai must serve only the authenticated app. Marketing routes become redirects, the root path becomes auth-aware, and Clerk middleware stops wasting cycles on dead marketing paths.

Output: Clean frontend with no marketing code, proper redirects, narrowed middleware, app-context 404 page.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-app-cleanup/20-RESEARCH.md
@.planning/phases/20-app-cleanup/20-CONTEXT.md
@frontend/src/middleware.ts
@frontend/next.config.ts
@frontend/src/app/layout.tsx
@frontend/src/app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete marketing routes and components, add redirects and 404 page</name>
  <files>
    frontend/src/app/(marketing)/layout.tsx
    frontend/src/app/(marketing)/page.tsx
    frontend/src/app/(marketing)/about/page.tsx
    frontend/src/app/(marketing)/contact/page.tsx
    frontend/src/app/(marketing)/pricing/page.tsx
    frontend/src/app/(marketing)/privacy/page.tsx
    frontend/src/app/(marketing)/terms/page.tsx
    frontend/src/app/(marketing)/signin/page.tsx
    frontend/src/components/marketing/fade-in.tsx
    frontend/src/components/marketing/footer.tsx
    frontend/src/components/marketing/home-content.tsx
    frontend/src/components/marketing/insourced-home-content.tsx
    frontend/src/components/marketing/navbar.tsx
    frontend/src/components/marketing/pricing-content.tsx
    frontend/src/app/not-found.tsx
    frontend/next.config.ts
  </files>
  <action>
    1. DELETE the entire `(marketing)` route group directory: `rm -rf frontend/src/app/(marketing)/`
       This removes all 8 files: layout.tsx, page.tsx, about/page.tsx, contact/page.tsx, pricing/page.tsx, privacy/page.tsx, terms/page.tsx, signin/page.tsx

    2. DELETE the entire marketing components directory: `rm -rf frontend/src/components/marketing/`
       This removes all 6 files: fade-in.tsx, footer.tsx, home-content.tsx, insourced-home-content.tsx, navbar.tsx, pricing-content.tsx

    3. ADD permanent redirects in `frontend/next.config.ts` for old marketing paths. These are static redirects that run BEFORE middleware (no auth needed). Use `permanent: true` (Next.js emits 308 which search engines treat identically to 301 for SEO transfer). Include `basePath: false` on ALL external destination redirects (required by Next.js for URLs starting with https://). Keep existing `reactStrictMode` and `output: "standalone"`. The final config:

       ```typescript
       import type { NextConfig } from "next";

       const nextConfig: NextConfig = {
         reactStrictMode: true,
         output: "standalone",
         async redirects() {
           return [
             { source: "/pricing", destination: "https://getinsourced.ai/pricing", permanent: true, basePath: false },
             { source: "/about", destination: "https://getinsourced.ai/about", permanent: true, basePath: false },
             { source: "/contact", destination: "https://getinsourced.ai/contact", permanent: true, basePath: false },
             { source: "/privacy", destination: "https://getinsourced.ai/privacy", permanent: true, basePath: false },
             { source: "/terms", destination: "https://getinsourced.ai/terms", permanent: true, basePath: false },
             { source: "/signin", destination: "/sign-in", permanent: true },
           ];
         },
       };

       export default nextConfig;
       ```

    4. CREATE `frontend/src/app/not-found.tsx` — app-context 404 page per user decision ("Page not found — go to dashboard"). Use the project's existing Tailwind classes: `bg-obsidian` background, `text-white` heading, `text-muted-foreground` body, `bg-brand hover:bg-brand/90` button, `rounded-xl` corners. Include a Link to /dashboard. This file replaces the default Next.js 404 for all unmatched routes.

       ```typescript
       import Link from "next/link";

       export default function NotFound() {
         return (
           <div className="min-h-screen bg-obsidian flex items-center justify-center px-4">
             <div className="text-center space-y-4">
               <h1 className="text-4xl font-bold text-white">Page not found</h1>
               <p className="text-muted-foreground">This page doesn&apos;t exist.</p>
               <Link
                 href="/dashboard"
                 className="inline-block px-6 py-3 bg-brand hover:bg-brand/90 text-white font-medium rounded-xl transition-colors"
               >
                 Go to dashboard
               </Link>
             </div>
           </div>
         );
       }
       ```
  </action>
  <verify>
    Run `ls frontend/src/app/(marketing)/ 2>/dev/null` — should return nothing (directory gone).
    Run `ls frontend/src/components/marketing/ 2>/dev/null` — should return nothing (directory gone).
    Run `cat frontend/next.config.ts` — should contain `getinsourced.ai` redirect destinations and `basePath: false`.
    Run `cat frontend/src/app/not-found.tsx` — should contain "Page not found" and link to /dashboard.
    Run `grep -r "components/marketing" frontend/src/ 2>/dev/null` — should return nothing (no dangling imports).
  </verify>
  <done>
    All 14 marketing files deleted. next.config.ts has 6 redirect rules (5 external to getinsourced.ai with basePath: false, 1 internal /signin to /sign-in). not-found.tsx exists with app-context messaging and dashboard link. Zero remaining references to marketing components in the codebase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite Clerk middleware and remove force-dynamic exports</name>
  <files>
    frontend/src/middleware.ts
    frontend/src/app/layout.tsx
    frontend/src/app/(dashboard)/layout.tsx
  </files>
  <action>
    1. REWRITE `frontend/src/middleware.ts` completely. The current middleware uses `isPublicRoute` allowlist pattern that includes now-deleted marketing paths. Replace with:

       a. Replace `isPublicRoute` with `isProtectedRoute` using `createRouteMatcher`. Protected routes are:
          `/dashboard(.*)`, `/onboarding(.*)`, `/projects(.*)`, `/billing(.*)`, `/chat(.*)`, `/company(.*)`, `/strategy(.*)`, `/timeline(.*)`, `/understanding(.*)`, `/architecture(.*)`, `/admin(.*)`

       b. Add root redirect BEFORE the protected route check. CRITICAL: Check `pathname === "/"` BEFORE calling `await auth()` to avoid running auth on every request (Pitfall 2 from research). Inside the if-block: call `const { userId } = await auth()`, if userId redirect to /dashboard, else redirect to /sign-in. Use `NextResponse.redirect(new URL("/dashboard", request.url))` — NOT redirectToSignIn() (per research Open Question 1).

       c. Keep admin route handling: if `pathname.startsWith("/admin")`, call auth(), check publicMetadata.admin === true, redirect non-admins to /dashboard.

       d. For all other protected routes: call `await auth.protect()` which handles redirect to sign-in internally with proper redirect_url.

       e. Keep the existing `config.matcher` unchanged — it correctly skips _next internals and static files.

       The complete middleware should match the "Final middleware.ts shape" in 20-RESEARCH.md.

    2. REMOVE `export const dynamic = "force-dynamic";` from `frontend/src/app/layout.tsx` (line 9). The root layout has zero server-side dynamic calls — it only renders ClerkProvider, fonts, and Toaster. Removing this allows Next.js to statically optimize sign-in/sign-up pages.

    3. REMOVE `export const dynamic = "force-dynamic";` from `frontend/src/app/(dashboard)/layout.tsx` (line 4). The dashboard layout has zero server-side dynamic calls — it only renders BrandNav, children, and FloatingChat. Dashboard pages are all "use client" components that fetch data client-side.

    4. After all edits, run `cd frontend && npx next build` to verify the build succeeds. This confirms:
       - No broken imports from deleted marketing files
       - Middleware compiles correctly
       - next.config.ts redirects are valid
       - not-found.tsx renders without errors
  </action>
  <verify>
    Run `cd /Users/vladcortex/co-founder/frontend && npx next build` — build should succeed with zero errors.
    Run `grep -n "isPublicRoute" frontend/src/middleware.ts` — should return nothing (pattern replaced).
    Run `grep -n "isProtectedRoute" frontend/src/middleware.ts` — should return the createRouteMatcher line.
    Run `grep -n "pathname === \"/\"" frontend/src/middleware.ts` — should return the root redirect check.
    Run `grep -n "force-dynamic" frontend/src/app/layout.tsx` — should return nothing.
    Run `grep -n "force-dynamic" frontend/src/app/\(dashboard\)/layout.tsx` — should return nothing.
  </verify>
  <done>
    Middleware uses isProtectedRoute pattern with auth-aware root redirect. force-dynamic removed from root layout and dashboard layout. `next build` succeeds confirming no broken imports or configuration issues.
  </done>
</task>

</tasks>

<verification>
1. `next build` passes — no compilation errors from deleted routes or modified middleware
2. `grep -r "(marketing)" frontend/src/` returns nothing — route group fully removed
3. `grep -r "components/marketing" frontend/src/` returns nothing — marketing components fully removed
4. `grep "force-dynamic" frontend/src/app/layout.tsx frontend/src/app/\(dashboard\)/layout.tsx` returns nothing
5. `frontend/src/middleware.ts` contains `isProtectedRoute` (not `isPublicRoute`)
6. `frontend/next.config.ts` contains all 6 redirect rules
7. `frontend/src/app/not-found.tsx` exists with dashboard link
</verification>

<success_criteria>
- All marketing route files and components deleted (14 files)
- next.config.ts has 6 permanent redirects (5 external, 1 internal)
- middleware.ts uses isProtectedRoute pattern with guarded root redirect
- force-dynamic removed from 2 layout files
- not-found.tsx created with app-context 404
- `next build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/20-app-cleanup/20-01-SUMMARY.md`
</output>
