---
phase: 09-strategy-graph-timeline
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - frontend/package.json
  - frontend/src/app/(dashboard)/strategy/page.tsx
  - frontend/src/components/strategy-graph/StrategyGraphCanvas.tsx
  - frontend/src/components/strategy-graph/ForceGraphInner.tsx
  - frontend/src/components/strategy-graph/NodeDetailModal.tsx
  - frontend/src/components/strategy-graph/GraphMinimap.tsx
autonomous: true

must_haves:
  truths:
    - "Strategy graph page renders force-directed graph with color-coded nodes by type"
    - "Hovering a node highlights connected nodes and edges, dims unconnected"
    - "Clicking a node opens a centered modal with title, status, date, why, impact_summary above fold"
    - "Modal has expandable sections for tradeoffs and alternatives"
    - "Graph supports zoom, pan, and minimap navigation"
    - "Graph handles empty state gracefully"
  artifacts:
    - path: "frontend/src/app/(dashboard)/strategy/page.tsx"
      provides: "Strategy graph page"
      contains: "StrategyGraphCanvas"
    - path: "frontend/src/components/strategy-graph/ForceGraphInner.tsx"
      provides: "ForceGraph2D canvas component with hover highlighting"
      contains: "ForceGraph2D"
    - path: "frontend/src/components/strategy-graph/NodeDetailModal.tsx"
      provides: "Shared node detail modal used by graph and timeline"
      contains: "NodeDetailModal"
  key_links:
    - from: "frontend/src/app/(dashboard)/strategy/page.tsx"
      to: "/api/graph/{project_id}"
      via: "apiFetch in useEffect"
      pattern: "apiFetch.*graph"
    - from: "frontend/src/components/strategy-graph/ForceGraphInner.tsx"
      to: "react-force-graph-2d"
      via: "import ForceGraph2D"
      pattern: "react-force-graph-2d"
    - from: "frontend/src/components/strategy-graph/StrategyGraphCanvas.tsx"
      to: "frontend/src/components/strategy-graph/ForceGraphInner.tsx"
      via: "dynamic import with ssr:false"
      pattern: "dynamic.*ForceGraphInner.*ssr.*false"
---

<objective>
Interactive strategy graph visualization with react-force-graph-2d and shared NodeDetailModal.

Purpose: Deliver the force-directed graph view where founders can visually explore decision relationships, hover to see connections, and click for detail. The NodeDetailModal is shared with the timeline view (Plan 09-04) for consistent experience. This fulfills GRPH-05 (interactive graph) and the graph visualization locked decisions.

Output: Strategy graph page, ForceGraph2D canvas with hover highlighting, NodeDetailModal, minimap.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-strategy-graph-timeline/09-RESEARCH.md
@.planning/phases/09-strategy-graph-timeline/09-02-SUMMARY.md

# Key source files:
@frontend/src/lib/api.ts                    # apiFetch pattern
@frontend/src/app/(dashboard)/layout.tsx     # Dashboard layout
@frontend/src/components/graph/GraphMinimap.tsx  # Existing minimap (reference/adapt)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-force-graph-2d and create ForceGraphInner with hover highlighting</name>
  <files>
    frontend/package.json
    frontend/src/components/strategy-graph/StrategyGraphCanvas.tsx
    frontend/src/components/strategy-graph/ForceGraphInner.tsx
    frontend/src/components/strategy-graph/GraphMinimap.tsx
  </files>
  <action>
    Run `cd /Users/vladcortex/co-founder/frontend && npm install react-force-graph-2d` to install the library.

    Create `frontend/src/components/strategy-graph/StrategyGraphCanvas.tsx`:
    - "use client" directive
    - Dynamic import: `const ForceGraphInner = dynamic(() => import("./ForceGraphInner"), { ssr: false, loading: () => <GraphLoadingSkeleton /> })`
    - `GraphLoadingSkeleton` — a div with animate-pulse bars (Tailwind pattern from Phase 04)
    - Props: `{ nodes, links, onNodeClick }` typed with `GraphNode[]` and `GraphLink[]` interfaces
    - Render `ForceGraphInner` passing nodes, links, onNodeClick
    - Wrap in a container div with `className="relative w-full h-[calc(100vh-12rem)]"` for proper sizing

    Create `frontend/src/components/strategy-graph/ForceGraphInner.tsx`:
    - Import `ForceGraph2D` from "react-force-graph-2d"
    - Import types: `ForceGraphMethods` from "react-force-graph-2d"
    - Define interfaces:
      ```typescript
      interface NodeObject {
        id: string;
        type: "decision" | "milestone" | "artifact";
        title: string;
        status: string;
        x?: number;
        y?: number;
      }
      interface LinkObject {
        source: string;
        target: string;
        relation: string;
      }
      ```

    - Color palette (Claude's discretion — using brand-adjacent colors):
      ```typescript
      const NODE_COLORS = {
        decision: "#8B5CF6",   // violet
        milestone: "#10B981",  // emerald
        artifact: "#3B82F6",   // blue
      } as const;
      const HIGHLIGHT_COLOR = "#F59E0B"; // amber hover ring
      const DIM_OPACITY = 0.2;
      ```

    - State: `hoverNode` (NodeObject | null)
    - Ref: `graphRef = useRef<ForceGraphMethods>(null)`

    - Adjacency-based hover highlighting (useMemo on hoverNode + links):
      Build `highlightNodes: Set<string>` and `highlightLinks: Set<string>` from links connected to hoverNode.
      When no hover: both sets empty (everything fully visible).
      When hovering: only hoverNode's neighbors are highlighted.
      Use `typeof link.source === "object" ? link.source.id : link.source` for safe ID extraction (d3-force mutates link.source from string to object after simulation).

    - `nodeCanvasObject` callback (useCallback):
      Draw circles with radius 8px.
      Apply `ctx.globalAlpha = isHighlighted ? 1.0 : DIM_OPACITY` for dimming unconnected nodes.
      Draw amber stroke ring on hovered node.
      Draw node title text below circle when scale > 1.5 (prevents text clutter at overview zoom).
      Reset `ctx.globalAlpha = 1.0` after drawing.

    - Props on ForceGraph2D:
      - `ref={graphRef}`
      - `graphData={useMemo(() => ({ nodes, links }), [nodes, links])}`
      - `nodeCanvasObject={nodeCanvasObject}`
      - `nodeCanvasObjectMode={() => "replace"}`
      - `onNodeClick={onNodeClick}`
      - `onNodeHover={setHoverNode}`
      - `linkColor` — highlight amber for connected links, `"rgba(255,255,255,0.1)"` for others
      - `linkWidth` — 2 for highlighted, 1 for others
      - `linkDirectionalArrowLength={4}` — show edge direction
      - `linkDirectionalArrowRelPos={1}`
      - `enableZoomInteraction={true}`
      - `enablePanInteraction={true}`
      - `backgroundColor="transparent"`
      - `width` and `height` props from container dimensions (use `useEffect` to measure parent)

    - Add `useEffect` on mount to call `graphRef.current?.zoomToFit(400)` after a short delay (300ms) so graph fits on initial load.

    Create `frontend/src/components/strategy-graph/GraphMinimap.tsx`:
    - Check if react-force-graph-2d has built-in minimap support. If not, create a simple minimap:
      - Small fixed-size div (180x120px) in bottom-right corner with `absolute` positioning
      - Render a simplified version: canvas element showing dots for node positions scaled down
      - Use `graphRef.current?.graphData()` to get current node positions
      - Draw colored dots (same colors as main graph)
      - Alternatively, if the library's minimap works, use that instead
    - Claude's discretion: position bottom-right with `absolute bottom-4 right-4` styling, `bg-black/60 rounded-lg border border-white/10 p-2`
  </action>
  <verify>
    `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | head -30` — no new TypeScript errors.
    Verify react-force-graph-2d is in package.json dependencies.
    Verify `StrategyGraphCanvas` uses `dynamic(() => import("./ForceGraphInner"), { ssr: false })`.
    Verify `ForceGraphInner` has `nodeCanvasObject` with DIM_OPACITY logic.
  </verify>
  <done>
    react-force-graph-2d installed.
    ForceGraphInner renders force-directed graph with color-coded circles by node type.
    Hover highlights connected nodes/edges and dims unconnected.
    Click callback triggers onNodeClick prop.
    Zoom, pan enabled. ZoomToFit on initial load.
    Minimap available for navigation context.
    StrategyGraphCanvas wraps ForceGraphInner with dynamic import (ssr:false).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create strategy page and NodeDetailModal (shared component)</name>
  <files>
    frontend/src/app/(dashboard)/strategy/page.tsx
    frontend/src/components/strategy-graph/NodeDetailModal.tsx
  </files>
  <action>
    Create `frontend/src/components/strategy-graph/NodeDetailModal.tsx`:
    - "use client" directive
    - Use framer-motion for modal animations (already installed)
    - Use shadcn Dialog component pattern if available, otherwise build modal:
      - Backdrop: `fixed inset-0 z-50 bg-black/60 backdrop-blur-sm` with click-to-close
      - Modal container: centered `max-w-lg w-full mx-auto`, dark glass card (`glass-strong border border-white/10 rounded-2xl`)
      - framer-motion `AnimatePresence` + `motion.div` with opacity+scale transition

    - Props interface:
      ```typescript
      interface NodeDetail {
        id: string;
        title: string;
        type: "decision" | "milestone" | "artifact";
        status: string;
        created_at: string;
        why: string;
        impact_summary: string;
        tradeoffs: string[];
        alternatives: string[];
      }
      interface NodeDetailModalProps {
        node: NodeDetail | null;
        onClose: () => void;
        showGraphLink?: boolean;  // true when opened from timeline
        onViewInGraph?: (nodeId: string) => void;
      }
      ```

    - Above-the-fold content (locked decision — visible without scrolling):
      - Type badge: colored pill showing "Decision" | "Milestone" | "Artifact" with matching NODE_COLORS
      - Title: `text-xl font-semibold text-white`
      - Status badge: pill with status text
      - Date: `text-sm text-muted-foreground` with formatted created_at
      - Why: one-line reason in `text-sm text-white/80`
      - Impact summary: one-line in `text-sm text-white/60`

    - Below-the-fold (expandable sections — locked decision):
      - "Tradeoffs" section: collapsible with ChevronDown icon, shows list of tradeoffs as bullet points
      - "Alternatives" section: collapsible with ChevronDown icon, shows list of alternatives as bullet points
      - Use useState for each section's expanded state (manual expand pattern from Phase 08-04)
      - Only render sections if arrays have items

    - "View in Graph" link: only shown when `showGraphLink` is true. Renders as a button/link that calls `onViewInGraph(node.id)`.

    - Connected decisions NOT shown in modal (locked decision — graph view handles relationships).

    - Close button: X icon in top-right corner. Also close on backdrop click and Escape key.

    - Claude's discretion: Read-only (no user annotations). Start simple, can add notes later.

    Create `frontend/src/app/(dashboard)/strategy/page.tsx`:
    - "use client" directive
    - Page title: "Strategy Graph" with subtitle "Decision relationships and project evolution"
    - Fetch graph data on mount via `apiFetch("/api/graph/{projectId}", getToken)` using useAuth from Clerk
    - Project ID: For now, use a project selector or fetch first project from `/api/projects`. Use `useEffect` to load. If no projects, show empty state.
    - State: `graphData` (nodes + links), `selectedNode` (for modal), `loading`, `error`
    - Render `StrategyGraphCanvas` with nodes/links and `onNodeClick={(node) => setSelectedNode(node)}`
    - Render `NodeDetailModal` with `node={selectedNode}` and `onClose={() => setSelectedNode(null)}`

    - Empty state (Claude's discretion): when no nodes exist, show centered message:
      ```
      <div className="flex flex-col items-center justify-center h-[60vh] text-center">
        <GitBranch className="w-12 h-12 text-white/20 mb-4" />
        <h3 className="text-lg font-medium text-white/60">No strategy data yet</h3>
        <p className="text-sm text-muted-foreground mt-1">Decision nodes will appear here as you make project decisions</p>
      </div>
      ```
    - Loading state: show skeleton/spinner while data loads
    - Error state: show error message with retry button

    - The page uses useAuth() from @clerk/nextjs for getToken, and needs a way to identify the current project. Options:
      1. URL search param `?project=uuid` — cleanest
      2. Fetch user's first project as default
      Use search param approach: `const searchParams = useSearchParams(); const projectId = searchParams.get("project");`
      If no projectId, show a project picker or redirect to /projects.
  </action>
  <verify>
    `cd /Users/vladcortex/co-founder/frontend && npx tsc --noEmit 2>&1 | head -30` — no new TypeScript errors.
    Verify `NodeDetailModal` has above-fold content (title, status, date, why, impact_summary) and expandable tradeoffs/alternatives.
    Verify strategy page fetches from /api/graph/ endpoint.
    Verify NodeDetailModal is NOT tightly coupled to graph (reusable by timeline).
  </verify>
  <done>
    Strategy page at /strategy renders the force-directed graph.
    Clicking a node opens NodeDetailModal with at-a-glance info above fold.
    Tradeoffs and alternatives are expandable sections in the modal.
    Modal reusable: accepts NodeDetail interface, not tied to graph-specific types.
    Empty state shows helpful message when no nodes exist.
    Page uses project_id from URL search param.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. react-force-graph-2d in package.json dependencies
3. ForceGraphInner loaded via dynamic import with ssr:false
4. NodeDetailModal is generic (not graph-specific) and can be imported by timeline components
5. Color-coded nodes by type (violet=decision, emerald=milestone, blue=artifact)
6. Hover highlighting dims non-connected nodes
7. Empty state renders when no graph data
</verification>

<success_criteria>
- GRPH-05: Graph visualization interactive — clickable nodes open detail modal
- Graph uses force-directed layout (locked decision)
- Color-coded circles for node types (locked decision)
- Hover highlights connected nodes and edges (locked decision)
- Click opens centered modal (locked decision)
- Zoom + pan + minimap (locked decision)
- Modal shows title, status, date, why, impact_summary above fold (locked decision)
- Expandable tradeoffs and alternatives in modal (locked decision)
- Modal reused by both graph and timeline (locked decision — shared component)
- Connected decisions NOT shown in modal (locked decision)
</success_criteria>

<output>
After completion, create `.planning/phases/09-strategy-graph-timeline/09-03-SUMMARY.md`
</output>
