---
phase: 22-security-headers-baseline-audit
plan: 02
type: execute
wave: 2
depends_on:
  - 22-01
files_modified:
  - infra/lib/marketing-stack.ts
autonomous: false
requirements:
  - INFRA-01

must_haves:
  truths:
    - "CloudFront response headers policy is defined in CDK source code as a custom ResponseHeadersPolicy construct"
    - "The AWS managed SECURITY_HEADERS preset is no longer referenced in marketing-stack.ts"
    - "Browser console shows zero CSP violations when loading getinsourced.ai"
    - "Google Rich Results Test and social preview debugger tools can render the site without CSP blocks"
    - "Content-Security-Policy header is present in CloudFront responses"
    - "Permissions-Policy header is present in CloudFront responses"
  artifacts:
    - path: "infra/lib/marketing-stack.ts"
      provides: "Custom ResponseHeadersPolicy replacing managed SECURITY_HEADERS"
      contains: "MarketingResponseHeadersPolicy"
  key_links:
    - from: "infra/lib/marketing-stack.ts"
      to: "CloudFront Distribution defaultBehavior"
      via: "responseHeadersPolicy property"
      pattern: "responseHeadersPolicy:\\s*marketingResponseHeadersPolicy"
---

<objective>
Replace the AWS managed `SECURITY_HEADERS` CloudFront response headers policy with a custom CDK `ResponseHeadersPolicy` that includes a proper Content-Security-Policy header, Permissions-Policy, and all standard security headers. Deploy via CDK and verify zero CSP violations.

Purpose: Bring security headers into source control with a real CSP (currently missing) and ensure the policy does not block third-party verification tools.
Output: Updated `marketing-stack.ts` with custom `ResponseHeadersPolicy`, deployed to CloudFront.
</objective>

<execution_context>
@/Users/vladcortex/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladcortex/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-security-headers-baseline-audit/22-RESEARCH.md
@infra/lib/marketing-stack.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace managed SECURITY_HEADERS with custom ResponseHeadersPolicy and deploy</name>
  <files>infra/lib/marketing-stack.ts</files>
  <action>
In `infra/lib/marketing-stack.ts`, create a custom `ResponseHeadersPolicy` construct and replace the managed `SECURITY_HEADERS` reference on line 86.

**Step 1: Add the custom policy construct** (place it before the Distribution construct, after the cache policies section around line 69):

```typescript
const marketingResponseHeadersPolicy = new cloudfront.ResponseHeadersPolicy(
  this,
  'MarketingResponseHeadersPolicy',
  {
    responseHeadersPolicyName: 'Marketing-SecurityHeaders',
    comment: 'Custom security headers for getinsourced.ai - v0.4',
    securityHeadersBehavior: {
      contentSecurityPolicy: {
        override: true,
        contentSecurityPolicy: [
          "default-src 'self'",
          "script-src 'self' 'unsafe-inline'",
          "style-src 'self' 'unsafe-inline'",
          "font-src 'self'",
          "img-src 'self' data:",
          "connect-src 'self'",
          "media-src 'none'",
          "object-src 'none'",
          "child-src 'none'",
          "base-uri 'self'",
          "form-action 'self'",
          "frame-ancestors 'self'",
          "upgrade-insecure-requests",
        ].join('; '),
      },
      contentTypeOptions: { override: true },
      frameOptions: {
        frameOption: cloudfront.HeadersFrameOption.SAMEORIGIN,
        override: true,
      },
      referrerPolicy: {
        referrerPolicy: cloudfront.HeadersReferrerPolicy.STRICT_ORIGIN_WHEN_CROSS_ORIGIN,
        override: true,
      },
      strictTransportSecurity: {
        accessControlMaxAge: cdk.Duration.seconds(63072000), // 2 years
        includeSubdomains: true,
        preload: false,
        override: true,
      },
      xssProtection: {
        protection: true,
        modeBlock: true,
        override: true,
      },
    },
    customHeadersBehavior: {
      customHeaders: [
        {
          header: 'Permissions-Policy',
          value: [
            'camera=()',
            'microphone=()',
            'geolocation=()',
            'payment=()',
            'usb=()',
            'magnetometer=()',
            'accelerometer=()',
            'gyroscope=()',
            'display-capture=()',
            'interest-cohort=()',
          ].join(', '),
          override: true,
        },
      ],
    },
  }
);
```

**Step 2: Replace the managed policy reference** on the `defaultBehavior.responseHeadersPolicy` line:

Change:
```typescript
responseHeadersPolicy: cloudfront.ResponseHeadersPolicy.SECURITY_HEADERS,
```
To:
```typescript
responseHeadersPolicy: marketingResponseHeadersPolicy,
```

**Step 3: Verify the `additionalBehaviors['_next/static/*']` does NOT have a `responseHeadersPolicy`** — it should remain without one (already the case; do NOT add one).

**CSP design decisions (from research):**
- `script-src 'self' 'unsafe-inline'` — Next.js static export injects 55 unique `self.__next_f.push()` inline scripts per build. Hash-based CSP is impractical (hashes change every build).
- `style-src 'self' 'unsafe-inline'` — Framer Motion sets inline `style=` attributes for animations (`opacity:0; transform:translateY(24px)`).
- `frame-ancestors 'self'` — NOT `'none'`. Google Rich Results Test renders previews in iframes; `'none'` blocks them.
- `img-src 'self' data:` — `data:` for any future base64 images.
- `media-src 'none'`, `object-src 'none'`, `child-src 'none'` — no media, plugins, or worker/iframe children.
- HSTS 2 years with `includeSubdomains` (all subdomains are HTTPS-only). `preload: false` — preload is a near-permanent commitment.
- Permissions-Policy disables all sensor APIs (camera, microphone, geolocation, etc.) — appropriate for a static marketing site.

**Step 4: Deploy the CDK stack.**

```bash
cd /Users/vladcortex/co-founder/infra
CDK_DEFAULT_REGION=us-east-1 AWS_DEFAULT_REGION=us-east-1 npx cdk deploy CoFounderMarketing --require-approval never
```

Wait for the deployment to complete successfully. The CloudFront distribution update may take 3-5 minutes to propagate.

**Step 5: Verify the new headers are live.**

```bash
curl -sI https://getinsourced.ai/ | grep -i -E "(content-security-policy|permissions-policy|strict-transport|x-frame|x-content|referrer-policy|x-xss)"
```

Expected output should show all 7 headers including the new `content-security-policy` and `permissions-policy`.
  </action>
  <verify>
1. `grep -c "ResponseHeadersPolicy.SECURITY_HEADERS" infra/lib/marketing-stack.ts` returns 0 (managed policy removed).
2. `grep -c "MarketingResponseHeadersPolicy" infra/lib/marketing-stack.ts` returns at least 2 (construct definition + usage).
3. `curl -sI https://getinsourced.ai/ | grep -i "content-security-policy"` returns a CSP header.
4. `curl -sI https://getinsourced.ai/ | grep -i "permissions-policy"` returns a Permissions-Policy header.
5. `curl -sI https://getinsourced.ai/ | grep -i "strict-transport-security"` shows max-age=63072000 with includeSubDomains.
6. CDK deploy completed without errors.
  </verify>
  <done>marketing-stack.ts uses custom MarketingResponseHeadersPolicy construct instead of managed SECURITY_HEADERS. CDK deployed. CloudFront returns Content-Security-Policy, Permissions-Policy, and all standard security headers.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify zero CSP violations and third-party tool compatibility</name>
  <files>N/A — verification only</files>
  <action>
Human verification of deployed security headers. What was built: Custom security headers policy deployed to CloudFront with CSP, Permissions-Policy, HSTS, and all standard security headers. The managed SECURITY_HEADERS preset has been replaced with a source-controlled custom policy.

Steps for human to verify:

1. **Browser console check:** Open https://getinsourced.ai/ in Chrome DevTools Console tab. Reload the page. Verify zero CSP violation errors (no "Refused to execute..." or "Refused to apply..." messages). Navigate to 2-3 other pages (/cofounder/, /pricing/) and check console on each.

2. **Response headers check:** In Chrome DevTools Network tab, click the main document request. Check Response Headers for:
   - `content-security-policy` header present with `default-src 'self'` and `script-src 'self' 'unsafe-inline'`
   - `permissions-policy` header present
   - `strict-transport-security` header with `max-age=63072000; includeSubDomains`
   - `x-frame-options: SAMEORIGIN`
   - `x-content-type-options: nosniff`
   - `referrer-policy: strict-origin-when-cross-origin`

3. **Framer Motion animations:** Verify that page elements still animate (hero text fades in, sections stagger in on scroll). If elements appear stuck at opacity:0, the CSP is blocking inline styles.

4. **Google Rich Results Test (optional but recommended):** Visit https://search.google.com/test/rich-results and enter `https://getinsourced.ai/`. If the preview pane renders (even without structured data yet), `frame-ancestors` is working correctly. If it shows a blank preview, there may be a CSP issue.
  </action>
  <verify>Human confirms zero CSP violations in browser console and all 7 security headers are present in response.</verify>
  <done>User types "approved" confirming zero CSP violations and all headers present, or describes issues to fix.</done>
</task>

</tasks>

<verification>
1. `infra/lib/marketing-stack.ts` contains a custom `ResponseHeadersPolicy` construct named `MarketingResponseHeadersPolicy`
2. No reference to `ResponseHeadersPolicy.SECURITY_HEADERS` remains in the codebase
3. `curl -sI https://getinsourced.ai/` returns Content-Security-Policy and Permissions-Policy headers
4. Browser console shows zero CSP violations on getinsourced.ai
5. Page animations (Framer Motion) work correctly (not blocked by CSP)
6. HSTS max-age is 63072000 (2 years) with includeSubDomains
</verification>

<success_criteria>
- CloudFront response headers policy is defined in CDK source code (custom construct, not managed preset)
- Content-Security-Policy header is present on all marketing site responses
- Permissions-Policy header disables unused sensor APIs
- Browser console shows zero CSP violations when loading any marketing page
- Google Rich Results Test can render page preview without CSP blocks
- Framer Motion animations work correctly (inline styles not blocked)
- HSTS is strengthened to 2 years with includeSubDomains
</success_criteria>

<output>
After completion, create `.planning/phases/22-security-headers-baseline-audit/22-02-SUMMARY.md`
</output>
